<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PM Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="/translations.js"></script>

  <style>
    :root {
      --dhl-yellow: #FFCC00;
      --dhl-red: #D40511;
      --dhl-dark: #1A1A1A;
      --dhl-mid: #2C2C2C;
      --dhl-grey: #6B6B6B;
      --dhl-light: #F4F4F4;
      --dhl-white: #FFFFFF;
      --dhl-border: #E0E0E0;
    }
    [x-cloak] { display: none !important; }

    html, body { height: 100%; overflow: hidden; }
    body { background: var(--dhl-light); font-family: 'Segoe UI', Arial, sans-serif; }

    /* Login screen */
    .login-screen { position:fixed;inset:0;z-index:9999;background:linear-gradient(135deg,#f0f4ff 0%,#e8edf5 100%);display:flex;align-items:center;justify-content:center; }

    /* Plan card active states */
    .plan-card-active-blue { border-color:#2563eb !important; background:linear-gradient(180deg,#eff6ff,#dbeafe) !important; box-shadow:0 0 0 2px rgba(37,99,235,0.18), 0 4px 16px rgba(37,99,235,0.12) !important; transform:translateY(-2px) !important; }
    .plan-card-active-purple { border-color:#7c3aed !important; background:linear-gradient(180deg,#faf5ff,#f3e8ff) !important; box-shadow:0 0 0 2px rgba(124,58,237,0.18), 0 4px 16px rgba(124,58,237,0.12) !important; transform:translateY(-2px) !important; }

    /* Login/Register buttons ‚Äî override Tailwind preflight */
    .btn-login {
      display:block !important; width:100% !important; box-sizing:border-box !important;
      background:linear-gradient(135deg,#2563eb,#1d4ed8) !important; color:#fff !important;
      border:none !important; border-radius:10px !important; padding:14px 24px !important;
      font-size:16px !important; font-weight:700 !important; cursor:pointer !important;
      text-align:center !important; letter-spacing:0.2px;
      box-shadow:0 4px 14px rgba(37,99,235,0.35); transition:all .2s;
      -webkit-appearance:none !important; appearance:none !important;
    }
    .btn-login:hover { box-shadow:0 6px 24px rgba(37,99,235,0.5); transform:translateY(-1px); }
    .btn-login:disabled { opacity:0.6; }
    .btn-register {
      display:block !important; width:100% !important; box-sizing:border-box !important;
      background:linear-gradient(135deg,#2563eb,#1d4ed8) !important; color:#fff !important;
      border:none !important; border-radius:10px !important; padding:16px 24px !important;
      font-size:17px !important; font-weight:700 !important; cursor:pointer !important;
      text-align:center !important; letter-spacing:0.3px;
      box-shadow:0 4px 16px rgba(37,99,235,0.35); transition:all .2s;
      -webkit-appearance:none !important; appearance:none !important;
    }
    .btn-register:hover { box-shadow:0 6px 24px rgba(37,99,235,0.5); transform:translateY(-1px); }
    .btn-register:disabled { opacity:0.6; }

    /* Sidebar */
    .sidebar { width: 220px; background: var(--dhl-dark); height: 100vh; overflow-y: auto; flex-shrink: 0; }
    .sidebar-logo { background: var(--dhl-yellow); padding: 14px 20px; display: flex; flex-direction: column; gap: 4px; }
    .sidebar-logo img { display: block; max-width: 100%; }
    .sidebar-logo .logo-sub { font-weight: 900; font-size: 15px; color: var(--dhl-dark); letter-spacing: 0.3px; line-height: 1.2; margin-top: 2px; }
    .sidebar-logo .logo-date { font-size: 10px; color: #555; font-weight: 500; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 12px 20px; color: #aaa; cursor: pointer; transition: all 0.15s; font-size: 14px; font-weight: 500; border-left: 3px solid transparent; }
    .nav-item:hover { background: rgba(255,204,0,0.08); color: #fff; }
    .nav-item.active { background: rgba(255,204,0,0.12); color: var(--dhl-yellow); border-left-color: var(--dhl-yellow); }
    .nav-icon { width: 18px; text-align: center; font-size: 16px; }
    .nav-section { padding: 14px 20px 6px; font-size: 10px; color: #555; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; }

    /* Header */
    .topbar { background: var(--dhl-white); border-bottom: 2px solid var(--dhl-border); padding: 14px 28px; display: flex; align-items: center; justify-content: space-between; }
    .topbar h1 { font-size: 20px; font-weight: 700; color: var(--dhl-dark); }
    .topbar .subtitle { font-size: 12px; color: var(--dhl-grey); margin-top: 1px; }

    /* KPI Cards */
    .kpi-card { background: var(--dhl-white); border-radius: 6px; padding: 18px 22px; border: 1px solid var(--dhl-border); position: relative; overflow: hidden; }
    .kpi-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--dhl-yellow); }
    .kpi-card.red::before { background: var(--dhl-red); }
    .kpi-card.green::before { background: #22c55e; }
    .kpi-card.blue::before { background: #3b82f6; }
    .kpi-card[data-click] { cursor: pointer; transition: box-shadow .15s, transform .15s; }
    .kpi-card[data-click]:hover { box-shadow: 0 2px 8px rgba(0,0,0,.1); transform: translateY(-1px); }
    .kpi-label { font-size: 11px; font-weight: 700; color: var(--dhl-grey); text-transform: uppercase; letter-spacing: 0.8px; }
    .kpi-value { font-size: 26px; font-weight: 800; color: var(--dhl-dark); margin-top: 4px; line-height: 1; }
    .kpi-sub { font-size: 12px; color: var(--dhl-grey); margin-top: 6px; }

    /* Charts */
    .chart-card { background: var(--dhl-white); border-radius: 6px; border: 1px solid var(--dhl-border); }
    .chart-header { padding: 14px 18px; border-bottom: 1px solid var(--dhl-border); font-size: 13px; font-weight: 700; color: var(--dhl-dark); display: flex; align-items: center; justify-content: space-between; }

    /* Table */
    .data-table { width: 100%; border-collapse: collapse; font-size: 12.5px; }
    .data-table th { background: var(--dhl-dark); color: var(--dhl-yellow); font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; padding: 10px 12px; text-align: left; white-space: nowrap; position: sticky; top: 0; z-index: 10; }
    .data-table td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; color: var(--dhl-dark); vertical-align: middle; overflow: hidden; }
    .data-table tr:hover td { background: #fffbea; }
    .data-table tr:last-child td { border-bottom: none; }

    /* Badges */
    .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 3px; font-size: 10.5px; font-weight: 700; white-space: nowrap; }
    .badge-yellow { background: #fff3cd; color: #856404; }
    .badge-green { background: #d1fae5; color: #065f46; }
    .badge-red { background: #fee2e2; color: #991b1b; }
    .badge-blue { background: #dbeafe; color: #1e40af; }
    .badge-grey { background: #f3f4f6; color: #4b5563; }
    .badge-purple { background: #ede9fe; color: #5b21b6; }

    /* Inline select (looks like a badge with a dropdown arrow) */
    .inline-select {
      display: inline-block; font-size: 11px; font-weight: 600;
      padding: 2px 20px 2px 7px; border-radius: 3px; border: none;
      appearance: none; -webkit-appearance: none; cursor: pointer; outline: none;
      min-width: 90px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath fill='%23888' d='M0 0l5 6 5-6z'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 6px center; background-size: 7px;
    }
    .inline-select:focus { outline: 2px solid var(--dhl-yellow); outline-offset: 1px; }
    .inline-select:hover { filter: brightness(0.94); }
    .inline-date {
      border: 1px solid transparent; border-radius: 3px; background: transparent;
      font-size: 12px; color: inherit; cursor: pointer; padding: 2px 4px; width: 106px;
      font-family: inherit;
    }
    .inline-date:hover { background: #f0f0f0; border-color: #e5e7eb; }
    .inline-date:focus { outline: 2px solid var(--dhl-yellow); background: white; border-color: transparent; }

    /* Buttons */
    .btn-primary { background: var(--dhl-yellow); color: var(--dhl-dark); font-weight: 700; border: none; padding: 8px 18px; border-radius: 4px; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; transition: opacity 0.1s; }
    .btn-primary:hover { opacity: 0.88; }
    .btn-danger { background: var(--dhl-red); color: white; font-weight: 700; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn-danger:hover { opacity: 0.88; }
    .btn-ghost { background: transparent; color: var(--dhl-grey); border: 1px solid var(--dhl-border); padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; }
    .btn-ghost:hover { background: var(--dhl-light); }
    .btn-sm { padding: 4px 10px; font-size: 11px; }
    .btn-icon { background: none; border: none; cursor: pointer; color: var(--dhl-grey); padding: 4px 6px; border-radius: 3px; }
    .btn-icon:hover { background: var(--dhl-light); color: var(--dhl-dark); }

    /* Forms */
    .form-group { margin-bottom: 14px; }
    .form-label { display: block; font-size: 11px; font-weight: 700; color: var(--dhl-grey); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .form-input { width: 100%; padding: 8px 10px; border: 1px solid var(--dhl-border); border-radius: 4px; font-size: 13px; color: var(--dhl-dark); background: white; outline: none; transition: border-color 0.15s; }
    .form-input:focus { border-color: var(--dhl-yellow); box-shadow: 0 0 0 2px rgba(255,204,0,0.2); }
    .form-select { width: 100%; padding: 8px 10px; border: 1px solid var(--dhl-border); border-radius: 4px; font-size: 13px; color: var(--dhl-dark); background: white; outline: none; cursor: pointer; }
    .form-select:focus { border-color: var(--dhl-yellow); }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: flex-start; justify-content: center; padding: 40px 20px; overflow-y: auto; }
    .modal { background: white; border-radius: 8px; width: 900px; max-width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.25); }
    .modal-header { background: var(--dhl-dark); color: white; padding: 16px 24px; border-radius: 8px 8px 0 0; display: flex; align-items: center; justify-content: space-between; }
    .modal-header h2 { font-size: 16px; font-weight: 700; }
    .modal-header .accent { color: var(--dhl-yellow); }
    .modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--dhl-border); display: flex; gap: 10px; justify-content: flex-end; background: var(--dhl-light); border-radius: 0 0 8px 8px; }

    /* Section divider in form */
    .form-section { background: var(--dhl-light); padding: 8px 12px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--dhl-grey); letter-spacing: 0.8px; margin: 16px 0 12px; border-left: 3px solid var(--dhl-yellow); }

    /* Filter bar */
    .filter-bar { background: var(--dhl-white); border-bottom: 1px solid var(--dhl-border); padding: 12px 24px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .filter-bar input, .filter-bar select { padding: 6px 10px; border: 1px solid var(--dhl-border); border-radius: 4px; font-size: 12px; color: var(--dhl-dark); background: var(--dhl-light); }
    .filter-bar input:focus, .filter-bar select:focus { outline: none; border-color: var(--dhl-yellow); }

    /* Settings tabs */
    .settings-tab { padding: 10px 20px; font-size: 13px; font-weight: 600; color: var(--dhl-grey); cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.15s; }
    .settings-tab.active { color: var(--dhl-dark); border-bottom-color: var(--dhl-yellow); }
    .settings-tab:hover { color: var(--dhl-dark); }

    /* Gantt */
    .gantt-container { overflow-x: auto; }
    .gantt-row { display: flex; align-items: center; height: 36px; border-bottom: 1px solid #f0f0f0; }
    .gantt-label { width: 220px; flex-shrink: 0; padding: 0 12px; font-size: 12px; color: var(--dhl-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-right: 1px solid var(--dhl-border); }
    .gantt-timeline { flex: 1; position: relative; height: 100%; }
    .gantt-bar { position: absolute; height: 14px; top: 50%; transform: translateY(-50%); border-radius: 2px; }
    .gantt-bar-tender { background: #3b82f6; opacity: 0.85; }
    .gantt-bar-delivery { background: #22c55e; opacity: 0.85; }
    .gantt-header-row { display: flex; background: var(--dhl-dark); }
    .gantt-header-label { width: 220px; flex-shrink: 0; padding: 8px 12px; font-size: 10px; font-weight: 700; color: var(--dhl-yellow); text-transform: uppercase; border-right: 1px solid #333; }
    .gantt-month { flex: 1; padding: 8px 4px; font-size: 10px; font-weight: 700; color: var(--dhl-yellow); text-align: center; border-right: 1px solid #333; }

    /* Progress bar */
    .progress-bar { height: 8px; background: var(--dhl-border); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--dhl-yellow); border-radius: 4px; transition: width 0.3s; }
    .progress-fill.over { background: var(--dhl-red); }

    /* Login screen */

    /* Scrollable table wrapper */
    .table-scroll { overflow-x: auto; overflow-y: auto; max-height: calc(100vh - 230px); }

    /* Testing status badges */
    .status-PASS { background: #d1fae5; color: #065f46; }
    .status-DEFECT { background: #fee2e2; color: #991b1b; }
    .status-WIP { background: #dbeafe; color: #1e40af; }
    .status-NA { background: #f3f4f6; color: #4b5563; }
    .status-NOT-STARTED { background: #fef9c3; color: #854d0e; }
    .severity-Critical { background: #fee2e2; color: #991b1b; }
    .severity-High { background: #ffedd5; color: #9a3412; }
    .severity-Medium { background: #fff3cd; color: #856404; }
    .severity-Low { background: #f3f4f6; color: #4b5563; }

    /* Deadline badge color */
    .deadline-urgent { color: var(--dhl-red); font-weight: 700; }
    .deadline-soon { color: #d97706; font-weight: 600; }

    /* Column resize handle */
    .data-table th { position: relative; user-select: none; }
    .col-resize-handle {
      position: absolute; right: 0; top: 0; bottom: 0; width: 5px;
      cursor: col-resize; z-index: 5; background: transparent;
    }
    .col-resize-handle:hover { background: rgba(255,204,0,0.6); }
    .col-resize-handle.resizing { background: var(--dhl-yellow); }

    /* Clickable item name */
    .item-name-link { cursor: pointer; text-decoration: none; }
    .item-name-link:hover { color: var(--dhl-red); text-decoration: underline; }

    /* Detail panel */
    .detail-panel {
      position: fixed; right: 0; top: 0; bottom: 0; width: 500px; max-width: 94vw;
      background: white; box-shadow: -6px 0 32px rgba(0,0,0,0.18); z-index: 900;
      display: flex; flex-direction: column; transform: translateX(100%);
      transition: transform 0.24s cubic-bezier(0.4,0,0.2,1);
    }
    .detail-panel.is-open { transform: translateX(0); }
    .detail-panel-header { background: var(--dhl-dark); color: white; padding: 16px 20px; flex-shrink: 0; }
    .detail-panel-body { flex: 1; overflow-y: auto; padding: 20px; }
    .detail-panel-footer { padding: 14px 20px; border-top: 1px solid var(--dhl-border); background: var(--dhl-light); flex-shrink: 0; display: flex; gap: 10px; }

    /* Detail info grid */
    .detail-field { margin-bottom: 10px; }
    .detail-field-label { font-size: 10px; font-weight: 700; color: var(--dhl-grey); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 2px; }
    .detail-field-value { font-size: 13px; color: var(--dhl-dark); }

    /* Comments */
    .comments-section { margin-top: 16px; }
    .comment-bubble { background: #f8f8f8; border-radius: 6px; padding: 10px 12px; margin-bottom: 8px; border-left: 3px solid var(--dhl-yellow); }
    .comment-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .comment-author { font-size: 11px; font-weight: 700; color: var(--dhl-dark); }
    .comment-time { font-size: 10px; color: #aaa; }
    .comment-del { margin-left: auto; background: none; border: none; cursor: pointer; color: #ccc; font-size: 15px; line-height: 1; padding: 0; }
    .comment-del:hover { color: var(--dhl-red); }
    .comment-text { font-size: 13px; color: #333; line-height: 1.4; white-space: pre-wrap; }
    .comment-add { display: flex; gap: 6px; margin-top: 10px; align-items: flex-end; }
    .comment-add textarea { flex: 1; padding: 7px 10px; border: 1px solid var(--dhl-border); border-radius: 4px; font-size: 12px; font-family: inherit; resize: none; outline: none; min-height: 52px; }
    .comment-add textarea:focus { border-color: var(--dhl-yellow); }

    /* ‚îÄ‚îÄ Project Plan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .pp-toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 12px; }
    .pp-toolbar .btn-sm { padding: 5px 12px; font-size: 12px; border-radius: 4px; cursor: pointer; border: 1px solid var(--dhl-border); background: #fff; color: var(--dhl-dark); font-weight: 600; }
    .pp-toolbar .btn-sm:hover { background: var(--dhl-yellow); color: #1a1a1a; }
    .pp-toolbar .btn-sm.active { background: var(--dhl-yellow); color: #1a1a1a; }
    .pp-tree-row { display: flex; align-items: center; padding: 4px 8px; border-bottom: 1px solid #f0f0f0; font-size: 13px; cursor: pointer; transition: background .1s; }
    .pp-tree-row:hover { background: #fafafa; }
    .pp-tree-row.phase { font-weight: 700; background: #f7f7f7; }
    .pp-tree-row.workstream { font-weight: 600; }
    .pp-tree-row.critical { border-left: 3px solid #ef4444; }
    .pp-tree-row.archived-row { opacity: 0.45; text-decoration: line-through; }
    .pp-tree-row .expand-btn { width: 20px; text-align: center; cursor: pointer; user-select: none; color: #999; }
    .pp-tree-row .task-name { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .pp-tree-row .cell { width: 100px; text-align: center; font-size: 12px; flex-shrink: 0; padding: 0 4px; }
    .pp-tree-row .cell-sm { width: 80px; padding: 0 4px; }
    .pp-tree-row .cell-lg { width: 130px; padding: 0 4px; }
    .pp-milestone { color: #d97706; font-weight: 700; }
    .pp-progress-bar { width: 60px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; display: inline-block; vertical-align: middle; }
    .pp-progress-fill { height: 100%; background: #22c55e; border-radius: 3px; transition: width .2s; }
    .pp-header-row { display: flex; align-items: center; padding: 6px 8px; border-bottom: 2px solid var(--dhl-border); font-size: 10px; font-weight: 700; text-transform: uppercase; color: #888; letter-spacing: .3px; }
    .pp-header-row .task-name { flex: 1; min-width: 0; }
    .pp-header-row .cell { width: 100px; text-align: center; flex-shrink: 0; padding: 0 4px; }
    .pp-header-row .cell-sm { width: 80px; text-align: center; flex-shrink: 0; padding: 0 4px; }
    .pp-header-row .cell-lg { width: 130px; text-align: center; flex-shrink: 0; padding: 0 4px; }

    /* ‚îÄ‚îÄ Gantt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .gantt-container { overflow-x: auto; overflow-y: auto; max-height: calc(100vh - 240px); border: 1px solid var(--dhl-border); border-radius: 6px; position: relative; }
    .gantt-header { display: flex; position: sticky; top: 0; z-index: 2; background: #f9fafb; border-bottom: 2px solid var(--dhl-border); }
    .gantt-header .gh-label { flex-shrink: 0; width: 260px; padding: 6px 8px; font-size: 11px; font-weight: 700; color: #666; border-right: 1px solid #e5e7eb; }
    .gantt-header .gh-months { display: flex; }
    .gantt-header .gh-month { text-align: center; font-size: 10px; font-weight: 600; color: #888; padding: 4px 0; border-left: 1px solid #e5e7eb; }
    .gantt-row { display: flex; height: 32px; border-bottom: 1px solid #f0f0f0; }
    .gantt-row:hover { background: #fafafa; }
    .gantt-row .gr-label { flex-shrink: 0; width: 260px; padding: 0 8px; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: flex; align-items: center; gap: 4px; border-right: 1px solid #e5e7eb; }
    .gantt-row .gr-bars { position: relative; flex: 1; height: 32px; }
    .gantt-bar { position: absolute; height: 14px; top: 5px; border-radius: 3px; min-width: 4px; font-size: 9px; color: #fff; display: flex; align-items: center; padding: 0 4px; overflow: hidden; }
    .gantt-bar.normal { background: #3b82f6; }
    .gantt-bar.critical { background: #ef4444; }
    .gantt-bar.done { background: #22c55e; }
    .gantt-bar.not-started { background: #9ca3af; }
    .gantt-bar.baseline { background: transparent; border: 1.5px dashed #6b7280; height: 6px; top: 22px; }
    .gantt-bar .bar-progress { position: absolute; left: 0; top: 0; height: 100%; background: rgba(0,0,0,0.2); border-radius: 3px 0 0 3px; }
    .gantt-milestone { position: absolute; width: 10px; height: 10px; top: 7px; background: #d97706; transform: rotate(45deg); border-radius: 2px; }
    .gantt-today { position: absolute; top: 0; bottom: 0; width: 2px; background: #ef4444; z-index: 1; }
    .gantt-dep-line { stroke: #6b7280; stroke-width: 1.2; fill: none; marker-end: url(#arrowhead); }

    /* ‚îÄ‚îÄ Kanban ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .kb-board { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 12px; min-height: calc(100vh - 200px); align-items: flex-start; }
    .kb-col { min-width: 280px; max-width: 320px; flex-shrink: 0; background: #f3f4f6; border-radius: 8px; display: flex; flex-direction: column; max-height: calc(100vh - 210px); }
    .kb-col-header { padding: 10px 12px; font-weight: 700; font-size: 13px; display: flex; align-items: center; gap: 8px; border-bottom: 3px solid; border-radius: 8px 8px 0 0; }
    .kb-col-header .kb-count { font-size: 11px; font-weight: 400; color: #888; }
    .kb-col-header .kb-wip-warn { color: #ef4444; font-size: 10px; font-weight: 700; }
    .kb-col-body { flex: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 6px; min-height: 60px; }
    .kb-col-body.drag-over { background: rgba(59,130,246,0.08); border-radius: 0 0 8px 8px; }
    .kb-card { background: #fff; border-radius: 6px; padding: 10px 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); cursor: grab; border-left: 3px solid transparent; transition: box-shadow .15s, transform .1s; }
    .kb-card:hover { box-shadow: 0 3px 8px rgba(0,0,0,0.12); }
    .kb-card:active { cursor: grabbing; transform: scale(0.98); }
    .kb-card.critical { border-left-color: #ef4444; }
    .kb-card.milestone { border-left-color: #d97706; }
    .kb-card .kb-card-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
    .kb-card .kb-card-meta { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #888; }
    .kb-card .kb-card-meta .kb-owner { background: var(--dhl-yellow); color: #1a1a1a; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; }
    .kb-card .kb-card-progress { margin-top: 6px; }
    .kb-quick-add { padding: 8px; }
    .kb-quick-add input { width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; outline: none; }
    .kb-quick-add input:focus { border-color: var(--dhl-yellow); }

  </style>
</head>
<body x-data="app()" x-init="init()" x-cloak>

<!-- COMPANY BLOCKED SCREEN -->
<div x-show="companyBlocked" class="login-screen" style="z-index:9998">
  <div style="background:#fff;border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,0.12);padding:40px 48px;width:440px;text-align:center">
    <div style="font-size:48px;margin-bottom:16px">üîí</div>
    <h2 style="font-size:20px;font-weight:700;margin-bottom:8px" x-text="t('trialExpiredTitle')"></h2>
    <p style="color:#666;font-size:14px;margin-bottom:20px" x-text="t('trialBlockedMsg')"></p>
    <p style="font-size:13px;color:#888"><span x-text="t('contactUs')"></span> <strong>podpora@pmtool.cz</strong></p>
    <button @click="logout()" style="margin-top:16px;background:#e5e7eb;border:none;border-radius:6px;padding:8px 20px;font-size:13px;cursor:pointer" x-text="t('logoutShort')"></button>
  </div>
</div>

<!-- LOGIN / PROJECT PICKER SCREEN -->
<div x-show="!token || !activeProjectId" class="login-screen">
  <div :style="loginStep === 'register' ? 'width:580px' : 'width:400px'"
    style="background:#fff;border-radius:18px;box-shadow:0 10px 50px rgba(0,0,0,0.12),0 2px 8px rgba(0,0,0,0.06);padding:40px 48px;max-width:95vw;transition:width .3s">

    <!-- F√ÅZE 1: P≈ôihla≈°ovac√≠ formul√°≈ô -->
    <div x-show="loginStep === 'credentials'">
      <div style="text-align:center;margin-bottom:32px">
        <div style="width:60px;height:60px;background:linear-gradient(135deg,#2563eb,#1d4ed8);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:28px;box-shadow:0 4px 12px rgba(37,99,235,0.25)">üóÇÔ∏è</div>
        <div style="font-size:24px;font-weight:800;color:#1a1a1a;letter-spacing:-0.3px">PM Tool</div>
        <div style="font-size:14px;color:#64748b;margin-top:4px" x-text="t('loginPrompt')"></div>
      </div>
      <form @submit.prevent="login()">
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:12px;font-weight:600;color:#444;margin-bottom:5px" x-text="t('emailLabel')"></label>
          <input type="text" x-model="loginForm.email" required autocomplete="username"
            style="width:100%;box-sizing:border-box;border:1.5px solid #d1d5db;border-radius:10px;padding:11px 14px;font-size:14px;outline:none;transition:border-color .15s"
            onfocus="this.style.borderColor='#2563eb';this.style.boxShadow='0 0 0 3px rgba(37,99,235,0.08)'" onblur="this.style.borderColor='#d1d5db';this.style.boxShadow='none'"
            placeholder="admin@local">
        </div>
        <div style="margin-bottom:24px">
          <label style="display:block;font-size:12px;font-weight:600;color:#444;margin-bottom:5px" x-text="t('passwordLabel')"></label>
          <input type="password" x-model="loginForm.password" required autocomplete="current-password"
            style="width:100%;box-sizing:border-box;border:1.5px solid #d1d5db;border-radius:10px;padding:11px 14px;font-size:14px;outline:none;transition:border-color .15s"
            onfocus="this.style.borderColor='#2563eb';this.style.boxShadow='0 0 0 3px rgba(37,99,235,0.08)'" onblur="this.style.borderColor='#d1d5db';this.style.boxShadow='none'"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <div x-show="loginForm.error" x-text="loginForm.error"
          style="background:#fef2f2;border:1px solid #fca5a5;color:#dc2626;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:16px"></div>
        <button type="submit" :disabled="loginForm.loading" class="btn-login">
          <span x-show="!loginForm.loading" x-text="t('loginBtn')"></span>
          <span x-show="loginForm.loading" x-text="t('verifying')"></span>
        </button>
        <div style="text-align:center;margin-top:16px">
          <span style="font-size:13px;color:#94a3b8" x-text="t('noAccount')"></span>
          <a href="#" @click.prevent="loginStep = 'register'; loadPublicPlans()"
            style="display:inline-block;margin-left:6px;font-size:13px;color:#2563eb;font-weight:700;text-decoration:none;background:#eff6ff;padding:4px 14px;border-radius:6px;border:1px solid #bfdbfe;transition:all .15s"
            onmouseover="this.style.background='#dbeafe';this.style.borderColor='#93c5fd'" onmouseout="this.style.background='#eff6ff';this.style.borderColor='#bfdbfe'" x-text="t('registerLink')"></a>
        </div>
      </form>
    </div>

    <!-- F√ÅZE 2: V√Ωbƒõr projektu (po p≈ôihl√°≈°en√≠) -->
    <div x-show="loginStep === 'projects'">
      <div style="text-align:center;margin-bottom:24px">
        <div style="width:56px;height:56px;background:var(--dhl-accent,#FFCC00);border-radius:14px;display:flex;align-items:center;justify-content:center;margin:0 auto 14px;font-size:26px">üìÅ</div>
        <div style="font-size:20px;font-weight:700;color:#1a1a1a" x-text="t('selectProject')"></div>
        <div style="font-size:13px;color:#666;margin-top:4px">
          <span x-text="t('loggedInAs')"></span> <strong x-text="authUser?.name"></strong>
        </div>
      </div>

      <template x-for="p in projects" :key="p.id">
        <button @click="selectProject(p.id)"
          style="display:block;width:100%;text-align:left;padding:14px 18px;margin-bottom:8px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;background:#fff;transition:all .15s"
          onmouseover="this.style.borderColor='var(--dhl-accent,#FFCC00)';this.style.background='#fffbeb'"
          onmouseout="this.style.borderColor='#e5e7eb';this.style.background='#fff'">
          <span style="margin-right:10px">üìÅ</span>
          <span x-text="p.name"></span>
          <span x-show="authUser?.role === 'superadmin' && p.companyName" x-text="' ‚Äî ' + (p.companyName || '')" style="font-size:11px;color:#aaa;font-weight:400"></span>
          <span style="float:right;font-size:12px;color:#aaa">‚Üí</span>
        </button>
      </template>

      <div x-show="projects.length === 0"
        style="text-align:center;color:#999;padding:20px 0;font-size:13px;background:#f9fafb;border-radius:8px;border:1px solid #e5e7eb">
        <span x-text="t('noProjectsAssigned')"></span><br>
        <span style="font-size:12px" x-text="t('contactAdmin')"></span>
      </div>

      <button @click="logout()"
        style="width:100%;margin-top:12px;padding:8px;color:#888;font-size:12px;background:none;border:1px solid #e5e7eb;border-radius:6px;cursor:pointer;transition:background .15s"
        onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='none'"
        x-text="t('logoutOtherAccount')">
      </button>
    </div>

    <!-- F√ÅZE 3: Registrace nov√© firmy -->
    <div x-show="loginStep === 'register'" style="width:520px;max-width:95vw">
      <form @submit.prevent="register()">
      <div style="text-align:center;margin-bottom:24px">
        <div style="font-size:24px;font-weight:800;color:#1a1a1a" x-text="t('createAccount')"></div>
        <div style="font-size:13px;color:#888;margin-top:4px" x-text="t('trialOffer')"></div>
      </div>

      <!-- Plan cards -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:20px">
        <template x-for="pl in publicPlans" :key="pl.slug">
          <div @click="registerForm.planSlug = pl.slug"
            :class="{'plan-card-active-blue': registerForm.planSlug === pl.slug && pl.slug !== 'individual', 'plan-card-active-purple': registerForm.planSlug === pl.slug && pl.slug === 'individual'}"
            style="border:2px solid #e5e7eb;border-radius:14px;padding:18px 14px 16px;cursor:pointer;transition:all .25s ease;text-align:center;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.06)"
            onmouseover="if(!this.classList.contains('plan-card-active-blue')&&!this.classList.contains('plan-card-active-purple')){this.style.borderColor='#cbd5e1';this.style.boxShadow='0 4px 16px rgba(0,0,0,0.1)';this.style.transform='translateY(-2px)'}"
            onmouseout="if(!this.classList.contains('plan-card-active-blue')&&!this.classList.contains('plan-card-active-purple')){this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 4px rgba(0,0,0,0.06)';this.style.transform='none'}">
            <template x-if="pl.slug === 'advanced'">
              <div style="display:inline-block;background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;font-size:9px;font-weight:700;padding:3px 12px;border-radius:10px;letter-spacing:0.5px;margin-bottom:8px" x-text="t('mostPopular')"></div>
            </template>
            <div style="width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:20px"
              :style="pl.slug === 'start' ? 'background:#dbeafe' : pl.slug === 'advanced' ? 'background:#eff6ff' : 'background:#f3e8ff'">
              <span x-text="pl.slug === 'start' ? 'üöÄ' : pl.slug === 'advanced' ? '‚ö°' : 'üéØ'"></span>
            </div>
            <div style="font-size:16px;font-weight:800;margin-bottom:4px;color:#1a1a1a" x-text="pl.name"></div>
            <div x-show="pl.slug !== 'individual'">
              <span style="font-size:26px;font-weight:800;color:#2563eb;line-height:1" x-text="pl.priceMonthly"></span>
              <span style="font-size:14px;font-weight:600;color:#2563eb" x-text="' ' + t('czk')"></span>
              <div style="font-size:11px;color:#94a3b8;margin-bottom:10px" x-text="t('perMonth')"></div>
            </div>
            <div x-show="pl.slug === 'individual'" style="font-size:20px;font-weight:700;color:#7c3aed;margin-bottom:10px;line-height:1.4" x-text="t('customPlan')"></div>
            <div style="font-size:12px;color:#64748b;line-height:1.7;text-align:left;padding:0 4px">
              <template x-if="pl.slug === 'start'">
                <div>
                  <div style="display:flex;align-items:center;gap:6px"><span style="color:#22c55e;font-weight:700">‚úì</span> <span x-text="t('planStart1')"></span></div>
                  <div style="display:flex;align-items:center;gap:6px"><span style="color:#22c55e;font-weight:700">‚úì</span> <span x-text="t('planStart2')"></span></div>
                  <div style="display:flex;align-items:center;gap:6px"><span style="color:#22c55e;font-weight:700">‚úì</span> <span x-text="t('planStart3')"></span></div>
                </div>
              </template>
              <template x-if="pl.slug === 'advanced'">
                <div>
                  <div style="display:flex;align-items:center;gap:6px"><span style="color:#22c55e;font-weight:700">‚úì</span> <span x-text="t('planAdvanced1')"></span></div>
                  <div style="display:flex;align-items:center;gap:6px"><span style="color:#22c55e;font-weight:700">‚úì</span> <span x-text="t('planAdvanced2')"></span></div>
                  <div style="display:flex;align-items:center;gap:6px"><span style="color:#22c55e;font-weight:700">‚úì</span> <span x-text="t('planAdvanced3')"></span></div>
                </div>
              </template>
              <template x-if="pl.slug === 'individual'">
                <div>
                  <div style="display:flex;align-items:center;gap:6px"><span style="color:#7c3aed;font-weight:700">‚úì</span> <span x-text="t('planIndividual1')"></span></div>
                  <div style="display:flex;align-items:center;gap:6px"><span style="color:#7c3aed;font-weight:700">‚úì</span> <span x-text="t('planIndividual2')"></span></div>
                  <div style="display:flex;align-items:center;gap:6px"><span style="color:#7c3aed;font-weight:700">‚úì</span> <span x-text="t('planIndividual3')"></span></div>
                </div>
              </template>
            </div>
          </div>
        </template>
      </div>

      <!-- Form fields -->
      <div style="margin-bottom:10px">
        <label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px" x-text="t('companyNameLabel')"></label>
        <input x-model="registerForm.companyName" @input="registerForm.companySlug = registerForm.companyName.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'')"
          style="width:100%;box-sizing:border-box;border:1px solid #d1d5db;border-radius:8px;padding:10px 14px;font-size:14px;outline:none;transition:border-color .15s"
          onfocus="this.style.borderColor='#2563eb'" onblur="this.style.borderColor='#d1d5db'"
          :placeholder="t('companyPlaceholder')">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
        <div>
          <label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px" x-text="t('yourName')"></label>
          <input x-model="registerForm.userName"
            style="width:100%;box-sizing:border-box;border:1px solid #d1d5db;border-radius:8px;padding:10px 14px;font-size:14px;outline:none;transition:border-color .15s"
            onfocus="this.style.borderColor='#2563eb'" onblur="this.style.borderColor='#d1d5db'"
            :placeholder="t('namePlaceholder')">
        </div>
        <div>
          <label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px" x-text="t('emailLabel')"></label>
          <input x-model="registerForm.userEmail"
            style="width:100%;box-sizing:border-box;border:1px solid #d1d5db;border-radius:8px;padding:10px 14px;font-size:14px;outline:none;transition:border-color .15s"
            onfocus="this.style.borderColor='#2563eb'" onblur="this.style.borderColor='#d1d5db'"
            :placeholder="t('emailPlaceholder')">
        </div>
      </div>
      <div style="margin-bottom:6px">
        <label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px" x-text="t('passwordLabel')"></label>
        <input type="password" x-model="registerForm.userPassword"
          style="width:100%;box-sizing:border-box;border:1px solid #d1d5db;border-radius:8px;padding:10px 14px;font-size:14px;outline:none;transition:border-color .15s"
          onfocus="this.style.borderColor='#2563eb'" onblur="this.style.borderColor='#d1d5db'"
          :placeholder="t('minChars')">
      </div>
      <div style="font-size:11px;color:#999;margin-bottom:14px" x-text="t('passwordHint')"></div>

      <!-- CAPTCHA -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px 14px">
        <div style="flex:1">
          <div style="font-size:11px;font-weight:600;color:#64748b;margin-bottom:3px" x-text="t('verification')"></div>
          <div style="font-size:15px;font-weight:700;color:#1e293b" x-text="registerForm.captchaQuestion || 'Naƒç√≠t√°m‚Ä¶'"></div>
        </div>
        <input type="number" x-model.number="registerForm.captchaAnswer" placeholder="?"
          style="width:70px;box-sizing:border-box;border:1.5px solid #d1d5db;border-radius:8px;padding:8px 10px;font-size:16px;font-weight:700;text-align:center;outline:none"
          onfocus="this.style.borderColor='#2563eb'" onblur="this.style.borderColor='#d1d5db'">
      </div>

      <div x-show="registerForm.error" x-text="registerForm.error"
        style="background:#fef2f2;border:1px solid #fca5a5;color:#dc2626;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:12px"></div>

      <div x-show="registerForm.success" x-text="registerForm.success"
        style="background:#dcfce7;border:1px solid #86efac;color:#166534;border-radius:8px;padding:14px;font-size:14px;margin-bottom:12px;text-align:center;font-weight:600"></div>

      <button type="submit" :disabled="registerForm.loading" x-show="!registerForm.success" class="btn-register">
        <span x-show="!registerForm.loading" x-text="registerForm.planSlug === 'individual' ? t('registerBtnIndividual') : t('registerBtn')"></span>
        <span x-show="registerForm.loading" x-text="t('creatingAccount')"></span>
      </button>

      <button type="button" @click="loginStep = 'credentials'; registerForm.success = ''"
        style="width:100%;margin-top:10px;padding:10px;color:#666;font-size:13px;background:none;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:background .15s"
        onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='none'"
        x-text="t('backToLogin')">
      </button>
      </form>
    </div>

  </div>
</div>

<div x-show="token && activeProjectId" class="flex" style="height: 100vh;">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo" :style="'background:' + logoBgColor">
      <div class="logo-sub" style="font-size:18px;margin-bottom:2px" x-text="t('yourLogo')"></div>
      <div x-show="projectName" class="logo-date" style="font-size:11px;font-weight:700;color:#1a1a1a;margin-top:1px" x-text="projectName"></div>
      <div class="logo-date" x-text="new Date().toLocaleDateString(lang === 'en' ? 'en-GB' : 'cs-CZ', {day:'2-digit',month:'long',year:'numeric'})"></div>
    </div>

    <!-- Project switcher -->
    <div x-show="projects.length > 1" @click="activeProjectId = null; loginStep = 'projects'; localStorage.removeItem('bt-project-id')"
      style="padding:10px 14px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.1);background:rgba(0,0,0,0.15);transition:background .15s"
      onmouseover="this.style.background='rgba(0,0,0,0.25)'" onmouseout="this.style.background='rgba(0,0,0,0.15)'">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="font-size:14px">&#128193;</span>
        <span x-text="projects.find(p=>p.id===activeProjectId)?.name || 'Projekt'"
          style="flex:1;font-size:12px;font-weight:600;color:#e0e0e0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></span>
        <span style="font-size:10px;color:#888">&#8964;</span>
      </div>
    </div>

    <div class="nav-section" x-text="t('sectionOverview')"></div>
    <div class="nav-item" :class="{ active: view === 'dashboard' }" @click="view = 'dashboard'; loadDashboard()">
      <span class="nav-icon">üìä</span> <span x-text="t('navDashboard')"></span>
    </div>
    <div class="nav-item" :class="{ active: view === 'gantt' }" @click="view = 'gantt'; renderGantt()">
      <span class="nav-icon">üìÖ</span> <span x-text="t('navTimeline')"></span>
    </div>

    <div class="nav-section" x-show="can('risks','read') || can('issues','read') || can('changes','read') || can('assumptions','read') || can('projectplan','read')" x-text="t('sectionPM')"></div>
    <div x-show="can('projectplan','read')" class="nav-item" :class="{ active: view === 'projectplan' }" @click="view = 'projectplan'; ppTab = 'table'; loadTasks()">
      <span class="nav-icon">üìã</span> <span x-text="t('navProjectPlan')"></span>
    </div>
    <div x-show="can('projectplan','read')" class="nav-item" :class="{ active: view === 'kanban' }" @click="view = 'kanban'; loadTasks(); loadKanbanColumns()">
      <span class="nav-icon">üìå</span> <span x-text="t('navKanban')"></span>
    </div>
    <div x-show="can('risks','read')" class="nav-item" :class="{ active: view === 'risks' }" @click="view = 'risks'; loadRisks()">
      <span class="nav-icon">‚ö†Ô∏è</span> <span x-text="t('navRisks')"></span>
    </div>
    <div x-show="can('issues','read')" class="nav-item" :class="{ active: view === 'issues' }" @click="view = 'issues'; loadIssues()">
      <span class="nav-icon">üêõ</span> <span x-text="t('navIssues')"></span>
    </div>
    <div x-show="can('changes','read')" class="nav-item" :class="{ active: view === 'changes' }" @click="view = 'changes'; loadChanges()">
      <span class="nav-icon">üîÑ</span> <span x-text="t('navChanges')"></span>
    </div>
    <div x-show="can('assumptions','read')" class="nav-item" :class="{ active: view === 'assumptions' }" @click="view = 'assumptions'; loadAssumptions()">
      <span class="nav-icon">üìù</span> <span x-text="t('navAssumptions')"></span>
    </div>

    <div class="nav-section" x-show="can('assets','read') || can('labor','read')" x-text="t('sectionImpl')"></div>
    <div x-show="can('assets','read') || can('labor','read')" class="nav-item" :class="{ active: view === 'assets' || view === 'labor' }" @click="view = 'assets'; assetsSubTab = can('assets','read') ? 'items' : 'labor'; if(assetsSubTab==='items'){loadItems();$nextTick(()=>restoreColWidths())}else{loadLabor().then(()=>$nextTick(()=>renderLaborChart()))}">
      <span class="nav-icon">üìã</span> <span x-text="t('navAssets')"></span>
    </div>
    <div x-show="can('testing','read')" class="nav-item" :class="{ active: view === 'testing' }" @click="view = 'testing'; testingTab='stats'; loadTestSets().then(() => { loadTestStats(); $nextTick(() => { testSets.forEach(ts => { if (ts.dateMin && ts.dateMax) renderWaterfall(ts) }); renderSetPieCharts() }) })">
      <span class="nav-icon">üß™</span> <span x-text="t('navTesting')"></span>
    </div>

    <div class="nav-section" x-text="t('sectionSolution')"></div>
    <div class="nav-item" :class="{ active: view === 'pallet-calc' }" @click="view = 'pallet-calc'">
      <span class="nav-icon">üì¶</span> <span x-text="t('navStorage')"></span>
    </div>

    <div x-show="authUser?.role === 'admin' || authUser?.role === 'superadmin'" class="nav-section" x-text="t('sectionConfig')"></div>
    <div x-show="authUser?.role === 'admin' || authUser?.role === 'superadmin'" class="nav-item" :class="{ active: view === 'settings' }" @click="view = 'settings'; settingsTab = 'people'; loadSettings()">
      <span class="nav-icon">‚öôÔ∏è</span> <span x-text="t('navSettings')"></span>
    </div>

    <div style="padding: 16px 20px; margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1);text-align:center">
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:10px;text-align:center" x-show="authUser">
        <div style="width:32px;height:32px;border-radius:50%;background:var(--dhl-accent,#FFCC00);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#1a1a1a;margin:0 auto"
          x-text="(authUser?.name || 'A').charAt(0).toUpperCase()"></div>
        <div style="text-align:center">
          <div style="font-size:12px;font-weight:600;color:#f0f0f0" x-text="authUser?.name"></div>
          <div x-show="authUser?.role === 'superadmin'" style="font-size:10px;background:#7c3aed;color:#fff;padding:1px 8px;border-radius:10px;font-weight:700;letter-spacing:.5px;display:inline-block">SUPER</div>
          <div x-show="authUser?.role === 'admin'" style="font-size:10px;color:#aaa;text-transform:uppercase;letter-spacing:.5px">ADMIN</div>
          <div x-show="authUser?.role === 'user'" style="font-size:10px;color:#aaa;text-transform:uppercase;letter-spacing:.5px" x-text="authUser?.companyName || 'USER'"></div>
        </div>
      </div>
      <button @click="logout()" style="width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);color:#ccc;border-radius:6px;padding:6px;font-size:11px;cursor:pointer;transition:background .15s"
        onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'"
        x-text="t('logoutBtn')">
      </button>
      <button @click="supportModal = { show: true, subject: '', message: '', sending: false, success: false, error: '' }"
        style="display:block;width:100%;background:none;border:none;text-align:center;color:#888;font-size:10px;margin-top:6px;cursor:pointer;transition:color .15s;padding:0"
        onmouseover="this.style.color='#bbb'" onmouseout="this.style.color='#888'"
        x-text="t('contactSupport')">
      </button>
      <div style="font-size:10px;color:#666;line-height:1.6;margin-top:8px">
        <span style="color: var(--dhl-yellow)">‚óè</span> <span x-text="t('appVersion')"></span>
      </div>
    </div>
  </aside>

  <!-- SUPPORT MODAL -->
  <div class="modal-overlay" x-show="supportModal.show" @click.self="supportModal.show = false" x-transition style="z-index:2000">
    <div class="chart-card" style="width:100%;max-width:520px;margin-top:60px" @click.stop>
      <div style="padding:24px">
        <!-- Header -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
          <h3 style="font-weight:700;font-size:16px;margin:0" x-text="t('supportTitle')"></h3>
          <button @click="supportModal.show = false" style="background:none;border:none;font-size:20px;cursor:pointer;color:#999;padding:0;line-height:1">&times;</button>
        </div>

        <!-- Success message -->
        <div x-show="supportModal.success" style="background:#ECFDF5;border:1px solid #6EE7B7;border-radius:8px;padding:16px;text-align:center">
          <div style="font-size:28px;margin-bottom:8px">&#10004;</div>
          <p style="color:#065F46;font-weight:600;font-size:14px;margin:0" x-text="t('supportSuccess')"></p>
          <button @click="supportModal.show = false" class="btn-primary" style="margin-top:16px;padding:8px 24px;font-size:13px" x-text="t('supportClose')"></button>
        </div>

        <!-- Form -->
        <form x-show="!supportModal.success" @submit.prevent="submitSupport()" style="display:flex;flex-direction:column;gap:14px">
          <div class="form-group">
            <label class="form-label" x-text="t('supportSubject')"></label>
            <input type="text" class="form-input" x-model="supportModal.subject" :placeholder="t('supportSubjectPlaceholder')" required maxlength="200">
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('supportMessage')"></label>
            <textarea class="form-input" x-model="supportModal.message" :placeholder="t('supportMessagePlaceholder')" required rows="5" maxlength="5000" style="resize:vertical;min-height:100px"></textarea>
          </div>
          <div x-show="supportModal.error" style="background:#FEF2F2;border:1px solid #FCA5A5;border-radius:6px;padding:10px;color:#991B1B;font-size:13px" x-text="t('supportError')"></div>
          <button type="submit" class="btn-primary" style="padding:10px;font-size:14px;font-weight:600" :disabled="supportModal.sending">
            <span x-show="!supportModal.sending" x-text="t('supportSend')"></span>
            <span x-show="supportModal.sending" x-text="t('supportSending')"></span>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="flex-1 flex flex-col" style="min-width: 0; height: 100vh; overflow-y: auto;">
    <!-- Trial Banner -->
    <div x-show="companyStatus === 'trial' && trialDaysLeft !== null"
      style="background:#FEF3C7;border-bottom:2px solid #F59E0B;padding:10px 28px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;text-align:center">
      <div>
        <span style="font-weight:700;color:#92400E">‚è∞ <span x-text="t('trialBanner')"></span> <span x-text="trialDaysLeft"></span> <span x-text="t('trialBannerDays')"></span></span>
        <span style="color:#78350F;margin-left:8px" x-text="t('trialBannerAction')"></span>
      </div>
    </div>

    <!-- TOPBAR -->
    <div class="topbar">
      <div>
        <h1 x-text="viewTitle()"></h1>
        <div class="subtitle" x-text="viewSubtitle()"></div>
      </div>
      <div class="flex gap-2 items-center">
        <template x-if="(view === 'assets' || view === 'labor') && can('assets','read') && can('labor','read')">
          <div style="display:flex;gap:4px;background:#f1f5f9;border-radius:10px;padding:3px">
            <button @click="view='assets'; loadItems(); $nextTick(()=>restoreColWidths())"
              :style="view==='assets' ? 'background:var(--dhl-dark);color:var(--dhl-yellow);box-shadow:0 2px 6px rgba(0,0,0,0.15)' : 'background:transparent;color:#64748b'"
              style="padding:7px 18px;font-size:13px;font-weight:700;border:none;cursor:pointer;border-radius:7px;transition:all .2s">
              <span x-text="t('assetListBtn')"></span>
            </button>
            <button @click="view='labor'; loadLabor().then(()=>$nextTick(()=>renderLaborChart()))"
              :style="view==='labor' ? 'background:var(--dhl-dark);color:var(--dhl-yellow);box-shadow:0 2px 6px rgba(0,0,0,0.15)' : 'background:transparent;color:#64748b'"
              style="padding:7px 18px;font-size:13px;font-weight:700;border:none;cursor:pointer;border-radius:7px;transition:all .2s">
              <span x-text="t('hrCostsBtn')"></span>
            </button>
          </div>
        </template>
        <template x-if="view === 'assets' && can('assets','write')">
          <button class="btn-primary" @click="openNewItem()">
            <span x-text="t('addItem')"></span>
          </button>
        </template>
        <template x-if="view === 'dashboard'">
          <div class="flex gap-2">
            <button class="btn-ghost btn-sm" @click="exportDashboardPDF()"
              style="border:1px solid #ddd;font-weight:600;display:flex;align-items:center;gap:4px">
              <span x-text="t('exportPdf')"></span>
            </button>
            <button class="btn-primary btn-sm" @click="exportAllPDF()"
              style="display:flex;align-items:center;gap:4px">
              <span x-text="t('exportAll')"></span>
            </button>
          </div>
        </template>
        <template x-if="view === 'gantt'">
          <button class="btn-ghost btn-sm" @click="exportGanttPDF()"
            style="border:1px solid #ddd;font-weight:600;display:flex;align-items:center;gap:4px"
            x-text="t('exportPdf')"
          </button>
        </template>
        <template x-if="view === 'testing' && testingTab === 'stats'">
          <button class="btn-ghost btn-sm" @click="exportTestingDashboardPDF()"
            style="border:1px solid #ddd;font-weight:600;display:flex;align-items:center;gap:4px"
            x-text="t('exportPdf')"
          </button>
        </template>
        <template x-if="view === 'risks'">
          <div class="flex gap-2">
            <button class="btn-ghost btn-sm" @click="exportRisksPDF()"
              style="border:1px solid #ddd;font-weight:600;display:flex;align-items:center;gap:4px" x-text="t('exportPdf')"></button>
            <button x-show="can('risks','write')" class="btn-primary" @click="openNewRisk()" x-text="t('newRisk')"></button>
          </div>
        </template>
        <template x-if="view === 'issues'">
          <div class="flex gap-2">
            <button class="btn-ghost btn-sm" @click="exportIssuesPDF()"
              style="border:1px solid #ddd;font-weight:600;display:flex;align-items:center;gap:4px" x-text="t('exportPdf')"></button>
            <button x-show="can('issues','write')" class="btn-primary" @click="openNewIssue()" x-text="t('newIssue')"></button>
          </div>
        </template>
        <template x-if="view === 'changes'">
          <div class="flex gap-2">
            <button class="btn-ghost btn-sm" @click="exportChangesPDF()"
              style="border:1px solid #ddd;font-weight:600;display:flex;align-items:center;gap:4px" x-text="t('exportPdf')"></button>
            <button x-show="can('changes','write')" class="btn-primary" @click="openNewChange()" x-text="t('newChange')"></button>
          </div>
        </template>
        <template x-if="view === 'assumptions'">
          <div class="flex gap-2">
            <button class="btn-ghost btn-sm" @click="exportAssumptionsPDF()"
              style="border:1px solid #ddd;font-weight:600;display:flex;align-items:center;gap:4px" x-text="t('exportPdf')"></button>
            <button x-show="can('assumptions','write')" class="btn-primary" @click="openNewAssumption()" x-text="t('newAssumption')"></button>
          </div>
        </template>
        <!-- Currency toggle (hidden when eurRate=0) -->
        <template x-if="eurRate > 0">
          <span class="text-xs text-gray-400" style="white-space:nowrap"
            :style="currency !== 'EUR' ? 'visibility:hidden' : ''"
            x-text="'@ ' + eurRate + ' CZK'"></span>
        </template>
        <template x-if="eurRate > 0">
          <button
            @click="currency = currency === 'CZK' ? 'EUR' : 'CZK'"
            style="height:32px;padding:0 14px;border:1px solid #ddd;border-radius:16px;cursor:pointer;font-size:12px;font-weight:700;background:white;color:#333;display:flex;align-items:center;gap:6px;white-space:nowrap">
            <span x-text="currency"></span>
            <span style="color:#bbb;font-size:14px;line-height:1">‚áÑ</span>
            <span style="color:#aaa" x-text="currency === 'CZK' ? 'EUR' : 'CZK'"></span>
          </button>
        </template>
        <template x-if="eurRate <= 0">
          <span class="text-xs text-gray-400" :title="t('exchangeRate')" style="padding:4px 10px;border:1px solid #eee;border-radius:12px;background:#fafafa">CZK</span>
        </template>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- DASHBOARD VIEW -->
    <!-- ============================================================ -->
    <div x-show="view === 'dashboard'" class="p-6 space-y-6">
      <!-- KPI Row -->
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
        <div class="kpi-card" data-click @click="view='assets'; loadItems()">
          <div class="kpi-label" x-text="t('assetEstimate')"></div>
          <div class="kpi-value" x-text="fmtMoney(dash.summary?.totalEstimated)"></div>
          <div class="kpi-sub" x-text="(dash.summary?.totalItems ?? 0) + ' ' + t('itemsCapex') + ' ' + fmtMoney(dash.summary?.totalCapex)"></div>
        </div>
        <div class="kpi-card blue" data-click @click="view='assets'; loadItems()">
          <div class="kpi-label" x-text="t('pmPeople')"></div>
          <div class="kpi-value" x-text="fmtMoney(dash.summary?.totalLabor)"></div>
          <div class="kpi-sub" x-text="(dash.laborCosts?.length ?? 0) + ' ' + t('roles')"></div>
        </div>
        <div class="kpi-card" style="--accent:#7c3aed">
          <div class="kpi-label" style="color:var(--dhl-grey)" x-text="t('grandTotal')"></div>
          <div class="kpi-value" style="color:#7c3aed" x-text="fmtMoney(dash.summary?.grandTotal)"></div>
          <div class="kpi-sub" x-text="t('assetsPlusPeople')"></div>
        </div>
        <div class="kpi-card green" data-click @click="view='assets'; loadItems()">
          <div class="kpi-label" x-text="t('spentAssets')"></div>
          <div class="kpi-value" x-text="fmtMoney(dash.summary?.totalActual)"></div>
          <div class="kpi-sub" x-text="(dash.summary?.spentPct ?? 0) + t('pctEstimate')"></div>
        </div>
        <div class="kpi-card" data-click style="--accent:#0ea5e9" @click="view='assets'; loadItems()">
          <div class="kpi-label" style="color:var(--dhl-grey)" x-text="t('spentPeople')"></div>
          <div class="kpi-value" style="color:#0ea5e9" x-text="(dash.summary?.totalLaborSpent ?? 0) > 0 ? fmtMoney(dash.summary?.totalLaborSpent) : '‚Äî'"></div>
          <div class="kpi-sub" x-text="t('actualSpentRoles')"></div>
        </div>
        <div class="kpi-card" data-click :class="(dash.summary?.remaining ?? 0) < 0 ? 'red' : ''" @click="view='assets'; loadItems()">
          <div class="kpi-label" x-text="t('remainingAssets')"></div>
          <div class="kpi-value" :class="(dash.summary?.remaining ?? 0) < 0 ? 'text-red-600' : 'text-green-600'"
            x-text="fmtMoney(dash.summary?.remaining)"></div>
          <div class="kpi-sub" x-text="t('estimateMinusActual')"></div>
        </div>
      </div>

      <!-- Project Plan KPIs -->
      <div x-show="can('projectplan','read') && (dash.summary?.ppTotalTasks ?? 0) > 0">
        <div style="font-size:12px;font-weight:700;color:#666;text-transform:uppercase;margin-bottom:6px;letter-spacing:0.5px" x-text="t('dashPPProgress')"></div>
        <div class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-9 gap-2">
          <!-- 1. Progress (weighted) -->
          <div class="kpi-card" data-click style="padding:10px" @click="view='projectplan'; ppTab='table'; loadTasks()">
            <div class="kpi-label" style="font-size:10px" x-text="t('dashPPProgress')"></div>
            <div class="kpi-value" style="font-size:20px" x-text="(dash.summary?.ppProgressPct ?? 0) + '%'"></div>
            <div class="kpi-sub" style="font-size:10px" x-text="(dash.summary?.ppDoneTasks ?? 0) + '/' + (dash.summary?.ppTotalTasks ?? 0) + ' ‚Äî ' + t('dashPPWeightedProgress')"></div>
          </div>
          <!-- 2. Planned Completion (time + work) -->
          <div class="kpi-card" data-click style="padding:10px" @click="view='projectplan'; ppTab='gantt'; loadTasks()">
            <div class="kpi-label" style="font-size:10px" x-text="t('dashPPPlannedPct')"></div>
            <div class="kpi-value" style="font-size:18px">
              <span x-text="t('dashPPPlannedTime') + ' ' + (dash.summary?.ppPlannedTimePct ?? '‚Äî') + '%'"></span>
            </div>
            <div class="kpi-sub" style="font-size:10px" x-text="t('dashPPPlannedWork') + ' ' + (dash.summary?.ppShouldBeDone ?? 0) + '/' + (dash.summary?.ppTotalTasks ?? 0) + ' ' + t('dashPPShouldBeDone')"></div>
          </div>
          <!-- 3. Overdue -->
          <div class="kpi-card" data-click :class="(dash.summary?.ppOverdueTasks ?? 0) > 0 ? 'red' : 'green'" style="padding:10px"
            @click="view='projectplan'; ppTab='table'; ppFilters={status:'',type:'',ownerId:'',search:''}; $nextTick(() => { ppFilters.status='blocked'; loadTasks() })">
            <div class="kpi-label" style="font-size:10px" x-text="t('dashPPOverdue')"></div>
            <div class="kpi-value" style="font-size:20px" x-text="dash.summary?.ppOverdueTasks ?? 0"></div>
            <div class="kpi-sub" style="font-size:10px" x-text="t('dashPPOverdueSub')"></div>
          </div>
          <!-- 4. Critical path -->
          <div class="kpi-card" data-click style="padding:10px" @click="view='projectplan'; ppTab='gantt'; loadTasks()">
            <div class="kpi-label" style="font-size:10px" x-text="t('dashPPCritical')"></div>
            <div class="kpi-value" style="font-size:20px" x-text="dash.summary?.ppCriticalTasks ?? 0"></div>
            <div class="kpi-sub" style="font-size:10px" x-text="t('dashPPCriticalSub')"></div>
          </div>
          <!-- 5. Schedule variance -->
          <div class="kpi-card" data-click style="padding:10px" :class="(dash.summary?.ppScheduleVarianceDays ?? 0) > 0 ? 'red' : (dash.summary?.ppScheduleVarianceDays ?? 0) < 0 ? 'green' : ''"
            @click="view='projectplan'; ppTab='gantt'; loadTasks()">
            <div class="kpi-label" style="font-size:10px" x-text="t('dashPPScheduleVar')"></div>
            <div class="kpi-value" style="font-size:20px" x-text="dash.summary?.ppScheduleVarianceDays != null ? (dash.summary.ppScheduleVarianceDays > 0 ? '+' : '') + dash.summary.ppScheduleVarianceDays + ' ' + t('dashPPScheduleVarDays') : '‚Äî'"></div>
            <div class="kpi-sub" style="font-size:10px" x-text="dash.summary?.ppScheduleVarianceDays == null ? '' : dash.summary.ppScheduleVarianceDays < 0 ? t('dashPPScheduleVarAhead') : dash.summary.ppScheduleVarianceDays > 0 ? t('dashPPScheduleVarBehind') : t('dashPPScheduleVarOnTrack')"></div>
          </div>
          <!-- 6. Unscheduled -->
          <div class="kpi-card" data-click style="padding:10px" :class="(dash.summary?.ppUnscheduledTasks ?? 0) > 0 ? '' : 'green'"
            @click="view='projectplan'; ppTab='table'; ppFilters={status:'unscheduled',type:'',ownerId:'',search:''}; loadTasks()">
            <div class="kpi-label" style="font-size:10px" x-text="t('dashPPUnscheduled')"></div>
            <div class="kpi-value" style="font-size:20px" x-text="dash.summary?.ppUnscheduledTasks ?? 0"></div>
            <div class="kpi-sub" style="font-size:10px" x-text="t('dashPPUnscheduledSub')"></div>
          </div>
          <!-- 7. Linked risks -->
          <div x-show="can('risks','read')" class="kpi-card" data-click style="padding:10px" :class="(dash.summary?.ppLinkedRisks ?? 0) > 0 ? 'red' : ''"
            @click="view='risks'; loadRisks()">
            <div class="kpi-label" style="font-size:10px" x-text="t('dashPPRisks')"></div>
            <div class="kpi-value" style="font-size:20px" x-text="dash.summary?.ppLinkedRisks ?? 0"></div>
            <div class="kpi-sub" style="font-size:10px" x-text="t('dashPPLinkedRisks')"></div>
          </div>
          <!-- 8. Linked assumptions -->
          <div x-show="can('assumptions','read')" class="kpi-card" data-click style="padding:10px"
            @click="view='assumptions'; loadAssumptions()">
            <div class="kpi-label" style="font-size:10px" x-text="t('dashPPAssumptions')"></div>
            <div class="kpi-value" style="font-size:20px" x-text="dash.summary?.ppLinkedAssumptions ?? 0"></div>
            <div class="kpi-sub" style="font-size:10px" x-text="t('dashPPLinkedAssumptions')"></div>
          </div>
          <!-- 9. Health / On Track indicator -->
          <div class="kpi-card" style="padding:10px"
            :class="dash.summary?.ppHealthStatus === 'critical' ? 'red' : dash.summary?.ppHealthStatus === 'at_risk' ? '' : 'green'">
            <div class="kpi-label" style="font-size:10px" x-text="t('dashPPHealth')"></div>
            <div class="kpi-value" style="font-size:16px" x-text="dash.summary?.ppHealthStatus === 'critical' ? t('dashPPHealthCritical') : dash.summary?.ppHealthStatus === 'at_risk' ? t('dashPPHealthAtRisk') : t('dashPPHealthOnTrack')"></div>
            <div class="kpi-sub" style="font-size:10px" x-text="t('dashPPHealthSub')"></div>
          </div>
        </div>
      </div>

      <!-- Budget progress (actual vs estimated) -->
      <template x-if="(dash.summary?.totalEstimated ?? 0) > 0">
        <div class="chart-card p-4">
          <div class="flex items-center justify-between mb-3">
            <span class="font-bold text-sm" x-text="t('budgetProgress')"></span>
            <span class="text-sm font-bold" :class="(dash.summary.spentPct??0) > 100 ? 'text-red-600' : 'text-green-600'"
              x-text="(dash.summary.spentPct ?? 0) + '%'"></span>
          </div>
          <div class="progress-bar" style="height:12px">
            <div class="progress-fill" :class="{ over: (dash.summary.spentPct??0) > 100 }"
              :style="'width:' + Math.min(dash.summary.spentPct ?? 0, 100) + '%'"></div>
          </div>
          <div class="flex justify-between text-xs text-gray-400 mt-1">
            <span><span x-text="t('spent')"></span> <b x-text="fmtMoney(dash.summary.totalActual)"></b></span>
            <span><span x-text="t('remaining')"></span> <b x-text="fmtMoney(dash.summary.remaining)"></b></span>
          </div>
        </div>
      </template>

      <!-- Charts row 1 -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="chart-card lg:col-span-2">
          <div class="chart-header">
            <span x-text="t('costsByCategory')"></span>
            <span class="text-xs text-gray-400" x-text="t('estimateVsActual')"></span>
          </div>
          <div style="padding:16px;height:260px">
            <canvas id="catChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header"><span x-text="t('tenderStatus')"></span><span class="text-xs text-gray-400">üîç</span></div>
          <div style="padding:16px;height:260px;display:flex;align-items:center;justify-content:center">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Charts row 2 -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="chart-card">
          <div class="chart-header">
            <span x-text="t('workloadTitle')"></span>
            <span class="text-xs text-gray-400" x-text="t('workloadSubtitle')"></span>
          </div>
          <div style="padding:16px;height:220px">
            <canvas id="personChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header"><span x-text="t('priorityTitle')"></span><span class="text-xs text-gray-400">üîç</span></div>
          <div style="padding:16px;height:220px;display:flex;align-items:center;justify-content:center">
            <canvas id="priorityChart"></canvas>
          </div>
        </div>
      </div>

      <!-- PM KPI Row -->
      <div x-show="can('risks','read') || can('issues','read') || can('changes','read')" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
        <div x-show="can('risks','read')" class="kpi-card" data-click :class="(dash.summary?.totalRisks ?? 0) > 0 ? 'red' : ''"
          @click="view='risks'; riskFilters={status:'',category:''}; loadRisks()">
          <div class="kpi-label" x-text="t('totalRisks')"></div>
          <div class="kpi-value" x-text="dash.summary?.totalRisks ?? 0"></div>
          <div class="kpi-sub" x-text="t('exposureScore') + ' ' + (dash.summary?.riskExposure ?? 0)"></div>
        </div>
        <div x-show="can('issues','read')" class="kpi-card" data-click :class="(dash.summary?.highSeverityIssues ?? 0) > 0 ? 'red' : 'green'"
          @click="view='issues'; issueFilters={status:'',severity:'Critical',type:''}; loadIssues()">
          <div class="kpi-label" x-text="t('highCriticalIssues')"></div>
          <div class="kpi-value" x-text="dash.summary?.highSeverityIssues ?? 0"></div>
          <div class="kpi-sub" x-text="t('criticalHigh')"></div>
        </div>
        <div x-show="can('changes','read')" class="kpi-card blue" data-click
          @click="view='changes'; changeFilters={approvalStatus:'Draft',changeType:''}; loadChanges()">
          <div class="kpi-label" x-text="t('pendingChanges')"></div>
          <div class="kpi-value" x-text="dash.summary?.pendingChangeRequests ?? 0"></div>
          <div class="kpi-sub" x-text="t('draftSubmitted')"></div>
        </div>
        <div x-show="can('changes','read')" class="kpi-card" data-click :class="(dash.summary?.budgetImpactSummary ?? 0) > 0 ? 'red' : ''"
          @click="view='changes'; changeFilters={approvalStatus:'Approved',changeType:''}; loadChanges()">
          <div class="kpi-label" x-text="t('budgetImpactCR')"></div>
          <div class="kpi-value" x-text="(dash.summary?.budgetImpactSummary ?? 0) !== 0 ? fmtMoney(dash.summary.budgetImpactSummary) : '‚Äî'"></div>
          <div class="kpi-sub" x-text="t('approvedCR')"></div>
        </div>
        <div x-show="can('risks','read')" class="kpi-card" data-click :class="(dash.summary?.riskExposure ?? 0) >= 20 ? 'red' : (dash.summary?.riskExposure ?? 0) >= 10 ? '' : 'green'"
          @click="view='risks'; riskFilters={status:'Open',category:''}; loadRisks()">
          <div class="kpi-label" x-text="t('riskExposure')"></div>
          <div class="kpi-value" x-text="dash.summary?.riskExposure ?? 0"></div>
          <div class="kpi-sub" x-text="t('openRiskScore')"></div>
        </div>
      </div>

      <!-- Assumption KPI Row -->
      <div x-show="can('assumptions','read')" class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="kpi-card" data-click :class="(dash.summary?.totalAssumptions ?? 0) > 0 ? 'blue' : ''"
          @click="view='assumptions'; assumptionFilters={status:'',category:'',phase:'',validationFilter:''}; loadAssumptions()">
          <div class="kpi-label" x-text="t('totalAssumptions')"></div>
          <div class="kpi-value" x-text="dash.summary?.totalAssumptions ?? 0"></div>
          <div class="kpi-sub" x-text="t('validated') + ' ' + (dash.summary?.validatedPct ?? 0) + ' %'"></div>
        </div>
        <div class="kpi-card" data-click :class="(dash.summary?.overdueAssumptions ?? 0) > 0 ? 'red' : 'green'"
          @click="view='assumptions'; assumptionFilters={status:'',category:'',phase:'',validationFilter:'overdue'}; loadAssumptions()">
          <div class="kpi-label" x-text="t('overdueValidation')"></div>
          <div class="kpi-value" x-text="dash.summary?.overdueAssumptions ?? 0"></div>
          <div class="kpi-sub" x-text="t('activeNoValidation')"></div>
        </div>
        <div class="kpi-card" data-click :class="(dash.summary?.expiringSoon ?? 0) > 0 ? '' : 'green'"
          @click="view='assumptions'; assumptionFilters={status:'',category:'',phase:'',validationFilter:'expiring'}; loadAssumptions()">
          <div class="kpi-label" x-text="t('expiresIn14')"></div>
          <div class="kpi-value" x-text="dash.summary?.expiringSoon ?? 0"></div>
          <div class="kpi-sub" x-text="t('upcomingDeadline')"></div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label" x-text="t('top5Risky')"></div>
          <div style="margin-top:8px">
            <template x-for="a in (dash.top5Assumptions ?? []).slice(0,5)" :key="a.id">
              <div style="display:flex;align-items:center;justify-content:space-between;padding:3px 0;font-size:11px;border-bottom:1px solid #f0f0f0" @click="view='assumptions';loadAssumptions()" style="cursor:pointer">
                <span style="color:#666" x-text="a.code + ' ' + a.title.slice(0,22) + (a.title.length>22?'‚Ä¶':'')"></span>
                <span :style="'background:' + exposureColor(a.exposureScore) + ';color:white;padding:1px 6px;border-radius:10px;font-size:10px;font-weight:700'" x-text="a.exposureScore"></span>
              </div>
            </template>
            <template x-if="!(dash.top5Assumptions?.length)">
              <div style="color:#aaa;font-size:11px;text-align:center;padding:8px 0" x-text="t('noActiveAssumptions')"></div>
            </template>
          </div>
        </div>
      </div>

      <!-- Upcoming deadlines -->
      <div class="chart-card">
        <div class="chart-header">
          <span x-text="t('upcomingDeadlines90')"></span>
          <span class="text-xs text-gray-400" x-text="(dash.upcomingDeadlines?.length ?? 0) + ' ' + t('items')"></span>
        </div>
        <template x-if="!dash.upcomingDeadlines?.length">
          <div class="p-8 text-center text-gray-400 text-sm" x-text="t('noUpcomingDeadlines')"></div>
        </template>
        <template x-if="dash.upcomingDeadlines?.length">
          <div class="table-scroll" style="max-height:280px">
            <table class="data-table">
              <thead>
                <tr>
                  <th x-text="t('colDescription')"></th>
                  <th x-text="t('colCategory')"></th>
                  <th x-text="t('colTenderDeadline')"></th>
                  <th x-text="t('colDeliveryDate')"></th>
                  <th>Status</th>
                  <th x-text="t('colResponsible')"></th>
                  <th x-text="t('colEstimate')"></th>
                </tr>
              </thead>
              <tbody>
                <template x-for="d in dash.upcomingDeadlines" :key="d.id">
                  <tr>
                    <td class="font-medium" x-text="d.description"></td>
                    <td x-text="d.category ?? '‚Äî'"></td>
                    <td :class="deadlineClass(d.tenderDeadline)" x-text="fmtDate(d.tenderDeadline)"></td>
                    <td x-text="fmtDate(d.deliveryDate)"></td>
                    <td><span class="badge" :class="statusBadge(d.tenderStatus)" x-text="d.tenderStatus ?? '‚Äî'"></span></td>
                    <td x-text="d.responsible ?? '‚Äî'"></td>
                    <td x-text="fmtMoney(d.totalEstCost)"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </template>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- ASSET LIST VIEW -->
    <!-- ============================================================ -->
    <div x-show="view === 'assets'" class="flex flex-col" style="height: calc(100vh - 64px)">
      <!-- Filter bar -->
      <div class="filter-bar">
        <input type="text" :placeholder="t('searchPlaceholder')" x-model="filters.search" @input.debounce.300ms="loadItems()" style="width:200px">
        <select x-model="filters.category" @change="loadItems()">
          <option value="" x-text="t('allCategories')"></option>
          <template x-for="c in categories" :key="c.id">
            <option :value="c.name" x-text="c.name"></option>
          </template>
        </select>
        <select x-model="filters.tenderStatus" @change="loadItems()">
          <option value="" x-text="t('allStatuses')"></option>
          <template x-for="s in TENDER_STATUSES" :key="s">
            <option :value="s" x-text="s"></option>
          </template>
        </select>
        <select x-model="filters.responsibleId" @change="loadItems()">
          <option value="" x-text="t('allPeople')"></option>
          <template x-for="p in people" :key="p.id">
            <option :value="p.id" x-text="p.name"></option>
          </template>
        </select>
        <select x-model="filters.priorityId" @change="loadItems()">
          <option value="" x-text="t('allPriorities')"></option>
          <template x-for="p in priorities" :key="p.id">
            <option :value="p.id" x-text="p.name"></option>
          </template>
        </select>
        <label class="flex items-center gap-1 text-xs font-semibold cursor-pointer">
          <input type="checkbox" x-model="filters.capexOnly" @change="loadItems()"> <span x-text="t('capexOnly')"></span>
        </label>
        <button class="btn-ghost btn-sm" @click="clearFilters()" x-text="t('resetFilters')"></button>
        <span class="text-xs text-gray-400 ml-2" x-text="items.length + ' ' + t('items')"></span>
        <div style="flex:1"></div>
        <button class="btn-ghost btn-sm" @click="exportPDF()" title="Exportovat do PDF"
          style="border:1px solid #ddd;font-weight:600;display:flex;align-items:center;gap:5px"
          x-text="t('exportPdf')">
        </button>
      </div>

      <!-- Table -->
      <div class="table-scroll flex-1">
        <table class="data-table" id="assetTable" style="table-layout:fixed">
          <thead>
            <tr>
              <th style="width:210px"><span x-text="t('colDescription')"></span><div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:110px"><span x-text="t('colCategory')"></span><div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:110px"><span x-text="t('colSubcategory')"></span><div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:80px"><span x-text="t('colType')"></span><div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:92px"><span x-text="t('colEstimate')"></span><div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:92px"><span x-text="t('colActual')"></span><div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:82px"><span x-text="t('difference')"></span><div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:56px">CAPEX<div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:130px">Status<div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:96px"><span x-text="t('colPriority')"></span><div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:120px"><span x-text="t('colResponsible')"></span><div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:116px"><span x-text="t('colTenderDeadline')"></span><div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:106px"><span x-text="t('colDeliveryDate')"></span><div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:120px"><span x-text="t('colApproval')"></span><div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:120px"><span x-text="t('colSupplier')"></span><div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:180px"><span x-text="t('lastComment')"></span><div class="col-resize-handle" @mousedown.prevent="startColResize($event, $el)"></div></th>
              <th style="width:52px" x-text="t('auditColAction')"></th>
            </tr>
          </thead>
          <tbody>
            <template x-if="!items.length">
              <tr><td colspan="16" class="text-center py-10 text-gray-400">
                <span x-text="t('noItems')"></span>
              </td></tr>
            </template>
            <template x-for="item in items" :key="item.id">
              <tr>
                <td>
                  <div class="item-name-link font-semibold" style="width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" :title="item.description" x-text="item.description" @click="openDetail(item)"></div>
                  <div x-show="item.bottleneck" class="text-xs text-red-500" style="width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" x-text="'‚ö† ' + item.bottleneck"></div>
                </td>
                <td x-text="item.category ?? '‚Äî'"></td>
                <td x-text="item.subcategory ?? '‚Äî'"></td>
                <td x-text="item.itemType ?? '‚Äî'"></td>
                <td class="font-mono text-right" x-text="fmtMoney(item.totalEstCost)"></td>
                <td class="font-mono text-right" :class="{'text-red-600 font-bold': item.actualPrice > item.totalEstCost}" x-text="fmtMoney(item.actualPrice)"></td>
                <td class="font-mono text-right text-xs">
                  <template x-if="item.actualPrice != null && item.totalEstCost != null">
                    <span :class="(item.actualPrice - item.totalEstCost) > 0 ? 'text-red-600 font-bold' : 'text-green-600 font-semibold'">
                      <span x-text="(item.actualPrice - item.totalEstCost) > 0 ? '‚ñ≤' : '‚ñº'"></span>
                      <span x-text="fmtMoney(Math.abs(item.actualPrice - item.totalEstCost))"></span>
                    </span>
                  </template>
                  <template x-if="item.actualPrice == null || item.totalEstCost == null">
                    <span class="text-gray-300">‚Äî</span>
                  </template>
                </td>
                <td class="text-center">
                  <span x-show="item.capexNeeded" class="badge badge-red">CAPEX</span>
                </td>
                <td>
                  <select class="inline-select" :style="statusStyle(item.tenderStatus)"
                    :disabled="!can('assets','write')"
                    @change="quickPatch(item.id, 'tenderStatus', $event.target.value || null)">
                    <option value="" :selected="!item.tenderStatus" x-text="'‚Äî ' + t('status') + ' ‚Äî'"></option>
                    <template x-for="s in TENDER_STATUSES" :key="s">
                      <option :value="s" :selected="item.tenderStatus === s" x-text="s"></option>
                    </template>
                  </select>
                </td>
                <td>
                  <select class="inline-select"
                    :style="item.priority ? 'background:' + item.priority.color + '20;color:' + item.priority.color : 'background:#f3f4f6;color:#9ca3af'"
                    :disabled="!can('assets','write')"
                    @change="quickPatch(item.id, 'priorityId', $event.target.value ? parseInt($event.target.value) : null)">
                    <option value="" :selected="!item.priorityId" x-text="'‚Äî ' + t('colPriority') + ' ‚Äî'"></option>
                    <template x-for="p in priorities" :key="p.id">
                      <option :value="p.id" :selected="item.priorityId === p.id" x-text="p.name"></option>
                    </template>
                  </select>
                </td>
                <td>
                  <select class="inline-select" style="background:#f3f4f6;color:#1a1a1a;min-width:110px"
                    :disabled="!can('assets','write')"
                    @change="quickPatch(item.id, 'responsibleId', $event.target.value ? parseInt($event.target.value) : null)">
                    <option value="" :selected="!item.responsibleId" x-text="t('unassigned')"></option>
                    <template x-for="p in people" :key="p.id">
                      <option :value="p.id" :selected="item.responsibleId === p.id" x-text="p.name"></option>
                    </template>
                  </select>
                </td>
                <td>
                  <input type="date" class="inline-date" :class="deadlineClass(item.tenderDeadline)"
                    :disabled="!can('assets','write')"
                    :value="isoDate(item.tenderDeadline)"
                    @change="quickPatch(item.id, 'tenderDeadline', $event.target.value || null)">
                </td>
                <td>
                  <input type="date" class="inline-date"
                    :disabled="!can('assets','write')"
                    :value="isoDate(item.deliveryDate)"
                    @change="quickPatch(item.id, 'deliveryDate', $event.target.value || null)">
                </td>
                <td>
                  <select class="inline-select" :style="approvalStyle(item.approval)"
                    :disabled="!can('assets','write')"
                    @change="quickPatch(item.id, 'approval', $event.target.value || null)">
                    <option value="" :selected="!item.approval" x-text="'‚Äî ' + t('colApproval') + ' ‚Äî'"></option>
                    <option :selected="item.approval === 'Approved'">Approved</option>
                    <option :selected="item.approval === 'Pending'">Pending</option>
                    <option :selected="item.approval === 'Rejected'">Rejected</option>
                    <option :selected="item.approval === 'Not Required'">Not Required</option>
                  </select>
                </td>
                <td style="max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" x-text="item.chosenSupplier ?? '‚Äî'"></td>
                <td style="max-width:180px">
                  <template x-if="item.comments && item.comments[0]">
                    <div>
                      <div style="font-size:10px;font-weight:700;color:var(--dhl-grey);white-space:nowrap;overflow:hidden;text-overflow:ellipsis" x-text="item.comments[0].author"></div>
                      <div style="font-size:11px;color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" x-text="item.comments[0].text"></div>
                    </div>
                  </template>
                  <template x-if="!item.comments || !item.comments[0]">
                    <span class="text-gray-300 text-xs">‚Äî</span>
                  </template>
                </td>
                <td>
                  <button x-show="can('assets','write')" class="btn-icon" :title="t('deleteBtn')" @click="deleteItem(item.id)">üóëÔ∏è</button>
                </td>
              </tr>
            </template>
          </tbody>
          <tfoot x-show="items.length">
            <tr style="background:#f9f9f9;font-weight:700;border-top:2px solid #e0e0e0;font-size:12px">
              <td colspan="4" class="px-3 py-2"><span x-text="t('total')"></span> (<span x-text="items.length"></span> <span x-text="t('items')"></span>)</td>
              <td class="font-mono text-right px-3 py-2" x-text="fmtMoney(items.reduce((s,i)=>s+(i.totalEstCost??0),0))"></td>
              <td class="font-mono text-right px-3 py-2" x-text="fmtMoney(items.reduce((s,i)=>s+(i.actualPrice??0),0))"></td>
              <td class="font-mono text-right px-3 py-2">
                <span :class="items.reduce((s,i)=>s+((i.actualPrice??0)-(i.totalEstCost??0)),0) > 0 ? 'text-red-600' : 'text-green-600'"
                  x-text="(items.reduce((s,i)=>s+((i.actualPrice??0)-(i.totalEstCost??0)),0) > 0 ? '‚ñ≤ ' : '‚ñº ') + fmtMoney(Math.abs(items.reduce((s,i)=>s+((i.actualPrice??0)-(i.totalEstCost??0)),0)))">
                </span>
              </td>
              <td colspan="10"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- GANTT VIEW -->
    <!-- ============================================================ -->
    <div x-show="view === 'gantt'" class="p-6">
      <div class="chart-card">
        <div class="chart-header">
          <span x-text="t('ganttTitle')"></span>
          <div class="flex gap-4 text-xs items-center">
            <span class="flex items-center gap-1"><span style="display:inline-block;width:16px;height:10px;background:#3b82f6;border-radius:2px"></span> <span x-text="t('tenderLegend')"></span></span>
            <span class="flex items-center gap-1"><span style="display:inline-block;width:16px;height:10px;background:#22c55e;border-radius:2px"></span> <span x-text="t('deliveryLegend')"></span></span>
            <select x-model="ganttFilter" @change="renderGantt()" class="border border-gray-200 rounded px-2 py-1 text-xs">
              <option value="all" x-text="t('ganttAll')"></option>
              <option value="tender" x-text="t('ganttTender')"></option>
              <option value="delivery" x-text="t('ganttDelivery')"></option>
            </select>
          </div>
        </div>
        <div id="ganttArea" class="gantt-container" style="min-height:200px">
          <div class="text-center text-gray-400 py-12 text-sm" x-text="t('loadingGantt')"></div>
        </div>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- LABOR / PM VIEW -->
    <!-- ============================================================ -->
    <div x-show="view === 'labor'" class="p-6 space-y-6">

      <!-- Summary cards -->
      <div class="grid grid-cols-4 gap-4">
        <div class="kpi-card blue">
          <div class="kpi-label" x-text="t('totalPmPeople')"></div>
          <div class="kpi-value" x-text="fmtMoney(laborTotal())"></div>
          <div class="kpi-sub" x-text="labor.length + ' ' + t('roles')"></div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label" x-text="t('projectRoles')"></div>
          <div class="kpi-value" x-text="(currency, fmtMoney(laborByType('Project')))"></div>
          <div class="kpi-sub" x-text="labor.filter(l => l.costType === 'Project').length + ' ' + t('roles')"></div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label" x-text="t('annualOneOff')"></div>
          <div class="kpi-value" x-text="(currency, fmtMoney(laborByType('Annual') + laborByType('One-off')))"></div>
          <div class="kpi-sub" x-text="labor.filter(l => l.costType !== 'Project').length + ' ' + t('roles')"></div>
        </div>
        <div class="kpi-card green">
          <div class="kpi-label" x-text="t('spentPeopleLabel')"></div>
          <div class="kpi-value" x-text="labor.some(l => l.spent > 0) ? fmtMoney(labor.reduce((s,l) => s + (l.spent||0), 0)) : '‚Äî'"></div>
          <div class="kpi-sub" x-text="labor.filter(l => l.spent > 0).length + ' ' + t('rolesWithSpent')"></div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Table -->
        <div class="chart-card lg:col-span-2">
          <div class="chart-header">
            <span x-text="t('rolesAndCosts')"></span>
            <button x-show="can('labor','write')" class="btn-primary btn-sm" @click="openLaborForm()" x-text="t('addRole')"></button>
          </div>
          <div class="table-scroll" style="max-height:520px">
            <table class="data-table">
              <thead>
                <tr>
                  <th x-text="t('colRole')"></th>
                  <th x-text="t('colPerson')"></th>
                  <th x-text="t('colDepartment')"></th>
                  <th x-text="t('colCostType')"></th>
                  <th class="text-right" x-text="t('colRate') + ' (' + currency + ')'"></th>
                  <th class="text-right" x-text="t('colMD')"></th>
                  <th class="text-right" x-text="t('colTotalPlan')"></th>
                  <th class="text-right" x-text="t('colSpentRole')"></th>
                  <th x-text="t('notesLabel')"></th>
                </tr>
              </thead>
              <tbody>
                <template x-if="!labor.length">
                  <tr><td colspan="9" class="text-center py-10 text-gray-400">
                    <span x-text="t('noLaborRecords')"></span>
                  </td></tr>
                </template>
                <template x-for="lc in labor" :key="lc.id">
                  <tr :class="laborDetail.lc?.id === lc.id ? 'bg-yellow-50' : ''" style="cursor:pointer" @click="openLaborDetail(lc)">
                    <td class="font-semibold" style="color:var(--dhl-red)" x-text="lc.role"></td>
                    <td x-text="lc.personName || '‚Äî'"></td>
                    <td x-text="lc.department || '‚Äî'"></td>
                    <td>
                      <span class="badge"
                        :class="{ 'badge-blue': lc.costType === 'Project', 'badge-yellow': lc.costType === 'Annual', 'badge-grey': lc.costType === 'One-off' }"
                        x-text="lc.costType"></span>
                    </td>
                    <td class="font-mono text-right" x-text="(currency, fmtMoney(lc.mdRate))"></td>
                    <td class="text-right font-semibold" x-text="lc.mdDays + ' MD'"></td>
                    <td class="font-mono text-right font-bold" x-text="(currency, fmtMoney(laborAmount(lc)))"></td>
                    <td class="font-mono text-right font-semibold"
                      :style="lc.spent > laborAmount(lc) ? 'color:#dc2626' : lc.spent > laborAmount(lc) * (laborWarningPct/100) ? 'color:#f97316' : lc.spent > 0 ? 'color:#16a34a' : 'color:#ccc'"
                      x-text="lc.spent > 0 ? fmtMoney(lc.spent) : '‚Äî'"></td>
                    <td class="text-gray-400 text-xs" x-text="lc.notes || '‚Äî'"></td>
                  </tr>
                </template>
              </tbody>
              <tfoot x-show="labor.length">
                <tr style="background:#f9f9f9;font-weight:700;border-top:2px solid #e0e0e0">
                  <td colspan="4" class="px-3 py-2 text-sm" x-text="t('total')"></td>
                  <td class="text-right px-3 py-2 text-gray-400 text-xs" x-text="labor.reduce((s,l)=>s+l.mdDays,0).toFixed(1) + ' MD'"></td>
                  <td class="font-mono text-right px-3 py-2" x-text="fmtMoney(laborTotal())"></td>
                  <td class="font-mono text-right px-3 py-2 text-green-700" x-text="labor.some(l=>l.spent>0) ? fmtMoney(labor.reduce((s,l)=>s+(l.spent||0),0)) : '‚Äî'"></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Detail panel -->
        <div class="chart-card" x-show="laborDetail.open && !laborForm.open">
          <div class="chart-header">
            <div>
              <div class="font-bold" x-text="laborDetail.lc?.role"></div>
              <div class="text-xs text-gray-400 mt-0.5" x-text="[laborDetail.lc?.personName, laborDetail.lc?.department, laborDetail.lc?.costType].filter(Boolean).join(' ¬∑ ')"></div>
            </div>
            <button class="btn-ghost btn-sm" @click="laborDetail = { open: false, lc: null }; $nextTick(() => renderLaborChart())">‚úï</button>
          </div>
          <div class="p-4 space-y-4">
            <!-- Sazba / MD / Celkem souhrn -->
            <div class="grid grid-cols-3 gap-2 text-center" style="background:#f9f9f9;border-radius:6px;padding:10px">
              <div>
                <div class="text-xs text-gray-500 font-bold uppercase" x-text="t('colRate')"></div>
                <div class="font-mono font-bold text-sm mt-1" x-text="fmtMoney(laborDetail.lc?.mdRate)"></div>
              </div>
              <div>
                <div class="text-xs text-gray-500 font-bold uppercase" x-text="t('colMD')"></div>
                <div class="font-bold text-sm mt-1" x-text="(laborDetail.lc?.mdDays || 0) + ' MD'"></div>
              </div>
              <div>
                <div class="text-xs text-gray-500 font-bold uppercase" x-text="t('colTotalPlan')"></div>
                <div class="font-mono font-bold text-sm mt-1" x-text="fmtMoney(laborAmount(laborDetail.lc || {}))"></div>
              </div>
            </div>
            <!-- Utraceno ‚Äì z√°znamy -->
            <div>
              <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#6b6b6b;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                <span x-text="t('spentForRole')"></span>
                <span x-show="laborFormEntries.length > 0" class="font-mono normal-case"
                  :class="laborFormEntries.reduce((s,e)=>s+e.amount,0) > laborAmount(laborDetail.lc||{}) ? 'text-red-600' : laborFormEntries.reduce((s,e)=>s+e.amount,0) > laborAmount(laborDetail.lc||{})*(laborWarningPct/100) ? 'text-yellow-500' : 'text-green-700'"
                  x-text="fmtMoney(laborFormEntries.reduce((s,e)=>s+e.amount,0))"></span>
              </div>
              <template x-for="entry in laborFormEntries" :key="entry.id">
                <div style="display:flex;align-items:center;gap:6px;padding:5px 0;border-bottom:1px solid #f5f5f5;font-size:12px">
                  <span style="color:#888;min-width:70px;flex-shrink:0" x-text="new Date(entry.date).toLocaleDateString(lang === 'en' ? 'en-GB' : 'cs-CZ',{month:'short',year:'numeric'})"></span>
                  <span class="font-mono font-semibold flex-1"
                    :class="laborFormEntries.reduce((s,e)=>s+e.amount,0) > laborAmount(laborDetail.lc||{}) ? 'text-red-600' : laborFormEntries.reduce((s,e)=>s+e.amount,0) > laborAmount(laborDetail.lc||{})*(laborWarningPct/100) ? 'text-yellow-500' : 'text-green-700'"
                    x-text="fmtMoney(entry.amount)"></span>
                  <span class="text-gray-400" style="font-size:11px;flex:2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" x-text="entry.note || ''"></span>
                  <button x-show="can('labor','write')" class="btn-icon" style="padding:2px 5px;color:#ccc;flex-shrink:0" @click="deleteLaborEntry(entry.id)" :title="t('delete')">‚úï</button>
                </div>
              </template>
              <p x-show="!laborFormEntries.length" class="text-xs text-gray-400 py-2" x-text="t('noRecords')"></p>
              <!-- P≈ôidat z√°znam -->
              <div style="margin-top:8px;display:flex;gap:6px;align-items:flex-end">
                <div>
                  <label class="form-label" style="font-size:10px" x-text="t('month')"></label>
                  <input class="form-input" type="month" x-model="laborEntryForm.month" style="width:122px;font-size:12px;padding:4px 8px">
                </div>
                <div style="flex:1">
                  <label class="form-label" style="font-size:10px" x-text="t('amount') + ' (' + currency + ')'"></label>
                  <input class="form-input" type="number" x-model="laborEntryForm.amount" min="0" step="1" style="font-size:12px;padding:4px 8px" placeholder="0">
                </div>
                <button x-show="can('labor','write')" class="btn-primary btn-sm" @click="addLaborEntry()" :disabled="!laborEntryForm.amount">Ôºã</button>
              </div>
              <input class="form-input mt-1" type="text" x-model="laborEntryForm.note" style="font-size:12px;padding:4px 8px" :placeholder="t('invoicePayslip')">
            </div>
            <!-- Akce -->
            <div style="display:flex;gap:8px;padding-top:8px;border-top:1px solid #f0f0f0">
              <button x-show="can('labor','write')" class="btn-ghost" style="flex:1;font-size:12px" @click="openLaborForm(laborDetail.lc)" x-text="t('editRole')"></button>
              <button x-show="can('labor','write')" class="btn-danger btn-sm" style="font-size:12px" @click="deleteLabor(laborDetail.lc?.id); laborDetail = { open: false, lc: null }" x-text="t('deleteRole')"></button>
            </div>
          </div>
        </div>

        <!-- Form -->
        <div class="chart-card" x-show="laborForm.open">
          <div class="chart-header">
            <span x-text="laborForm.id ? t('editRoleTitle') : t('newRoleTitle')"></span>
            <button class="btn-ghost btn-sm" @click="laborForm.open = false; $nextTick(() => renderLaborChart())">‚úï</button>
          </div>
          <div class="p-4 space-y-3">
            <div class="form-group">
              <label class="form-label" x-text="t('roleNameLabel')"></label>
              <input class="form-input" type="text" x-model="laborForm.role"
                :placeholder="t('roleNamePlaceholder')">
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('personFteLabel')"></label>
              <input class="form-input" type="text" x-model="laborForm.personName"
                :placeholder="t('personFtePlaceholder')">
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('departmentLabel')"></label>
              <select class="form-select" x-model="laborForm.department">
                <option value="" x-text="t('unassigned')"></option>
                <template x-for="dept in departments" :key="dept">
                  <option :value="dept" x-text="dept"></option>
                </template>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('costTypeLabel')"></label>
              <select class="form-select" x-model="laborForm.costType">
                <option>Project</option>
                <option>Annual</option>
                <option>One-off</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div class="form-group">
                <label class="form-label" x-text="t('ratePerMd') + ' (' + currency + ')'"></label>
                <input class="form-input" type="number" x-model="laborForm.mdRate" min="0" :placeholder="currency === 'EUR' ? '200' : '5000'">
              </div>
              <div class="form-group">
                <label class="form-label" x-text="t('mdDays')"></label>
                <input class="form-input" type="number" x-model="laborForm.mdDays" min="0" step="0.5" placeholder="100">
              </div>
            </div>
            <div x-show="laborForm.mdRate > 0 && laborForm.mdDays > 0"
                 class="rounded p-2 text-sm font-bold text-center"
                 style="background:#fff3cd;color:#856404;border:1px solid #ffc107">
              <span x-text="t('totalLabel')"></span>
              <span x-text="fmtMoney(laborForm.mdRate * laborForm.mdDays)"></span>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('notesLabel')"></label>
              <input class="form-input" type="text" x-model="laborForm.notes"
                :placeholder="t('notesPlaceholder')">
            </div>
            <button class="btn-primary w-full" @click="saveLabor()">
              <span x-text="laborForm.id ? t('saveChanges') : t('addRoleBtn')"></span>
            </button>
          </div>
        </div>

        <!-- Chart ‚Äî when nothing is open -->
        <div class="chart-card" x-show="!laborForm.open && !laborDetail.open">
          <div class="chart-header" x-text="t('costStructure')"></div>
          <div style="padding:16px;height:260px;display:flex;align-items:center;justify-content:center">
            <canvas id="laborChart"></canvas>
          </div>
        </div>

      </div>
    </div>

    <!-- ============================================================ -->
    <!-- TESTING VIEW -->
    <!-- ============================================================ -->
    <div x-show="view === 'testing'" class="p-6 space-y-4">

      <!-- Header toolbar -->
      <div class="flex items-center gap-3 flex-wrap">
        <!-- Tab switcher -->
        <div style="display:flex;gap:4px;background:#f1f5f9;border-radius:10px;padding:4px">
          <button @click="testingTab='stats'; loadTestStats(); $nextTick(() => { testSets.forEach(ts => { if (ts.dateMin && ts.dateMax) renderWaterfall(ts) }); renderSetPieCharts() })"
            :style="testingTab==='stats'?'background:var(--dhl-dark);color:var(--dhl-yellow);box-shadow:0 2px 6px rgba(0,0,0,0.15)':'background:transparent;color:#64748b'"
            style="padding:10px 24px;font-size:14px;font-weight:700;border:none;cursor:pointer;border-radius:8px;transition:all .2s;letter-spacing:0.2px">
            <span x-text="t('testDashboard')"></span>
          </button>
          <button @click="testingTab='sets'"
            :style="testingTab==='sets'?'background:var(--dhl-dark);color:var(--dhl-yellow);box-shadow:0 2px 6px rgba(0,0,0,0.15)':'background:transparent;color:#64748b'"
            style="padding:10px 24px;font-size:14px;font-weight:700;border:none;cursor:pointer;border-radius:8px;transition:all .2s;letter-spacing:0.2px">
            <span x-text="t('testMgmtTab')"></span>
          </button>
        </div>

        <template x-if="testingTab==='sets' && can('testing','write')">
          <div class="flex gap-2">
            <button class="btn-primary btn-sm" @click="openTsForm()" x-text="t('newTestSet')"></button>
            <button class="btn-ghost btn-sm" @click="csvImport.open=true;csvImport.setId=null;csvImport.setName='';csvImport.raw='';csvImport.fileName='';csvImport.error=''" x-text="t('importCsv')"></button>
          </div>
        </template>
      </div>

      <!-- STATISTICS TAB -->
      <div x-show="testingTab==='stats'" x-cloak>
        <template x-if="testStats">
          <div class="space-y-4">
            <!-- KPI row -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div class="kpi-card green">
                <div class="kpi-label">PASS</div>
                <div class="kpi-value" x-text="testStats.cases.PASS"></div>
                <div class="kpi-sub" x-text="t('testCases')"></div>
              </div>
              <div class="kpi-card red">
                <div class="kpi-label">DEFECT</div>
                <div class="kpi-value" x-text="testStats.cases.DEFECT"></div>
                <div class="kpi-sub" x-text="t('testCases')"></div>
              </div>
              <div class="kpi-card blue">
                <div class="kpi-label">WIP</div>
                <div class="kpi-value" x-text="testStats.cases.WIP"></div>
                <div class="kpi-sub" x-text="t('testCases')"></div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">N/A</div>
                <div class="kpi-value" x-text="testStats.cases['N/A']"></div>
                <div class="kpi-sub" x-text="t('testCases')"></div>
              </div>
            </div>

            <!-- Progress bar -->
            <div class="chart-card p-4">
              <div style="font-size:12px;font-weight:700;color:var(--dhl-grey);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px" x-text="t('overallProgress')"></div>
              <template x-if="testStats">
                <div>
                  <div class="flex gap-1 mb-2" style="height:18px;border-radius:4px;overflow:hidden">
                    <div :style="'flex:'+(testStats.cases.PASS||0)+';background:#22c55e'" :title="'PASS: '+(testStats.cases.PASS||0)"></div>
                    <div :style="'flex:'+(testStats.cases.DEFECT||0)+';background:#ef4444'" :title="'DEFECT: '+(testStats.cases.DEFECT||0)"></div>
                    <div :style="'flex:'+(testStats.cases.WIP||0)+';background:#3b82f6'" :title="'WIP: '+(testStats.cases.WIP||0)"></div>
                    <div :style="'flex:'+(testStats.cases['N/A']||0)+';background:#9ca3af'" :title="'N/A: '+(testStats.cases['N/A']||0)"></div>
                  </div>
                  <div class="flex gap-4" style="font-size:11px">
                    <span style="color:#22c55e;font-weight:700">‚óè PASS: <span x-text="testStats.cases.PASS||0"></span></span>
                    <span style="color:#ef4444;font-weight:700">‚óè DEFECT: <span x-text="testStats.cases.DEFECT||0"></span></span>
                    <span style="color:#3b82f6;font-weight:700">‚óè WIP: <span x-text="testStats.cases.WIP||0"></span></span>
                    <span style="color:#9ca3af;font-weight:700">‚óè N/A: <span x-text="testStats.cases['N/A']||0"></span></span>
                  </div>
                </div>
              </template>
            </div>

            <!-- Per test set donut charts -->
            <template x-if="testSets.length > 0">
              <div class="chart-card">
                <div class="chart-header">
                  <span x-text="t('progressBySet')"></span>
                  <span class="text-xs text-gray-400" x-text="testSets.length + ' sets'"></span>
                </div>
                <div class="p-4">
                  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                    <template x-for="ts in testSets" :key="'setstat-'+ts.id">
                      <div style="border:1px solid var(--dhl-border);border-radius:6px;padding:14px 16px">
                        <!-- Card header -->
                        <div class="flex items-center gap-2 mb-3">
                          <span style="font-weight:700;font-size:13px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" x-text="ts.name"></span>
                          <span class="badge flex-shrink-0" :class="testSetStatusClass(ts)" style="font-size:10px;font-weight:700" x-text="testSetStatus(ts)"></span>
                        </div>
                        <!-- Donut + legend -->
                        <div class="flex items-center gap-4">
                          <!-- Donut canvas with % center label -->
                          <div style="position:relative;width:100px;height:100px;flex-shrink:0">
                            <canvas :id="'pie-ts-'+ts.id" width="100" height="100"></canvas>
                            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none">
                              <div style="font-size:17px;font-weight:800;color:#1a1a1a"
                                x-text="ts.testCases.length ? Math.round(ts.testCases.filter(c=>['PASS','N/A'].includes(c.status)).length / ts.testCases.length * 100) + '%' : '‚Äî'"></div>
                              <div style="font-size:9px;color:#888;font-weight:600;text-transform:uppercase;letter-spacing:0.4px" x-text="t('done')"></div>
                            </div>
                          </div>
                          <!-- Legend -->
                          <div style="flex:1;min-width:0;font-size:11px;line-height:1.9">
                            <div class="flex justify-between">
                              <span style="color:#22c55e;font-weight:700">‚óè PASS</span>
                              <span style="font-weight:700" x-text="ts.testCases.filter(c=>c.status==='PASS').length"></span>
                            </div>
                            <div class="flex justify-between">
                              <span style="color:#ef4444;font-weight:700">‚óè DEFECT</span>
                              <span style="font-weight:700" x-text="ts.testCases.filter(c=>c.status==='DEFECT').length"></span>
                            </div>
                            <div class="flex justify-between">
                              <span style="color:#3b82f6;font-weight:700">‚óè WIP</span>
                              <span style="font-weight:700" x-text="ts.testCases.filter(c=>c.status==='WIP').length"></span>
                            </div>
                            <div class="flex justify-between">
                              <span style="color:#9ca3af;font-weight:700">‚óè N/A</span>
                              <span style="font-weight:700" x-text="ts.testCases.filter(c=>c.status==='N/A').length"></span>
                            </div>
                            <div class="flex justify-between">
                              <span style="color:#d97706;font-weight:700">‚óè Not Started</span>
                              <span style="font-weight:700" x-text="ts.testCases.filter(c=>c.status==='Not Started').length"></span>
                            </div>
                            <div style="margin-top:5px;padding-top:5px;border-top:1px solid #f0f0f0;color:#888;font-size:10px">
                              <span x-text="t('totalTests')"></span> <strong x-text="ts.testCases.length"></strong>
                            </div>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </template>

            <!-- Waterfall per test set -->
            <template x-for="ts in testSets.filter(ts => ts.dateMin && ts.dateMax)" :key="'wf-stats-'+ts.id">
              <div class="chart-card p-4">
                <div style="font-size:12px;font-weight:700;color:var(--dhl-grey);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">
                  üìÖ <span x-text="ts.name"></span> <span x-text="t('testPlanSchedule')"></span>
                  <span style="font-size:10px;color:#888;font-weight:400;margin-left:6px" x-text="(ts.dateMin ? ts.dateMin.slice(0,10) : '?') + ' ‚Üí ' + (ts.dateMax ? ts.dateMax.slice(0,10) : '?')"></span>
                </div>
                <div :id="'waterfall-'+ts.id" style="width:100%;height:130px"></div>
              </div>
            </template>

            <!-- Defects -->
            <div class="chart-card p-4">
              <div style="font-size:12px;font-weight:700;color:var(--dhl-grey);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px" x-text="t('defects')"></div>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div style="text-align:center;padding:12px;background:#fff3cd;border-radius:5px">
                  <div style="font-size:11px;font-weight:700;color:#856404">OPEN</div>
                  <div style="font-size:22px;font-weight:800;color:#1a1a1a" x-text="testStats.defects.open"></div>
                </div>
                <div style="text-align:center;padding:12px;background:#dbeafe;border-radius:5px">
                  <div style="font-size:11px;font-weight:700;color:#1e40af">IN PROGRESS</div>
                  <div style="font-size:22px;font-weight:800;color:#1a1a1a" x-text="testStats.defects.inProgress"></div>
                </div>
                <div style="text-align:center;padding:12px;background:#d1fae5;border-radius:5px">
                  <div style="font-size:11px;font-weight:700;color:#065f46">FIXED</div>
                  <div style="font-size:22px;font-weight:800;color:#1a1a1a" x-text="testStats.defects.fixed"></div>
                </div>
                <div style="text-align:center;padding:12px;background:#f3f4f6;border-radius:5px">
                  <div style="font-size:11px;font-weight:700;color:#4b5563">CLOSED</div>
                  <div style="font-size:22px;font-weight:800;color:#1a1a1a" x-text="testStats.defects.closed"></div>
                </div>
              </div>
              <div class="flex gap-3 mt-3 flex-wrap" style="font-size:11px">
                <span style="font-weight:700;color:#991b1b">‚óè Critical: <span x-text="testStats.defects.bySeverity.Critical"></span></span>
                <span style="font-weight:700;color:#c2410c">‚óè High: <span x-text="testStats.defects.bySeverity.High"></span></span>
                <span style="font-weight:700;color:#d97706">‚óè Medium: <span x-text="testStats.defects.bySeverity.Medium"></span></span>
                <span style="font-weight:700;color:#6b7280">‚óè Low: <span x-text="testStats.defects.bySeverity.Low"></span></span>
              </div>
            </div>

            <!-- Defects list top 15 -->
            <template x-if="testStats.defectsList && testStats.defectsList.length > 0">
              <div class="chart-card" style="overflow:hidden">
                <div class="chart-header">
                  <span x-text="t('topDefects')"></span>
                  <span class="text-xs text-gray-400" x-text="testStats.defectsList.length + ' ' + t('defectsCount')"></span>
                </div>
                <div style="overflow-x:auto">
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th style="width:80px" x-text="t('severity')"></th>
                        <th x-text="t('description')"></th>
                        <th>Test case</th>
                        <th>Test set</th>
                        <th style="width:90px" x-text="t('status')"></th>
                        <th style="width:90px" x-text="t('reportedBy')"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <template x-for="d in testStats.defectsList" :key="d.id">
                        <tr>
                          <td>
                            <span class="badge" :class="defectSeverityClass(d.severity)" x-text="d.severity"></span>
                          </td>
                          <td>
                            <div style="font-weight:600;font-size:12px" x-text="d.title"></div>
                            <template x-if="d.description">
                              <div style="font-size:11px;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px" x-text="d.description"></div>
                            </template>
                          </td>
                          <td style="font-size:12px;color:#555" x-text="d.testCase"></td>
                          <td style="font-size:12px;color:#888" x-text="d.testSet"></td>
                          <td>
                            <span class="badge"
                              :style="d.status==='Open'?'background:#fff3cd;color:#856404':d.status==='Fixed'?'background:#d1fae5;color:#065f46':d.status==='Closed'?'background:#f3f4f6;color:#4b5563':'background:#dbeafe;color:#1e40af'"
                              x-text="d.status"></span>
                          </td>
                          <td style="font-size:11px;color:#888" x-text="d.reportedBy || '‚Äî'"></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>
            </template>
          </div>
        </template>
        <template x-if="!testStats">
          <div class="text-center py-12 text-gray-400" x-text="t('loadingStats')"></div>
        </template>
      </div>

      <!-- TEST SETS TAB -->
      <div x-show="testingTab==='sets'" class="space-y-4">
        <template x-if="testSets.length === 0">
          <div class="chart-card p-10 text-center" style="color:var(--dhl-grey);font-size:13px">
            <span x-text="t('noTestSets')"></span>
          </div>
        </template>

        <template x-for="ts in testSets" :key="ts.id">
          <div class="chart-card">
            <!-- TestSet header -->
            <div class="chart-header" style="cursor:pointer;user-select:none" @click="expandedSets[ts.id] = !expandedSets[ts.id]">
              <div class="flex items-center gap-2 flex-1 min-w-0">
                <span style="font-size:16px" x-text="expandedSets[ts.id] ? '‚ñº' : '‚ñ∂'"></span>
                <span style="font-size:16px">üìÅ</span>
                <span style="font-weight:800;font-size:14px" x-text="ts.name"></span>
                <span class="badge badge-grey" style="font-size:10px" x-text="ts.testCases.length + ' test≈Ø'"></span>
                <span :class="testSetStatusClass(ts)" class="badge" style="font-size:10px;font-weight:700" x-text="testSetStatus(ts)"></span>
                <!-- date range badges -->
                <template x-if="ts.dateMin || ts.dateMax">
                  <span style="font-size:10px;color:#888;font-weight:600" x-text="(ts.dateMin ? ts.dateMin.slice(0,10) : '?') + ' ‚Üí ' + (ts.dateMax ? ts.dateMax.slice(0,10) : '?')"></span>
                </template>
                <!-- quick status pills -->
                <span style="font-size:10px;font-weight:700;color:#22c55e" x-text="'‚úì' + ts.testCases.filter(c=>c.status==='PASS').length"></span>
                <span style="font-size:10px;font-weight:700;color:#ef4444" x-text="'‚úó' + ts.testCases.filter(c=>c.status==='DEFECT').length"></span>
                <span style="font-size:10px;font-weight:700;color:#3b82f6" x-text="'‚ü≥' + ts.testCases.filter(c=>c.status==='WIP').length"></span>
              </div>
              <div class="flex gap-2" @click.stop>
                <button x-show="can('testing','write')" class="btn-ghost btn-sm" @click="openTcForm(ts.id)" x-text="t('addTest')"></button>
                <button x-show="can('testing','write')" class="btn-ghost btn-sm" @click="openTsForm(ts)">‚úèÔ∏è</button>
                <button x-show="can('testing','write')" class="btn-ghost btn-sm" @click="csvImport.open=true;csvImport.setId=ts.id;csvImport.setName=ts.name;csvImport.raw='';csvImport.fileName='';csvImport.error=''" :title="t('importCsv')">‚¨Ü CSV</button>
                <button x-show="can('testing','write')" class="btn-danger btn-sm" @click="deleteTestSet(ts.id)" :title="t('delete')">‚úï</button>
              </div>
            </div>

            <!-- TestCases list -->
            <div x-show="expandedSets[ts.id]" style="padding:8px 18px 14px">
              <template x-if="ts.testCases.length === 0">
                <div style="color:#aaa;font-size:12px;padding:8px 0" x-text="t('noTestCases')"></div>
              </template>

              <template x-for="tc in ts.testCases" :key="tc.id">
                <div style="border:1px solid var(--dhl-border);border-radius:5px;margin-bottom:8px;overflow:hidden">
                  <!-- TestCase header -->
                  <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:#fafafa;cursor:pointer"
                    @click="expandedCases[tc.id] = !expandedCases[tc.id]">
                    <span style="font-size:12px;color:#888" x-text="expandedCases[tc.id] ? '‚ñº' : '‚ñ∂'"></span>
                    <span style="font-size:13px">üß™</span>
                    <span style="font-weight:700;font-size:13px;flex:1" x-text="tc.name"></span>

                    <!-- Status dropdown -->
                    <select :value="tc.status" @click.stop @change.stop="updateTestCaseStatus(tc, $event.target.value)"
                      :class="statusBadgeClass(tc.status)"
                      class="inline-select"
                      style="font-size:10px;min-width:90px;border:none;font-weight:700;padding:3px 6px;border-radius:3px">
                      <option>Not Started</option>
                      <option>WIP</option>
                      <option>PASS</option>
                      <option>DEFECT</option>
                      <option>N/A</option>
                    </select>

                    <div class="flex gap-1" @click.stop>
                      <button x-show="can('testing','write')" class="btn-ghost btn-sm" style="font-size:10px" @click="openTcForm(ts.id, tc)">‚úèÔ∏è</button>
                      <button x-show="can('testing','write')" class="btn-danger btn-sm" style="font-size:10px" @click="deleteTestCase(tc.id, ts.id)">‚úï</button>
                    </div>
                  </div>

                  <!-- TestCase body (expanded) -->
                  <div x-show="expandedCases[tc.id]" style="padding:10px 14px;border-top:1px solid #f0f0f0">

                    <!-- Meta info -->
                    <div class="flex gap-4 flex-wrap" style="font-size:11px;color:#888;margin-bottom:10px">
                      <template x-if="tc.testedBy"><span>üë§ <span x-text="tc.testedBy"></span></span></template>
                      <template x-if="tc.dataUsed"><span>üìã <span x-text="tc.dataUsed"></span></span></template>
                      <template x-if="tc.notes"><span style="color:#555">üí¨ <span x-text="tc.notes"></span></span></template>
                    </div>

                    <!-- TEST STEPS -->
                    <div style="font-size:11px;font-weight:700;color:var(--dhl-grey);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px" x-text="t('testSteps')"></div>
                    <template x-if="tc.steps.length === 0 && !(stepForms[tc.id]?.adding)">
                      <div style="color:#bbb;font-size:12px;margin-bottom:6px" x-text="t('noSteps')"></div>
                    </template>

                    <template x-for="(step, si) in tc.steps" :key="step.id">
                      <div style="border:1px solid #e5e7eb;border-radius:5px;padding:8px 10px;margin-bottom:6px;background:#fff">
                        <div style="display:flex;align-items:flex-start;gap:8px">
                          <span style="font-size:11px;color:#bbb;min-width:18px;text-align:right;padding-top:2px" x-text="(si+1)+'.'"></span>
                          <div style="flex:1;min-width:0">
                            <!-- Akce + Oƒçek√°van√Ω v√Ωsledek -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:6px">
                              <div>
                                <div style="font-size:9px;font-weight:700;color:#9ca3af;text-transform:uppercase;margin-bottom:2px" x-text="t('action')"></div>
                                <div style="font-size:12px;color:#1a1a1a" x-text="step.description"></div>
                              </div>
                              <div>
                                <div style="font-size:9px;font-weight:700;color:#9ca3af;text-transform:uppercase;margin-bottom:2px" x-text="t('expectedResult')"></div>
                                <div style="font-size:12px;color:#555" x-text="step.notes || '‚Äî'"></div>
                              </div>
                            </div>
                            <!-- Status + Tester + Datum -->
                            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                              <select :value="step.status" @change="updateStepStatus(step, tc, $event.target.value)"
                                :class="statusBadgeClass(step.status)"
                                class="inline-select"
                                style="font-size:10px;min-width:90px;border:none;font-weight:700;padding:2px 6px;border-radius:3px">
                                <option>Not Started</option>
                                <option>WIP</option>
                                <option>PASS</option>
                                <option>DEFECT</option>
                                <option>N/A</option>
                              </select>
                              <template x-if="step.testedBy">
                                <span style="font-size:10px;color:#6b7280">üë§ <span x-text="step.testedBy"></span></span>
                              </template>
                              <template x-if="step.testedAt">
                                <span style="font-size:10px;color:#6b7280">üìÖ <span x-text="step.testedAt ? step.testedAt.slice(0,10) : ''"></span></span>
                              </template>
                            </div>
                          </div>
                          <div class="flex gap-1" style="flex-shrink:0">
                            <button x-show="can('testing','write')" class="btn-icon" style="font-size:11px;color:#888" @click="openStepEdit(step)" :title="t('editStep')">‚úèÔ∏è</button>
                            <button x-show="can('testing','write')" class="btn-icon" style="font-size:11px;color:#ccc" @click="deleteTestStep(step.id, tc)" :title="t('delete')">‚úï</button>
                          </div>
                        </div>
                      </div>
                    </template>

                    <!-- Add step form -->
                    <div style="border:1px solid #e5e7eb;border-radius:5px;padding:10px 12px;margin-top:6px;background:#f9fafb">
                      <div style="font-size:9px;font-weight:700;color:#9ca3af;text-transform:uppercase;margin-bottom:8px" x-text="t('addStep')"></div>
                      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
                        <div>
                          <div style="font-size:10px;font-weight:700;color:#555;margin-bottom:3px" x-text="t('action') + ' *'"></div>
                          <input x-model="getStepForm(tc.id).description"
                            @keydown.enter.prevent="addTestStep(tc)"
                            style="width:100%;padding:5px 8px;border:1px solid var(--dhl-border);border-radius:4px;font-size:12px;outline:none;box-sizing:border-box"
                            :placeholder="t('stepDescription')"
                            @focus="getStepForm(tc.id).adding=true">
                        </div>
                        <div>
                          <div style="font-size:10px;font-weight:700;color:#555;margin-bottom:3px" x-text="t('expectedResult')"></div>
                          <input x-model="getStepForm(tc.id).notes"
                            style="width:100%;padding:5px 8px;border:1px solid var(--dhl-border);border-radius:4px;font-size:12px;outline:none;box-sizing:border-box"
                            :placeholder="t('whatExpected')">
                        </div>
                      </div>
                      <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:flex-end">
                        <div>
                          <div style="font-size:10px;font-weight:700;color:#555;margin-bottom:3px" x-text="t('testerName')"></div>
                          <input x-model="getStepForm(tc.id).testedBy"
                            style="width:100%;padding:5px 8px;border:1px solid var(--dhl-border);border-radius:4px;font-size:12px;outline:none;box-sizing:border-box"
                            :placeholder="t('testerName')">
                        </div>
                        <div>
                          <div style="font-size:10px;font-weight:700;color:#555;margin-bottom:3px" x-text="t('testDate')"></div>
                          <input type="date" x-model="getStepForm(tc.id).testedAt"
                            style="width:100%;padding:5px 8px;border:1px solid var(--dhl-border);border-radius:4px;font-size:12px;outline:none;box-sizing:border-box">
                        </div>
                        <button x-show="can('testing','write')" class="btn-primary btn-sm" @click="addTestStep(tc)" style="white-space:nowrap" x-text="t('addStep')"></button>
                      </div>
                    </div>

                    <!-- DEFECTS -->
                    <div style="font-size:11px;font-weight:700;color:var(--dhl-grey);text-transform:uppercase;letter-spacing:0.5px;margin:12px 0 6px"><span x-text="t('defects')"></span>
                      <button x-show="can('testing','write')" class="btn-ghost btn-sm" style="margin-left:8px;font-size:10px"
                        @click="openDefectForm(tc.id)" x-text="t('addDefect')"></button>
                    </div>
                    <template x-if="tc.defects.length === 0">
                      <div style="color:#bbb;font-size:12px" x-text="t('noDefects')"></div>
                    </template>
                    <template x-for="def in tc.defects" :key="def.id">
                      <div style="display:flex;align-items:flex-start;gap:8px;padding:6px 8px;border-radius:4px;background:#fff8f8;border:1px solid #fee2e2;margin-bottom:4px">
                        <div style="flex:1;min-width:0">
                          <div style="font-size:12px;font-weight:700;color:#991b1b" x-text="def.title"></div>
                          <div style="font-size:11px;color:#888;margin-top:1px" x-text="def.description || ''"></div>
                        </div>
                        <span :class="defectSeverityClass(def.severity)" class="badge" style="font-size:9px" x-text="def.severity"></span>
                        <select :value="def.status" @change="updateDefectStatus(def, $event.target.value)"
                          class="inline-select badge-grey" style="font-size:10px;min-width:80px">
                          <option>Open</option>
                          <option>In Progress</option>
                          <option>Fixed</option>
                          <option>Closed</option>
                          <option>Rejected</option>
                        </select>
                        <button x-show="can('testing','write')" class="btn-icon" style="color:#ccc;font-size:11px" @click="deleteDefect(def.id, tc)">‚úï</button>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- TestSet Form Modal -->
    <div class="modal-overlay" x-show="tsForm.open" @click.self="tsForm.open=false">
      <div class="modal" style="max-width:480px">
        <div class="modal-header">
          <h2><span class="accent" x-text="tsForm.id ? t('editTestSet') : t('newTestSetTitle')"></span></h2>
          <button class="btn-icon" style="color:#aaa" @click="tsForm.open=false">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" x-text="t('nameRequired')"></label>
            <input class="form-input" x-model="tsForm.name" :placeholder="t('exampleInbound')">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('dateFrom')"></label>
              <input type="date" class="form-input" x-model="tsForm.dateMin">
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('dateTo')"></label>
              <input type="date" class="form-input" x-model="tsForm.dateMax">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('notes')"></label>
            <textarea class="form-input" x-model="tsForm.notes" rows="2" :placeholder="t('optionalNotes')"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-ghost" @click="tsForm.open=false" x-text="t('cancel')"></button>
          <button class="btn-primary" @click="saveTestSet()">
            <span x-text="tsForm.id ? t('save') : t('create')"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- TestCase Form Modal -->
    <div class="modal-overlay" x-show="tcForm.open" @click.self="tcForm.open=false">
      <div class="modal" style="max-width:500px">
        <div class="modal-header">
          <h2><span class="accent" x-text="tcForm.id ? t('editTestCase') : t('newTestCaseTitle')"></span></h2>
          <button class="btn-icon" style="color:#aaa" @click="tcForm.open=false">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" x-text="t('nameRequired')"></label>
            <input class="form-input" x-model="tcForm.name" :placeholder="t('exampleHappyFlow')">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('status')"></label>
              <select class="form-select" x-model="tcForm.status">
                <option>Not Started</option>
                <option>WIP</option>
                <option>PASS</option>
                <option>DEFECT</option>
                <option>N/A</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('testedBy')"></label>
              <input class="form-input" x-model="tcForm.testedBy" :placeholder="t('testerName')">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('dataUsed')"></label>
            <input class="form-input" x-model="tcForm.dataUsed" :placeholder="t('dataUsedExample')">
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('notes')"></label>
            <textarea class="form-input" x-model="tcForm.notes" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-ghost" @click="tcForm.open=false" x-text="t('cancel')"></button>
          <button class="btn-primary" @click="saveTestCase()">
            <span x-text="tcForm.id ? t('save') : t('add')"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Defect Form Modal -->
    <div class="modal-overlay" x-show="defectForm.open" @click.self="defectForm.open=false">
      <div class="modal" style="max-width:460px">
        <div class="modal-header">
          <h2><span class="accent" x-text="defectForm.id ? t('editDefect') : t('newDefectTitle')"></span></h2>
          <button class="btn-icon" style="color:#aaa" @click="defectForm.open=false">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" x-text="t('nameRequired')"></label>
            <input class="form-input" x-model="defectForm.title" :placeholder="t('defectShortDesc')">
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('description')"></label>
            <textarea class="form-input" x-model="defectForm.description" rows="3" :placeholder="t('reproduceSteps')"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('severity')"></label>
              <select class="form-select" x-model="defectForm.severity">
                <option>Critical</option>
                <option>High</option>
                <option>Medium</option>
                <option>Low</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('status')"></label>
              <select class="form-select" x-model="defectForm.status">
                <option>Open</option>
                <option>In Progress</option>
                <option>Fixed</option>
                <option>Closed</option>
                <option>Rejected</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('reportedBy')"></label>
            <input class="form-input" x-model="defectForm.reportedBy">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-ghost" @click="defectForm.open=false" x-text="t('cancel')"></button>
          <button class="btn-primary" @click="saveDefect()">
            <span x-text="defectForm.id ? t('save') : t('add')"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Step Edit Modal -->
    <div class="modal-overlay" x-show="stepEditForm.open" @click.self="stepEditForm.open=false">
      <div class="modal" style="max-width:520px">
        <div class="modal-header">
          <h2><span class="accent" x-text="t('editStep')"></span></h2>
          <button class="btn-icon" style="color:#aaa" @click="stepEditForm.open=false">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group" style="grid-column:1/-1">
              <label class="form-label" x-text="t('action') + ' *'"></label>
              <textarea class="form-input" x-model="stepEditForm.description" rows="2" :placeholder="t('stepDescription')"></textarea>
            </div>
            <div class="form-group" style="grid-column:1/-1">
              <label class="form-label" x-text="t('expectedResult')"></label>
              <textarea class="form-input" x-model="stepEditForm.notes" rows="2" :placeholder="t('whatExpected')"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('status')"></label>
              <select class="form-select" x-model="stepEditForm.status">
                <option>Not Started</option>
                <option>WIP</option>
                <option>PASS</option>
                <option>DEFECT</option>
                <option>N/A</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('testDate')"></label>
              <input type="date" class="form-input" x-model="stepEditForm.testedAt">
            </div>
            <div class="form-group" style="grid-column:1/-1">
              <label class="form-label" x-text="t('testerName')"></label>
              <input class="form-input" x-model="stepEditForm.testedBy" :placeholder="t('testerName')">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-ghost" @click="stepEditForm.open=false" x-text="t('cancel')"></button>
          <button class="btn-primary" @click="saveStepEdit()" x-text="t('save')"></button>
        </div>
      </div>
    </div>

    <!-- CSV Import Modal -->
    <div class="modal-overlay" x-show="csvImport.open" @click.self="csvImport.open=false">
      <div class="modal" style="max-width:560px">
        <div class="modal-header">
          <h2><span class="accent" x-text="t('csvImportTitle')"></span></h2>
          <button class="btn-icon" style="color:#aaa" @click="csvImport.open=false">‚úï</button>
        </div>
        <div class="modal-body">
          <!-- Format info + download template -->
          <div style="background:#f8f8f8;border-radius:4px;padding:10px 12px;font-size:11px;color:#555;margin-bottom:14px;border-left:3px solid var(--dhl-yellow);display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
            <div>
              <strong x-text="t('csvRequired')"></strong><br>
              <strong x-text="t('csvOptional')"></strong><br>
              <span style="color:#888" x-text="t('csvAutoStatus')"></span>
            </div>
            <button class="btn-ghost btn-sm" style="white-space:nowrap;flex-shrink:0" @click="downloadCsvTemplate()" x-text="t('downloadTemplate')"></button>
          </div>

          <!-- Target set -->
          <template x-if="csvImport.setId">
            <div style="padding:8px 10px;background:#fffbea;border-radius:4px;font-size:12px;margin-bottom:12px;border:1px solid #fde68a">
              <span x-text="t('importToSet')"></span> <strong x-text="csvImport.setName"></strong>
            </div>
          </template>
          <template x-if="!csvImport.setId">
            <div class="form-group">
              <label class="form-label" x-text="t('newSetName')"></label>
              <input class="form-input" x-model="csvImport.setName" :placeholder="t('leaveBlank')">
            </div>
          </template>

          <!-- File upload drop zone -->
          <div class="form-group">
            <label class="form-label" x-text="t('csvFile')"></label>
            <div style="border:2px dashed var(--dhl-border);border-radius:6px;padding:24px 16px;text-align:center;cursor:pointer;background:#fafafa;transition:border-color 0.15s"
              @click="$refs.csvFileInput.click()"
              @dragover.prevent="$event.currentTarget.style.borderColor='var(--dhl-yellow)'"
              @dragleave="$event.currentTarget.style.borderColor='var(--dhl-border)'"
              @drop.prevent="handleCsvDrop($event); $event.currentTarget.style.borderColor='var(--dhl-border)'">
              <input type="file" accept=".csv,.txt" x-ref="csvFileInput" style="display:none" @change="handleCsvFile($event)">
              <template x-if="!csvImport.fileName">
                <div>
                  <div style="font-size:28px;margin-bottom:8px">üìÇ</div>
                  <div style="font-size:12px;font-weight:600;color:#555" x-text="t('dragDropCsv')"></div>
                  <div style="font-size:11px;color:#bbb;margin-top:3px">.csv, .txt</div>
                </div>
              </template>
              <template x-if="csvImport.fileName">
                <div>
                  <div style="font-size:24px;margin-bottom:6px">‚úÖ</div>
                  <div style="font-size:13px;font-weight:700;color:#1a1a1a" x-text="csvImport.fileName"></div>
                  <div style="font-size:11px;color:#888;margin-top:2px" x-text="(csvImport.raw.split('\n').length - 1) + ' ' + t('dataRows')"></div>
                  <button class="btn-ghost btn-sm" style="margin-top:8px;font-size:10px" @click.stop="csvImport.fileName='';csvImport.raw='';$refs.csvFileInput.value=''" x-text="t('cancelFile')"></button>
                </div>
              </template>
            </div>
          </div>

          <template x-if="csvImport.error">
            <div style="background:#fee2e2;color:#991b1b;padding:8px 12px;border-radius:4px;font-size:12px" x-text="csvImport.error"></div>
          </template>
        </div>
        <div class="modal-footer">
          <button class="btn-ghost" @click="csvImport.open=false" x-text="t('cancel')"></button>
          <button class="btn-primary" @click="importCSV()" :disabled="csvImport.loading || !csvImport.raw">
            <span x-text="csvImport.loading ? t('importing') : t('importBtn')"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- ============================================================ -->
    <!-- RISK MANAGEMENT VIEW -->
    <!-- ============================================================ -->
    <div x-show="view === 'risks'" class="p-6 space-y-4">
      <!-- Sub-tabs -->
      <div class="flex gap-1 border-b border-gray-200 mb-2">
        <button @click="riskTab='list'" :class="riskTab==='list' ? 'active' : ''" class="settings-tab" x-text="t('riskListTab')"></button>
        <button @click="riskTab='matrix'" :class="riskTab==='matrix' ? 'active' : ''" class="settings-tab" x-text="t('riskMatrixTab')"></button>
        <button @click="riskTab='top10'; $nextTick(()=>renderTop10Chart())" :class="riskTab==='top10' ? 'active' : ''" class="settings-tab" x-text="t('top10Tab')"></button>
        <button @click="riskTab='trend'; $nextTick(()=>renderRiskTrendChart())" :class="riskTab==='trend' ? 'active' : ''" class="settings-tab" x-text="t('trendTab')"></button>
      </div>

      <!-- LIST TAB -->
      <div x-show="riskTab==='list'">
        <div class="filter-bar mb-3" style="background:transparent;border:none;padding:0">
          <select x-model="riskFilters.status" class="form-select" style="width:160px">
            <option value="" x-text="t('allStatuses')"></option>
            <option>Open</option><option>Monitoring</option><option>Mitigated</option><option>Closed</option>
          </select>
          <select x-model="riskFilters.category" class="form-select" style="width:160px">
            <option value="" x-text="t('allCategories')"></option>
            <option>technical</option><option>budget</option><option>resource</option><option>external</option><option>regulatory</option>
          </select>
        </div>
        <div class="chart-card">
          <div class="table-scroll" style="max-height:calc(100vh - 260px)">
            <table class="data-table">
              <thead>
                <tr>
                  <th style="width:50px">ID</th>
                  <th x-text="t('colName')"></th>
                  <th style="width:100px" x-text="t('category')"></th>
                  <th style="width:50px">P</th>
                  <th style="width:50px">I</th>
                  <th style="width:70px" x-text="t('riskScore')">Score</th>
                  <th style="width:110px" x-text="t('owner')"></th>
                  <th style="width:100px" x-text="t('status')"></th>
                  <th style="width:100px" x-text="t('reviewDate')"></th>
                  <th style="width:110px" x-text="t('materializationDate')"></th>
                  <th style="width:80px" x-text="t('auditColAction')"></th>
                </tr>
              </thead>
              <tbody>
                <template x-if="!filteredRisks.length">
                  <tr><td colspan="10" class="text-center py-10 text-gray-400"><span x-text="t('noRisks')"></span></td></tr>
                </template>
                <template x-for="r in filteredRisks" :key="r.id">
                  <tr>
                    <td class="font-mono text-xs text-gray-400" x-text="'R-' + String(r.id).padStart(3,'0')"></td>
                    <td>
                      <div class="font-semibold" x-text="r.title"></div>
                      <div x-show="r.description" class="text-xs text-gray-400" x-text="r.description?.slice(0,80)"></div>
                    </td>
                    <td><span class="badge badge-blue" x-text="r.category"></span></td>
                    <td class="text-center font-bold" x-text="r.probability"></td>
                    <td class="text-center font-bold" x-text="r.impact"></td>
                    <td class="text-center">
                      <span class="badge font-bold text-sm" :style="riskScoreStyle(r.score)" x-text="r.score"></span>
                    </td>
                    <td x-text="r.owner?.name ?? '‚Äî'"></td>
                    <td><span class="badge" :class="riskStatusBadge(r.status)" x-text="r.status"></span></td>
                    <td class="text-xs" x-text="r.reviewDate ? fmtDate(r.reviewDate) : '‚Äî'"></td>
                    <td class="text-xs" :class="r.materializationDate && new Date(r.materializationDate) <= new Date() ? 'deadline-urgent' : ''"
                      x-text="r.materializationDate ? fmtDate(r.materializationDate) : '‚Äî'"></td>
                    <td>
                      <button x-show="can('risks','write')" class="btn-icon" @click="openEditRisk(r)" :title="t('edit')">‚úèÔ∏è</button>
                      <button x-show="can('risks','write')" class="btn-icon" @click="deleteRisk(r.id)" :title="t('delete')" style="color:#D40511">üóë</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- MATRIX TAB -->
      <div x-show="riskTab==='matrix'">
        <div class="chart-card p-6">
          <div class="text-sm font-bold mb-4 text-gray-600" x-text="t('riskHeatmap')"></div>
          <div style="display:grid;grid-template-columns:40px repeat(5,1fr);gap:4px;max-width:600px">
            <!-- Header row -->
            <div></div>
            <template x-for="i in [1,2,3,4,5]" :key="'hi'+i">
              <div class="text-center text-xs font-bold text-gray-500" x-text="t('impactLabel') + ' ' + i"></div>
            </template>
            <!-- 5 rows (prob 5‚Üí1) -->
            <template x-for="prob in [5,4,3,2,1]" :key="'row'+prob">
              <template x-for="_dummy in [[]]" :key="'d'+prob">
                <div class="contents">
                  <div class="text-xs font-bold text-gray-500 flex items-center justify-end pr-2" x-text="'P' + prob"></div>
                  <template x-for="impact in [1,2,3,4,5]" :key="'cell'+prob+'-'+impact">
                    <div :style="riskCellStyle(prob, impact)"
                         style="min-height:64px;border-radius:4px;padding:4px;display:flex;flex-direction:column;gap:2px;cursor:default">
                      <div class="text-xs font-bold text-center" x-text="prob*impact"></div>
                      <template x-for="r in risksInCell(prob, impact)" :key="r.id">
                        <div class="text-xs truncate font-medium" :title="r.title" x-text="r.title.slice(0,18) + (r.title.length>18?'‚Ä¶':'')"></div>
                      </template>
                    </div>
                  </template>
                </div>
              </template>
            </template>
          </div>
          <!-- Legend -->
          <div class="flex gap-4 mt-4 text-xs">
            <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:14px;height:14px;background:#d1fae5;border-radius:2px;display:inline-block"></span>Low (1‚Äì4)</span>
            <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:14px;height:14px;background:#fef9c3;border-radius:2px;display:inline-block"></span>Medium (5‚Äì9)</span>
            <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:14px;height:14px;background:#ffedd5;border-radius:2px;display:inline-block"></span>High (10‚Äì14)</span>
            <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:14px;height:14px;background:#fee2e2;border-radius:2px;display:inline-block"></span>Critical (15‚Äì25)</span>
          </div>
        </div>
      </div>

      <!-- TOP 10 TAB -->
      <div x-show="riskTab==='top10'">
        <div class="chart-card p-4" style="max-width:700px">
          <div style="height:320px"><canvas id="top10Chart"></canvas></div>
        </div>
      </div>

      <!-- TREND TAB -->
      <div x-show="riskTab==='trend'">
        <div class="chart-card p-4" style="max-width:800px">
          <div class="flex gap-3 items-center mb-4">
            <label class="form-label mb-0" x-text="t('selectRisk')"></label>
            <select class="form-select" style="max-width:300px" x-model="riskTrendId" @change="loadRiskTrend()">
              <option value="" x-text="t('selectOption')"></option>
              <template x-for="r in risks" :key="r.id">
                <option :value="r.id" x-text="'R-' + String(r.id).padStart(3,'0') + ' ' + r.title"></option>
              </template>
            </select>
          </div>
          <div style="height:280px"><canvas id="trendChart"></canvas></div>
        </div>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- ISSUE TRACKER VIEW -->
    <!-- ============================================================ -->
    <div x-show="view === 'issues'" class="p-6 space-y-4">
      <div class="filter-bar" style="background:transparent;border:none;padding:0">
        <select x-model="issueFilters.status" class="form-select" style="width:160px">
          <option value="" x-text="t('allStatuses')"></option>
          <option>Open</option><option>In progress</option><option>Escalated</option><option>Resolved</option><option>Closed</option>
        </select>
        <select x-model="issueFilters.severity" class="form-select" style="width:140px">
          <option value="" x-text="t('allSeverities')"></option>
          <option>Critical</option><option>High</option><option>Medium</option><option>Low</option>
        </select>
        <select x-model="issueFilters.type" class="form-select" style="width:160px">
          <option value="" x-text="t('allTypes')"></option>
          <option>Bug</option><option>Operational</option><option>Blocking</option><option>Financial</option><option>Compliance</option><option>Timing</option>
        </select>
        <button class="btn-ghost btn-sm" @click="issueFilters={status:'',severity:'',type:''}" x-text="t('resetFilters')"></button>
      </div>
      <div class="chart-card">
        <div class="table-scroll" style="max-height:calc(100vh - 260px)">
          <table class="data-table">
            <thead>
              <tr>
                <th style="width:50px">ID</th>
                <th x-text="t('colName')"></th>
                <th style="width:100px" x-text="t('issueType')"></th>
                <th style="width:90px" x-text="t('issueSeverity')"></th>
                <th style="width:90px" x-text="t('issuePriority')"></th>
                <th style="width:90px" x-text="t('status')"></th>
                <th style="width:110px" x-text="t('owner')"></th>
                <th style="width:100px" x-text="t('dueDate')"></th>
                <th style="width:130px" x-text="t('linkedRisk')"></th>
                <th style="width:80px" x-text="t('colActions')"></th>
              </tr>
            </thead>
            <tbody>
              <template x-if="!filteredIssues.length">
                <tr><td colspan="10" class="text-center py-10 text-gray-400"><span x-text="t('noIssues')"></span></td></tr>
              </template>
              <template x-for="iss in filteredIssues" :key="iss.id">
                <tr>
                  <td class="font-mono text-xs text-gray-400" x-text="'I-' + String(iss.id).padStart(3,'0')"></td>
                  <td>
                    <div class="font-semibold" x-text="iss.title"></div>
                    <div x-show="iss.rootCause" class="text-xs text-gray-400" x-text=t('rootCauseLabel') + ' ' + (iss.rootCause?.slice(0,60) ?? '')"></div>
                  </td>
                  <td><span class="badge badge-blue" x-text="iss.type"></span></td>
                  <td><span class="badge" :class="severityBadge(iss.severity)" x-text="iss.severity"></span></td>
                  <td><span class="badge" :class="severityBadge(iss.priority)" x-text="iss.priority"></span></td>
                  <td><span class="badge" :class="issueStatusBadge(iss.status)" x-text="iss.status"></span></td>
                  <td x-text="iss.owner?.name ?? '‚Äî'"></td>
                  <td class="text-xs" :class="iss.dueDate && new Date(iss.dueDate) < new Date() ? 'deadline-urgent' : ''" x-text="iss.dueDate ? fmtDate(iss.dueDate) : '‚Äî'"></td>
                  <td class="text-xs" x-text="iss.linkedRisk ? ('R-' + String(iss.linkedRisk.id).padStart(3,'0') + ' ' + iss.linkedRisk.title.slice(0,20)) : '‚Äî'"></td>
                  <td>
                    <button x-show="can('issues','write')" class="btn-icon" @click="openEditIssue(iss)" :title="t('edit')">‚úèÔ∏è</button>
                    <button x-show="can('issues','write')" class="btn-icon" @click="deleteIssue(iss.id)" :title="t('delete')" style="color:#D40511">üóë</button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- CHANGE MANAGEMENT VIEW -->
    <!-- ============================================================ -->
    <div x-show="view === 'changes'" class="p-6 space-y-4">
      <div class="filter-bar" style="background:transparent;border:none;padding:0">
        <select x-model="changeFilters.approvalStatus" class="form-select" style="width:180px">
          <option value="" x-text="t('allStatuses')"></option>
          <option>Draft</option><option>Submitted</option><option>Approved</option><option>Rejected</option><option>Implemented</option>
        </select>
        <select x-model="changeFilters.changeType" class="form-select" style="width:160px">
          <option value="" x-text="t('allTypes')"></option>
          <option>Scope</option><option>Budget</option><option>Timeline</option><option>Technical</option>
        </select>
        <button class="btn-ghost btn-sm" @click="changeFilters={approvalStatus:'',changeType:''}" x-text="t('resetFilters')"></button>
      </div>
      <div class="chart-card">
        <div class="table-scroll" style="max-height:calc(100vh - 260px)">
          <table class="data-table">
            <thead>
              <tr>
                <th style="width:50px">ID</th>
                <th x-text="t('colName')"></th>
                <th style="width:100px" x-text="t('changeType')"></th>
                <th style="width:110px" x-text="t('budgetImpact')"></th>
                <th style="width:120px" x-text="t('approvalStatus')"></th>
                <th style="width:120px" x-text="t('requestedBy')"></th>
                <th style="width:120px" x-text="t('approvedBy')"></th>
                <th style="width:80px" x-text="t('colActions')"></th>
              </tr>
            </thead>
            <tbody>
              <template x-if="!filteredChanges.length">
                <tr><td colspan="8" class="text-center py-10 text-gray-400"><span x-text="t('noChanges')"></span></td></tr>
              </template>
              <template x-for="cr in filteredChanges" :key="cr.id">
                <tr>
                  <td class="font-mono text-xs text-gray-400" x-text="'CR-' + String(cr.id).padStart(3,'0')"></td>
                  <td>
                    <div class="font-semibold" x-text="cr.title"></div>
                    <div x-show="cr.description" class="text-xs text-gray-400" x-text="cr.description?.slice(0,70)"></div>
                  </td>
                  <td><span class="badge badge-purple" x-text="cr.changeType"></span></td>
                  <td class="font-mono text-right" :class="(cr.budgetImpact ?? 0) > 0 ? 'text-red-600 font-bold' : ''"
                    x-text="cr.budgetImpact ? fmtMoney(cr.budgetImpact) : '‚Äî'"></td>
                  <td><span class="badge" :class="crStatusBadge(cr.approvalStatus)" x-text="cr.approvalStatus"></span></td>
                  <td x-text="cr.requestedBy?.name ?? '‚Äî'"></td>
                  <td x-text="cr.approvedBy?.name ?? '‚Äî'"></td>
                  <td>
                    <button x-show="can('changes','write')" class="btn-icon" @click="openEditChange(cr)" :title="t('edit')">‚úèÔ∏è</button>
                    <button x-show="can('changes','write')" class="btn-icon" @click="deleteChange(cr.id)" :title="t('delete')" style="color:#D40511">üóë</button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ASSUMPTION LOG VIEW -->
    <!-- ============================================================ -->
    <div x-show="view === 'assumptions'" class="p-6 space-y-4">
      <!-- Tabs -->
      <div class="flex gap-2 border-b border-gray-200 pb-1 mb-2">
        <button @click="assumptionTab='list'"   :class="assumptionTab==='list'   ? 'tab-active' : 'tab'" class="tab" x-text="t('assumptionListTab')"></button>
        <button @click="assumptionTab='dashboard'" :class="assumptionTab==='dashboard' ? 'tab-active' : 'tab'" class="tab" x-text="t('testDashboard')"></button>
      </div>

      <!-- LIST TAB -->
      <template x-if="assumptionTab === 'list'">
        <div class="space-y-3">
          <!-- Filter bar -->
          <div class="flex gap-2 flex-wrap">
            <select x-model="assumptionFilters.status" class="filter-select" style="min-width:140px">
              <option value="" x-text="t('allStatuses')"></option>
              <option>Active</option><option>Under review</option><option>Validated</option>
              <option>Invalid</option><option>Converted to Risk</option><option>Closed</option>
            </select>
            <select x-model="assumptionFilters.category" class="filter-select" style="min-width:130px">
              <option value="" x-text="t('allCategories')"></option>
              <option>Finance</option><option>Scope</option><option>Resource</option>
              <option>Vendor</option><option>Client</option><option>IT</option>
            </select>
            <select x-model="assumptionFilters.phase" class="filter-select" style="min-width:140px">
              <option value="" x-text="t('allPhases')"></option>
              <option>Design</option><option>Tender</option><option>Implementation</option><option>Go-live</option>
            </select>
            <span class="text-xs text-gray-400 self-center ml-2" x-text="filteredAssumptions.length + ' ' + t('records')"></span>
          </div>

          <div class="chart-card p-0">
            <div class="table-scroll">
              <table class="data-table">
                <thead>
                  <tr>
                    <th style="width:70px">Code</th>
                    <th x-text="t('colName')"></th>
                    <th x-text="t('category')"></th>
                    <th x-text="t('phase')"></th>
                    <th x-text="t('type')"></th>
                    <th x-text="t('status')"></th>
                    <th x-text="t('ownerLabel')"></th>
                    <th>Exposure</th>
                    <th x-text="t('validationDate')"></th>
                    <th style="width:80px" x-text="t('colActions')"></th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="a in filteredAssumptions" :key="a.id">
                    <tr>
                      <td style="font-family:monospace;font-weight:700;color:#666" x-text="a.code"></td>
                      <td>
                        <div style="font-weight:600" x-text="a.title"></div>
                        <div x-show="a.isLocked" style="font-size:10px;color:#22c55e;font-weight:700" x-text="t('locked')"></div>
                        <div x-show="a.convertedRiskId" style="font-size:10px;color:#ef4444"><span x-text="t('linkedRiskLabel')"></span><span x-text="a.convertedRiskId"></span></div>
                      </td>
                      <td><span class="status-badge" style="background:#e0e7ff;color:#3730a3" x-text="a.category"></span></td>
                      <td x-text="a.phase"></td>
                      <td x-text="a.type"></td>
                      <td><span :class="assumptionStatusBadge(a.status)" x-text="a.status"></span></td>
                      <td x-text="a.owner?.name ?? '‚Äî'"></td>
                      <td>
                        <span :style="'background:' + exposureColor(a.exposureScore) + ';color:white;padding:2px 8px;border-radius:10px;font-size:12px;font-weight:700'"
                          x-text="a.exposureScore"></span>
                      </td>
                      <td>
                        <span x-show="a.validationDate"
                          :style="isOverdue(a.validationDate, a.status) ? 'color:#ef4444;font-weight:700' : ''"
                          x-text="a.validationDate ? a.validationDate.slice(0,10) : '‚Äî'"></span>
                        <span x-show="!a.validationDate" style="color:#aaa">‚Äî</span>
                      </td>
                      <td>
                        <button x-show="can('assumptions','write')" class="btn-icon" @click="openEditAssumption(a)" :title="t('edit')">‚úèÔ∏è</button>
                        <button x-show="can('assumptions','write')" class="btn-icon" @click="deleteAssumption(a.id)" :title="t('delete')" style="color:#D40511">üóë</button>
                      </td>
                    </tr>
                  </template>
                  <template x-if="!filteredAssumptions.length">
                    <tr><td colspan="10" style="text-align:center;color:#aaa;padding:32px"><span x-text="t('noAssumptions')"></span></td></tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </template>

      <!-- DASHBOARD TAB -->
      <template x-if="assumptionTab === 'dashboard'">
        <div class="space-y-4">
          <!-- KPI cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="kpi-card blue">
              <div class="kpi-label" x-text="t('totalAssumptions')"></div>
              <div class="kpi-value" x-text="assumptions.length"></div>
              <div class="kpi-sub" x-text="t('validated') + ' ' + assumptions.filter(a=>a.status==='Validated'||a.status==='Closed').length + ' / ' + assumptions.length"></div>
            </div>
            <div class="kpi-card" :class="assumptions.filter(a=>['Active','Under review'].includes(a.status)).length > 0 ? '' : 'green'">
              <div class="kpi-label" x-text="t('pctValidated')"></div>
              <div class="kpi-value" x-text="assumptions.length > 0 ? Math.round(assumptions.filter(a=>a.status==='Validated'||a.status==='Closed').length / assumptions.length * 100) + ' %' : '‚Äî'"></div>
              <div class="kpi-sub" x-text="t('ofAllAssumptions')"></div>
            </div>
            <div class="kpi-card" :class="assumptions.filter(a=>['Active','Under review'].includes(a.status) && a.validationDate && new Date(a.validationDate) < new Date()).length > 0 ? 'red' : 'green'">
              <div class="kpi-label" x-text="t('overdueValidation')"></div>
              <div class="kpi-value" x-text="assumptions.filter(a=>['Active','Under review'].includes(a.status) && a.validationDate && new Date(a.validationDate) < new Date()).length"></div>
              <div class="kpi-sub" x-text="t('activeNoValidation')"></div>
            </div>
            <div class="kpi-card" :class="assumptions.filter(a=>['Active','Under review'].includes(a.status) && a.validationDate && new Date(a.validationDate) <= new Date(Date.now()+14*864e5) && new Date(a.validationDate) >= new Date()).length > 0 ? '' : 'green'">
              <div class="kpi-label" x-text="t('expiresIn14')"></div>
              <div class="kpi-value" x-text="assumptions.filter(a=>['Active','Under review'].includes(a.status) && a.validationDate && new Date(a.validationDate) <= new Date(Date.now()+14*864e5) && new Date(a.validationDate) >= new Date()).length"></div>
              <div class="kpi-sub" x-text="t('upcomingDeadline')"></div>
            </div>
          </div>

          <!-- Top 5 by exposure -->
          <div class="chart-card">
            <div class="chart-header"><span x-text="t('top5RiskyTitle')"></span></div>
            <div style="padding:16px">
              <template x-for="(a, i) in [...assumptions].filter(x=>x.status==='Active'||x.status==='Under review').sort((a,b)=>b.exposureScore-a.exposureScore).slice(0,5)" :key="a.id">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                  <div style="font-size:13px;font-weight:700;color:#aaa;width:20px" x-text="i+1"></div>
                  <div style="flex:1;min-width:0">
                    <div style="font-size:12px;font-weight:700;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" x-text="a.code + ' ‚Äî ' + a.title"></div>
                    <div style="font-size:11px;color:#666" x-text="a.category + ' ¬∑ ' + a.phase"></div>
                  </div>
                  <div style="width:160px">
                    <div style="background:#f0f0f0;border-radius:4px;height:14px;overflow:hidden">
                      <div :style="'width:' + Math.round(a.exposureScore/15*100) + '%;height:100%;background:' + exposureColor(a.exposureScore) + ';border-radius:4px'" ></div>
                    </div>
                  </div>
                  <div :style="'background:' + exposureColor(a.exposureScore) + ';color:white;padding:2px 10px;border-radius:10px;font-weight:700;font-size:12px;min-width:32px;text-align:center'" x-text="a.exposureScore"></div>
                </div>
              </template>
              <template x-if="!assumptions.filter(x=>x.status==='Active'||x.status==='Under review').length">
                <div style="color:#aaa;text-align:center;padding:24px 0;font-size:13px" x-text="t('noActiveAssumptions')"></div>
              </template>
            </div>
          </div>

          <!-- By category/status breakdown -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="chart-card">
              <div class="chart-header"><span x-text="t('assumptionsByStatus')"></span></div>
              <div style="padding:16px">
                <template x-for="st in ['Active','Under review','Validated','Invalid','Converted to Risk','Closed']" :key="st">
                  <div x-show="assumptions.filter(a=>a.status===st).length > 0" style="display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-bottom:1px solid #f5f5f5;font-size:13px">
                    <span><span :class="assumptionStatusBadge(st)" x-text="st"></span></span>
                    <span style="font-weight:700" x-text="assumptions.filter(a=>a.status===st).length"></span>
                  </div>
                </template>
              </div>
            </div>
            <div class="chart-card">
              <div class="chart-header"><span x-text="t('assumptionsByCategory')"></span></div>
              <div style="padding:16px">
                <template x-for="cat in ['Finance','Scope','Resource','Vendor','Client','IT']" :key="cat">
                  <div x-show="assumptions.filter(a=>a.category===cat).length > 0" style="display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-bottom:1px solid #f5f5f5;font-size:13px">
                    <span><span class="status-badge" style="background:#e0e7ff;color:#3730a3" x-text="cat"></span></span>
                    <span style="font-weight:700" x-text="assumptions.filter(a=>a.category===cat).length"></span>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <!-- PALLET STORAGE CALCULATION VIEW -->
    <!-- ============================================================ -->
    <div x-show="view === 'pallet-calc'" style="height:100%;display:flex;flex-direction:column;padding:0">
      <iframe src="/pallet-calculator.html" style="flex:1;border:none;width:100%;height:100%"></iframe>
    </div>

    <!-- PROJECT PLAN VIEW -->
    <!-- ============================================================ -->
    <div x-show="view === 'projectplan'" class="p-6" style="overflow:auto;max-height:calc(100vh - 60px)">
      <h2 class="text-xl font-bold mb-4" x-text="t('titleProjectPlan')"></h2>

      <!-- Toolbar -->
      <div class="pp-toolbar">
        <button class="btn-sm" :class="{ active: ppTab === 'table' }" @click="ppTab = 'table'" x-text="t('ppTableView')"></button>
        <button class="btn-sm" :class="{ active: ppTab === 'gantt' }" @click="ppTab = 'gantt'; $nextTick(() => renderPPGantt())" x-text="t('ppGanttView')"></button>
        <span style="width:1px;height:20px;background:#ddd;margin:0 4px"></span>
        <button x-show="can('projectplan','write')" class="btn-sm" @click="openNewTask('phase')" x-text="t('ppNewPhase')"></button>
        <button x-show="can('projectplan','write')" class="btn-sm" @click="openNewTask('task')" x-text="t('ppNewTask')"></button>
        <span style="width:1px;height:20px;background:#ddd;margin:0 4px"></span>
        <button x-show="ppTab === 'table'" class="btn-sm" @click="ppExpandAll()" x-text="t('ppExpandAll')"></button>
        <button x-show="ppTab === 'table'" class="btn-sm" @click="ppCollapseAll()" x-text="t('ppCollapseAll')"></button>
        <button x-show="can('projectplan','write')" class="btn-sm" @click="calcCriticalPath()" x-text="t('ppCalcCritPath')"></button>
        <button x-show="can('projectplan','write')" class="btn-sm" @click="saveAllBaselines()" x-text="t('ppSaveAllBaselines')"></button>
        <button class="btn-sm" @click="exportTasksJson()" x-text="t('ppExportJson')"></button>
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;margin-left:8px;cursor:pointer">
          <input type="checkbox" x-model="ppWorkDays"> <span x-text="t('ppWorkDaysToggle')"></span>
        </label>
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;margin-left:auto;cursor:pointer">
          <input type="checkbox" x-model="showArchived" @change="loadTasks()"> <span x-text="t('ppShowArchived')"></span>
        </label>
      </div>

      <!-- Filters -->
      <div class="pp-toolbar" style="gap:6px">
        <select x-model="ppFilters.status" @change="loadTasks()" style="font-size:12px;padding:4px 8px;border:1px solid #ddd;border-radius:4px">
          <option value="" x-text="t('ppAllStatuses')"></option>
          <option value="not_started" x-text="t('statusNotStarted')"></option>
          <option value="in_progress" x-text="t('statusInProgress')"></option>
          <option value="done" x-text="t('statusDone')"></option>
          <option value="blocked" x-text="t('statusBlocked')"></option>
          <option value="unscheduled" x-text="t('statusUnscheduled')"></option>
        </select>
        <select x-model="ppFilters.type" @change="loadTasks()" style="font-size:12px;padding:4px 8px;border:1px solid #ddd;border-radius:4px">
          <option value="" x-text="t('ppAllTypes')"></option>
          <option value="phase" x-text="t('typePhase')"></option>
          <option value="workstream" x-text="t('typeWorkstream')"></option>
          <option value="task" x-text="t('typeTask')"></option>
        </select>
        <select x-model="ppFilters.ownerId" @change="loadTasks()" style="font-size:12px;padding:4px 8px;border:1px solid #ddd;border-radius:4px">
          <option value="" x-text="t('ppAllOwners')"></option>
          <template x-for="p in people" :key="p.id"><option :value="p.id" x-text="p.name"></option></template>
        </select>
        <input type="text" x-model="ppFilters.search" @input.debounce.300ms="loadTasks()" :placeholder="t('search')" style="font-size:12px;padding:4px 8px;border:1px solid #ddd;border-radius:4px;width:180px">
      </div>

      <!-- TABLE VIEW -->
      <div x-show="ppTab === 'table'">
        <div x-show="filteredTasks().length === 0" class="text-center py-12 text-gray-400" x-text="t('ppNoTasks')"></div>
        <div x-show="filteredTasks().length > 0">
          <!-- Header -->
          <div class="pp-header-row">
            <div style="width:28px"></div>
            <div class="task-name" x-text="t('ppTaskName')"></div>
            <div class="cell" x-text="t('ppTaskType')"></div>
            <div class="cell" x-text="t('ppOwner')"></div>
            <div class="cell" x-text="t('ppStatus')"></div>
            <div class="cell-sm" x-text="t('ppProgress')"></div>
            <div class="cell-lg" x-text="t('ppPlannedStart')"></div>
            <div class="cell-lg" x-text="t('ppPlannedEnd')"></div>
            <div class="cell-sm" x-text="ppWorkDays ? t('ppDurationWork') : t('ppDuration')"></div>
            <div class="cell-sm" x-text="t('ppFloat')"></div>
            <div class="cell-sm" x-text="t('ppCriticalPath')"></div>
            <div class="cell" x-text="t('ppLinkedRisk')"></div>
          </div>
          <!-- Rows -->
          <template x-for="node in taskTreeFlat()" :key="node.id">
            <div class="pp-tree-row"
              :class="{ phase: node.type==='phase', workstream: node.type==='workstream', critical: node.isCriticalPath, 'archived-row': node.archived }"
              :style="'padding-left:' + (node._level * 24 + 8) + 'px'"
              @click="openEditTask(node)">
              <div class="expand-btn" @click.stop="toggleExpand(node.id)"
                x-show="node._hasChildren"
                x-text="expandedTasks[node.id] ? '‚ñº' : '‚ñ∂'"></div>
              <div class="expand-btn" x-show="!node._hasChildren">&nbsp;</div>
              <div class="task-name">
                <span x-show="node.isMilestone" class="pp-milestone" title="Milestone">‚ô¶ </span>
                <span x-text="node.name"></span>
              </div>
              <div class="cell"><span x-text="t('type'+node.type.charAt(0).toUpperCase()+node.type.slice(1))"></span></div>
              <div class="cell" x-text="node.owner?.name || '‚Äî'"></div>
              <div class="cell">
                <span style="font-size:11px;padding:2px 8px;border-radius:10px;font-weight:600"
                  :style="node.status==='done'?'background:#dcfce7;color:#166534':node.status==='in_progress'?'background:#dbeafe;color:#1e40af':node.status==='blocked'?'background:#fee2e2;color:#991b1b':node.status==='unscheduled'?'background:#fef3c7;color:#92400e':'background:#f3f4f6;color:#374151'"
                  x-text="t('status'+node.status.split('_').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(''))"></span>
              </div>
              <div class="cell-sm">
                <div class="pp-progress-bar"><div class="pp-progress-fill" :style="'width:'+node.progress+'%'"></div></div>
                <span style="font-size:10px;margin-left:3px" x-text="node.progress+'%'"></span>
              </div>
              <div class="cell-lg" x-text="node.plannedStart ? node.plannedStart.slice(0,10) : '‚Äî'"></div>
              <div class="cell-lg" x-text="node.plannedEnd ? node.plannedEnd.slice(0,10) : '‚Äî'"></div>
              <div class="cell-sm" x-text="ppWorkDays ? (node.durationWorkDays ?? '‚Äî') : (node.durationDays ?? '‚Äî')"></div>
              <div class="cell-sm" x-text="node.floatDays ?? '‚Äî'"></div>
              <div class="cell-sm" x-text="node.isCriticalPath ? '‚óè' : ''"></div>
              <div class="cell" style="font-size:11px;color:#b45309" x-text="node.linkedRiskId ? (risks.find(r=>r.id===node.linkedRiskId)?.title || '‚ö† #'+node.linkedRiskId) : ''"></div>
            </div>
          </template>
        </div>
      </div>

      <!-- GANTT VIEW -->
      <div x-show="ppTab === 'gantt'">
        <div class="pp-toolbar" style="margin-bottom:8px">
          <button class="btn-sm" :class="{ active: ganttZoom === 'month' }" @click="ganttZoom='month'; $nextTick(() => renderPPGantt())" x-text="t('ppGanttZoomMonth')"></button>
          <button class="btn-sm" :class="{ active: ganttZoom === 'week' }" @click="ganttZoom='week'; $nextTick(() => renderPPGantt())" x-text="t('ppGanttZoomWeek')"></button>
        </div>
        <div x-show="ganttTasks().length === 0" class="text-center py-12 text-gray-400" x-text="t('ppGanttNoData')"></div>
        <div id="pp-gantt-container" class="gantt-container" x-show="ganttTasks().length > 0"></div>
      </div>
    </div>

    <!-- KANBAN VIEW -->
    <!-- ============================================================ -->
    <div x-show="view === 'kanban'" style="padding:16px;overflow:hidden;height:calc(100vh - 60px);display:flex;flex-direction:column">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-shrink:0">
        <h2 class="text-xl font-bold" x-text="t('titleKanban')"></h2>
        <button x-show="authUser?.role === 'admin' || authUser?.role === 'superadmin'" class="btn-sm" style="padding:5px 12px;font-size:12px;border-radius:4px;cursor:pointer;border:1px solid #ddd;background:#fff;font-weight:600" @click="openKanbanColumnModal()" x-text="t('kbManageColumns')"></button>
      </div>
      <div class="kb-board" style="flex:1">
        <template x-for="col in kanbanColumns" :key="col.id">
          <div class="kb-col"
            @dragover.prevent="$el.querySelector('.kb-col-body').classList.add('drag-over')"
            @dragleave="$el.querySelector('.kb-col-body').classList.remove('drag-over')"
            @drop.prevent="dropKanbanCard($event, col.id); $el.querySelector('.kb-col-body').classList.remove('drag-over')">
            <div class="kb-col-header" :style="'border-bottom-color:'+col.color">
              <span x-text="col.name"></span>
              <span class="kb-count" x-text="'('+kanbanColTasks(col.id).length+')'"></span>
              <span x-show="col.wipLimit && kanbanColTasks(col.id).length > col.wipLimit" class="kb-wip-warn" x-text="'WIP!'"></span>
            </div>
            <div class="kb-col-body">
              <template x-for="task in kanbanColTasks(col.id)" :key="task.id">
                <div class="kb-card" :class="{ critical: task.isCriticalPath, milestone: task.isMilestone }"
                  draggable="true"
                  @dragstart="$event.dataTransfer.setData('text/plain', task.id)"
                  @click="openEditTask(task)">
                  <div class="kb-card-title" x-text="task.name"></div>
                  <div class="kb-card-meta">
                    <span x-show="task.owner" class="kb-owner" x-text="(task.owner?.name||'').charAt(0).toUpperCase()"></span>
                    <span x-text="t('status'+task.status.split('_').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(''))"></span>
                    <span x-show="task.isMilestone" class="pp-milestone">‚ô¶</span>
                    <span x-show="task.linkedRiskId" style="color:#b45309;font-size:10px" x-text="'‚ö† ' + (risks.find(r=>r.id===task.linkedRiskId)?.title || '').slice(0,20)"></span>
                  </div>
                  <div class="kb-card-progress" x-show="task.progress > 0">
                    <div class="pp-progress-bar" style="width:100%"><div class="pp-progress-fill" :style="'width:'+task.progress+'%'"></div></div>
                  </div>
                </div>
              </template>
              <div x-show="kanbanColTasks(col.id).length === 0" style="text-align:center;padding:16px;font-size:12px;color:#aaa" x-text="t('kbNoTasks')"></div>
            </div>
            <!-- Quick add -->
            <div class="kb-quick-add" x-show="can('projectplan','write')">
              <div x-show="!kanbanQuickAdd[col.id]" style="text-align:center">
                <button style="font-size:12px;color:#888;cursor:pointer;background:none;border:none" @click="kanbanQuickAdd[col.id] = true" x-text="t('kbAddCard')"></button>
              </div>
              <div x-show="kanbanQuickAdd[col.id]">
                <input :placeholder="t('kbQuickAddPlaceholder')" @keydown.enter="quickAddKanbanTask(col.id, $event.target); $event.target.value=''" @keydown.escape="kanbanQuickAdd[col.id] = false" x-ref="'kb-add-'+col.id">
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- TASK MODAL -->
    <!-- ============================================================ -->
    <div x-show="taskModal.open" class="modal-overlay" @click.self="taskModal.open=false" style="display:flex;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000">
      <div style="background:#fff;border-radius:10px;width:780px;max-height:90vh;overflow-y:auto;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,0.2)">
        <h3 class="text-lg font-bold mb-4" x-text="taskModal.id ? t('ppModalEditTask') : t('ppModalNewTask')"></h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <!-- LEFT COLUMN -->
          <div style="display:flex;flex-direction:column;gap:10px">
            <div>
              <label class="detail-field-label" x-text="t('ppModalTaskName')"></label>
              <input x-model="taskForm.name" :placeholder="t('ppModalTaskNamePlaceholder')" class="w-full" style="padding:6px 10px;border:1px solid #ddd;border-radius:4px;font-size:13px">
            </div>
            <div>
              <label class="detail-field-label" x-text="t('ppModalDescription')"></label>
              <textarea x-model="taskForm.description" :placeholder="t('ppModalDescPlaceholder')" rows="3" style="width:100%;padding:6px 10px;border:1px solid #ddd;border-radius:4px;font-size:13px;resize:vertical"></textarea>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div>
                <label class="detail-field-label" x-text="t('ppModalType')"></label>
                <select x-model="taskForm.type" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:13px">
                  <option value="phase" x-text="t('typePhase')"></option>
                  <option value="workstream" x-text="t('typeWorkstream')"></option>
                  <option value="task" x-text="t('typeTask')"></option>
                </select>
              </div>
              <div>
                <label class="detail-field-label" x-text="t('ppModalParent')"></label>
                <select x-model="taskForm.parentId" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:13px">
                  <option :value="null" x-text="t('ppModalParentNone')"></option>
                  <template x-for="pt in tasks.filter(t => t.id !== taskModal.id && (t.type==='phase' || t.type==='workstream'))" :key="pt.id">
                    <option :value="pt.id" x-text="(pt.type==='phase'?'[F] ':'[W] ') + pt.name"></option>
                  </template>
                </select>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div>
                <label class="detail-field-label" x-text="t('ppModalOwner')"></label>
                <select x-model="taskForm.ownerId" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:13px">
                  <option value="">‚Äî</option>
                  <template x-for="p in people" :key="p.id"><option :value="p.id" x-text="p.name"></option></template>
                </select>
              </div>
              <div style="display:flex;align-items:flex-end;padding-bottom:4px">
                <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer">
                  <input type="checkbox" x-model="taskForm.isMilestone"> <span x-text="t('ppModalMilestone')"></span>
                </label>
              </div>
            </div>
          </div>

          <!-- RIGHT COLUMN -->
          <div style="display:flex;flex-direction:column;gap:10px">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div>
                <label class="detail-field-label" x-text="t('ppStatus')"></label>
                <select x-model="taskForm.status" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:13px">
                  <option value="not_started" x-text="t('statusNotStarted')"></option>
                  <option value="in_progress" x-text="t('statusInProgress')"></option>
                  <option value="done" x-text="t('statusDone')"></option>
                  <option value="blocked" x-text="t('statusBlocked')"></option>
                  <option value="unscheduled" x-text="t('statusUnscheduled')"></option>
                </select>
              </div>
              <div>
                <label class="detail-field-label" x-text="t('ppProgress')"></label>
                <div style="display:flex;align-items:center;gap:6px">
                  <input type="range" min="0" max="100" step="5" x-model.number="taskForm.progress" style="flex:1">
                  <span style="font-size:12px;width:35px;text-align:right" x-text="taskForm.progress+'%'"></span>
                </div>
              </div>
            </div>
            <div class="detail-field-label" x-text="t('ppModalPlanning')"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div>
                <label class="detail-field-label" x-text="t('ppPlannedStart')"></label>
                <input type="date" x-model="taskForm.plannedStart" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:13px">
              </div>
              <div>
                <label class="detail-field-label" x-text="t('ppPlannedEnd')"></label>
                <input type="date" x-model="taskForm.plannedEnd" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:13px">
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div>
                <label class="detail-field-label" x-text="t('ppModalCost')"></label>
                <input type="number" x-model="taskForm.estimatedCost" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:13px">
              </div>
              <div>
                <label class="detail-field-label" x-text="t('ppDuration')"></label>
                <div style="padding:8px 0;font-size:13px;color:#666" x-text="calcModalDuration()"></div>
              </div>
            </div>

            <!-- Links -->
            <div class="detail-field-label" x-text="t('ppModalLinks')"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div>
                <label class="detail-field-label" x-text="t('ppModalLinkedRisk')"></label>
                <select x-model="taskForm.linkedRiskId" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:12px">
                  <option value="" x-text="t('ppModalLinkNone')"></option>
                  <template x-for="r in risks" :key="r.id"><option :value="r.id" x-text="r.title"></option></template>
                </select>
              </div>
              <div>
                <label class="detail-field-label" x-text="t('ppModalLinkedAssumption')"></label>
                <select x-model="taskForm.linkedAssumptionId" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:12px">
                  <option value="" x-text="t('ppModalLinkNone')"></option>
                  <template x-for="a in assumptions" :key="a.id"><option :value="a.id" x-text="a.title"></option></template>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Dependencies section -->
        <div style="margin-top:16px;border-top:1px solid #eee;padding-top:12px">
          <div class="detail-field-label" x-text="t('ppModalDeps')"></div>
          <template x-for="dep in taskDeps" :key="dep.id">
            <div style="display:flex;align-items:center;gap:8px;margin:4px 0;font-size:12px">
              <span x-text="tasks.find(t=>t.id===dep.predecessorId)?.name || '#'+dep.predecessorId"></span>
              <span style="color:#888" x-text="dep.type"></span>
              <span x-show="dep.lagDays" style="color:#888" x-text="'lag: '+dep.lagDays+'d'"></span>
              <button x-show="can('projectplan','write')" @click="removeDep(dep.id)" style="color:#ef4444;background:none;border:none;cursor:pointer;font-size:11px" x-text="t('ppModalRemoveDep')"></button>
            </div>
          </template>
          <div x-show="taskModal.id && can('projectplan','write')" style="display:flex;align-items:center;gap:6px;margin-top:6px">
            <select x-model="taskDepsNew.predecessorId" style="flex:1;padding:4px 6px;border:1px solid #ddd;border-radius:4px;font-size:12px">
              <option value="" x-text="t('ppModalPredecessor')"></option>
              <template x-for="pt in tasks.filter(t => t.id !== taskModal.id)" :key="pt.id"><option :value="pt.id" x-text="pt.name"></option></template>
            </select>
            <select x-model="taskDepsNew.type" style="width:60px;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:12px">
              <option>FS</option><option>FF</option><option>SS</option><option>SF</option>
            </select>
            <input type="number" x-model.number="taskDepsNew.lagDays" style="width:50px;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:12px" placeholder="Lag">
            <button @click="addDep()" class="btn-sm" x-text="t('ppModalAddDep')"></button>
          </div>
        </div>

        <!-- Footer -->
        <div style="margin-top:20px;display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:6px">
            <button x-show="taskModal.id && can('projectplan','write') && !tasks.find(t=>t.id===taskModal.id)?.archived" @click="archiveTask(taskModal.id)" style="padding:6px 14px;background:#fee2e2;color:#991b1b;border:none;border-radius:4px;font-size:12px;cursor:pointer" x-text="t('ppModalArchiveTask')"></button>
            <button x-show="taskModal.id && authUser?.role==='superadmin' && tasks.find(t=>t.id===taskModal.id)?.archived" @click="restoreTask(taskModal.id)" style="padding:6px 14px;background:#dcfce7;color:#166534;border:none;border-radius:4px;font-size:12px;cursor:pointer" x-text="t('ppModalRestoreTask')"></button>
            <button x-show="taskModal.id && authUser?.role==='superadmin'" @click="deleteTaskPermanent(taskModal.id)" style="padding:6px 14px;background:#dc2626;color:#fff;border:none;border-radius:4px;font-size:12px;cursor:pointer" x-text="t('ppModalDeletePermanent')"></button>
          </div>
          <div style="display:flex;gap:8px">
            <button @click="taskModal.open=false" style="padding:6px 16px;border:1px solid #ddd;border-radius:4px;font-size:13px;cursor:pointer">Cancel</button>
            <button x-show="can('projectplan','write')" @click="saveTask()" style="padding:6px 16px;background:var(--dhl-yellow);border:none;border-radius:4px;font-size:13px;font-weight:600;cursor:pointer" x-text="t('ppModalSaveTask')"></button>
          </div>
        </div>
      </div>
    </div>

    <!-- KANBAN COLUMN MANAGEMENT MODAL -->
    <div x-show="kanbanColumnModal.open" class="modal-overlay" @click.self="kanbanColumnModal.open=false" style="display:flex;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000">
      <div style="background:#fff;border-radius:10px;width:500px;max-height:80vh;overflow-y:auto;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,0.2)">
        <h3 class="text-lg font-bold mb-4" x-text="t('kbManageColumns')"></h3>
        <template x-for="(col, idx) in kanbanColumnForm" :key="idx">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <input type="text" x-model="col.name" :placeholder="t('kbColumnName')" style="flex:1;padding:6px 8px;border:1px solid #ddd;border-radius:4px;font-size:13px">
            <input type="color" x-model="col.color" style="width:32px;height:32px;border:none;cursor:pointer;border-radius:4px">
            <input type="number" x-model.number="col.wipLimit" :placeholder="t('kbWipLimit')" style="width:60px;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:12px" min="0">
            <button @click="kanbanColumnForm.splice(idx,1)" style="color:#ef4444;background:none;border:none;cursor:pointer;font-size:16px">&times;</button>
          </div>
        </template>
        <button @click="kanbanColumnForm.push({id:null,name:'',color:'#6B7280',wipLimit:null,sortOrder:kanbanColumnForm.length})" class="btn-sm" style="margin-top:4px" x-text="t('kbAddColumn')"></button>
        <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
          <button @click="kanbanColumnModal.open=false" style="padding:6px 16px;border:1px solid #ddd;border-radius:4px;font-size:13px;cursor:pointer">Cancel</button>
          <button @click="saveKanbanColumns()" style="padding:6px 16px;background:var(--dhl-yellow);border:none;border-radius:4px;font-size:13px;font-weight:600;cursor:pointer" x-text="t('kbSaveColumns')"></button>
        </div>
      </div>
    </div>

    <!-- SETTINGS VIEW -->
    <!-- ============================================================ -->
    <div x-show="view === 'settings'" class="p-6">
      <!-- Tabs -->
      <div class="flex border-b border-gray-200 mb-6">
        <div class="settings-tab" :class="{ active: settingsTab === 'people' }" @click="settingsTab = 'people'" x-text="t('tabPeople')"></div>
        <div class="settings-tab" :class="{ active: settingsTab === 'categories' }" @click="settingsTab = 'categories'" x-text="t('tabCategories')">&nbsp;</div>
        <div class="settings-tab" :class="{ active: settingsTab === 'priorities' }" @click="settingsTab = 'priorities'" x-text="t('tabPriorities')">&nbsp;</div>
        <div class="settings-tab" :class="{ active: settingsTab === 'departments' }" @click="settingsTab = 'departments'" x-text="t('tabDepartments')">&nbsp;</div>
        <div class="settings-tab" :class="{ active: settingsTab === 'currency' }" @click="settingsTab = 'currency'" x-text="t('tabCurrency')">&nbsp;</div>
        <div class="settings-tab" :class="{ active: settingsTab === 'branding' }" @click="settingsTab = 'branding'" x-text="t('tabAppearance')">&nbsp;</div>
        <div class="settings-tab" :class="{ active: settingsTab === 'log' }" @click="settingsTab = 'log'; loadAuditLog()" x-text="t('tabAudit')">&nbsp;</div>
        <div x-show="authUser?.role === 'superadmin'" class="settings-tab" :class="{ active: settingsTab === 'companies' }" @click="settingsTab = 'companies'; loadCompanies(); loadPlans()" x-text="t('tabCompanies')">&nbsp;</div>
        <div x-show="authUser?.role === 'superadmin'" class="settings-tab" :class="{ active: settingsTab === 'plans' }" @click="settingsTab = 'plans'; loadPlans()" x-text="t('tabPlans')">&nbsp;</div>
        <div x-show="authUser?.role === 'superadmin'" class="settings-tab" :class="{ active: settingsTab === 'invoices' }" @click="settingsTab = 'invoices'; loadInvoices()" x-text="t('tabInvoices')">&nbsp;</div>
        <div x-show="authUser?.role === 'superadmin'" class="settings-tab" :class="{ active: settingsTab === 'saas-dashboard' }" @click="settingsTab = 'saas-dashboard'; loadSaasStats()" x-text="t('tabSaas')">&nbsp;</div>
        <div x-show="authUser?.role === 'admin'" class="settings-tab" :class="{ active: settingsTab === 'users' }" @click="settingsTab = 'users'; loadUsers()" x-text="t('tabUsers')">&nbsp;</div>
        <div x-show="authUser?.role === 'admin'" class="settings-tab" :class="{ active: settingsTab === 'projects' || settingsTab === 'project-members' }" @click="settingsTab = 'projects'; loadProjects()" x-text="t('tabProjects')"></div>
        <div class="settings-tab" :class="{ active: settingsTab === 'language' }" @click="settingsTab = 'language'" x-text="t('tabLanguage')"></div>
      </div>

      <!-- Language settings -->
      <div x-show="settingsTab === 'language'" class="max-w-sm">
        <div class="chart-card p-6 space-y-4">
          <h3 class="font-bold text-base" x-text="t('tabLanguage')"></h3>
          <div class="form-group">
            <label class="form-label" x-text="t('languageLabel')"></label>
            <div style="display:flex;gap:12px">
              <button @click="setLang('cs')"
                :style="lang === 'cs' ? 'border:3px solid var(--dhl-yellow);box-shadow:0 3px 10px rgba(0,0,0,0.2)' : 'border:3px solid transparent;opacity:0.55'"
                style="flex:1;padding:16px;border-radius:12px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:8px;background:white;transition:all .2s">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 600" style="width:72px;height:48px;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.15)">
                  <rect width="900" height="300" fill="#fff"/><rect y="300" width="900" height="300" fill="#D7141A"/>
                  <polygon points="0,0 450,300 0,600" fill="#11457E"/>
                </svg>
                <span style="font-size:13px;font-weight:700;color:#333" x-text="t('langCzech')"></span>
              </button>
              <button @click="setLang('en')"
                :style="lang === 'en' ? 'border:3px solid var(--dhl-yellow);box-shadow:0 3px 10px rgba(0,0,0,0.2)' : 'border:3px solid transparent;opacity:0.55'"
                style="flex:1;padding:16px;border-radius:12px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:8px;background:white;transition:all .2s">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" style="width:72px;height:48px;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.15)">
                  <clipPath id="s"><path d="M0,0 v30 h60 v-30 z"/></clipPath>
                  <clipPath id="t"><path d="M30,15 h30 v15 z v15 h-30 z h-30 v-15 z v-15 h30 z"/></clipPath>
                  <g clip-path="url(#s)">
                    <path d="M0,0 v30 h60 v-30 z" fill="#012169"/>
                    <path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/>
                    <path d="M0,0 L60,30 M60,0 L0,30" clip-path="url(#t)" stroke="#C8102E" stroke-width="4"/>
                    <path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/>
                    <path d="M30,0 v30 M0,15 h60" stroke="#C8102E" stroke-width="6"/>
                  </g>
                </svg>
                <span style="font-size:13px;font-weight:700;color:#333" x-text="t('langEnglish')"></span>
              </button>
            </div>
            <div class="text-xs text-gray-400 mt-2" x-text="t('languageHelp')"></div>
          </div>
        </div>
      </div>

      <!-- Departments settings -->
      <div x-show="settingsTab === 'departments'">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="chart-card">
            <div class="chart-header">
              <span x-text="t('departmentsTitle')"></span>
            </div>
            <div class="p-4 space-y-2">
              <template x-if="!departments.length">
                <div class="text-gray-400 text-sm py-4 text-center"><span x-text="t('noDepartments')"></span></div>
              </template>
              <template x-for="dept in departments" :key="dept">
                <div class="flex items-center justify-between p-3 rounded border border-gray-100 hover:border-yellow-300 transition-colors">
                  <div class="font-semibold text-sm" x-text="dept"></div>
                  <button class="btn-icon" @click="deleteDepartment(dept)" :title="t('delete')">üóëÔ∏è</button>
                </div>
              </template>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header" x-text="t('addDepartment')"></div>
            <div class="p-4 space-y-3">
              <div class="form-group">
                <label class="form-label" x-text="t('departmentNameLabel')"></label>
                <input class="form-input" type="text" x-model="departmentForm.name"
                  :placeholder="t('departmentPlaceholder')"
                  @keydown.enter="addDepartment()">
              </div>
              <button class="btn-primary" @click="addDepartment()" x-text="t('addDepartmentBtn')"></button>
              <div class="mt-4 p-3 rounded text-xs text-gray-500" style="background:#f9f9f9;border:1px solid #e0e0e0">
                <span x-text="t('departmentInfo')"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Log view -->
      <div x-show="settingsTab === 'log'">
        <!-- Category switcher -->
        <div class="flex gap-2 mb-4 flex-wrap">
          <button
            @click="auditCategory='Budget Tracker'; auditFilter=''; loadAuditLog()"
            :style="auditCategory==='Budget Tracker' ? 'background:var(--dhl-dark);color:var(--dhl-yellow)' : 'background:white;color:#666;border:1px solid #ddd'"
            style="padding:7px 18px;font-size:12px;font-weight:700;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:6px">
            üìä Budget Tracker
          </button>
          <button
            @click="auditCategory='Test Management'; auditFilter=''; loadAuditLog()"
            :style="auditCategory==='Test Management' ? 'background:var(--dhl-dark);color:var(--dhl-yellow)' : 'background:white;color:#666;border:1px solid #ddd'"
            style="padding:7px 18px;font-size:12px;font-weight:700;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:6px">
            üß™ Test Management
          </button>
          <button
            @click="auditCategory='Risk Management'; auditFilter=''; loadAuditLog()"
            :style="auditCategory==='Risk Management' ? 'background:var(--dhl-dark);color:var(--dhl-yellow)' : 'background:white;color:#666;border:1px solid #ddd'"
            style="padding:7px 18px;font-size:12px;font-weight:700;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:6px">
            ‚ö†Ô∏è Risk Management
          </button>
          <button
            @click="auditCategory='Issue Tracker'; auditFilter=''; loadAuditLog()"
            :style="auditCategory==='Issue Tracker' ? 'background:var(--dhl-dark);color:var(--dhl-yellow)' : 'background:white;color:#666;border:1px solid #ddd'"
            style="padding:7px 18px;font-size:12px;font-weight:700;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:6px">
            üêõ Issue Tracker
          </button>
          <button
            @click="auditCategory='Change Management'; auditFilter=''; loadAuditLog()"
            :style="auditCategory==='Change Management' ? 'background:var(--dhl-dark);color:var(--dhl-yellow)' : 'background:white;color:#666;border:1px solid #ddd'"
            style="padding:7px 18px;font-size:12px;font-weight:700;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:6px">
            üîÑ Change Management
          </button>
          <button
            @click="auditCategory='Assumption Log'; auditFilter=''; loadAuditLog()"
            :style="auditCategory==='Assumption Log' ? 'background:var(--dhl-dark);color:var(--dhl-yellow)' : 'background:white;color:#666;border:1px solid #ddd'"
            style="padding:7px 18px;font-size:12px;font-weight:700;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:6px">
            üìù Assumption Log
          </button>
          <button
            @click="auditCategory='Project Plan'; auditFilter=''; loadAuditLog()"
            :style="auditCategory==='Project Plan' ? 'background:var(--dhl-dark);color:var(--dhl-yellow)' : 'background:white;color:#666;border:1px solid #ddd'"
            style="padding:7px 18px;font-size:12px;font-weight:700;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:6px">
            üìã Project Plan
          </button>
          <button
            @click="auditCategory='Kanban'; auditFilter=''; loadAuditLog()"
            :style="auditCategory==='Kanban' ? 'background:var(--dhl-dark);color:var(--dhl-yellow)' : 'background:white;color:#666;border:1px solid #ddd'"
            style="padding:7px 18px;font-size:12px;font-weight:700;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:6px">
            üìå Kanban
          </button>
          <button
            @click="auditCategory='Spr√°va u≈æivatel≈Ø'; auditFilter=''; loadAuditLog()"
            :style="auditCategory==='Spr√°va u≈æivatel≈Ø' ? 'background:var(--dhl-dark);color:var(--dhl-yellow)' : 'background:white;color:#666;border:1px solid #ddd'"
            style="padding:7px 18px;font-size:12px;font-weight:700;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:6px">
            üë• User Management
          </button>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <span x-text="auditCategory + ' ‚Äî ' + t('tabAudit')"></span>
            <div class="flex gap-2 items-center">
              <!-- Entity filter ‚Äî Budget Tracker -->
              <select x-show="auditCategory==='Budget Tracker'" x-model="auditFilter" @change="loadAuditLog()" class="border border-gray-200 rounded px-2 py-1 text-xs">
                <option value="" x-text="t('ganttAll')"></option>
                <option value="Item">Items</option>
                <option value="Labor">Labor</option>
                <option value="Osoba">People</option>
                <option value="Kategorie">Categories</option>
                <option value="Priorita">Priorities</option>
              </select>
              <!-- Entity filter ‚Äî Test Management -->
              <select x-show="auditCategory==='Test Management'" x-model="auditFilter" @change="loadAuditLog()" class="border border-gray-200 rounded px-2 py-1 text-xs">
                <option value="" x-text="t('auditAll')"></option>
                <option value="TestSet" x-text="t('auditTestSet')"></option>
                <option value="TestCase" x-text="t('auditTestCase')"></option>
                <option value="TestStep" x-text="t('auditTestStep')"></option>
                <option value="Defect" x-text="t('auditDefect')"></option>
              </select>
              <!-- Entity filter ‚Äî Risk Management -->
              <select x-show="auditCategory==='Risk Management'" x-model="auditFilter" @change="loadAuditLog()" class="border border-gray-200 rounded px-2 py-1 text-xs">
                <option value="" x-text="t('auditAll')"></option>
                <option value="Risk" x-text="t('auditRisk')"></option>
              </select>
              <!-- Entity filter ‚Äî Issue Tracker -->
              <select x-show="auditCategory==='Issue Tracker'" x-model="auditFilter" @change="loadAuditLog()" class="border border-gray-200 rounded px-2 py-1 text-xs">
                <option value="" x-text="t('auditAll')"></option>
                <option value="Issue" x-text="t('auditIssue')"></option>
              </select>
              <!-- Entity filter ‚Äî Change Management -->
              <select x-show="auditCategory==='Change Management'" x-model="auditFilter" @change="loadAuditLog()" class="border border-gray-200 rounded px-2 py-1 text-xs">
                <option value="" x-text="t('auditAll')"></option>
                <option value="ChangeRequest">Change Request</option>
              </select>
              <!-- Entity filter ‚Äî Project Plan -->
              <select x-show="auditCategory==='Project Plan'" x-model="auditFilter" @change="loadAuditLog()" class="border border-gray-200 rounded px-2 py-1 text-xs">
                <option value="">All</option>
                <option value="Task">Task</option>
              </select>
              <!-- Entity filter ‚Äî Kanban -->
              <select x-show="auditCategory==='Kanban'" x-model="auditFilter" @change="loadAuditLog()" class="border border-gray-200 rounded px-2 py-1 text-xs">
                <option value="">All</option>
                <option value="Task">Task (Move)</option>
                <option value="KanbanColumn">Column</option>
              </select>
              <button class="btn-ghost btn-sm" @click="loadAuditLog()" :title="t('refreshLog')"
                style="font-size:15px;padding:4px 8px;line-height:1">‚Üª</button>
              <button class="btn-ghost btn-sm" @click="clearAuditLog()" x-text="t('clearLog')"></button>
            </div>
          </div>
          <div class="table-scroll" style="max-height:600px">
            <table class="data-table">
              <thead>
                <tr>
                  <th style="width:160px" x-text="t('auditColTime')"></th>
                  <th style="width:120px" x-text="t('auditColUser')"></th>
                  <th style="width:80px" x-text="t('auditColEntity')"></th>
                  <th style="width:70px" x-text="t('auditColAction')"></th>
                  <th x-text="t('auditColDesc')"></th>
                </tr>
              </thead>
              <tbody>
                <template x-if="!auditLog.length">
                  <tr><td colspan="5" class="text-center py-10 text-gray-400" x-text="t('auditNoRecords')"></td></tr>
                </template>
                <template x-for="entry in auditLog" :key="entry.id">
                  <tr>
                    <td class="text-xs text-gray-500 font-mono" x-text="fmtDateTime(entry.timestamp)"></td>
                    <td class="font-semibold text-xs" x-text="entry.user"></td>
                    <td>
                      <span class="badge badge-grey text-xs" x-text="entry.entity"></span>
                    </td>
                    <td>
                      <span class="badge text-xs"
                        :class="{ 'badge-green': entry.action === 'CREATE' || entry.action === 'RESTORE', 'badge-yellow': entry.action === 'UPDATE' || entry.action === 'MOVE' || entry.action === 'BASELINE', 'badge-red': entry.action === 'DELETE' || entry.action === 'ARCHIVE' }"
                        x-text="entry.action"></span>
                    </td>
                    <td class="text-xs" x-text="entry.summary"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Currency settings -->
      <div x-show="settingsTab === 'currency'" class="max-w-sm">
        <div class="chart-card p-6 space-y-4">
          <h3 class="font-bold text-base" x-text="t('projectSettings')"></h3>
          <div class="form-group">
            <label class="form-label" x-text="t('projectNameLabel')"></label>
            <input class="form-input" type="text" x-model="settingsForm.projectName"
              :placeholder="t('projectNamePlaceholder')">
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('exchangeRate')"></label>
            <div class="flex gap-2 items-center">
              <span class="text-sm text-gray-500">1 EUR =</span>
              <input class="form-input" type="number" step="0.01" min="1"
                x-model="settingsForm.eurRate" placeholder="25.00" style="width:120px">
              <span class="text-sm text-gray-500">CZK</span>
            </div>
            <div class="text-xs text-gray-400 mt-1"><span x-text="t('exchangeHelp')"></span></div>
          </div>
          <div class="form-group mt-4">
            <label class="form-label" x-text="t('currentUser')"></label>
            <input class="form-input" type="text" x-model="settingsForm.currentUser" :placeholder="t('yourNamePlaceholder')">
          </div>
          <div class="form-group">
        <label class="form-label" x-text="t('laborWarning')"></label>
        <div class="flex gap-2 items-center">
          <input class="form-input" type="number" min="1" max="100" x-model="settingsForm.laborWarningPct" style="width:100px">
          <span class="text-sm text-gray-500"><span x-text="t('laborWarningHelp1')"></span></span>
        </div>
        <div class="text-xs text-gray-400 mt-1"><span x-text="t('laborWarningHelp2')"></span></div>
      </div>
      <button class="btn-primary" @click="saveEurRate()" x-text="t('saveSettings')"></button>
          <div x-show="settingsSaved" class="text-green-600 text-sm font-semibold" x-text="'‚úì ' + t('saved')"></div>
          <div class="mt-4 p-3 rounded" style="background:#f9f9f9;border:1px solid #e0e0e0">
            <div class="text-xs text-gray-500 mb-2 font-bold uppercase tracking-wide" x-text="t('currentExchange')"></div>
            <template x-if="eurRate > 0">
              <div>
                <div class="text-sm">1 000 000 CZK = <b x-text="new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(1000000/eurRate)"></b></div>
                <div class="text-sm">100 000 CZK = <b x-text="new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(100000/eurRate)"></b></div>
              </div>
            </template>
            <template x-if="eurRate <= 0">
              <div class="text-sm text-gray-400"><span x-text="t('exchangeNotSet')"></span></div>
            </template>
          </div>
        </div>
      </div>

      <!-- Branding settings -->
      <div x-show="settingsTab === 'branding'" class="max-w-lg">
        <div class="chart-card p-6 space-y-5">
          <h3 class="font-bold text-base" x-text="t('brandingTitle')"></h3>

          <!-- Colour palette picker -->
          <div class="form-group">
            <label class="form-label" style="font-weight:700;margin-bottom:10px;display:block" x-text="t('colorPalette')"></label>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <template x-for="p in palettes" :key="p.id">
                <div @click="selectPalette(p.id)" :title="p.name"
                  style="cursor:pointer;border-radius:8px;overflow:hidden;width:72px;transition:transform 0.1s"
                  :style="colorPalette === p.id
                    ? 'outline:3px solid ' + p.accent + ';outline-offset:2px;transform:scale(1.07)'
                    : 'outline:2px solid #e0e0e0;outline-offset:2px'"
                  @mouseenter="$el.style.transform='scale(1.05)'"
                  @mouseleave="$el.style.transform = colorPalette === p.id ? 'scale(1.07)' : 'scale(1)'">
                  <div :style="'background:' + p.dark + ';padding:10px 8px;display:flex;gap:5px;align-items:center;justify-content:center'">
                    <div :style="'width:20px;height:20px;border-radius:50%;background:' + p.accent"></div>
                    <div :style="'width:10px;height:10px;border-radius:50%;background:' + p.accent + ';opacity:0.45'"></div>
                  </div>
                  <div :style="'background:' + p.accent + ';padding:5px 4px;text-align:center;font-size:10px;font-weight:800;letter-spacing:0.3px;color:' + p.dark" x-text="p.name"></div>
                </div>
              </template>
            </div>
            <div class="text-xs text-gray-400 mt-2"><span x-text="t('paletteHelp')"></span></div>
          </div>

          <!-- Logo upload -->
          <div class="form-group">
            <label class="form-label" x-text="t('uploadLogo')"></label>
            <input type="file" accept="image/*" @change="handleLogoUpload($event)"
              style="display:block;width:100%;padding:6px 10px;border:1px solid #e0e0e0;border-radius:4px;font-size:13px;background:white;cursor:pointer">
            <div class="text-xs text-gray-400 mt-1"><span x-text="t('logoUploadHelp')"></span></div>
          </div>

          <!-- Live preview -->
          <div class="form-group">
            <label class="form-label" x-text="t('preview')"></label>
            <div :style="'background:' + settingsForm.logoBgColor + '; padding:14px 20px; display:inline-block; border-radius:4px; border:1px solid #ddd'">
              <img :src="logoSrc" :style="'width:' + settingsForm.logoWidth + 'px; display:block'">
            </div>
          </div>

          <!-- Logo width -->
          <div class="form-group">
            <label class="form-label" x-text="t('logoWidth')"></label>
            <div class="flex gap-3 items-center">
              <input type="range" min="40" max="180" x-model="settingsForm.logoWidth" style="flex:1;cursor:pointer">
              <input type="number" min="40" max="180" x-model="settingsForm.logoWidth"
                class="form-input" style="width:80px">
              <span class="text-sm text-gray-500">px</span>
            </div>
            <div class="text-xs text-gray-400 mt-1"><span x-text="t('logoWidthHelp')"></span></div>
          </div>

          <!-- Background color -->
          <div class="form-group">
            <label class="form-label" x-text="t('logoBgColor')"></label>
            <div class="flex gap-3 items-center">
              <input type="color" x-model="settingsForm.logoBgColor"
                style="width:44px;height:36px;border:1px solid #ddd;border-radius:4px;cursor:pointer;padding:2px">
              <input type="text" x-model="settingsForm.logoBgColor"
                class="form-input" style="width:110px" placeholder="#FFCC00">
              <div class="w-8 h-8 rounded border border-gray-200" :style="'background:' + settingsForm.logoBgColor"></div>
            </div>
          </div>

          <div class="flex gap-2 pt-2">
            <button class="btn-primary" @click="saveBranding()" x-text="t('saveAppearance')"></button>
            <button class="btn-ghost" @click="resetLogo()" x-text="t('resetLogo')"></button>
          </div>
          <div x-show="settingsSaved" class="text-green-600 text-sm font-semibold" x-text="'‚úì ' + t('saved')"></div>
        </div>
      </div>

      <!-- People settings -->
      <div x-show="settingsTab === 'people'">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="chart-card">
            <div class="chart-header">
              <span x-text="t('peopleTitle')"></span>
              <button class="btn-primary btn-sm" @click="openPersonForm()" x-text="t('addPerson')"></button>
            </div>
            <div class="p-4 space-y-2">
              <template x-if="!people.length">
                <div class="text-gray-400 text-sm py-4 text-center"><span x-text="t('noPeople')"></span></div>
              </template>
              <template x-for="p in people" :key="p.id">
                <div class="flex items-center justify-between p-3 rounded border border-gray-100 hover:border-yellow-300 transition-colors">
                  <div>
                    <div class="font-semibold text-sm" x-text="p.name"></div>
                    <div class="text-xs text-gray-400" x-text="[p.department, p.email].filter(Boolean).join(' ¬∑ ')"></div>
                  </div>
                  <div class="flex gap-1">
                    <button class="btn-icon" @click="openPersonForm(p)">‚úèÔ∏è</button>
                    <button class="btn-icon" @click="deletePerson(p.id)">üóëÔ∏è</button>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Person form -->
          <div class="chart-card" x-show="personForm.open">
            <div class="chart-header">
              <span x-text="personForm.id ? t('editPerson') : t('newPerson')"></span>
              <button class="btn-ghost btn-sm" @click="personForm.open = false" x-text="t('closeBtn')"></button>
            </div>
            <div class="p-4 space-y-3">
              <div class="form-group">
                <label class="form-label" x-text="t('nameLabel')"></label>
                <input class="form-input" type="text" x-model="personForm.name" :placeholder="t('namePlaceholder')">
              </div>
              <div class="form-group">
                <label class="form-label" x-text="t('departmentLabel')"></label>
                <select class="form-select" x-model="personForm.department">
                  <option value="" x-text="t('unassigned')"></option>
                  <template x-for="dept in departments" :key="dept">
                    <option :value="dept" x-text="dept"></option>
                  </template>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" x-text="t('emailField')"></label>
                <input class="form-input" type="email" x-model="personForm.email" :placeholder="t('emailPlaceholder')">
              </div>
              <button class="btn-primary" @click="savePerson()" x-text="t('savePerson')"></button>
            </div>
          </div>
        </div>
      </div>

      <!-- Categories settings -->
      <div x-show="settingsTab === 'categories'">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="chart-card">
            <div class="chart-header">
              <span x-text="t('categoriesTitle')"></span>
              <button class="btn-primary btn-sm" @click="openCategoryForm()" x-text="t('addCategory')"></button>
            </div>
            <div class="p-4 space-y-2">
              <template x-if="!categories.length">
                <div class="text-gray-400 text-sm py-4 text-center"><span x-text="t('noCategories')"></span></div>
              </template>
              <template x-for="c in categories" :key="c.id">
                <div class="flex items-center justify-between p-3 rounded border border-gray-100 hover:border-yellow-300 transition-colors">
                  <div>
                    <div class="font-semibold text-sm" x-text="c.name"></div>
                    <div class="text-xs text-gray-400" x-text="(c.subcategories?.length ?? 0) + ' podkategorie: ' + (c.subcategories?.join(', ') || '‚Äî')"></div>
                  </div>
                  <div class="flex gap-1">
                    <button class="btn-icon" @click="openCategoryForm(c)">‚úèÔ∏è</button>
                    <button class="btn-icon" @click="deleteCategory(c.id)">üóëÔ∏è</button>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <div class="chart-card" x-show="categoryForm.open">
            <div class="chart-header">
              <span x-text="categoryForm.id ? t('editCategory') : t('newCategory')"></span>
              <button class="btn-ghost btn-sm" @click="categoryForm.open = false">‚úï</button>
            </div>
            <div class="p-4 space-y-3">
              <div class="form-group">
                <label class="form-label" x-text="t('categoryNameLabel')"></label>
                <input class="form-input" type="text" x-model="categoryForm.name" :placeholder="t('categoryPlaceholder')">
              </div>
              <div class="form-group">
                <label class="form-label" x-text="t('subcategoriesLabel')"></label>
                <input class="form-input" type="text" x-model="categoryForm.subcatText" :placeholder="t('subcategoriesPlaceholder')">
                <div class="text-xs text-gray-400 mt-1"><span x-text="t('subcategoriesHelp')"></span></div>
              </div>
              <button class="btn-primary" @click="saveCategory()" x-text="t('saveCategory')"></button>
            </div>
          </div>
        </div>
      </div>

      <!-- Priorities settings -->
      <div x-show="settingsTab === 'priorities'">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="chart-card">
            <div class="chart-header">
              <span x-text="t('prioritiesTitle')"></span>
              <button class="btn-primary btn-sm" @click="openPriorityForm()" x-text="t('addPriority')"></button>
            </div>
            <div class="p-4 space-y-2">
              <template x-if="!priorities.length">
                <div class="text-gray-400 text-sm py-4 text-center"><span x-text="t('noPriorities')"></span></div>
              </template>
              <template x-for="p in priorities" :key="p.id">
                <div class="flex items-center justify-between p-3 rounded border border-gray-100 hover:border-yellow-300 transition-colors">
                  <div class="flex items-center gap-3">
                    <div class="w-5 h-5 rounded" :style="'background:' + p.color"></div>
                    <div>
                      <div class="font-semibold text-sm" x-text="p.name"></div>
                      <div class="text-xs text-gray-400"><span x-text="t('priorityRank')"></span>: <span x-text="p.rank"></span></div>
                    </div>
                  </div>
                  <div class="flex gap-1">
                    <button class="btn-icon" @click="openPriorityForm(p)">‚úèÔ∏è</button>
                    <button class="btn-icon" @click="deletePriority(p.id)">üóëÔ∏è</button>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <div class="chart-card" x-show="priorityForm.open">
            <div class="chart-header">
              <span x-text="priorityForm.id ? t('editPriority') : t('newPriority')"></span>
              <button class="btn-ghost btn-sm" @click="priorityForm.open = false">‚úï</button>
            </div>
            <div class="p-4 space-y-3">
              <div class="form-group">
                <label class="form-label" x-text="t('priorityNameLabel')"></label>
                <input class="form-input" type="text" x-model="priorityForm.name" :placeholder="t('priorityPlaceholder')">
              </div>
              <div class="form-group">
                <label class="form-label" x-text="t('color')"></label>
                <div class="flex gap-2 items-center">
                  <input type="color" x-model="priorityForm.color" class="w-10 h-10 rounded cursor-pointer border border-gray-200">
                  <input class="form-input" type="text" x-model="priorityForm.color" placeholder="#FFCC00">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label" x-text="t('priorityRank')"></label>
                <input class="form-input" type="number" x-model="priorityForm.rank" min="0">
              </div>
              <button class="btn-primary" @click="savePriority()" x-text="t('savePriority')"></button>
            </div>
          </div>
        </div>
      </div>

      <!-- Users tab ‚Äî admin only -->
      <div x-show="settingsTab === 'users'">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- User list -->
          <div class="chart-card">
            <div class="chart-header" x-text="t('usersTitle')"></div>
            <div class="p-4 space-y-2">
              <template x-if="!users.length">
                <div class="text-gray-400 text-sm py-4 text-center"><span x-text="t('noUsers')"></span></div>
              </template>
              <template x-for="u in users" :key="u.id">
                <div class="flex items-center justify-between p-3 rounded border transition-colors"
                  :class="userForm.id === u.id ? 'border-yellow-400 bg-yellow-50' : 'border-gray-100 hover:border-yellow-300'">
                  <div style="min-width:0;flex:1">
                    <div class="font-semibold text-sm flex items-center gap-2">
                      <span x-text="u.name"></span>
                      <span x-show="u.role === 'admin'" style="background:#1a1a1a;color:#FFCC00;font-size:9px;padding:1px 6px;border-radius:3px;font-weight:700">ADMIN</span>
                      <span x-show="!u.active" style="background:#fee2e2;color:#dc2626;font-size:9px;padding:1px 6px;border-radius:3px;font-weight:700">NEAKTIVN√ç</span>
                    </div>
                    <div class="text-xs text-gray-400" x-text="u.email"></div>
                    <div x-show="u.role !== 'admin'" class="flex flex-wrap gap-1 mt-1">
                      <template x-for="s in SECTIONS" :key="s">
                        <span x-show="(JSON.parse(u.permissions||'{}')[s] ?? 'none') !== 'none'"
                          :style="(JSON.parse(u.permissions||'{}')[s]) === 'write' ? 'background:#dcfce7;color:#166534' : 'background:#e0f2fe;color:#0369a1'"
                          style="font-size:9px;padding:1px 5px;border-radius:3px;font-weight:600;text-transform:uppercase"
                          x-text="s + ':' + (JSON.parse(u.permissions||'{}')[s])"></span>
                      </template>
                    </div>
                  </div>
                  <div class="flex gap-1 ml-2">
                    <button class="btn-icon" @click="editUser(u)" :title="t('editPermissions')">‚úèÔ∏è</button>
                    <button class="btn-icon" x-show="u.id !== authUser?.id" @click="deactivateUser(u)" :title="u.active ? t('deactivate') : t('activate')">
                      <span x-text="u.active ? 'üîí' : 'üîì'"></span>
                    </button>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Add / Edit user + Permission matrix -->
          <div class="chart-card">
            <div class="chart-header" x-text="userForm.id ? t('editUser') : t('addUser')"></div>
            <div class="p-4 space-y-3">
              <div class="form-group" x-show="!userForm.id">
                <label class="form-label" x-text="t('emailRequired')"></label>
                <input class="form-input" type="text" x-model="userForm.email" :placeholder="t('emailPlaceholder')">
              </div>
              <div class="form-group">
                <label class="form-label" x-text="t('nameRequiredField')"></label>
                <input class="form-input" type="text" x-model="userForm.name" :placeholder="t('namePlaceholder')">
              </div>
              <div class="form-group">
                <label class="form-label" x-text="t('accountType')"></label>
                <select class="form-input" x-model="userForm.role">
                  <option value="user" x-text="t('userManaged')"></option>
                  <option value="admin" x-text="t('adminFull')"></option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" x-text="userForm.id ? t('passwordOptional') : t('passwordRequired')"></label>
                <input class="form-input" type="password" x-model="userForm.password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              </div>

              <!-- Permission matrix ‚Äî only for non-admin -->
              <div x-show="userForm.role !== 'admin'" style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden">
                <div style="background:#f9fafb;padding:8px 12px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#555;border-bottom:1px solid #e5e7eb">
                  <span x-text="t('permissionsTitle')"></span>
                </div>
                <div style="padding:8px">
                  <template x-for="s in SECTIONS" :key="s">
                    <div class="flex items-center justify-between py-1" style="border-bottom:1px solid #f3f4f6">
                      <span class="text-sm font-medium" x-text="SECTION_LABELS[s]" style="min-width:160px"></span>
                      <div class="flex gap-1">
                        <button
                          @click="userForm.permissions[s] = 'none'"
                          :class="userForm.permissions[s] === 'none' ? 'btn-primary btn-sm' : 'btn-ghost btn-sm'"
                          style="font-size:11px;padding:3px 10px" x-text="t('permNone')"></button>
                        <button
                          @click="userForm.permissions[s] = 'read'"
                          :class="userForm.permissions[s] === 'read' ? 'btn-primary btn-sm' : 'btn-ghost btn-sm'"
                          style="font-size:11px;padding:3px 10px" x-text="t('permRead')"></button>
                        <button
                          @click="userForm.permissions[s] = 'write'"
                          :class="userForm.permissions[s] === 'write' ? 'btn-primary btn-sm' : 'btn-ghost btn-sm'"
                          style="font-size:11px;padding:3px 10px" x-text="t('permWrite')"></button>
                      </div>
                    </div>
                  </template>
                </div>
                <!-- Quick presets -->
                <div style="padding:8px 8px 6px;background:#f9fafb;border-top:1px solid #e5e7eb;display:flex;gap:6px;flex-wrap:wrap">
                  <span style="font-size:11px;color:#888;align-self:center" x-text="t('preset')"></span>
                  <button class="btn-ghost btn-sm" style="font-size:11px" @click="SECTIONS.forEach(s => userForm.permissions[s] = 'read')" x-text="t('allRead')"></button>
                  <button class="btn-ghost btn-sm" style="font-size:11px" @click="SECTIONS.forEach(s => userForm.permissions[s] = 'write')" x-text="t('allWrite')"></button>
                  <button class="btn-ghost btn-sm" style="font-size:11px" @click="SECTIONS.forEach(s => userForm.permissions[s] = 'none')" x-text="t('allNone')"></button>
                </div>
              </div>
              <div x-show="userForm.role === 'admin'" style="background:#fefce8;border:1px solid #fde047;border-radius:8px;padding:10px 12px;font-size:12px;color:#713f12">
                <span x-text="t('adminFullInfo')"></span>
              </div>

              <div x-show="userForm.error" x-text="userForm.error" style="color:#dc2626;font-size:12px"></div>
              <div class="flex gap-2">
                <button class="btn-primary" @click="saveUser()" x-text="userForm.id ? t('saveChanges') : t('addUserBtn')"></button>
                <button x-show="userForm.id" class="btn-ghost" @click="resetUserForm()" x-text="t('cancel')"></button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Projects settings -->
      <div x-show="settingsTab === 'projects'">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h3 class="font-bold text-base" x-text="t('projectsTitle')"></h3>
          <button @click="resetProjectForm(); projectForm._showCreate = true"
            style="background:var(--dhl-yellow);border:none;border-radius:6px;padding:7px 14px;font-size:13px;font-weight:600;cursor:pointer">
            <span x-text="t('newProject')"></span>
          </button>
        </div>

        <!-- Create/Edit form -->
        <div x-show="projectForm.id !== null || projectForm._showCreate"
          style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:20px;margin-bottom:20px">
          <h4 style="font-weight:600;margin-bottom:12px" x-text="projectForm.id ? t('editProject') : t('newProjectTitle')"></h4>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <input x-model="projectForm.name" :placeholder="t('projectNamePlaceholder2')" class="form-input" style="flex:1;min-width:180px">
            <input x-model="projectForm.description" :placeholder="t('projectDescPlaceholder')" class="form-input" style="flex:2;min-width:200px">
            <button @click="saveProject()" style="background:var(--dhl-yellow);border:none;border-radius:6px;padding:7px 14px;font-size:13px;font-weight:600;cursor:pointer" x-text="t('save')"></button>
            <button @click="resetProjectForm(); projectForm._showCreate = false" style="background:#e5e7eb;border:none;border-radius:6px;padding:7px 14px;font-size:13px;cursor:pointer" x-text="t('cancel')"></button>
          </div>
          <div x-show="projectForm.error" x-text="projectForm.error" style="color:#dc2626;font-size:13px;margin-top:8px"></div>
        </div>

        <!-- Projects list -->
        <div style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden">
          <table style="width:100%;border-collapse:collapse;font-size:13px">
            <thead style="background:#f9fafb">
              <tr>
                <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('colName')"></th>
                <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('auditColDesc')"></th>
                <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('colMembers')"></th>
                <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('colActions')"></th>
              </tr>
            </thead>
            <tbody>
              <template x-for="p in projects" :key="p.id">
                <tr style="border-top:1px solid #e5e7eb">
                  <td style="padding:10px 14px;font-weight:500">
                    <span x-text="p.name"></span>
                    <span x-show="p.id === activeProjectId" style="margin-left:6px;background:var(--dhl-yellow);font-size:10px;padding:1px 6px;border-radius:10px;font-weight:700" x-text="t('active')"></span>
                  </td>
                  <td style="padding:10px 14px;color:#666" x-text="p.description || '‚Äî'"></td>
                  <td style="padding:10px 14px" x-text="p.users?.length ?? '?'"></td>
                  <td style="padding:10px 14px">
                    <div style="display:flex;gap:6px;flex-wrap:wrap">
                      <button @click="editProject(p)" style="background:#f3f4f6;border:none;border-radius:4px;padding:4px 10px;font-size:12px;cursor:pointer" x-text="t('editBtn')"></button>
                      <button @click="loadProjectMembers(p.id); settingsTab = 'project-members'" style="background:#f3f4f6;border:none;border-radius:4px;padding:4px 10px;font-size:12px;cursor:pointer" x-text="t('membersBtn')"></button>
                      <button x-show="p.id !== 1" @click="deleteProject(p.id)" style="background:#fee2e2;border:none;border-radius:4px;padding:4px 10px;font-size:12px;cursor:pointer;color:#dc2626" x-text="t('deleteProjectBtn')"></button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Project Members settings -->
      <div x-show="settingsTab === 'project-members'">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
          <button @click="settingsTab = 'projects'" style="background:#f3f4f6;border:none;border-radius:6px;padding:7px 12px;font-size:13px;cursor:pointer" x-text="t('back')"></button>
          <h3 class="font-bold text-base" x-text="t('projectMembers')"></h3>
        </div>

        <!-- Add member -->
        <div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin-bottom:20px">
          <div style="font-size:13px;font-weight:600;margin-bottom:10px" x-text="t('addToProject')"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <select x-ref="addMemberSelect" class="form-input" style="flex:1;min-width:180px">
              <template x-for="u in users.filter(u => !projectMembers.find(m => m.userId === u.id))" :key="u.id">
                <option :value="u.id" x-text="u.name + ' (' + u.email + ')'"></option>
              </template>
            </select>
            <button @click="addProjectMember(projectMembersProjectId, parseInt($refs.addMemberSelect.value))"
              style="background:var(--dhl-yellow);border:none;border-radius:6px;padding:7px 14px;font-size:13px;font-weight:600;cursor:pointer" x-text="t('addBtn')"></button>
          </div>
        </div>

        <!-- Members list -->
        <div style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden">
          <table style="width:100%;border-collapse:collapse;font-size:13px">
            <thead style="background:#f9fafb">
              <tr>
                <th style="padding:10px 14px;text-align:left" x-text="t('colName')"></th>
                <th style="padding:10px 14px;text-align:left" x-text="t('colEmail')"></th>
                <th style="padding:10px 14px;text-align:left">Role</th>
                <th style="padding:10px 14px"></th>
              </tr>
            </thead>
            <tbody>
              <template x-for="m in projectMembers" :key="m.userId">
                <tr style="border-top:1px solid #e5e7eb">
                  <td style="padding:10px 14px;font-weight:500" x-text="m.user.name"></td>
                  <td style="padding:10px 14px;color:#666" x-text="m.user.email"></td>
                  <td style="padding:10px 14px" x-text="m.user.role"></td>
                  <td style="padding:10px 14px">
                    <button @click="removeProjectMember(projectMembersProjectId, m.userId)"
                      style="background:#fee2e2;border:none;border-radius:4px;padding:4px 10px;font-size:12px;cursor:pointer;color:#dc2626" x-text="t('remove')"></button>
                  </td>
                </tr>
              </template>
              <tr x-show="projectMembers.length === 0">
                <td colspan="4" style="padding:20px;text-align:center;color:#999;font-size:13px" x-text="t('noMembers')"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Companies settings (superadmin only) -->
      <div x-show="settingsTab === 'companies'">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h3 class="font-bold text-base" x-text="t('companiesTitle')"></h3>
          <button @click="resetCompanyForm(); companyForm._showCreate = true"
            style="background:#7c3aed;color:#fff;border:none;border-radius:6px;padding:7px 14px;font-size:13px;font-weight:600;cursor:pointer">
            <span x-text="t('newCompany')"></span>
          </button>
        </div>

        <!-- Create/Edit form -->
        <div x-show="companyForm.id !== null || companyForm._showCreate"
          style="background:#faf5ff;border:1px solid #ddd6fe;border-radius:8px;padding:20px;margin-bottom:20px">
          <h4 style="font-weight:600;margin-bottom:12px;color:#7c3aed" x-text="companyForm.id ? t('editCompany') : t('newCompanyTitle')"></h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
            <div>
              <label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px" x-text="t('companyNameField')"></label>
              <input x-model="companyForm.name" :placeholder="t('companyNamePlaceholder')" class="form-input">
            </div>
            <div>
              <label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px" x-text="t('slugField')"></label>
              <input x-model="companyForm.slug" :placeholder="t('slugPlaceholder')" class="form-input">
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px">
            <div>
              <label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px" x-text="t('planField')"></label>
              <select x-model.number="companyForm.planId" class="form-input" style="height:38px">
                <option value="" x-text="t('noPlan')"></option>
                <template x-for="p in plans" :key="p.id">
                  <option :value="p.id" x-text="p.name + ' (' + p.priceMonthly + ' Kƒç/mƒõs)'"></option>
                </template>
              </select>
            </div>
            <div>
              <label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px"><span x-text="t('maxProjects')"></span></label>
              <input type="number" x-model.number="companyForm.maxProjectsOverride" :placeholder="t('defaultFromPlan')" class="form-input" min="0">
            </div>
            <div>
              <label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px"><span x-text="t('maxUsers')"></span></label>
              <input type="number" x-model.number="companyForm.maxUsersOverride" :placeholder="t('defaultFromPlan')" class="form-input" min="0">
            </div>
          </div>
          <div x-show="companyForm.id" style="display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px">
            <div>
              <label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px" x-text="t('statusField')"></label>
              <select x-model="companyForm.status" class="form-input" style="height:38px">
                <option value="trial">Trial</option>
                <option value="active">Active</option>
                <option value="expired">Expired</option>
                <option value="blocked">Blocked</option>
              </select>
            </div>
          </div>
          <div x-show="!companyForm.id" style="background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:14px;margin-bottom:10px">
            <div style="font-size:12px;font-weight:600;color:#444;margin-bottom:8px" x-text="t('adminAccount')"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
              <input x-model="companyForm.adminName" :placeholder="t('adminNamePlaceholder')" class="form-input">
              <input x-model="companyForm.adminEmail" :placeholder="t('adminEmailPlaceholder')" class="form-input">
              <input type="password" x-model="companyForm.adminPassword" :placeholder="t('adminPasswordPlaceholder')" class="form-input">
            </div>
          </div>
          <div x-show="companyForm.error" x-text="companyForm.error" style="color:#dc2626;font-size:13px;margin-bottom:8px"></div>
          <div style="display:flex;gap:8px">
            <button @click="saveCompany()" style="background:#7c3aed;color:#fff;border:none;border-radius:6px;padding:7px 14px;font-size:13px;font-weight:600;cursor:pointer" x-text="t('save')"></button>
            <button @click="resetCompanyForm(); companyForm._showCreate = false" style="background:#e5e7eb;border:none;border-radius:6px;padding:7px 14px;font-size:13px;cursor:pointer" x-text="t('cancel')"></button>
          </div>
        </div>

        <!-- Companies list -->
        <div style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden">
          <table style="width:100%;border-collapse:collapse;font-size:13px">
            <thead style="background:#faf5ff">
              <tr>
                <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('colCompany')"></th>
                <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('colPlan')"></th>
                <th style="padding:10px 14px;text-align:center;font-weight:600" x-text="t('colUsers')"></th>
                <th style="padding:10px 14px;text-align:center;font-weight:600" x-text="t('colProjects')"></th>
                <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('colStatus')"></th>
                <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('colActions')"></th>
              </tr>
            </thead>
            <tbody>
              <template x-for="c in companies" :key="c.id">
                <tr style="border-top:1px solid #e5e7eb">
                  <td style="padding:10px 14px;font-weight:600" x-text="c.name"></td>
                  <td style="padding:10px 14px;font-size:12px" x-text="c.plan?.name || '‚Äî'"></td>
                  <td style="padding:10px 14px;text-align:center">
                    <span x-text="(c._count?.users ?? 0) + ' / ' + (c.maxUsersOverride ?? c.plan?.maxUsers ?? '‚àû')"></span>
                  </td>
                  <td style="padding:10px 14px;text-align:center">
                    <span x-text="(c._count?.projects ?? 0) + ' / ' + (c.maxProjectsOverride ?? c.plan?.maxProjects ?? '‚àû')"></span>
                  </td>
                  <td style="padding:10px 14px">
                    <span :style="c.status === 'active' ? 'background:#dcfce7;color:#16a34a' : c.status === 'trial' ? 'background:#FEF3C7;color:#92400E' : 'background:#fee2e2;color:#dc2626'"
                      style="font-size:11px;padding:2px 8px;border-radius:10px;font-weight:600">
                      <span x-text="c.status"></span>
                    </span>
                  </td>
                  <td style="padding:10px 14px">
                    <div style="display:flex;gap:6px;flex-wrap:wrap">
                      <button @click="editCompany(c)" style="background:#f3f4f6;border:none;border-radius:4px;padding:4px 10px;font-size:12px;cursor:pointer" x-text="t('editCompanyBtn')"></button>
                      <button @click="viewCompanyOverview(c.id)" style="background:#ede9fe;border:none;border-radius:4px;padding:4px 10px;font-size:12px;cursor:pointer;color:#7c3aed" x-text="t('detailBtn')"></button>
                      <button x-show="c.id !== 1" @click="deleteCompany(c.id)" style="background:#fee2e2;border:none;border-radius:4px;padding:4px 10px;font-size:12px;cursor:pointer;color:#dc2626" x-text="t('deleteCompanyBtn')"></button>
                    </div>
                  </td>
                </tr>
              </template>
              <tr x-show="companies.length === 0">
                <td colspan="6" style="padding:20px;text-align:center;color:#999;font-size:13px" x-text="t('noCompanies')"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Company Detail / Overview (superadmin support view) -->
      <div x-show="settingsTab === 'company-overview'">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
          <button @click="settingsTab = 'companies'" style="background:#f3f4f6;border:none;border-radius:6px;padding:7px 12px;font-size:13px;cursor:pointer" x-text="t('back')"></button>
          <h3 class="font-bold text-base" x-text="companyOverview?.company?.name + ' ‚Äî ' + t('companyOverview')"></h3>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div>
            <h4 style="font-weight:600;margin-bottom:10px;font-size:13px;color:#666;text-transform:uppercase;letter-spacing:.5px" x-text="t('companySectionUsers')"></h4>
            <div style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden">
              <table style="width:100%;border-collapse:collapse;font-size:13px">
                <tbody>
                  <template x-for="u in companyOverview?.users ?? []" :key="u.id">
                    <tr style="border-top:1px solid #e5e7eb">
                      <td style="padding:8px 12px;font-weight:500" x-text="u.name"></td>
                      <td style="padding:8px 12px;color:#666" x-text="u.email"></td>
                      <td style="padding:8px 12px"><span x-text="u.role" style="font-size:11px;background:#f3f4f6;padding:1px 6px;border-radius:8px"></span></td>
                    </tr>
                  </template>
                  <tr x-show="!companyOverview?.users?.length">
                    <td colspan="3" style="padding:12px;text-align:center;color:#999" x-text="t('noUsersInCompany')"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div>
            <h4 style="font-weight:600;margin-bottom:10px;font-size:13px;color:#666;text-transform:uppercase;letter-spacing:.5px" x-text="t('companySectionProjects')"></h4>
            <div style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden">
              <table style="width:100%;border-collapse:collapse;font-size:13px">
                <tbody>
                  <template x-for="p in companyOverview?.projects ?? []" :key="p.id">
                    <tr style="border-top:1px solid #e5e7eb">
                      <td style="padding:8px 12px;font-weight:500">üìÅ <span x-text="p.name"></span></td>
                      <td style="padding:8px 12px;color:#999;font-size:11px" x-text="new Date(p.createdAt).toLocaleDateString('cs-CZ')"></td>
                    </tr>
                  </template>
                  <tr x-show="!companyOverview?.projects?.length">
                    <td colspan="2" style="padding:12px;text-align:center;color:#999" x-text="t('noProjectsInCompany')"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Plans management (superadmin) -->
      <div x-show="settingsTab === 'plans'">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h3 class="font-bold text-base" x-text="t('plansTitle')"></h3>
          <button @click="resetPlanForm(); planForm._showCreate = true"
            style="background:#7c3aed;color:#fff;border:none;border-radius:6px;padding:7px 14px;font-size:13px;font-weight:600;cursor:pointer" x-text="t('newPlan')"></button>
        </div>
        <div x-show="planForm.id !== null || planForm._showCreate"
          style="background:#faf5ff;border:1px solid #ddd6fe;border-radius:8px;padding:20px;margin-bottom:20px">
          <h4 style="font-weight:600;margin-bottom:12px;color:#7c3aed" x-text="planForm.id ? t('editPlan') : t('newPlanTitle')"></h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
            <div><label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px" x-text="t('colName')"></label>
              <input x-model="planForm.name" class="form-input" :placeholder="t('planNamePlaceholder')"></div>
            <div><label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px" x-text="t('slugField')"></label>
              <input x-model="planForm.slug" class="form-input" placeholder="start"></div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px">
            <div><label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px" x-text="t('priceMonthly')"></label>
              <input type="number" x-model.number="planForm.priceMonthly" class="form-input"></div>
            <div><label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px" x-text="t('maxProjectsLabel')"></label>
              <input type="number" x-model.number="planForm.maxProjects" class="form-input"></div>
            <div><label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px" x-text="t('maxUsersLabel')"></label>
              <input type="number" x-model.number="planForm.maxUsers" class="form-input"></div>
          </div>
          <div style="margin-bottom:10px">
            <label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:3px" x-text="t('descriptionLabel')"></label>
            <input x-model="planForm.description" class="form-input" :placeholder="t('planDescPlaceholder')">
          </div>
          <div style="margin-bottom:12px">
            <label style="font-size:12px;font-weight:600;color:#444;display:block;margin-bottom:6px" x-text="t('allowedSections')"></label>
            <div style="display:flex;flex-wrap:wrap;gap:6px">
              <template x-for="s in SECTIONS" :key="s">
                <label style="display:flex;align-items:center;gap:4px;background:#f3f4f6;border-radius:6px;padding:5px 10px;font-size:12px;cursor:pointer">
                  <input type="checkbox" :value="s" x-model="planForm.sections"> <span x-text="SECTION_LABELS[s] || s"></span>
                </label>
              </template>
            </div>
          </div>
          <div style="margin-bottom:12px">
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer">
              <input type="checkbox" x-model="planForm.isPublic">
              <span style="font-weight:600;color:#444" x-text="t('publicPlan')"></span>
              <span style="font-size:11px;color:#94a3b8" x-text="t('publicPlanHelp')"></span>
            </label>
          </div>
          <div x-show="planForm.error" x-text="planForm.error" style="color:#dc2626;font-size:13px;margin-bottom:8px"></div>
          <div style="display:flex;gap:8px">
            <button @click="savePlan()" style="background:#7c3aed;color:#fff;border:none;border-radius:6px;padding:7px 14px;font-size:13px;font-weight:600;cursor:pointer" x-text="t('save')"></button>
            <button @click="resetPlanForm(); planForm._showCreate = false" style="background:#e5e7eb;border:none;border-radius:6px;padding:7px 14px;font-size:13px;cursor:pointer" x-text="t('cancel')"></button>
          </div>
        </div>
        <div style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden">
          <table style="width:100%;border-collapse:collapse;font-size:13px">
            <thead style="background:#faf5ff"><tr>
              <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('colPlan')"></th>
              <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('colSections')"></th>
              <th style="padding:10px 14px;text-align:right;font-weight:600" x-text="t('colPrice')"></th>
              <th style="padding:10px 14px;text-align:center;font-weight:600" x-text="t('colCompaniesCount')"></th>
              <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('colActions')"></th>
            </tr></thead>
            <tbody>
              <template x-for="p in plans" :key="p.id">
                <tr style="border-top:1px solid #e5e7eb">
                  <td style="padding:10px 14px;font-weight:600"><span x-text="p.name"></span>
                    <span x-show="p.isDefault" style="font-size:10px;background:#dcfce7;color:#16a34a;padding:1px 6px;border-radius:8px;margin-left:6px" x-text="t('badgeDefault')"></span>
                    <span x-show="p.isPublic" style="font-size:10px;background:#e0f2fe;color:#0369a1;padding:1px 6px;border-radius:8px;margin-left:4px" x-text="t('badgePublic')"></span>
                    <span x-show="!p.isPublic" style="font-size:10px;background:#fef3c7;color:#92400e;padding:1px 6px;border-radius:8px;margin-left:4px" x-text="t('badgeHidden')"></span></td>
                  <td style="padding:10px 14px"><div style="display:flex;flex-wrap:wrap;gap:3px">
                    <template x-for="s in JSON.parse(p.sections || '[]')" :key="s">
                      <span style="font-size:10px;background:#e0f2fe;color:#0369a1;padding:1px 6px;border-radius:8px" x-text="s"></span>
                    </template></div></td>
                  <td style="padding:10px 14px;text-align:right;font-weight:600" x-text="p.priceMonthly + ' Kƒç'"></td>
                  <td style="padding:10px 14px;text-align:center" x-text="p._count?.companies ?? 0"></td>
                  <td style="padding:10px 14px">
                    <div style="display:flex;gap:6px"><button @click="editPlan(p)" style="background:#f3f4f6;border:none;border-radius:4px;padding:4px 10px;font-size:12px;cursor:pointer">‚úèÔ∏è</button>
                    <button x-show="p.active" @click="deletePlan(p.id)" style="background:#fee2e2;border:none;border-radius:4px;padding:4px 10px;font-size:12px;cursor:pointer;color:#dc2626">üóë</button></div></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Invoices management (superadmin) -->
      <div x-show="settingsTab === 'invoices'">
        <h3 class="font-bold text-base" style="margin-bottom:20px" x-text="t('invoicesTitle')"></h3>
        <div style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden">
          <table style="width:100%;border-collapse:collapse;font-size:13px">
            <thead style="background:#faf5ff"><tr>
              <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('colCompany')"></th>
              <th style="padding:10px 14px;text-align:right;font-weight:600" x-text="t('amount')"></th>
              <th style="padding:10px 14px;text-align:left;font-weight:600">VS</th>
              <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('colStatus')"></th>
              <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('dueDate')"></th>
              <th style="padding:10px 14px;text-align:left;font-weight:600" x-text="t('colActions')"></th>
            </tr></thead>
            <tbody>
              <template x-for="inv in invoices" :key="inv.id">
                <tr style="border-top:1px solid #e5e7eb">
                  <td style="padding:10px 14px;font-weight:500" x-text="inv.company?.name || '‚Äî'"></td>
                  <td style="padding:10px 14px;text-align:right;font-weight:600" x-text="inv.amount + ' Kƒç'"></td>
                  <td style="padding:10px 14px;font-family:monospace;font-size:12px;font-weight:700" x-text="inv.variableSymbol"></td>
                  <td style="padding:10px 14px">
                    <span :style="inv.status === 'paid' ? 'background:#dcfce7;color:#16a34a' : inv.status === 'pending' ? 'background:#FEF3C7;color:#92400E' : 'background:#fee2e2;color:#dc2626'"
                      style="font-size:11px;padding:2px 8px;border-radius:10px;font-weight:600" x-text="inv.status"></span></td>
                  <td style="padding:10px 14px;font-size:12px" x-text="new Date(inv.dueDate).toLocaleDateString('cs-CZ')"></td>
                  <td style="padding:10px 14px">
                    <button x-show="inv.status === 'pending'" @click="markInvoicePaid(inv.id)"
                      style="background:#dcfce7;color:#16a34a;border:none;border-radius:4px;padding:4px 12px;font-size:12px;font-weight:600;cursor:pointer" x-text="t('markPaid')"></button>
                  </td>
                </tr>
              </template>
              <tr x-show="invoices.length === 0"><td colspan="6" style="padding:20px;text-align:center;color:#999" x-text="t('noInvoices')"></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- SaaS Dashboard (superadmin) -->
      <div x-show="settingsTab === 'saas-dashboard'">
        <h3 class="font-bold text-base" style="margin-bottom:20px" x-text="t('saasTitle')"></h3>
        <div x-show="saasStats" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px">
          <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;text-align:center">
            <div style="font-size:28px;font-weight:700" x-text="saasStats?.totalCompanies || 0"></div>
            <div style="font-size:12px;color:#666;margin-top:4px" x-text="t('totalCompanies')"></div>
          </div>
          <div style="background:#dcfce7;border:1px solid #bbf7d0;border-radius:8px;padding:16px;text-align:center">
            <div style="font-size:28px;font-weight:700;color:#16a34a" x-text="saasStats?.activeCompanies || 0"></div>
            <div style="font-size:12px;color:#166534;margin-top:4px" x-text="t('activeCompanies')"></div>
          </div>
          <div style="background:#FEF3C7;border:1px solid #FDE68A;border-radius:8px;padding:16px;text-align:center">
            <div style="font-size:28px;font-weight:700;color:#92400E" x-text="saasStats?.trialCompanies || 0"></div>
            <div style="font-size:12px;color:#78350F;margin-top:4px">Trial</div>
          </div>
          <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;text-align:center">
            <div style="font-size:28px;font-weight:700" x-text="(saasStats?.monthlyRevenue || 0) + ' Kƒç'"></div>
            <div style="font-size:12px;color:#666;margin-top:4px" x-text="t('monthlyRevenue')"></div>
          </div>
        </div>
        <div x-show="saasStats" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px">
          <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;text-align:center">
            <div style="font-size:28px;font-weight:700" x-text="saasStats?.totalUsers || 0"></div>
            <div style="font-size:12px;color:#666;margin-top:4px" x-text="t('colUsers')"></div>
          </div>
          <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;text-align:center">
            <div style="font-size:28px;font-weight:700" x-text="saasStats?.totalProjects || 0"></div>
            <div style="font-size:12px;color:#666;margin-top:4px" x-text="t('colProjects')"></div>
          </div>
        </div>
        <!-- Recent registrations -->
        <div x-show="saasStats?.recentRegistrations?.length">
          <h4 style="font-weight:600;font-size:13px;color:#666;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px" x-text="t('recentRegistrations')"></h4>
          <div style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;margin-bottom:20px">
            <table style="width:100%;border-collapse:collapse;font-size:13px">
              <tbody>
                <template x-for="r in saasStats?.recentRegistrations ?? []" :key="r.id">
                  <tr style="border-top:1px solid #e5e7eb">
                    <td style="padding:8px 12px;font-weight:500" x-text="r.name"></td>
                    <td style="padding:8px 12px"><span :style="r.status === 'active' ? 'background:#dcfce7;color:#16a34a' : r.status === 'trial' ? 'background:#FEF3C7;color:#92400E' : 'background:#fee2e2;color:#dc2626'"
                      style="font-size:11px;padding:1px 6px;border-radius:8px;font-weight:600" x-text="r.status"></span></td>
                    <td style="padding:8px 12px;color:#888;font-size:12px" x-text="r.plan?.name || '‚Äî'"></td>
                    <td style="padding:8px 12px;color:#999;font-size:11px" x-text="new Date(r.createdAt).toLocaleDateString('cs-CZ')"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
        <!-- Pending invoices -->
        <div x-show="saasStats?.pendingInvoices?.length">
          <h4 style="font-weight:600;font-size:13px;color:#666;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px" x-text="t('pendingPayments')"></h4>
          <div style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden">
            <table style="width:100%;border-collapse:collapse;font-size:13px">
              <tbody>
                <template x-for="inv in saasStats?.pendingInvoices ?? []" :key="inv.id">
                  <tr style="border-top:1px solid #e5e7eb">
                    <td style="padding:8px 12px;font-weight:500" x-text="inv.company?.name || '‚Äî'"></td>
                    <td style="padding:8px 12px;font-weight:600" x-text="inv.amount + ' Kƒç'"></td>
                    <td style="padding:8px 12px;font-family:monospace" x-text="inv.variableSymbol"></td>
                    <td style="padding:8px 12px"><button @click="markInvoicePaid(inv.id); loadSaasStats()"
                      style="background:#dcfce7;color:#16a34a;border:none;border-radius:4px;padding:3px 10px;font-size:12px;font-weight:600;cursor:pointer" x-text="t('markPaid')"></button></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

  </div><!-- end main -->
</div><!-- end flex / token guard -->

<!-- ============================================================ -->
<!-- RISK MODAL -->
<!-- ============================================================ -->
<div class="modal-overlay" x-show="riskModal.open" @click.self="riskModal.open = false" x-transition>
  <div class="modal" @click.stop>
    <div class="modal-header">
      <h2><span class="accent">Risk</span> / <span x-text="riskModal.id ? t('editRisk') : t('newRiskTitle')"></span></h2>
      <button @click="riskModal.open = false" style="color:#aaa;font-size:20px;background:none;border:none;cursor:pointer">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="grid grid-cols-2 gap-x-6">
        <!-- LEFT -->
        <div>
          <div class="form-section" x-text="t('riskIdentification')"></div>
          <div class="form-group">
            <label class="form-label" x-text="t('riskTitle')"></label>
            <input class="form-input" type="text" x-model="riskForm.title" :placeholder="t('riskTitlePlaceholder')">
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('descriptionLabel')"></label>
            <textarea class="form-input" rows="3" x-model="riskForm.description" :placeholder="t('detailedDesc')"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('category')"></label>
            <select class="form-select" x-model="riskForm.category">
              <option>technical</option><option>budget</option><option>resource</option><option>external</option><option>regulatory</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('probability')"></label>
              <select class="form-select" x-model="riskForm.probability">
                <option value="1" x-text="t('prob1')"></option>
                <option value="2" x-text="t('prob2')"></option>
                <option value="3" x-text="t('prob3')"></option>
                <option value="4" x-text="t('prob4')"></option>
                <option value="5" x-text="t('prob5')"></option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('impact')"></label>
              <select class="form-select" x-model="riskForm.impact">
                <option value="1" x-text="t('impact1')"></option>
                <option value="2" x-text="t('impact2')"></option>
                <option value="3" x-text="t('impact3')"></option>
                <option value="4" x-text="t('impact4')"></option>
                <option value="5" x-text="t('impact5')"></option>
              </select>
            </div>
          </div>
          <!-- Live score -->
          <div class="form-group">
            <label class="form-label" x-text="t('riskScore')"></label>
            <span class="badge text-base font-bold px-4 py-1" :style="riskScoreStyle(riskForm.probability * riskForm.impact)"
              x-text="riskForm.probability * riskForm.impact"></span>
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('status')"></label>
            <select class="form-select" x-model="riskForm.status">
              <option>Open</option><option>Monitoring</option><option>Mitigated</option><option>Closed</option>
            </select>
          </div>
        </div>
        <!-- RIGHT -->
        <div>
          <div class="form-section" x-text="t('plansResponsibility')"></div>
          <div class="form-group">
            <label class="form-label" x-text="t('owner')"></label>
            <select class="form-select" x-model="riskForm.ownerId">
              <option value="" x-text="t('unassigned')"></option>
              <template x-for="p in people" :key="p.id">
                <option :value="p.id" x-text="p.name"></option>
              </template>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('identificationDate')"></label>
              <input class="form-input" type="date" x-model="riskForm.dateIdentified">
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('reviewDate')"></label>
              <input class="form-input" type="date" x-model="riskForm.reviewDate">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('materializationDate')"></label>
            <input class="form-input" type="date" x-model="riskForm.materializationDate">
            <div class="text-xs text-gray-400 mt-1"><span x-text="t('materializationHelp')"></span></div>
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('mitigationPlan')"></label>
            <textarea class="form-input" rows="3" x-model="riskForm.mitigationPlan" :placeholder="t('mitigationPlaceholder')"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('contingencyPlan')"></label>
            <textarea class="form-input" rows="3" x-model="riskForm.contingencyPlan" :placeholder="t('contingencyPlaceholder')"></textarea>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" @click="riskModal.open = false" x-text="t('cancel')"></button>
      <button class="btn-primary" @click="saveRisk()" x-text="t('saveRisk')"></button>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- ISSUE MODAL -->
<!-- ============================================================ -->
<div class="modal-overlay" x-show="issueModal.open" @click.self="issueModal.open = false" x-transition>
  <div class="modal" @click.stop>
    <div class="modal-header">
      <h2><span class="accent">Issue</span> / <span x-text="issueModal.id ? t('editIssue') : t('newIssueTitle')"></span></h2>
      <button @click="issueModal.open = false" style="color:#aaa;font-size:20px;background:none;border:none;cursor:pointer">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="grid grid-cols-2 gap-x-6">
        <!-- LEFT -->
        <div>
          <div class="form-section" x-text="t('basicInfo')"></div>
          <div class="form-group">
            <label class="form-label" x-text="t('riskTitle')"></label>
            <input class="form-input" type="text" x-model="issueForm.title" :placeholder="t('issueTitlePlaceholder')">
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('descriptionLabel')"></label>
            <textarea class="form-input" rows="3" x-model="issueForm.description" :placeholder="t('detailedDesc')"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('issueType')"></label>
              <select class="form-select" x-model="issueForm.type">
                <option>Bug</option><option>Operational</option><option>Blocking</option><option>Financial</option><option>Compliance</option><option>Timing</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('status')"></label>
              <select class="form-select" x-model="issueForm.status">
                <option>Open</option><option>In progress</option><option>Escalated</option><option>Resolved</option><option>Closed</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('issueSeverity')"></label>
              <select class="form-select" x-model="issueForm.severity">
                <option>Critical</option><option>High</option><option>Medium</option><option>Low</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('issuePriority')"></label>
              <select class="form-select" x-model="issueForm.priority">
                <option>Critical</option><option>High</option><option>Medium</option><option>Low</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('rootCause')"></label>
            <textarea class="form-input" rows="2" x-model="issueForm.rootCause" :placeholder="t('rootCausePlaceholder')"></textarea>
          </div>
        </div>
        <!-- RIGHT -->
        <div>
          <div class="form-section" x-text="t('responsibilityLinks')"></div>
          <div class="form-group">
            <label class="form-label" x-text="t('owner')"></label>
            <select class="form-select" x-model="issueForm.ownerId">
              <option value="" x-text="t('unassigned')"></option>
              <template x-for="p in people" :key="p.id">
                <option :value="p.id" x-text="p.name"></option>
              </template>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('dueDate')"></label>
            <input class="form-input" type="date" x-model="issueForm.dueDate">
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('linkedRisk')"></label>
            <select class="form-select" x-model="issueForm.linkedRiskId">
              <option value="" x-text="t('noLink')"></option>
              <template x-for="r in risks" :key="r.id">
                <option :value="r.id" x-text="'R-' + String(r.id).padStart(3,'0') + ' ' + r.title"></option>
              </template>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('linkedCR')"></label>
            <select class="form-select" x-model="issueForm.linkedChangeRequestId">
              <option value="" x-text="t('noLink')"></option>
              <template x-for="cr in changes" :key="cr.id">
                <option :value="cr.id" x-text="'CR-' + String(cr.id).padStart(3,'0') + ' ' + cr.title"></option>
              </template>
            </select>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" @click="issueModal.open = false" x-text="t('cancel')"></button>
      <button class="btn-primary" @click="saveIssue()" x-text="t('saveIssue')"></button>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- CHANGE REQUEST MODAL -->
<!-- ============================================================ -->
<div class="modal-overlay" x-show="changeModal.open" @click.self="changeModal.open = false" x-transition>
  <div class="modal" style="width:960px;max-width:98%" @click.stop>
    <div class="modal-header">
      <h2><span class="accent">Change</span> / <span x-text="changeModal.id ? t('editChange') : t('newChangeTitle')"></span></h2>
      <button @click="changeModal.open = false" style="color:#aaa;font-size:20px;background:none;border:none;cursor:pointer">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="grid grid-cols-2 gap-x-6">
        <!-- LEFT -->
        <div>
          <div class="form-section" x-text="t('basicInfo')"></div>
          <div class="form-group">
            <label class="form-label" x-text="t('riskTitle')"></label>
            <input class="form-input" type="text" x-model="changeForm.title" :placeholder="t('changeTitlePlaceholder')">
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('descriptionLabel')"></label>
            <textarea class="form-input" rows="3" x-model="changeForm.description" :placeholder="t('changeDesc')"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('changeType')"></label>
              <select class="form-select" x-model="changeForm.changeType">
                <option>Scope</option><option>Budget</option><option>Timeline</option><option>Technical</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('approvalStatus')"></label>
              <select class="form-select" x-model="changeForm.approvalStatus">
                <option>Draft</option><option>Submitted</option><option>Approved</option><option>Rejected</option><option>Implemented</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('requestedBy')"></label>
              <select class="form-select" x-model="changeForm.requestedById">
                <option value="" x-text="t('selectPerson')"></option>
                <template x-for="p in people" :key="p.id">
                  <option :value="p.id" x-text="p.name"></option>
                </template>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('approvedBy')"></label>
              <select class="form-select" x-model="changeForm.approvedById">
                <option value="" x-text="t('selectPerson')"></option>
                <template x-for="p in people" :key="p.id">
                  <option :value="p.id" x-text="p.name"></option>
                </template>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('businessJustification')"></label>
            <textarea class="form-input" rows="3" x-model="changeForm.businessJustification" :placeholder="t('businessJustPlaceholder')"></textarea>
          </div>
        </div>
        <!-- RIGHT -->
        <div>
          <div class="form-section" x-text="t('impactAnalysis')"></div>
          <div class="form-group">
            <label class="form-label" x-text="t('budgetImpact')"></label>
            <input class="form-input" type="number" x-model="changeForm.budgetImpact" placeholder="0">
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('timelineImpact')"></label>
            <input class="form-input" type="text" x-model="changeForm.timelineImpact" :placeholder="t('timelineImpactPlaceholder')">
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('resourceImpact')"></label>
            <input class="form-input" type="text" x-model="changeForm.resourceImpact" :placeholder="t('resourceImpactPlaceholder')">
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('riskImpact')"></label>
            <input class="form-input" type="text" x-model="changeForm.riskImpact" :placeholder="t('riskImpactPlaceholder')">
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('linkedRequirements')"></label>
            <textarea class="form-input" rows="2" x-model="changeForm.linkedRequirements" :placeholder="t('linkedReqPlaceholder')"></textarea>
          </div>
          <div class="form-section" x-text="t('links')"></div>
          <div class="form-group">
            <label class="form-label" x-text="t('linkedRisks')"></label>
            <div style="max-height:100px;overflow-y:auto;border:1px solid #e0e0e0;border-radius:4px;padding:6px">
              <template x-for="r in risks" :key="r.id">
                <label style="display:flex;align-items:center;gap:6px;padding:2px 0;cursor:pointer;font-size:12px">
                  <input type="checkbox" :value="r.id" :checked="changeForm.linkedRiskIds.includes(r.id)"
                    @change="toggleCRLink('linkedRiskIds', r.id, $event.target.checked)">
                  <span class="badge" :style="riskScoreStyle(r.score)" x-text="r.score"></span>
                  <span x-text="'R-' + String(r.id).padStart(3,'0') + ' ' + r.title"></span>
                </label>
              </template>
              <div x-show="!risks.length" class="text-xs text-gray-400 p-1" x-text="t('noRisksInSystem')"></div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('linkedIssues')"></label>
            <div style="max-height:100px;overflow-y:auto;border:1px solid #e0e0e0;border-radius:4px;padding:6px">
              <template x-for="iss in issues" :key="iss.id">
                <label style="display:flex;align-items:center;gap:6px;padding:2px 0;cursor:pointer;font-size:12px">
                  <input type="checkbox" :value="iss.id" :checked="changeForm.linkedIssueIds.includes(iss.id)"
                    @change="toggleCRLink('linkedIssueIds', iss.id, $event.target.checked)">
                  <span class="badge" :class="severityBadge(iss.severity)" x-text="iss.severity"></span>
                  <span x-text="'I-' + String(iss.id).padStart(3,'0') + ' ' + iss.title"></span>
                </label>
              </template>
              <div x-show="!issues.length" class="text-xs text-gray-400 p-1" x-text="t('noIssuesInSystem')"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" @click="changeModal.open = false" x-text="t('cancel')"></button>
      <button class="btn-primary" @click="saveChange()" x-text="t('saveChange')"></button>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- ASSUMPTION MODAL -->
<!-- ============================================================ -->
<div class="modal-overlay" x-show="assumptionModal.open" @click.self="assumptionModal.open = false" x-transition>
  <div class="modal" style="max-width:760px" @click.stop>
    <div class="modal-header">
      <h2 x-text="assumptionModal.id ? t('editAssumption') : t('newAssumptionTitle')"></h2>
      <button @click="assumptionModal.open = false" style="color:#aaa;font-size:20px;background:none;border:none;cursor:pointer">‚úï</button>
    </div>
    <!-- Locked warning -->
    <div x-show="assumptionForm._isLocked" style="background:#fef9c3;border:1px solid #fde047;border-radius:6px;padding:10px 14px;margin:0 24px 12px;font-size:12px;color:#854d0e">
      <span x-html="t('assumptionLocked')"></span>
    </div>
    <!-- Converted to Risk info -->
    <div x-show="assumptionForm._convertedRiskId" style="background:#fee2e2;border:1px solid #fca5a5;border-radius:6px;padding:10px 14px;margin:0 24px 12px;font-size:12px;color:#991b1b">
      <span x-text="t('assumptionConverted')"></span> <strong>#<span x-text="assumptionForm._convertedRiskId"></span></strong>
    </div>
    <div class="modal-body" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <!-- LEFT COLUMN -->
      <div class="space-y-3">
        <div>
          <label class="form-label" x-text="t('riskTitle')"></label>
          <input class="form-input" x-model="assumptionForm.title" :disabled="assumptionForm._isLocked" :placeholder="t('assumptionTitlePlaceholder')">
        </div>
        <div>
          <label class="form-label" x-text="t('detailedDescLabel')"></label>
          <textarea class="form-input" rows="3" x-model="assumptionForm.description" :disabled="assumptionForm._isLocked" :placeholder="t('whatWeAssume')"></textarea>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label class="form-label" x-text="t('category')"></label>
            <select class="form-input" x-model="assumptionForm.category" :disabled="assumptionForm._isLocked">
              <option>Finance</option><option>Scope</option><option>Resource</option>
              <option>Vendor</option><option>Client</option><option>IT</option>
            </select>
          </div>
          <div>
            <label class="form-label" x-text="t('phase')"></label>
            <select class="form-input" x-model="assumptionForm.phase" :disabled="assumptionForm._isLocked">
              <option>Design</option><option>Tender</option><option>Implementation</option><option>Go-live</option>
            </select>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label class="form-label" x-text="t('type')"></label>
            <select class="form-input" x-model="assumptionForm.type" :disabled="assumptionForm._isLocked">
              <option>Strategic</option><option>Operational</option><option>Technical</option>
            </select>
          </div>
          <div>
            <label class="form-label" x-text="t('source')"></label>
            <select class="form-input" x-model="assumptionForm.source" :disabled="assumptionForm._isLocked">
              <option>Client statement</option><option>Vendor proposal</option><option>Internal planning</option>
            </select>
          </div>
        </div>
        <div>
          <label class="form-label" x-text="t('validationMethod')"></label>
          <select class="form-input" x-model="assumptionForm.validationMethod" :disabled="assumptionForm._isLocked">
            <option value="" x-text="t('notSelected')"></option>
            <option>Dokument</option><option>Smlouva</option><option>Email confirmation</option><option>Fyzick√© ovƒõ≈ôen√≠</option>
          </select>
        </div>
        <div>
          <label class="form-label" x-text="t('notesLabel')"></label>
          <textarea class="form-input" rows="2" x-model="assumptionForm.notes" :placeholder="t('internalNotes')"></textarea>
        </div>
      </div>
      <!-- RIGHT COLUMN -->
      <div class="space-y-3">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label class="form-label" x-text="t('status')"></label>
            <select class="form-input" x-model="assumptionForm.status">
              <option>Active</option><option>Under review</option><option>Validated</option>
              <option>Invalid</option><option>Converted to Risk</option><option>Closed</option>
            </select>
          </div>
          <div>
            <label class="form-label" x-text="t('ownerLabel')"></label>
            <select class="form-input" x-model="assumptionForm.ownerId" :disabled="assumptionForm._isLocked">
              <option value="" x-text="t('notSelected')"></option>
              <template x-for="p in people" :key="p.id">
                <option :value="p.id" x-text="p.name"></option>
              </template>
            </select>
          </div>
        </div>
        <div>
          <label class="form-label" x-text="t('validationDate')"></label>
          <input type="date" class="form-input" x-model="assumptionForm.validationDate" :disabled="assumptionForm._isLocked">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label class="form-label" x-text="t('budgetImpactCzk')"></label>
            <input type="number" class="form-input" x-model="assumptionForm.budgetImpact" :disabled="assumptionForm._isLocked" placeholder="0">
          </div>
          <div>
            <label class="form-label" x-text="t('timelineImpactDays')"></label>
            <input type="number" class="form-input" x-model="assumptionForm.timelineImpact" :disabled="assumptionForm._isLocked" placeholder="0">
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label class="form-label" x-text="t('scopeImpact')"></label>
            <select class="form-input" x-model="assumptionForm.scopeImpact" :disabled="assumptionForm._isLocked">
              <option>Low</option><option>Medium</option><option>High</option>
            </select>
          </div>
          <div>
            <label class="form-label" x-text="t('invalidationProb')"></label>
            <select class="form-input" x-model="assumptionForm.invalidationProbability" :disabled="assumptionForm._isLocked">
              <option value="1" x-text="t('prob1')"></option><option value="2" x-text="t('prob2')"></option>
              <option value="3" x-text="t('prob3')"></option><option value="4" x-text="t('prob4')"></option>
              <option value="5" x-text="t('prob5')"></option>
            </select>
          </div>
        </div>
        <!-- Exposure score live preview -->
        <div style="background:#f8f8f8;border-radius:8px;padding:12px;text-align:center">
          <div style="font-size:11px;color:#999;margin-bottom:4px" x-text="t('exposureScoreLabel')"></div>
          <div :style="'font-size:28px;font-weight:800;color:' + exposureColor(parseInt(assumptionForm.invalidationProbability) * ({'Low':1,'Medium':2,'High':3}[assumptionForm.scopeImpact] ?? 2))"
            x-text="parseInt(assumptionForm.invalidationProbability) * ({'Low':1,'Medium':2,'High':3}[assumptionForm.scopeImpact] ?? 2)"></div>
          <div style="font-size:10px;color:#aaa;margin-top:2px" x-text="t('exposureMax')"></div>
        </div>
        <!-- Warning for Invalid status -->
        <div x-show="assumptionForm.status === 'Invalid'" style="background:#fef2f2;border:1px solid #fca5a5;border-radius:6px;padding:10px 12px;font-size:11px;color:#991b1b">
          <span x-html="t('invalidWarning')"></span>
        </div>
        <!-- Info for Validated status -->
        <div x-show="assumptionForm.status === 'Validated'" style="background:#f0fdf4;border:1px solid #86efac;border-radius:6px;padding:10px 12px;font-size:11px;color:#166534">
          <span x-html="t('validatedInfo')"></span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" @click="assumptionModal.open = false" x-text="t('cancel')"></button>
      <button class="btn-primary" @click="saveAssumption()" x-text="t('saveAssumption')"></button>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- ITEM MODAL -->
<!-- ============================================================ -->
<div class="modal-overlay" x-show="itemModal.open" @click.self="itemModal.open = false" x-transition>
  <div class="modal" @click.stop>
    <div class="modal-header">
      <h2><span class="accent" x-text="projectName || 'PM Tool'"></span> / <span x-text="itemModal.id ? t('editItem') : t('newItemTitle')"></span></h2>
      <button @click="itemModal.open = false" style="color:#aaa;font-size:20px;background:none;border:none;cursor:pointer">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="grid grid-cols-2 gap-x-6">

        <!-- LEFT COLUMN -->
        <div>
          <div class="form-section" x-text="t('basicInfo')"></div>
          <div class="form-group">
            <label class="form-label" x-text="t('itemDescLabel')"></label>
            <input class="form-input" type="text" x-model="itemForm.description" :placeholder="t('itemDescPlaceholder')">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('category')"></label>
              <select class="form-select" x-model="itemForm.category" @change="itemForm.subcategory = ''">
                <option value="" x-text="t('selectPerson')"></option>
                <template x-for="c in categories" :key="c.id">
                  <option :value="c.name" x-text="c.name"></option>
                </template>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('subcategory')"></label>
              <select class="form-select" x-model="itemForm.subcategory">
                <option value="" x-text="t('selectPerson')"></option>
                <template x-for="s in subcatsForSelected" :key="s">
                  <option :value="s" x-text="s"></option>
                </template>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('colType')"></label>
              <select class="form-select" x-model="itemForm.itemType">
                <option value="">‚Äî</option>
                <option>One-off</option><option>Lease</option><option>Subscription</option>
                <option>Service</option><option>CAPEX</option><option>OPEX</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('unitLabel')"></label>
              <input class="form-input" type="text" x-model="itemForm.unit" :placeholder="t('unitPlaceholder')">
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('quantity')"></label>
              <input class="form-input" type="number" x-model="itemForm.quantity" min="0">
            </div>
          </div>

          <div class="form-section" x-text="t('financial')"></div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('totalEstimate')"></label>
              <input class="form-input" type="number" x-model="itemForm.totalEstCost" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('additionalCosts')"></label>
              <input class="form-input" type="number" x-model="itemForm.additionalCostRevision" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('estimateRevised')"></label>
              <input class="form-input" type="number" x-model="itemForm.totalCostAfterRevision" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('actualPrice')"></label>
              <input class="form-input" type="number" x-model="itemForm.actualPrice" placeholder="0">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('depreciation')"></label>
              <input class="form-input" type="number" x-model="itemForm.depreciationMonths" placeholder="36">
            </div>
            <div class="form-group flex items-end pb-1">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" x-model="itemForm.capexNeeded" class="w-4 h-4">
                <span class="form-label mb-0" x-text="t('capexItem')"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div>
          <div class="form-section" x-text="t('tenderProcurement')"></div>
          <div class="form-group">
            <label class="form-label" x-text="t('colTenderStatus')"></label>
            <select class="form-select" x-model="itemForm.tenderStatus">
              <option value="" x-text="t('notSelected')"></option>
              <template x-for="s in TENDER_STATUSES" :key="s">
                <option :value="s" x-text="s"></option>
              </template>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('tenderStartLabel')"></label>
              <input class="form-input" type="date" x-model="itemForm.tenderStartDate">
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('tenderDeadlineLabel')"></label>
              <input class="form-input" type="date" x-model="itemForm.tenderDeadline">
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('orderDateLabel')"></label>
              <input class="form-input" type="date" x-model="itemForm.orderPlaceDate">
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('deliveryDateLabel')"></label>
              <input class="form-input" type="date" x-model="itemForm.deliveryDate">
            </div>
          </div>

          <div class="form-section" x-text="t('responsibilityPriority')"></div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('responsiblePerson')"></label>
              <select class="form-select" x-model="itemForm.responsibleId">
                <option :value="null" x-text="t('unassigned')"></option>
                <template x-for="p in people" :key="p.id">
                  <option :value="p.id" x-text="p.name"></option>
                </template>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('issuePriority')"></label>
              <select class="form-select" x-model="itemForm.priorityId">
                <option :value="null" x-text="t('notSelected')"></option>
                <template x-for="p in priorities" :key="p.id">
                  <option :value="p.id" x-text="p.name"></option>
                </template>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="form-group">
              <label class="form-label" x-text="t('approvalLabel')"></label>
              <select class="form-select" x-model="itemForm.approval">
                <option value="" x-text="t('notSelected')"></option>
                <option>Approved</option>
                <option>Pending</option>
                <option>Rejected</option>
                <option>Not Required</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" x-text="t('chosenSupplier')"></label>
              <input class="form-input" type="text" x-model="itemForm.chosenSupplier" :placeholder="t('supplierPlaceholder')">
            </div>
          </div>

          <div class="form-section" x-text="t('notesSection')"></div>
          <div class="form-group">
            <label class="form-label" x-text="t('bottleneck')"></label>
            <input class="form-input" type="text" x-model="itemForm.bottleneck" :placeholder="t('bottleneckPlaceholder')">
          </div>
          <div class="form-group">
            <label class="form-label" x-text="t('notesLabel')"></label>
            <textarea class="form-input" x-model="itemForm.notes" rows="3" :placeholder="t('notesPlaceholderItem')"></textarea>
          </div>
        </div>

      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" @click="itemModal.open = false" x-text="t('cancel')"></button>
      <button class="btn-primary" @click="saveItem()">
        <span x-text="itemModal.id ? t('saveItem') : t('createItem')"></span>
      </button>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- DETAIL PANEL OVERLAY -->
<!-- ============================================================ -->
<div x-show="detailPanel.open" x-cloak
     style="position:fixed;inset:0;background:rgba(0,0,0,0.18);z-index:899"
     @click="closeDetail()"
     x-transition:enter="transition-opacity duration-200"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition-opacity duration-150"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
</div>

<div class="detail-panel" :class="{ 'is-open': detailPanel.open }" x-cloak @click.stop>
  <template x-if="detailPanel.item">
    <div style="display:contents">

      <!-- Panel header -->
      <div class="detail-panel-header">
        <div class="flex items-start justify-between gap-3">
          <div style="flex:1;min-width:0">
            <div style="font-size:11px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px"><span x-text="t('detailTitle')"></span></div>
            <div style="font-size:16px;font-weight:700;color:white;line-height:1.3;word-break:break-word" x-text="detailPanel.item.description"></div>
            <div style="margin-top:5px;font-size:11px;color:#aaa" x-text="[detailPanel.item.category, detailPanel.item.subcategory, detailPanel.item.itemType].filter(Boolean).join(' ¬∑ ') || '‚Äî'"></div>
          </div>
          <button @click="closeDetail()" style="background:none;border:none;color:#888;font-size:22px;cursor:pointer;flex-shrink:0;line-height:1;margin-top:-2px">‚úï</button>
        </div>
        <!-- Status + priority badges -->
        <div class="flex gap-2 flex-wrap mt-3">
          <span x-show="detailPanel.item.tenderStatus" class="badge" :class="statusBadge(detailPanel.item.tenderStatus)" x-text="detailPanel.item.tenderStatus"></span>
          <span x-show="detailPanel.item.priority" class="badge" :style="'background:' + (detailPanel.item.priority?.color ?? '#ccc') + '22;color:' + (detailPanel.item.priority?.color ?? '#666')" x-text="detailPanel.item.priority?.name"></span>
          <span x-show="detailPanel.item.approval" class="badge" :class="approvalBadge(detailPanel.item.approval)" x-text="detailPanel.item.approval"></span>
          <span x-show="detailPanel.item.capexNeeded" class="badge badge-red">CAPEX</span>
        </div>
      </div>

      <!-- Panel body -->
      <div class="detail-panel-body">

        <!-- Financial -->
        <div style="margin-bottom:14px">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--dhl-grey);margin-bottom:8px;border-left:3px solid var(--dhl-yellow);padding-left:8px" x-text="t('financing')"></div>
          <div class="grid grid-cols-3 gap-3">
            <div class="detail-field">
              <div class="detail-field-label" x-text="t('estimate')"></div>
              <div class="detail-field-value font-mono font-bold" x-text="fmtMoney(detailPanel.item.totalEstCost) || '‚Äî'"></div>
            </div>
            <div class="detail-field">
              <div class="detail-field-label" x-text="t('actual')"></div>
              <div class="detail-field-value font-mono font-bold"
                :class="detailPanel.item.actualPrice > detailPanel.item.totalEstCost ? 'text-red-600' : 'text-green-600'"
                x-text="fmtMoney(detailPanel.item.actualPrice) || '‚Äî'"></div>
            </div>
            <div class="detail-field">
              <div class="detail-field-label" x-text="t('difference')"></div>
              <template x-if="detailPanel.item.actualPrice != null && detailPanel.item.totalEstCost != null">
                <div class="detail-field-value font-mono font-bold"
                  :class="(detailPanel.item.actualPrice - detailPanel.item.totalEstCost) > 0 ? 'text-red-600' : 'text-green-600'">
                  <span x-text="(detailPanel.item.actualPrice - detailPanel.item.totalEstCost) > 0 ? '‚ñ≤ ' : '‚ñº '"></span>
                  <span x-text="fmtMoney(Math.abs(detailPanel.item.actualPrice - detailPanel.item.totalEstCost))"></span>
                </div>
              </template>
              <template x-if="detailPanel.item.actualPrice == null || detailPanel.item.totalEstCost == null">
                <div class="detail-field-value text-gray-400">‚Äî</div>
              </template>
            </div>
          </div>
        </div>

        <!-- Dates + people -->
        <div style="margin-bottom:14px">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--dhl-grey);margin-bottom:8px;border-left:3px solid var(--dhl-yellow);padding-left:8px" x-text="t('datesResponsibility')"></div>
          <div class="grid grid-cols-2 gap-3">
            <div class="detail-field">
              <div class="detail-field-label" x-text="t('responsible')"></div>
              <div class="detail-field-value" x-text="detailPanel.item.responsible?.name || '‚Äî'"></div>
            </div>
            <div class="detail-field">
              <div class="detail-field-label" x-text="t('supplier')"></div>
              <div class="detail-field-value" x-text="detailPanel.item.chosenSupplier || '‚Äî'"></div>
            </div>
            <div class="detail-field">
              <div class="detail-field-label" x-text="t('tenderDeadlineLabel')"></div>
              <div class="detail-field-value" :class="deadlineClass(detailPanel.item.tenderDeadline)" x-text="fmtDate(detailPanel.item.tenderDeadline)"></div>
            </div>
            <div class="detail-field">
              <div class="detail-field-label" x-text="t('deliveryDateLabel')"></div>
              <div class="detail-field-value" x-text="fmtDate(detailPanel.item.deliveryDate)"></div>
            </div>
          </div>
        </div>

        <!-- Notes / bottleneck -->
        <div x-show="detailPanel.item.notes || detailPanel.item.bottleneck" style="margin-bottom:14px">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--dhl-grey);margin-bottom:8px;border-left:3px solid var(--dhl-yellow);padding-left:8px" x-text="t('notesLabel')"></div>
          <div x-show="detailPanel.item.bottleneck" class="text-xs font-semibold text-red-600 mb-1" x-text="'‚ö† ' + detailPanel.item.bottleneck"></div>
          <div x-show="detailPanel.item.notes" class="text-sm text-gray-600" x-text="detailPanel.item.notes"></div>
        </div>

        <!-- Comments / conversation -->
        <div class="comments-section">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--dhl-grey);margin-bottom:10px;border-left:3px solid var(--dhl-yellow);padding-left:8px">
            <span x-text="t('conversation')"></span>
            <span x-show="comments.length" style="font-weight:400;color:#aaa;text-transform:none;letter-spacing:0" x-text="'(' + comments.length + ')'"></span>
          </div>

          <div x-show="!comments.length" class="text-xs text-gray-400 text-center py-2" x-text="t('noComments')"></div>

          <template x-for="c in comments" :key="c.id">
            <div class="comment-bubble">
              <div class="comment-meta">
                <span class="comment-author" x-text="c.author"></span>
                <span class="comment-time" x-text="fmtDateTime(c.createdAt)"></span>
                <button class="comment-del" @click="deleteComment(c.id)" :title="t('deleteComment')">√ó</button>
              </div>
              <div class="comment-text" x-text="c.text"></div>
            </div>
          </template>

          <div class="comment-add">
            <textarea x-model="commentInput" :placeholder="t('commentPlaceholder')" rows="2"
              @keydown.ctrl.enter.prevent="addComment()"></textarea>
            <button class="btn-primary btn-sm" @click="addComment()" x-text="t('sendComment')"></button>
          </div>
        </div>

      </div><!-- end panel body -->

      <!-- Panel footer -->
      <div class="detail-panel-footer">
        <button class="btn-primary" @click="openEditItem(detailPanel.item)" x-text="t('editItemBtn')"></button>
        <button class="btn-ghost" @click="closeDetail()" x-text="t('close')"></button>
        <div style="flex:1"></div>
        <button class="btn-danger btn-sm" @click="deleteItem(detailPanel.item.id); closeDetail()" x-text="t('deleteBtn')"></button>
      </div>

    </div>
  </template>
</div>

<script>
const API = ''

// ‚îÄ‚îÄ Auth: intercept all /api/* fetch calls to inject Bearer token ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
;(function () {
  const _fetch = window.fetch
  window.fetch = function (url, opts = {}) {
    if (typeof url === 'string' && url.includes('/api/') && !url.includes('/api/auth/login')) {
      const token = localStorage.getItem('bt-token')
      if (token) {
        const projectId = localStorage.getItem('bt-project-id')
        const extraHeaders = { 'Authorization': `Bearer ${token}` }
        if (projectId) extraHeaders['X-Project-Id'] = projectId
        opts = { ...opts, headers: { ...extraHeaders, ...(opts.headers || {}) } }
      }
    }
    return _fetch.call(this, url, opts).then(r => {
      if (r.status === 401 && typeof url === 'string' && url.includes('/api/') && localStorage.getItem('bt-token')) {
        // Token expired / invalid ‚Äî clear and reload to show login screen
        localStorage.removeItem('bt-token')
        localStorage.removeItem('bt-auth-user')
        location.reload()
      }
      return r
    })
  }
})()

// Chart instances stored OUTSIDE Alpine reactivity ‚Äî Alpine's Proxy corrupts Chart.js internal state
const _charts = {}

// Column resize ‚Äî module level to avoid Alpine proxy
const COL_WIDTHS_KEY = 'bt-col-widths'
let _rTh = null, _rX0 = 0, _rW0 = 0, _rHandle = null

function startColResize(e, handle) {
  _rTh = handle.closest('th')
  _rX0 = e.clientX
  _rW0 = _rTh.offsetWidth
  _rHandle = handle
  handle.classList.add('resizing')
  e.preventDefault()
}

function saveColWidths() {
  const table = document.getElementById('assetTable')
  if (!table) return
  const widths = Array.from(table.querySelectorAll('thead th')).map(th => th.offsetWidth)
  localStorage.setItem(COL_WIDTHS_KEY, JSON.stringify(widths))
}

function restoreColWidths() {
  try {
    const saved = localStorage.getItem(COL_WIDTHS_KEY)
    if (!saved) return
    const widths = JSON.parse(saved)
    const table = document.getElementById('assetTable')
    if (!table) return
    table.querySelectorAll('thead th').forEach((th, i) => {
      if (widths[i] > 0) {
        th.style.width = widths[i] + 'px'
        th.style.minWidth = widths[i] + 'px'
      }
    })
  } catch {}
}

document.addEventListener('mousemove', e => {
  if (!_rTh) return
  const w = Math.max(50, _rW0 + e.clientX - _rX0)
  _rTh.style.width = w + 'px'
  _rTh.style.minWidth = w + 'px'
})
document.addEventListener('mouseup', () => {
  if (_rHandle) _rHandle.classList.remove('resizing')
  if (_rTh) saveColWidths()
  _rTh = null; _rHandle = null
})

const TENDER_STATUSES = [
  'Not Tender Needed',
  'Tender Planned',
  'Tender Closed',
  'Implementation',
  'Approved',
  'Complete',
]

function app() {
  return {
    view: 'dashboard',
    settingsTab: 'people',
    lang: localStorage.getItem('bt-lang') || 'cs',
    t(key) { return (T[this.lang] || T.cs)[key] || (T.cs)[key] || key },
    setLang(l) { this.lang = l; localStorage.setItem('bt-lang', l); document.documentElement.lang = l },

    // Data
    items: [],
    people: [],
    categories: [],
    priorities: [],
    departments: [],
    labor: [],
    laborSpent: [],
    dash: {},

    // Filters
    filters: { search: '', category: '', tenderStatus: '', responsibleId: '', priorityId: '', capexOnly: false },

    // Detail panel
    detailPanel: { open: false, item: null },
    comments: [],
    commentInput: '',
    // Forms
    itemModal: { open: false, id: null },
    itemForm: {},
    personForm: { open: false, id: null, name: '', email: '', department: '' },
    categoryForm: { open: false, id: null, name: '', subcatText: '' },
    priorityForm: { open: false, id: null, name: '', color: '#FFCC00', rank: 0 },
    laborForm: { open: false, id: null, role: '', personName: '', department: '', costType: 'Project', mdRate: '', mdDays: '', notes: '' },
    laborDetail: { open: false, lc: null },
    laborFormEntries: [],
    laborEntryForm: { month: new Date().toISOString().slice(0, 7), amount: '', note: '' },
    laborWarningPct: 80,
    departmentForm: { name: '' },
    settingsForm: { eurRate: '25', currentUser: 'Admin', projectName: '', laborWarningPct: '80', logoWidth: '96', logoBgColor: '#FFCC00' },

    // Logo & branding
    logoSrc: '/logo.svg',
    logoWidth: 96,
    logoBgColor: '#FFCC00',
    projectName: '',
    settingsSaved: false,
    colorPalette: 'classic',
    palettes: [
      { id: 'classic',    name: 'Classic', accent: '#FFCC00', dark: '#1A1A1A', mid: '#2C2C2C', light: '#F4F4F4' },
      { id: 'ocean',  name: 'Ocean',  accent: '#38BDF8', dark: '#0F172A', mid: '#1E293B', light: '#F0F9FF' },
      { id: 'forest', name: 'Forest', accent: '#4ADE80', dark: '#052E16', mid: '#14532D', light: '#F0FDF4' },
      { id: 'indigo', name: 'Indigo', accent: '#A78BFA', dark: '#1E1B4B', mid: '#312E81', light: '#F5F3FF' },
      { id: 'sunset', name: 'Sunset', accent: '#FB923C', dark: '#431407', mid: '#7C2D12', light: '#FFF7ED' },
    ],

    // Currency
    currency: 'CZK',
    eurRate: 25,

    // Auth
    token: localStorage.getItem('bt-token') || null,
    authUser: JSON.parse(localStorage.getItem('bt-auth-user') || 'null'),
    loginForm: { email: '', password: '', error: '', loading: false },
    loginStep: 'credentials',  // 'credentials' | 'projects'
    registerForm: { companyName: '', companySlug: '', planSlug: '', userName: '', userEmail: '', userPassword: '', captchaId: '', captchaQuestion: '', captchaAnswer: null, error: '', success: '', loading: false },

    // Support modal
    supportModal: { show: false, subject: '', message: '', sending: false, success: false, error: '' },

    // Projects (multi-project workspace)
    projects: JSON.parse(localStorage.getItem('bt-projects') || '[]'),
    activeProjectId: parseInt(localStorage.getItem('bt-project-id') || '0') || null,
    showProjectPicker: false,

    // Current user (for audit log)
    currentUser: 'Admin',

    // Audit log
    auditLog: [],
    auditFilter: '',
    auditCategory: 'Budget Tracker',

    // Users (admin)
    users: [],
    SECTIONS: ['assets','labor','testing','risks','issues','changes','assumptions','projectplan'],
    SECTION_LABELS: { assets:'Assets / Budget', labor:'Lid√© / PM n√°klady', testing:'Test Management', risks:'Risk Management', issues:'Issue Tracker', changes:'Change Management', assumptions:'Assumption Log', projectplan:'Project Plan' },
    userForm: {
      id: null, email: '', name: '', password: '', error: '', role: 'user',
      permissions: { assets:'none', labor:'none', testing:'none', risks:'none', issues:'none', changes:'none', assumptions:'none', projectplan:'none' }
    },

    // Project management (admin)
    projectForm: { id: null, name: '', description: '', error: '' },
    projectMembers: [],
    projectMembersProjectId: null,

    // Company management (superadmin)
    companies: [],
    companyOverview: null,
    companyForm: { id: null, name: '', slug: '', planId: null, status: 'trial', maxProjectsOverride: null, maxUsersOverride: null, adminEmail: '', adminName: '', adminPassword: '', error: '', _showCreate: false },
    // SaaS plan management
    companyStatus: localStorage.getItem('bt-company-status') || 'active',
    trialEndsAt: localStorage.getItem('bt-trial-ends-at') || null,
    planSections: JSON.parse(localStorage.getItem('bt-plan-sections') || '[]'),
    planName: localStorage.getItem('bt-plan-name') || null,
    companyBlocked: false,
    plans: [],
    planForm: { id: null, name: '', slug: '', sections: [], maxProjects: 1, maxUsers: 5, priceMonthly: 0, description: '', isDefault: false, isPublic: false, error: '', _showCreate: false },
    publicPlans: [],
    invoices: [],
    saasStats: null,

    ganttFilter: 'all',

    TENDER_STATUSES,

    // ‚îÄ‚îÄ Risk Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    risks: [],
    riskTab: 'list',
    riskFilters: { status: '', category: '' },
    riskModal: { open: false, id: null },
    riskForm: { title: '', description: '', category: 'technical', probability: 3, impact: 3, mitigationPlan: '', contingencyPlan: '', ownerId: '', status: 'Open', dateIdentified: '', reviewDate: '', materializationDate: '' },
    riskTrendId: '',
    _top10Chart: null,
    _trendChart: null,

    // ‚îÄ‚îÄ Issue Tracker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    issues: [],
    issueFilters: { status: '', severity: '', type: '' },
    issueModal: { open: false, id: null },
    issueForm: { title: '', description: '', type: 'Bug', severity: 'Medium', priority: 'Medium', status: 'Open', ownerId: '', dueDate: '', rootCause: '', linkedRiskId: '', linkedChangeRequestId: '' },

    // ‚îÄ‚îÄ Change Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    changes: [],
    changeFilters: { approvalStatus: '', changeType: '' },
    changeModal: { open: false, id: null },
    changeForm: { title: '', description: '', changeType: 'Scope', businessJustification: '', budgetImpact: null, timelineImpact: '', resourceImpact: '', riskImpact: '', requestedById: '', approvedById: '', approvalStatus: 'Draft', linkedRiskIds: [], linkedIssueIds: [], linkedRequirements: '' },

    // ‚îÄ‚îÄ Assumption Log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    assumptions: [],
    assumptionTab: 'list',
    assumptionFilters: { status: '', category: '', phase: '', validationFilter: '' },
    assumptionModal: { open: false, id: null },
    assumptionForm: { title: '', description: '', category: 'Finance', phase: 'Design', type: 'Operational', source: 'Internal planning', validationMethod: '', status: 'Active', ownerId: '', validationDate: '', budgetImpact: null, timelineImpact: null, scopeImpact: 'Medium', invalidationProbability: 3, notes: '', _isLocked: false, _convertedRiskId: null },

    // ‚îÄ‚îÄ Project Plan + Kanban ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    tasks: [],
    ppTab: 'table',
    ppFilters: { status: '', type: '', ownerId: '', search: '' },
    expandedTasks: {},
    showArchived: false,
    taskModal: { open: false, id: null },
    taskForm: { name: '', description: '', type: 'task', parentId: null, ownerId: '', status: 'not_started', progress: 0, isMilestone: false, plannedStart: '', plannedEnd: '', constraintType: '', constraintDate: '', estimatedCost: '', linkedRiskId: '', linkedAssumptionId: '', kanbanColumnId: null },
    taskDeps: [],
    taskDepsNew: { predecessorId: '', type: 'FS', lagDays: 0 },
    kanbanColumns: [],
    kanbanColumnModal: { open: false },
    kanbanColumnForm: [],
    kanbanQuickAdd: {},
    ganttZoom: 'month',
    ppWorkDays: false,

    // ‚îÄ‚îÄ Testing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    testSets: [],
    testStats: null,
    testingTab: 'stats',         // 'stats' | 'sets'
    expandedSets: {},            // setId -> bool
    expandedCases: {},           // caseId -> bool

    // TestSet form
    tsForm: { open: false, id: null, name: '', dateMin: '', dateMax: '', notes: '' },

    // TestCase form
    tcForm: { open: false, id: null, setId: null, name: '', status: 'WIP', notes: '', testedBy: '', dataUsed: '' },

    // TestStep inline add
    stepForms: {},               // caseId -> { description: '', adding: bool }

    // Defect form
    defectForm: { open: false, id: null, caseId: null, title: '', description: '', severity: 'Medium', status: 'Open', reportedBy: '' },

    // Step edit modal
    stepEditForm: { open: false, id: null, description: '', notes: '', status: 'Not Started', testedBy: '', testedAt: '' },

    // CSV import
    csvImport: { open: false, setId: null, setName: '', raw: '', fileName: '', loading: false, error: '' },

    // Waterfall chart instance
    _waterfallChart: null,


    async init() {
      // Apply cached palette immediately to avoid color flash before settings load
      const cachedPalette = localStorage.getItem('colorPalette') || 'classic'
      this.applyPalette(cachedPalette)
      if (!this.token) return  // not logged in ‚Äî show login screen, don't fetch
      // Refresh company status from server (handles superadmin activating company)
      await this.refreshCompanyStatus()
      // If token but no project selected and multiple projects exist, show picker
      if (!this.activeProjectId && this.projects.length > 1) {
        this.showProjectPicker = true
        return
      }
      await Promise.all([this.loadItems(), this.loadPeople(), this.loadCategories(), this.loadPriorities(), this.loadLabor(), this.loadSettings()])
      await Promise.all([this.loadRisks(), this.loadIssues(), this.loadChanges(), this.loadAssumptions()])
      this.loadDashboard()
      this.$nextTick(() => restoreColWidths())
    },

    viewTitle() {
      return { dashboard: this.t('titleDashboard'), assets: this.t('titleAssets'), gantt: this.t('titleTimeline'), labor: this.t('titleLabor'), settings: this.t('titleSettings'), testing: this.t('titleTesting'), risks: this.t('titleRisks'), issues: this.t('titleIssues'), changes: this.t('titleChanges'), assumptions: this.t('titleAssumptions') }[this.view] ?? ''
    },
    viewSubtitle() {
      return { dashboard: this.t('subtitleDashboard'), assets: this.t('subtitleAssets'), gantt: this.t('subtitleTimeline'), labor: this.t('subtitleLabor'), settings: this.t('subtitleSettings'), testing: this.t('subtitleTesting'), risks: this.t('subtitleRisks'), issues: this.t('subtitleIssues'), changes: this.t('subtitleChanges'), assumptions: this.t('subtitleAssumptions') }[this.view] ?? 'PM Tool'
    },

    async loadItems() {
      const params = new URLSearchParams()
      if (this.filters.search) params.set('search', this.filters.search)
      if (this.filters.category) params.set('category', this.filters.category)
      if (this.filters.tenderStatus) params.set('tenderStatus', this.filters.tenderStatus)
      if (this.filters.responsibleId) params.set('responsibleId', this.filters.responsibleId)
      if (this.filters.priorityId) params.set('priorityId', this.filters.priorityId)
      if (this.filters.capexOnly) params.set('capexNeeded', 'true')
      const r = await fetch(`${API}/api/items?` + params)
      if (!r.ok) return
      const data = await r.json()
      this.items = Array.isArray(data) ? data : []
    },

    handleLogoUpload(event) {
      const file = event.target.files[0]
      if (!file) return
      const reader = new FileReader()
      reader.onload = (e) => {
        this.logoSrc = e.target.result
      }
      reader.readAsDataURL(file)
    },

    applyPalette(id) {
      const p = this.palettes.find(x => x.id === id) || this.palettes[0]
      const s = document.documentElement.style
      s.setProperty('--dhl-yellow', p.accent)
      s.setProperty('--dhl-dark', p.dark)
      s.setProperty('--dhl-mid', p.mid)
      s.setProperty('--dhl-light', p.light)
      this.colorPalette = p.id
      localStorage.setItem('colorPalette', p.id)
    },

    async selectPalette(id) {
      this.applyPalette(id)
      await this.apiFetch('PUT', '/api/settings/colorPalette', { value: id })
      this.settingsSaved = true
      setTimeout(() => this.settingsSaved = false, 2000)
    },

    async saveBranding() {
      const width = Math.min(180, Math.max(40, parseInt(this.settingsForm.logoWidth) || 96))
      const color = this.settingsForm.logoBgColor || '#FFCC00'
      await this.apiFetch('PUT', '/api/settings/logoWidth', { value: String(width) })
      await this.apiFetch('PUT', '/api/settings/logoBgColor', { value: color })
      if (this.logoSrc && this.logoSrc !== '/logo.svg') {
        await this.apiFetch('PUT', '/api/settings/logoData', { value: this.logoSrc })
      }
      this.logoWidth = width
      this.logoBgColor = color
      this.settingsSaved = true
      setTimeout(() => this.settingsSaved = false, 2000)
    },

    async resetLogo() {
      this.logoSrc = '/logo.svg'
      this.logoWidth = 96
      this.logoBgColor = '#FFCC00'
      this.settingsForm.logoWidth = '96'
      this.settingsForm.logoBgColor = '#FFCC00'
      await this.apiFetch('PUT', '/api/settings/logoData', { value: '' })
      await this.apiFetch('PUT', '/api/settings/logoWidth', { value: '96' })
      await this.apiFetch('PUT', '/api/settings/logoBgColor', { value: '#FFCC00' })
    },

    async loadPeople() {
      const r = await fetch(`${API}/api/people`)
      if (!r.ok) return
      const d = await r.json()
      this.people = Array.isArray(d) ? d : []
    },

    async loadCategories() {
      const r = await fetch(`${API}/api/categories`)
      if (!r.ok) return
      const d = await r.json()
      this.categories = Array.isArray(d) ? d : []
    },

    async loadPriorities() {
      const r = await fetch(`${API}/api/priorities`)
      if (!r.ok) return
      const d = await r.json()
      this.priorities = Array.isArray(d) ? d : []
    },

    // --- Generic fetch helper (adds Authorization + Content-Type) ---
    async apiFetch(method, path, body = null, extraHeaders = {}) {
      const opts = {
        method,
        headers: {
          'Content-Type': 'application/json',
          ...(this.token ? { 'Authorization': `Bearer ${this.token}` } : {}),
          ...extraHeaders,
        },
      }
      if (body !== null) opts.body = JSON.stringify(body)
      const response = await fetch(`${API}${path}`, opts)
      if (response.status === 403) {
        const clone = response.clone()
        try {
          const err = await clone.json()
          if (err.error === 'company_blocked') { this.companyBlocked = true }
        } catch {}
      }
      return response
    },

    // --- Auth methods ---
    async login() {
      this.loginForm.loading = true
      this.loginForm.error = ''
      try {
        const r = await fetch(`${API}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: this.loginForm.email, password: this.loginForm.password }),
        })
        if (!r.ok) { this.loginForm.error = this.t('errInvalidCredentials'); return }
        const data = await r.json()
        this.token = data.token
        this.authUser = data.user
        this.currentUser = data.user.name
        localStorage.setItem('bt-token', data.token)
        localStorage.setItem('bt-auth-user', JSON.stringify(data.user))
        // Store SaaS plan data
        this.companyStatus = data.companyStatus || 'active'
        this.trialEndsAt = data.trialEndsAt || null
        this.planSections = data.planSections || []
        this.planName = data.planName || null
        localStorage.setItem('bt-company-status', this.companyStatus)
        localStorage.setItem('bt-trial-ends-at', this.trialEndsAt || '')
        localStorage.setItem('bt-plan-sections', JSON.stringify(this.planSections))
        localStorage.setItem('bt-plan-name', this.planName || '')
        // Reset view to dashboard on login (avoid stale view from previous session)
        this.view = 'dashboard'
        this.settingsTab = 'people'
        this.projects = data.projects || []
        localStorage.setItem('bt-projects', JSON.stringify(this.projects))
        if (this.projects.length === 1) {
          this.activeProjectId = this.projects[0].id
          localStorage.setItem('bt-project-id', String(this.projects[0].id))
          await this.init()
        } else if (this.projects.length > 1) {
          this.loginStep = 'projects'  // show project picker in login card
        } else {
          // 0 projects (admin with no project assigned) ‚Äî load app directly
          await this.init()
        }
      } finally {
        this.loginForm.loading = false
      }
    },

    selectProject(id) {
      this.activeProjectId = id
      localStorage.setItem('bt-project-id', String(id))
      this.showProjectPicker = false
      this.init()
    },

    async refreshCompanyStatus() {
      try {
        const r = await fetch(`${API}/api/auth/me`, { headers: { Authorization: `Bearer ${this.token}` } })
        if (!r.ok) return
        const me = await r.json()
        if (me.companyStatus) { this.companyStatus = me.companyStatus; localStorage.setItem('bt-company-status', me.companyStatus) }
        if (me.trialEndsAt !== undefined) { this.trialEndsAt = me.trialEndsAt; localStorage.setItem('bt-trial-ends-at', me.trialEndsAt || '') }
        if (me.planSections) { this.planSections = me.planSections; localStorage.setItem('bt-plan-sections', JSON.stringify(me.planSections)) }
        if (me.planName !== undefined) { this.planName = me.planName; localStorage.setItem('bt-plan-name', me.planName || '') }
      } catch {}
    },

    async submitSupport() {
      this.supportModal.sending = true
      this.supportModal.error = ''
      try {
        const proj = this.projects.find(p => p.id === this.activeProjectId)
        const res = await fetch('/api/support', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + this.token },
          body: JSON.stringify({
            subject: this.supportModal.subject,
            message: this.supportModal.message,
            projectName: proj?.name || 'N/A',
          })
        })
        if (!res.ok) throw new Error('fail')
        this.supportModal.success = true
      } catch {
        this.supportModal.error = true
      } finally {
        this.supportModal.sending = false
      }
    },

    logout() {
      this.token = null
      this.authUser = null
      localStorage.removeItem('bt-token')
      localStorage.removeItem('bt-auth-user')
      localStorage.removeItem('bt-projects')
      localStorage.removeItem('bt-project-id')
      this.projects = []
      this.activeProjectId = null
      this.loginStep = 'credentials'
      this.companyStatus = 'active'
      this.trialEndsAt = null
      this.planSections = []
      this.planName = null
      this.companyBlocked = false
      localStorage.removeItem('bt-company-status')
      localStorage.removeItem('bt-trial-ends-at')
      localStorage.removeItem('bt-plan-sections')
      localStorage.removeItem('bt-plan-name')
    },

    get trialDaysLeft() {
      if (!this.trialEndsAt) return null
      const diff = new Date(this.trialEndsAt) - new Date()
      return Math.max(0, Math.ceil(diff / (1000 * 60 * 60 * 24)))
    },

    async loadPublicPlans() {
      try {
        const r = await fetch(`${API}/api/plans/public`)
        if (r.ok) {
          this.publicPlans = await r.json()
          if (this.publicPlans.length > 0 && !this.registerForm.planSlug) {
            const def = this.publicPlans.find(p => p.isDefault) || this.publicPlans[0]
            this.registerForm.planSlug = def.slug
          }
        }
      } catch {}
      this.loadCaptcha()
    },
    async loadCaptcha() {
      try {
        const r = await fetch(`${API}/api/auth/captcha`)
        if (r.ok) {
          const data = await r.json()
          this.registerForm.captchaId = data.id
          this.registerForm.captchaQuestion = data.question
          this.registerForm.captchaAnswer = null
        }
      } catch {}
    },

    async register() {
      this.registerForm.loading = true
      this.registerForm.error = ''
      this.registerForm.success = ''

      // Frontend field validation
      if (!this.registerForm.companyName || this.registerForm.companyName.length < 2) {
        this.registerForm.error = this.t('errCompanyName')
        this.registerForm.loading = false
        return
      }
      if (!this.registerForm.userName || this.registerForm.userName.length < 1) {
        this.registerForm.error = this.t('errYourName')
        this.registerForm.loading = false
        return
      }
      const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
      if (!this.registerForm.userEmail || !emailRe.test(this.registerForm.userEmail)) {
        this.registerForm.error = this.t('errInvalidEmail')
        this.registerForm.loading = false
        return
      }
      const pw = this.registerForm.userPassword
      if (pw.length < 6 || !/[a-z]/.test(pw) || !/[A-Z]/.test(pw) || !/\d/.test(pw) || !/[^a-zA-Z0-9]/.test(pw)) {
        this.registerForm.error = this.t('errPasswordReq')
        this.registerForm.loading = false
        return
      }
      if (!this.registerForm.planSlug) {
        this.registerForm.error = this.t('errSelectPlan')
        this.registerForm.loading = false
        return
      }
      if (!this.registerForm.captchaAnswer && this.registerForm.captchaAnswer !== 0) {
        this.registerForm.error = this.t('errCaptcha')
        this.registerForm.loading = false
        return
      }

      try {
        const r = await fetch(`${API}/api/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            companyName: this.registerForm.companyName,
            companySlug: this.registerForm.companySlug,
            planSlug: this.registerForm.planSlug,
            userName: this.registerForm.userName,
            userEmail: this.registerForm.userEmail,
            userPassword: this.registerForm.userPassword,
            captchaId: this.registerForm.captchaId,
            captchaAnswer: this.registerForm.captchaAnswer,
          }),
        })
        if (!r.ok) {
          const err = await r.json().catch(() => ({}))
          // Show specific error messages in Czech
          if (err.error === 'Company slug already taken') {
            this.registerForm.error = this.t('errSlugTaken')
          } else if (err.error === 'Email already registered') {
            this.registerForm.error = this.t('errEmailTaken')
          } else if (err.error === 'Invalid plan') {
            this.registerForm.error = this.t('errInvalidPlan')
          } else if (err.details) {
            // Parse Zod validation errors
            const issues = err.details?.fieldErrors || {}
            const msgs = Object.entries(issues).map(([field, errs]) => {
              const labels = { companyName: 'N√°zev firmy', companySlug: 'Slug', planSlug: 'Tarif', userName: 'Jm√©no', userEmail: 'E-mail', userPassword: 'Heslo' }
              return (labels[field] || field) + ': ' + (Array.isArray(errs) ? errs.join(', ') : errs)
            })
            this.registerForm.error = msgs.length > 0 ? msgs.join(' | ') : (err.error || this.t('errRegistrationFailed'))
          } else {
            this.registerForm.error = err.error || this.t('errRegistrationFailed')
          }
          this.loadCaptcha() // reload captcha on error
          return
        }
        const data = await r.json()
        // Individual plan ‚Äî show success message, don't auto-login
        if (data.individual) {
          this.registerForm.success = data.message
          return
        }
        this.token = data.token
        this.authUser = data.user
        this.currentUser = data.user.name
        localStorage.setItem('bt-token', data.token)
        localStorage.setItem('bt-auth-user', JSON.stringify(data.user))
        this.projects = data.projects || []
        localStorage.setItem('bt-projects', JSON.stringify(this.projects))
        this.companyStatus = data.companyStatus || 'trial'
        this.trialEndsAt = data.trialEndsAt || null
        this.planSections = data.planSections || []
        this.planName = data.planName || null
        localStorage.setItem('bt-company-status', this.companyStatus)
        localStorage.setItem('bt-trial-ends-at', this.trialEndsAt || '')
        localStorage.setItem('bt-plan-sections', JSON.stringify(this.planSections))
        localStorage.setItem('bt-plan-name', this.planName || '')
        // Reset view to dashboard after registration (avoid lingering superadmin view)
        this.view = 'dashboard'
        this.settingsTab = 'people'
        if (this.projects.length >= 1) {
          this.activeProjectId = this.projects[0].id
          localStorage.setItem('bt-project-id', String(this.projects[0].id))
          await this.init()
        }
      } finally {
        this.registerForm.loading = false
      }
    },

    // Permission check helper
    can(section, access = 'read') {
      if (!this.authUser) return false
      // Superadmin bypasses everything
      if (this.authUser.role === 'superadmin') return true
      // Plan-level check: admin AND user must respect plan sections
      if (this.planSections && this.planSections.length > 0 && !this.planSections.includes(section)) return false
      // Admin bypasses per-user permission checks (but not plan check above)
      if (this.authUser.role === 'admin') return true
      let perms = {}
      try { perms = JSON.parse(this.authUser.permissions || '{}') } catch {}
      const level = perms[section] ?? 'none'
      if (access === 'read')  return level === 'read' || level === 'write'
      if (access === 'write') return level === 'write'
      return false
    },

    async loadSettings() {
      const r = await fetch(`${API}/api/settings`)
      const s = await r.json()
      const rate = parseFloat(s.eurRate || '25')
      this.eurRate = isNaN(rate) || rate <= 0 ? 25 : rate
      this.settingsForm.eurRate = String(this.eurRate)
      this.currentUser = s.currentUser || 'Admin'
      this.settingsForm.currentUser = this.currentUser
      this.projectName = s.projectName || ''
      this.settingsForm.projectName = this.projectName
      const warnPct = parseInt(s.laborWarningPct || '80')
      this.laborWarningPct = isNaN(warnPct) ? 80 : warnPct
      this.settingsForm.laborWarningPct = String(this.laborWarningPct)
      try { this.departments = JSON.parse(s.departments || '[]') } catch { this.departments = [] }
      // Branding
      this.logoWidth = Math.min(180, Math.max(40, parseInt(s.logoWidth || '96') || 96))
      this.logoBgColor = s.logoBgColor || '#FFCC00'
      this.logoSrc = s.logoData || '/logo.svg'
      this.settingsForm.logoWidth = String(this.logoWidth)
      this.settingsForm.logoBgColor = this.logoBgColor
      // Palette
      this.applyPalette(s.colorPalette || 'classic')
    },

    async saveEurRate() {
      const rate = parseFloat(this.settingsForm.eurRate)
      if (!rate || rate <= 0) return alert(this.t('alertInvalidRate'))
      const warnPct = parseInt(this.settingsForm.laborWarningPct) || 80
      await this.apiFetch('PUT', '/api/settings/eurRate', { value: String(rate) })
      await this.apiFetch('PUT', '/api/settings/currentUser', { value: this.settingsForm.currentUser || 'Admin' })
      await this.apiFetch('PUT', '/api/settings/projectName', { value: this.settingsForm.projectName || '' })
      await this.apiFetch('PUT', '/api/settings/laborWarningPct', { value: String(warnPct) })
      this.eurRate = rate
      this.laborWarningPct = warnPct
      this.currentUser = this.settingsForm.currentUser || 'Admin'
      this.projectName = this.settingsForm.projectName || ''
      this.settingsSaved = true
      setTimeout(() => this.settingsSaved = false, 2000)
    },

    async addDepartment() {
      const name = this.departmentForm.name.trim()
      if (!name) return alert(this.t('alertEnterDeptName'))
      if (this.departments.includes(name)) return alert(this.t('alertDeptExists'))
      this.departments = [...this.departments, name].sort((a, b) => a.localeCompare(b, 'cs'))
      await this.apiFetch('PUT', '/api/settings/departments', { value: JSON.stringify(this.departments) })
      this.departmentForm.name = ''
    },

    async deleteDepartment(name) {
      if (!confirm(`Smazat oddƒõlen√≠ "${name}"?`)) return
      this.departments = this.departments.filter(d => d !== name)
      await this.apiFetch('PUT', '/api/settings/departments', { value: JSON.stringify(this.departments) })
    },

    async loadAuditLog() {
      const params = new URLSearchParams({ category: this.auditCategory })
      if (this.auditFilter) params.set('entity', this.auditFilter)
      const r = await fetch(`${API}/api/audit?${params}`)
      if (!r.ok) return
      const d = await r.json()
      this.auditLog = Array.isArray(d) ? d : []
    },

    async clearAuditLog() {
      if (!confirm(`Smazat cel√Ω log kategorie "${this.auditCategory}"?`)) return
      const params = new URLSearchParams({ category: this.auditCategory })
      await fetch(`${API}/api/audit?${params}`, { method: 'DELETE' })
      this.auditLog = []
    },

    // --- User management (admin only) ---
    async loadUsers() {
      const r = await fetch(`${API}/api/users`)
      if (!r.ok) return
      this.users = await r.json()
    },

    editUser(u) {
      let perms = { assets:'none', labor:'none', testing:'none', risks:'none', issues:'none', changes:'none', assumptions:'none' }
      try { perms = { ...perms, ...JSON.parse(u.permissions || '{}') } } catch {}
      this.userForm = { id: u.id, email: u.email, name: u.name, role: u.role, password: '', error: '', permissions: perms }
    },

    resetUserForm() {
      this.userForm = {
        id: null, email: '', name: '', password: '', error: '', role: 'user',
        permissions: { assets:'none', labor:'none', testing:'none', risks:'none', issues:'none', changes:'none', assumptions:'none' }
      }
    },

    async saveUser() {
      this.userForm.error = ''
      if (!this.userForm.name) { this.userForm.error = this.t('alertEnterName'); return }
      if (!this.userForm.id && !this.userForm.email) { this.userForm.error = this.t('alertFillEmail'); return }
      if (!this.userForm.id && !this.userForm.password) { this.userForm.error = this.t('alertFillPassword'); return }
      // Validate password format
      if (this.userForm.password) {
        const pw = this.userForm.password
        if (pw.length < 6 || !/[a-z]/.test(pw) || !/[A-Z]/.test(pw) || !/\d/.test(pw) || !/[^a-zA-Z0-9]/.test(pw)) {
          this.userForm.error = this.t('errPasswordReq')
          return
        }
      }

      const body = { name: this.userForm.name, role: this.userForm.role, permissions: this.userForm.permissions }
      if (!this.userForm.id) body.email = this.userForm.email
      if (this.userForm.password) body.password = this.userForm.password

      const r = this.userForm.id
        ? await this.apiFetch('PUT', `/api/users/${this.userForm.id}`, body)
        : await this.apiFetch('POST', '/api/users', body)

      if (!r.ok) {
        const err = await r.json().catch(() => ({}))
        if (err.details?.fieldErrors) {
          const labels = { email: 'E-mail', name: 'Jm√©no', password: 'Heslo', role: 'Role' }
          const msgs = Object.entries(err.details.fieldErrors).map(([f, e]) => (labels[f]||f) + ': ' + (Array.isArray(e)?e.join(', '):e))
          this.userForm.error = msgs.join(' | ')
        } else {
          this.userForm.error = err.message || err.error || 'Chyba p≈ôi ukl√°d√°n√≠'
        }
        return
      }
      await this.loadUsers()
      this.resetUserForm()
    },

    async deactivateUser(u) {
      const action = u.active ? 'deaktivovat' : 'aktivovat'
      if (!confirm(`Opravdu chcete ${action} u≈æivatele "${u.name}"?`)) return
      const r = u.active
        ? await this.apiFetch('DELETE', `/api/users/${u.id}`)
        : await this.apiFetch('PUT', `/api/users/${u.id}`, { active: true })
      if (r.ok) await this.loadUsers()
    },

    // --- Project management methods ---
    async loadProjects() {
      const r = await fetch(`${API}/api/projects`)
      if (!r.ok) return
      this.projects = await r.json()
    },
    resetProjectForm() {
      this.projectForm = { id: null, name: '', description: '', error: '' }
    },
    editProject(p) {
      this.projectForm = { id: p.id, name: p.name, description: p.description || '', error: '' }
    },
    async saveProject() {
      this.projectForm.error = ''
      const isNew = !this.projectForm.id
      const url = isNew ? '/api/projects' : `/api/projects/${this.projectForm.id}`
      const method = isNew ? 'POST' : 'PUT'
      const r = await this.apiFetch(method, url, { name: this.projectForm.name, description: this.projectForm.description })
      if (!r.ok) {
        const err = await r.json().catch(() => ({}))
        this.projectForm.error = err.message || err.error || 'Chyba p≈ôi ukl√°d√°n√≠'
        return
      }
      await this.loadProjects()
      this.resetProjectForm()
    },
    async deleteProject(id) {
      if (!confirm(this.t('confirmDeleteProject'))) return
      await this.apiFetch('DELETE', `/api/projects/${id}`)
      await this.loadProjects()
    },
    async loadProjectMembers(projectId) {
      this.projectMembersProjectId = projectId
      const r = await fetch(`${API}/api/projects/${projectId}/users`)
      this.projectMembers = r.ok ? await r.json() : []
    },
    async addProjectMember(projectId, userId) {
      await this.apiFetch('POST', `/api/projects/${projectId}/users`, { userId })
      await this.loadProjectMembers(projectId)
    },
    async removeProjectMember(projectId, userId) {
      await this.apiFetch('DELETE', `/api/projects/${projectId}/users/${userId}`)
      await this.loadProjectMembers(projectId)
    },

    // --- Company management methods (superadmin) ---
    async loadCompanies() {
      const r = await this.apiFetch('GET', '/api/companies')
      if (r.ok) this.companies = await r.json()
    },
    resetCompanyForm() {
      this.companyForm = { id: null, name: '', slug: '', planId: null, status: 'trial', maxProjectsOverride: null, maxUsersOverride: null, adminEmail: '', adminName: '', adminPassword: '', error: '', _showCreate: false }
    },
    editCompany(c) {
      this.companyForm = {
        id: c.id, name: c.name, slug: c.slug, planId: c.planId,
        status: c.status || 'trial',
        maxProjectsOverride: c.maxProjectsOverride ?? null,
        maxUsersOverride: c.maxUsersOverride ?? null,
        adminEmail: '', adminName: '', adminPassword: '', error: '', _showCreate: false,
      }
    },
    async saveCompany() {
      this.companyForm.error = ''
      const isNew = !this.companyForm.id
      const url = isNew ? '/api/companies' : `/api/companies/${this.companyForm.id}`
      const method = isNew ? 'POST' : 'PUT'
      const body = isNew
        ? { name: this.companyForm.name, slug: this.companyForm.slug, planId: this.companyForm.planId, adminEmail: this.companyForm.adminEmail, adminName: this.companyForm.adminName, adminPassword: this.companyForm.adminPassword }
        : {
          name: this.companyForm.name, slug: this.companyForm.slug,
          planId: this.companyForm.planId || undefined,
          status: this.companyForm.status,
          maxProjectsOverride: this.companyForm.maxProjectsOverride || null,
          maxUsersOverride: this.companyForm.maxUsersOverride || null,
        }
      const r = await this.apiFetch(method, url, body)
      if (!r.ok) {
        const err = await r.json().catch(() => ({}))
        this.companyForm.error = err.error || 'Chyba p≈ôi ukl√°d√°n√≠'
        return
      }
      await this.loadCompanies()
      this.resetCompanyForm()
    },
    async deleteCompany(id) {
      if (!confirm(this.t('confirmDeleteCompany'))) return
      await this.apiFetch('DELETE', `/api/companies/${id}`)
      await this.loadCompanies()
    },
    async viewCompanyOverview(id) {
      const r = await this.apiFetch('GET', `/api/companies/${id}/overview`)
      if (r.ok) {
        this.companyOverview = await r.json()
        this.settingsTab = 'company-overview'
      }
    },

    // --- Plan management methods (superadmin) ---
    async loadPlans() {
      const r = await this.apiFetch('GET', '/api/plans')
      if (r.ok) this.plans = await r.json()
    },
    resetPlanForm() {
      this.planForm = { id: null, name: '', slug: '', sections: [], maxProjects: 1, maxUsers: 5, priceMonthly: 0, description: '', isDefault: false, isPublic: false, error: '', _showCreate: false }
    },
    editPlan(p) {
      this.planForm = { id: p.id, name: p.name, slug: p.slug, sections: JSON.parse(p.sections || '[]'), maxProjects: p.maxProjects, maxUsers: p.maxUsers, priceMonthly: p.priceMonthly, description: p.description || '', isDefault: p.isDefault, isPublic: p.isPublic ?? true, error: '', _showCreate: false }
    },
    async savePlan() {
      this.planForm.error = ''
      const isNew = !this.planForm.id
      const url = isNew ? '/api/plans' : `/api/plans/${this.planForm.id}`
      const method = isNew ? 'POST' : 'PUT'
      const body = { name: this.planForm.name, slug: this.planForm.slug, sections: this.planForm.sections, maxProjects: this.planForm.maxProjects, maxUsers: this.planForm.maxUsers, priceMonthly: this.planForm.priceMonthly, description: this.planForm.description, isDefault: this.planForm.isDefault, isPublic: this.planForm.isPublic }
      const r = await this.apiFetch(method, url, body)
      if (!r.ok) { const err = await r.json().catch(() => ({})); this.planForm.error = err.error || 'Chyba'; return }
      await this.loadPlans()
      this.resetPlanForm()
    },
    async deletePlan(id) {
      if (!confirm(this.t('confirmDeactivatePlan'))) return
      await this.apiFetch('DELETE', `/api/plans/${id}`)
      await this.loadPlans()
    },

    // --- Invoice methods (superadmin) ---
    async loadInvoices() {
      const r = await this.apiFetch('GET', '/api/invoices')
      if (r.ok) this.invoices = await r.json()
    },
    async markInvoicePaid(id) {
      if (!confirm(this.t('confirmMarkPaid'))) return
      await this.apiFetch('PATCH', `/api/invoices/${id}/pay`)
      await this.loadInvoices()
    },

    // --- SaaS stats (superadmin) ---
    async loadSaasStats() {
      const r = await this.apiFetch('GET', '/api/admin/stats')
      if (r.ok) this.saasStats = await r.json()
    },

    async loadLabor() {
      const [lr, sr] = await Promise.all([
        fetch(`${API}/api/labor`),
        fetch(`${API}/api/labor-spent`),
      ])
      if (lr.ok) { const d = await lr.json(); this.labor = Array.isArray(d) ? d : [] }
      if (sr.ok) { const d = await sr.json(); this.laborSpent = Array.isArray(d) ? d : [] }
    },

    async addLaborEntry() {
      const roleId = this.laborDetail.lc?.id
      if (!this.laborEntryForm.amount || !roleId) return
      const amountCzk = this.currency === 'EUR' && this.eurRate > 0
        ? parseFloat(this.laborEntryForm.amount) * this.eurRate
        : parseFloat(this.laborEntryForm.amount)
      await this.apiFetch('POST', `/api/labor/${roleId}/entries`, {
        date:   this.laborEntryForm.month + '-01',
        amount: amountCzk,
        note:   this.laborEntryForm.note || null,
      })
      this.laborEntryForm = { month: new Date().toISOString().slice(0, 7), amount: '', note: '' }
      await this.loadLabor()
      const updated = this.labor.find(l => l.id === roleId)
      if (updated) { this.laborDetail.lc = updated; this.laborFormEntries = updated.entries || [] }
    },

    async deleteLaborEntry(entryId) {
      if (!confirm(this.t('confirmDeleteRecord'))) return
      const roleId = this.laborDetail.lc?.id
      await this.apiFetch('DELETE', `/api/labor-entries/${entryId}`)
      await this.loadLabor()
      const updated = this.labor.find(l => l.id === roleId)
      if (updated) { this.laborDetail.lc = updated; this.laborFormEntries = updated.entries || [] }
    },

    async addLaborSpent() {
      if (!this.laborSpentForm.amount) return
      await this.apiFetch('POST', '/api/labor-spent', {
        date:   this.laborSpentForm.date,
        amount: parseFloat(this.laborSpentForm.amount),
        note:   this.laborSpentForm.note || null,
      })
      this.laborSpentForm = { date: new Date().toISOString().slice(0, 10), amount: '', note: '' }
      const r = await fetch(`${API}/api/labor-spent`)
      if (r.ok) { const d = await r.json(); this.laborSpent = Array.isArray(d) ? d : [] }
    },

    async deleteLaborSpent(id) {
      if (!confirm(this.t('confirmDeleteRecord'))) return
      await this.apiFetch('DELETE', `/api/labor-spent/${id}`)
      const r = await fetch(`${API}/api/labor-spent`)
      if (r.ok) { const d = await r.json(); this.laborSpent = Array.isArray(d) ? d : [] }
    },

    async loadDashboard() {
      const r = await fetch(`${API}/api/dashboard`)
      if (!r.ok) return
      this.dash = await r.json()
      this.$nextTick(() => this.renderCharts())
    },

    // ‚îÄ‚îÄ Risk Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    get filteredRisks() {
      return this.risks.filter(r =>
        (!this.riskFilters.status   || r.status   === this.riskFilters.status) &&
        (!this.riskFilters.category || r.category === this.riskFilters.category)
      )
    },
    get filteredIssues() {
      return this.issues.filter(i =>
        (!this.issueFilters.status   || i.status   === this.issueFilters.status) &&
        (!this.issueFilters.severity || i.severity === this.issueFilters.severity) &&
        (!this.issueFilters.type     || i.type     === this.issueFilters.type)
      )
    },
    get filteredChanges() {
      return this.changes.filter(c =>
        (!this.changeFilters.approvalStatus || c.approvalStatus === this.changeFilters.approvalStatus) &&
        (!this.changeFilters.changeType     || c.changeType     === this.changeFilters.changeType)
      )
    },
    get filteredAssumptions() {
      const now14 = new Date(Date.now() + 14 * 86400000)
      const nowD = new Date()
      return this.assumptions.filter(a => {
        if (this.assumptionFilters.status && a.status !== this.assumptionFilters.status) return false
        if (this.assumptionFilters.category && a.category !== this.assumptionFilters.category) return false
        if (this.assumptionFilters.phase && a.phase !== this.assumptionFilters.phase) return false
        if (this.assumptionFilters.validationFilter === 'overdue') {
          const active = !['Validated','Closed','Converted to Risk'].includes(a.status)
          return active && a.validationDate && new Date(a.validationDate) < nowD
        }
        if (this.assumptionFilters.validationFilter === 'expiring') {
          const active = !['Validated','Closed','Converted to Risk'].includes(a.status)
          return active && a.validationDate && new Date(a.validationDate) >= nowD && new Date(a.validationDate) <= now14
        }
        return true
      })
    },

    async loadRisks() {
      const r = await fetch(`${API}/api/risks`)
      if (!r.ok) return
      const data = await r.json()
      this.risks = Array.isArray(data) ? data : []
    },
    async loadIssues() {
      const r = await fetch(`${API}/api/issues`)
      if (!r.ok) return
      const data = await r.json()
      this.issues = Array.isArray(data) ? data : []
    },
    async loadChanges() {
      const r = await fetch(`${API}/api/changes`)
      if (!r.ok) return
      const data = await r.json()
      this.changes = Array.isArray(data) ? data : []
    },
    async loadAssumptions() {
      const r = await fetch(`${API}/api/assumptions`)
      if (!r.ok) return
      const data = await r.json()
      this.assumptions = Array.isArray(data) ? data : []
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PROJECT PLAN + KANBAN
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async loadTasks() {
      const params = new URLSearchParams()
      if (this.showArchived) params.set('archived', 'true')
      if (this.ppFilters.status) params.set('status', this.ppFilters.status)
      if (this.ppFilters.type) params.set('type', this.ppFilters.type)
      if (this.ppFilters.ownerId) params.set('ownerId', this.ppFilters.ownerId)
      if (this.ppFilters.search) params.set('search', this.ppFilters.search)
      const r = await fetch(`${API}/api/tasks?${params}`)
      if (!r.ok) return
      this.tasks = await r.json()
    },
    async loadKanbanColumns() {
      const r = await fetch(`${API}/api/kanban-columns`)
      if (!r.ok) return
      this.kanbanColumns = await r.json()
    },

    // Build flat tree for table display
    filteredTasks() { return this.tasks },
    taskTreeFlat() {
      const byParent = {}
      for (const t of this.tasks) {
        const pid = t.parentId || 0
        if (!byParent[pid]) byParent[pid] = []
        byParent[pid].push(t)
      }
      // Sort children by sortOrder
      for (const k in byParent) byParent[k].sort((a,b) => a.sortOrder - b.sortOrder)

      const result = []
      const walk = (parentId, level) => {
        const children = byParent[parentId] || []
        for (const c of children) {
          const hasChildren = (byParent[c.id] || []).length > 0
          result.push({ ...c, _level: level, _hasChildren: hasChildren })
          if (hasChildren && this.expandedTasks[c.id]) {
            walk(c.id, level + 1)
          }
        }
      }
      walk(0, 0)
      // Also handle null parentId mapped to 0
      return result
    },

    toggleExpand(id) {
      this.expandedTasks[id] = !this.expandedTasks[id]
    },
    ppExpandAll() {
      for (const t of this.tasks) this.expandedTasks[t.id] = true
    },
    ppCollapseAll() {
      this.expandedTasks = {}
    },

    // Kanban helpers
    kanbanColTasks(colId) {
      return this.tasks.filter(t => t.kanbanColumnId === colId && !t.archived).sort((a,b) => a.kanbanOrder - b.kanbanOrder)
    },

    // Open task modals
    openNewTask(type) {
      this.taskForm = { name: '', description: '', type: type || 'task', parentId: null, ownerId: '', status: 'not_started', progress: 0, isMilestone: false, plannedStart: '', plannedEnd: '', constraintType: '', constraintDate: '', estimatedCost: '', linkedRiskId: '', linkedAssumptionId: '', kanbanColumnId: null }
      this.taskDeps = []
      this.taskDepsNew = { predecessorId: '', type: 'FS', lagDays: 0 }
      this.taskModal = { open: true, id: null }
    },
    openEditTask(task) {
      this.taskForm = {
        name: task.name,
        description: task.description || '',
        type: task.type,
        parentId: task.parentId,
        ownerId: task.ownerId ?? '',
        status: task.status,
        progress: task.progress,
        isMilestone: task.isMilestone,
        plannedStart: task.plannedStart ? task.plannedStart.slice(0,10) : '',
        plannedEnd: task.plannedEnd ? task.plannedEnd.slice(0,10) : '',
        constraintType: task.constraintType || '',
        constraintDate: task.constraintDate ? task.constraintDate.slice(0,10) : '',
        estimatedCost: task.estimatedCost ?? '',
        linkedRiskId: task.linkedRiskId ?? '',
        linkedAssumptionId: task.linkedAssumptionId ?? '',
        kanbanColumnId: task.kanbanColumnId
      }
      this.taskDeps = (task.incomingDeps || [])
      this.taskDepsNew = { predecessorId: '', type: 'FS', lagDays: 0 }
      this.taskModal = { open: true, id: task.id }
    },

    async saveTask() {
      if (!this.taskForm.name?.trim()) return alert('Name is required')
      const payload = {
        name: this.taskForm.name,
        description: this.taskForm.description || null,
        type: this.taskForm.type,
        parentId: this.taskForm.parentId ? parseInt(this.taskForm.parentId) : null,
        ownerId: this.taskForm.ownerId ? parseInt(this.taskForm.ownerId) : null,
        status: this.taskForm.status,
        progress: parseInt(this.taskForm.progress) || 0,
        isMilestone: this.taskForm.isMilestone,
        plannedStart: this.taskForm.plannedStart || null,
        plannedEnd: this.taskForm.plannedEnd || null,
        constraintType: this.taskForm.constraintType || null,
        constraintDate: this.taskForm.constraintDate || null,
        estimatedCost: this.taskForm.estimatedCost ? parseFloat(this.taskForm.estimatedCost) : null,
        linkedRiskId: this.taskForm.linkedRiskId ? parseInt(this.taskForm.linkedRiskId) : null,
        linkedAssumptionId: this.taskForm.linkedAssumptionId ? parseInt(this.taskForm.linkedAssumptionId) : null,
      }
      if (this.taskForm.kanbanColumnId) payload.kanbanColumnId = parseInt(this.taskForm.kanbanColumnId)
      const method = this.taskModal.id ? 'PUT' : 'POST'
      const path = this.taskModal.id ? `/api/tasks/${this.taskModal.id}` : '/api/tasks'
      const res = await this.apiFetch(method, path, payload)
      if (!res.ok) {
        try { const err = await res.json(); alert('Error: ' + (err.error || JSON.stringify(err))) } catch { alert('Error: HTTP ' + res.status) }
        return
      }
      this.taskModal.open = false
      await this.loadTasks()
      if (this.view === 'kanban') await this.loadKanbanColumns()
    },

    async archiveTask(id) {
      if (!confirm('Archive this task?')) return
      await this.apiFetch('DELETE', `/api/tasks/${id}`)
      this.taskModal.open = false
      await this.loadTasks()
    },
    async restoreTask(id) {
      await this.apiFetch('PATCH', `/api/tasks/${id}/restore`)
      this.taskModal.open = false
      await this.loadTasks()
    },
    async deleteTaskPermanent(id) {
      if (!confirm('Permanently delete? This cannot be undone.')) return
      await this.apiFetch('DELETE', `/api/tasks/${id}/permanent`)
      this.taskModal.open = false
      await this.loadTasks()
    },

    // Dependencies
    async addDep() {
      if (!this.taskDepsNew.predecessorId || !this.taskModal.id) return
      const res = await this.apiFetch('POST', '/api/task-dependencies', {
        predecessorId: parseInt(this.taskDepsNew.predecessorId),
        successorId: this.taskModal.id,
        type: this.taskDepsNew.type,
        lagDays: parseInt(this.taskDepsNew.lagDays) || 0
      })
      if (!res.ok) {
        try { const err = await res.json(); alert(err.error || 'Error') } catch { alert('Error') }
        return
      }
      this.taskDepsNew = { predecessorId: '', type: 'FS', lagDays: 0 }
      // Reload task to get updated deps
      const r = await fetch(`${API}/api/tasks/${this.taskModal.id}`)
      if (r.ok) {
        const t = await r.json()
        this.taskDeps = t.incomingDeps || []
      }
    },
    async removeDep(depId) {
      await this.apiFetch('DELETE', `/api/task-dependencies/${depId}`)
      this.taskDeps = this.taskDeps.filter(d => d.id !== depId)
    },

    // Critical path
    async calcCriticalPath() {
      const res = await this.apiFetch('POST', '/api/tasks/critical-path')
      if (res.ok) {
        await this.loadTasks()
        const data = await res.json()
        alert(`Critical path: ${data.criticalPath.length} tasks, total ${data.totalDuration} ${this.t('ppDays')}`)
      }
    },

    // Baseline
    async saveAllBaselines() {
      const res = await this.apiFetch('POST', '/api/tasks/save-all-baselines')
      if (res.ok) {
        await this.loadTasks()
        alert(this.t('ppSaveBaseline') + ' ‚úì')
      }
    },

    // Export
    async exportTasksJson() {
      const r = await fetch(`${API}/api/tasks/export`)
      if (!r.ok) return
      const data = await r.json()
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url; a.download = 'tasks-export.json'; a.click()
      URL.revokeObjectURL(url)
    },

    // Kanban drag & drop
    async dropKanbanCard(ev, colId) {
      const taskId = parseInt(ev.dataTransfer.getData('text/plain'))
      if (!taskId) return
      await this.apiFetch('PATCH', `/api/tasks/${taskId}/kanban-move`, { kanbanColumnId: colId, kanbanOrder: 0 })
      await this.loadTasks()
    },

    // Kanban quick add
    async quickAddKanbanTask(colId, inputEl) {
      const name = inputEl.value?.trim()
      if (!name) return
      const res = await this.apiFetch('POST', '/api/tasks', { name, type: 'task', kanbanColumnId: colId, status: 'unscheduled' })
      if (res.ok) {
        inputEl.value = ''
        this.kanbanQuickAdd[colId] = false
        await this.loadTasks()
      }
    },

    // Kanban column management
    openKanbanColumnModal() {
      this.kanbanColumnForm = this.kanbanColumns.map(c => ({ id: c.id, name: c.name, color: c.color, wipLimit: c.wipLimit || 0, sortOrder: c.sortOrder }))
      this.kanbanColumnModal.open = true
    },
    async saveKanbanColumns() {
      // Save existing / create new / delete removed
      const existing = new Set(this.kanbanColumns.map(c => c.id))
      const formIds = new Set(this.kanbanColumnForm.filter(c => c.id).map(c => c.id))

      // Delete removed columns
      for (const c of this.kanbanColumns) {
        if (!formIds.has(c.id)) {
          await this.apiFetch('DELETE', `/api/kanban-columns/${c.id}`)
        }
      }
      // Create or update
      for (let i = 0; i < this.kanbanColumnForm.length; i++) {
        const c = this.kanbanColumnForm[i]
        c.sortOrder = i
        if (c.id) {
          await this.apiFetch('PUT', `/api/kanban-columns/${c.id}`, { name: c.name, color: c.color, wipLimit: c.wipLimit || null, sortOrder: c.sortOrder })
        } else {
          if (c.name?.trim()) {
            await this.apiFetch('POST', '/api/kanban-columns', { name: c.name, color: c.color, wipLimit: c.wipLimit || null })
          }
        }
      }
      this.kanbanColumnModal.open = false
      await this.loadKanbanColumns()
      await this.loadTasks()
    },

    // ‚îÄ‚îÄ Gantt Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ganttTasks() {
      return this.tasks.filter(t => t.plannedStart && t.plannedEnd && !t.archived)
    },

    renderPPGantt() {
      const container = document.getElementById('pp-gantt-container')
      if (!container) return
      const tasks = this.ganttTasks()
      if (tasks.length === 0) { container.innerHTML = ''; return }

      // Find date range
      let minDate = Infinity, maxDate = -Infinity
      for (const t of tasks) {
        const s = new Date(t.plannedStart).getTime()
        const e = new Date(t.plannedEnd).getTime()
        if (s < minDate) minDate = s
        if (e > maxDate) maxDate = e
        if (t.baselineStart) { const bs = new Date(t.baselineStart).getTime(); if (bs < minDate) minDate = bs }
        if (t.baselineEnd) { const be = new Date(t.baselineEnd).getTime(); if (be > maxDate) maxDate = be }
      }

      // Add 7-day padding
      minDate -= 7 * 86400000
      maxDate += 7 * 86400000
      const totalDays = Math.ceil((maxDate - minDate) / 86400000)
      const isWeek = this.ganttZoom === 'week'
      const dayWidth = isWeek ? 20 : 6
      const chartWidth = totalDays * dayWidth
      const rowH = 32

      const dayOffset = (dateStr) => {
        const d = new Date(dateStr).getTime()
        return Math.round((d - minDate) / 86400000) * dayWidth
      }

      // Build month/week headers
      let headersHtml = ''
      const startD = new Date(minDate)
      if (isWeek) {
        // Weekly ‚Äî first fill gap from minDate to first Monday
        const d = new Date(startD)
        d.setDate(d.getDate() - d.getDay() + 1)
        if (d.getTime() < minDate) d.setDate(d.getDate() + 7)
        // Gap before first Monday
        const gapDays = Math.round((d.getTime() - minDate) / 86400000)
        if (gapDays > 0) headersHtml += `<div class="gh-month" style="width:${gapDays*dayWidth}px"></div>`
        while (d.getTime() < maxDate) {
          const label = `${d.getDate()}.${d.getMonth()+1}`
          headersHtml += `<div class="gh-month" style="width:${7*dayWidth}px">${label}</div>`
          d.setDate(d.getDate() + 7)
        }
      } else {
        // Monthly ‚Äî first partial month from minDate to end of that month
        const d = new Date(startD.getFullYear(), startD.getMonth(), 1)
        while (d.getTime() < maxDate) {
          const mStart = Math.max(d.getTime(), minDate)
          const nextM = new Date(d.getFullYear(), d.getMonth()+1, 1)
          const mEnd = Math.min(nextM.getTime(), maxDate)
          const mDays = Math.max(1, Math.round((mEnd - mStart) / 86400000))
          const mNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']
          headersHtml += `<div class="gh-month" style="width:${mDays*dayWidth}px">${mNames[d.getMonth()]} ${d.getFullYear()}</div>`
          d.setMonth(d.getMonth() + 1)
        }
      }

      // Today line (offset by 260px for label column)
      const todayOffset = 260 + Math.round((Date.now() - minDate) / 86400000) * dayWidth
      const todayLine = `<div class="gantt-today" style="left:${todayOffset}px" title="${this.t('ppGanttToday')}"></div>`

      // Build rows
      let rowsHtml = ''
      // Sort: phases first, then by sortOrder
      const sorted = [...tasks].sort((a,b) => {
        if (a.type === 'phase' && b.type !== 'phase') return -1
        if (b.type === 'phase' && a.type !== 'phase') return 1
        return a.sortOrder - b.sortOrder
      })

      for (const t of sorted) {
        const left = dayOffset(t.plannedStart)
        const right = dayOffset(t.plannedEnd)
        const width = Math.max(right - left, 4)
        const barClass = t.isCriticalPath ? 'critical' : t.status === 'done' ? 'done' : t.status === 'not_started' ? 'not-started' : 'normal'

        let barsHtml = ''
        if (t.isMilestone) {
          barsHtml += `<div class="gantt-milestone" style="left:${left - 6}px"></div>`
        } else {
          const progressW = Math.round(width * (t.progress || 0) / 100)
          barsHtml += `<div class="gantt-bar ${barClass}" style="left:${left}px;width:${width}px" title="${t.name}">`
          barsHtml += `<div class="bar-progress" style="width:${progressW}px"></div>`
          barsHtml += `<span style="position:relative;z-index:1">${t.progress > 0 ? t.progress+'%' : ''}</span></div>`
        }

        // Baseline bar
        if (t.baselineStart && t.baselineEnd) {
          const bLeft = dayOffset(t.baselineStart)
          const bRight = dayOffset(t.baselineEnd)
          barsHtml += `<div class="gantt-bar baseline" style="left:${bLeft}px;width:${Math.max(bRight-bLeft,4)}px" title="${this.t('ppGanttBaselineBar')}"></div>`
        }

        const icon = t.type === 'phase' ? '‚ñ™ ' : t.isMilestone ? '‚ô¶ ' : ''
        const nameStyle = t.type === 'phase' ? 'font-weight:700' : t.type === 'workstream' ? 'font-weight:600' : ''
        rowsHtml += `<div class="gantt-row"><div class="gr-label" style="${nameStyle}">${icon}${this._escHtml(t.name)}</div><div class="gr-bars" style="width:${chartWidth}px">${barsHtml}</div></div>`
      }

      container.innerHTML = `
        <div class="gantt-header">
          <div class="gh-label">${this.t('ppTaskName')}</div>
          <div class="gh-months" style="width:${chartWidth}px;display:flex;position:relative">${headersHtml}</div>
        </div>
        <div style="position:relative">
          ${todayLine}
          ${rowsHtml}
        </div>`
    },

    calcModalDuration() {
      if (!this.taskForm.plannedStart || !this.taskForm.plannedEnd) return '‚Äî'
      const s = new Date(this.taskForm.plannedStart)
      const e = new Date(this.taskForm.plannedEnd)
      const calDays = Math.round((e - s) / 86400000) + 1  // inclusive
      let workDays = 0
      const d = new Date(s)
      while (d <= e) { const dow = d.getDay(); if (dow !== 0 && dow !== 6) workDays++; d.setDate(d.getDate() + 1) }
      return `${calDays} ${this.t('ppDays')} / ${workDays} ${this.t('ppWorkDays')}`
    },

    _escHtml(str) {
      const d = document.createElement('div'); d.textContent = str; return d.innerHTML
    },

    openNewAssumption() {
      this.assumptionForm = { title: '', description: '', category: 'Finance', phase: 'Design', type: 'Operational', source: 'Internal planning', validationMethod: '', status: 'Active', ownerId: '', validationDate: '', budgetImpact: null, timelineImpact: null, scopeImpact: 'Medium', invalidationProbability: 3, notes: '', _isLocked: false, _convertedRiskId: null }
      this.assumptionModal = { open: true, id: null }
    },
    openEditAssumption(a) {
      this.assumptionForm = { title: a.title, description: a.description ?? '', category: a.category, phase: a.phase, type: a.type, source: a.source, validationMethod: a.validationMethod ?? '', status: a.status, ownerId: a.ownerId ?? '', validationDate: a.validationDate ? a.validationDate.slice(0,10) : '', budgetImpact: a.budgetImpact ?? null, timelineImpact: a.timelineImpact ?? null, scopeImpact: a.scopeImpact, invalidationProbability: a.invalidationProbability, notes: a.notes ?? '', _isLocked: a.isLocked, _convertedRiskId: a.convertedRiskId }
      this.assumptionModal = { open: true, id: a.id }
    },
    async saveAssumption() {
      if (!this.assumptionForm.title?.trim()) return alert(this.t('alertEnterAssumption'))
      if (this.assumptionForm.status === 'Invalid') {
        if (!confirm('Status "Invalid" automaticky vytvo≈ô√≠ nov√© riziko a p≈ôevede assumption do stavu "Converted to Risk". Pokraƒçovat?')) return
      }
      const payload = {
        ...this.assumptionForm,
        ownerId: this.assumptionForm.ownerId ? parseInt(this.assumptionForm.ownerId) : null,
        invalidationProbability: parseInt(this.assumptionForm.invalidationProbability),
        budgetImpact: this.assumptionForm.budgetImpact ? parseFloat(this.assumptionForm.budgetImpact) : null,
        timelineImpact: this.assumptionForm.timelineImpact ? parseInt(this.assumptionForm.timelineImpact) : null,
        validationDate: this.assumptionForm.validationDate || null,
        validationMethod: this.assumptionForm.validationMethod || null,
      }
      delete payload._isLocked; delete payload._convertedRiskId
      const method = this.assumptionModal.id ? 'PUT' : 'POST'
      const path   = this.assumptionModal.id ? `/api/assumptions/${this.assumptionModal.id}` : '/api/assumptions'
      const res = await this.apiFetch(method, path, payload)
      if (!res.ok) {
        try { const err = await res.json(); alert('Chyba: ' + (err.error || err.message || JSON.stringify(err))) }
        catch { alert('Chyba: HTTP ' + res.status) }
        return
      }
      this.assumptionModal.open = false
      await this.loadAssumptions()
      await this.loadRisks()
      this.loadDashboard()
    },
    async deleteAssumption(id) {
      if (!confirm(this.t('confirmDeleteAssumption'))) return
      await this.apiFetch('DELETE', `/api/assumptions/${id}`)
      await this.loadAssumptions()
      this.loadDashboard()
    },

    // ‚îÄ‚îÄ Assumption helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    exposureColor(score) {
      if (score <= 3)  return '#22c55e'
      if (score <= 6)  return '#eab308'
      if (score <= 10) return '#f97316'
      return '#ef4444'
    },
    assumptionStatusBadge(status) {
      const m = { 'Active': 'badge-blue', 'Under review': 'badge-yellow', 'Validated': 'badge-green', 'Invalid': 'badge-red', 'Converted to Risk': 'badge-orange', 'Closed': 'badge-gray' }
      return 'status-badge ' + (m[status] ?? 'badge-gray')
    },
    isOverdue(dateStr, status) {
      if (!dateStr || !['Active', 'Under review'].includes(status)) return false
      return new Date(dateStr) < new Date()
    },

    exportAssumptionsPDF() {
      const rows = this.filteredAssumptions.map(a => `
        <tr>
          <td>${a.code}</td>
          <td>${a.title}</td>
          <td>${a.category}</td>
          <td>${a.phase}</td>
          <td>${a.type}</td>
          <td>${a.status}${a.isLocked ? ' üîí' : ''}</td>
          <td>${a.owner?.name ?? '‚Äî'}</td>
          <td style="font-weight:700">${a.exposureScore}</td>
          <td>${a.validationDate ? a.validationDate.slice(0,10) : '‚Äî'}</td>
          <td>${a.budgetImpact != null ? this.fmtMoney(a.budgetImpact) : '‚Äî'}</td>
        </tr>`).join('')
      this._openPrintWindow('Assumption Log', `
        ${this._pdfHeader('Assumption Log', this.projectName)}
        ${this._pdfBaseCss()}
        <table style="width:100%;border-collapse:collapse;font-size:11px">
          <thead><tr style="background:#1a1a1a;color:#FFCC00">
            <th style="padding:6px">Code</th><th>${this.t('colName')}</th><th>${this.t('category')}</th><th>${this.t('phase')}</th><th>${this.t('type')}</th>
            <th>Status</th><th>${this.t('ownerLabel')}</th><th>Exposure</th><th>${this.t('validationDate')}</th><th>${this.t('budgetImpactCzk')}</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>`)
    },

    openNewRisk() {
      this.riskForm = { title: '', description: '', category: 'technical', probability: 3, impact: 3, mitigationPlan: '', contingencyPlan: '', ownerId: '', status: 'Open', dateIdentified: new Date().toISOString().slice(0,10), reviewDate: '', materializationDate: '' }
      this.riskModal = { open: true, id: null }
    },
    openEditRisk(r) {
      this.riskForm = { title: r.title, description: r.description ?? '', category: r.category, probability: r.probability, impact: r.impact, mitigationPlan: r.mitigationPlan ?? '', contingencyPlan: r.contingencyPlan ?? '', ownerId: r.ownerId ?? '', status: r.status, dateIdentified: r.dateIdentified ? r.dateIdentified.slice(0,10) : '', reviewDate: r.reviewDate ? r.reviewDate.slice(0,10) : '', materializationDate: r.materializationDate ? r.materializationDate.slice(0,10) : '' }
      this.riskModal = { open: true, id: r.id }
    },
    async saveRisk() {
      if (!this.riskForm.title?.trim()) return alert(this.t('alertEnterRiskName'))
      const payload = { ...this.riskForm, probability: parseInt(this.riskForm.probability), impact: parseInt(this.riskForm.impact), ownerId: this.riskForm.ownerId ? parseInt(this.riskForm.ownerId) : null, reviewDate: this.riskForm.reviewDate || null, materializationDate: this.riskForm.materializationDate || null }
      const method = this.riskModal.id ? 'PUT' : 'POST'
      const path   = this.riskModal.id ? `/api/risks/${this.riskModal.id}` : '/api/risks'
      await this.apiFetch(method, path, payload)
      this.riskModal.open = false
      await this.loadRisks()
      this.loadDashboard()
    },
    async deleteRisk(id) {
      if (!confirm(this.t('confirmDeleteRisk'))) return
      await this.apiFetch('DELETE', `/api/risks/${id}`)
      await this.loadRisks()
      this.loadDashboard()
    },

    openNewIssue() {
      this.issueForm = { title: '', description: '', type: 'Bug', severity: 'Medium', priority: 'Medium', status: 'Open', ownerId: '', dueDate: '', rootCause: '', linkedRiskId: '', linkedChangeRequestId: '' }
      this.issueModal = { open: true, id: null }
    },
    openEditIssue(iss) {
      this.issueForm = { title: iss.title, description: iss.description ?? '', type: iss.type, severity: iss.severity, priority: iss.priority, status: iss.status, ownerId: iss.ownerId ?? '', dueDate: iss.dueDate ? iss.dueDate.slice(0,10) : '', rootCause: iss.rootCause ?? '', linkedRiskId: iss.linkedRiskId ?? '', linkedChangeRequestId: iss.linkedChangeRequestId ?? '' }
      this.issueModal = { open: true, id: iss.id }
    },
    async saveIssue() {
      if (!this.issueForm.title?.trim()) return alert(this.t('alertEnterIssueName'))
      const payload = { ...this.issueForm, ownerId: this.issueForm.ownerId ? parseInt(this.issueForm.ownerId) : null, linkedRiskId: this.issueForm.linkedRiskId ? parseInt(this.issueForm.linkedRiskId) : null, linkedChangeRequestId: this.issueForm.linkedChangeRequestId ? parseInt(this.issueForm.linkedChangeRequestId) : null, dueDate: this.issueForm.dueDate || null }
      const method = this.issueModal.id ? 'PUT' : 'POST'
      const path   = this.issueModal.id ? `/api/issues/${this.issueModal.id}` : '/api/issues'
      await this.apiFetch(method, path, payload)
      this.issueModal.open = false
      await this.loadIssues()
      this.loadDashboard()
    },
    async deleteIssue(id) {
      if (!confirm(this.t('confirmDeleteIssue'))) return
      await this.apiFetch('DELETE', `/api/issues/${id}`)
      await this.loadIssues()
      this.loadDashboard()
    },

    openNewChange() {
      this.changeForm = { title: '', description: '', changeType: 'Scope', businessJustification: '', budgetImpact: null, timelineImpact: '', resourceImpact: '', riskImpact: '', requestedById: '', approvedById: '', approvalStatus: 'Draft', linkedRiskIds: [], linkedIssueIds: [], linkedRequirements: '' }
      this.changeModal = { open: true, id: null }
    },
    openEditChange(cr) {
      this.changeForm = { title: cr.title, description: cr.description ?? '', changeType: cr.changeType, businessJustification: cr.businessJustification ?? '', budgetImpact: cr.budgetImpact ?? null, timelineImpact: cr.timelineImpact ?? '', resourceImpact: cr.resourceImpact ?? '', riskImpact: cr.riskImpact ?? '', requestedById: cr.requestedById ?? '', approvedById: cr.approvedById ?? '', approvalStatus: cr.approvalStatus, linkedRiskIds: Array.isArray(cr.linkedRiskIds) ? cr.linkedRiskIds : [], linkedIssueIds: Array.isArray(cr.linkedIssueIds) ? cr.linkedIssueIds : [], linkedRequirements: cr.linkedRequirements ?? '' }
      this.changeModal = { open: true, id: cr.id }
    },
    async saveChange() {
      if (!this.changeForm.title?.trim()) return alert(this.t('alertEnterChangeName'))
      const payload = { ...this.changeForm, requestedById: this.changeForm.requestedById ? parseInt(this.changeForm.requestedById) : null, approvedById: this.changeForm.approvedById ? parseInt(this.changeForm.approvedById) : null, budgetImpact: this.changeForm.budgetImpact ? parseFloat(this.changeForm.budgetImpact) : null }
      const method = this.changeModal.id ? 'PUT' : 'POST'
      const path   = this.changeModal.id ? `/api/changes/${this.changeModal.id}` : '/api/changes'
      await this.apiFetch(method, path, payload)
      this.changeModal.open = false
      await this.loadChanges()
      this.loadDashboard()
    },
    async deleteChange(id) {
      if (!confirm(this.t('confirmDeleteChange'))) return
      await this.apiFetch('DELETE', `/api/changes/${id}`)
      await this.loadChanges()
      this.loadDashboard()
    },
    toggleCRLink(field, id, checked) {
      const num = parseInt(id)
      if (checked) { if (!this.changeForm[field].includes(num)) this.changeForm[field].push(num) }
      else          { this.changeForm[field] = this.changeForm[field].filter(x => x !== num) }
    },

    // Risk matrix helpers
    risksInCell(prob, impact) {
      return this.risks.filter(r => r.probability === prob && r.impact === impact && r.status !== 'Closed')
    },
    riskCellStyle(prob, impact) {
      const score = prob * impact
      if (score >= 15) return 'background:#fee2e2;color:#991b1b'
      if (score >= 10) return 'background:#ffedd5;color:#9a3412'
      if (score >= 5)  return 'background:#fef9c3;color:#854d0e'
      return 'background:#d1fae5;color:#065f46'
    },
    riskScoreStyle(score) {
      if (score >= 15) return 'background:#fee2e2;color:#991b1b'
      if (score >= 10) return 'background:#ffedd5;color:#9a3412'
      if (score >= 5)  return 'background:#fef9c3;color:#854d0e'
      return 'background:#d1fae5;color:#065f46'
    },
    riskStatusBadge(s) {
      return { Open: 'badge-red', Monitoring: 'badge-yellow', Mitigated: 'badge-blue', Closed: 'badge-green' }[s] ?? 'badge-grey'
    },
    issueStatusBadge(s) {
      return { Open: 'badge-red', 'In progress': 'badge-blue', Escalated: 'badge-purple', Resolved: 'badge-yellow', Closed: 'badge-green' }[s] ?? 'badge-grey'
    },
    crStatusBadge(s) {
      return { Draft: 'badge-grey', Submitted: 'badge-blue', Approved: 'badge-green', Rejected: 'badge-red', Implemented: 'badge-purple' }[s] ?? 'badge-grey'
    },
    severityBadge(s) {
      return { Critical: 'badge-red', High: 'badge-yellow', Medium: 'badge-blue', Low: 'badge-grey' }[s] ?? 'badge-grey'
    },

    // Top 10 chart
    renderTop10Chart() {
      const top = [...this.risks].sort((a,b) => b.score - a.score).slice(0,10)
      const ctx = document.getElementById('top10Chart')
      if (!ctx) return
      if (this._top10Chart) { this._top10Chart.destroy(); this._top10Chart = null }
      this._top10Chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: top.map(r => r.title.slice(0,30) + (r.title.length>30?'‚Ä¶':'')),
          datasets: [{ label: 'Risk Score', data: top.map(r => r.score), backgroundColor: top.map(r => r.score >= 15 ? '#fee2e2' : r.score >= 10 ? '#ffedd5' : r.score >= 5 ? '#fef9c3' : '#d1fae5'), borderColor: top.map(r => r.score >= 15 ? '#991b1b' : r.score >= 10 ? '#9a3412' : r.score >= 5 ? '#854d0e' : '#065f46'), borderWidth: 1 }],
        },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { min: 0, max: 25 } } },
      })
    },

    // Trend chart
    async loadRiskTrend() {
      if (!this.riskTrendId) return
      const r = await fetch(`${API}/api/risks/${this.riskTrendId}/history`)
      const history = await r.json()
      const ctx = document.getElementById('trendChart')
      if (!ctx) return
      if (this._trendChart) { this._trendChart.destroy(); this._trendChart = null }
      if (!history.length) { ctx.getContext('2d')?.clearRect(0,0,ctx.width,ctx.height); return }
      this._trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: history.map(h => this.fmtDate(h.date)),
          datasets: [{ label: 'Risk Score', data: history.map(h => h.score), borderColor: '#D40511', backgroundColor: 'rgba(212,5,17,0.1)', tension: 0.3, fill: true, pointRadius: 5 }],
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 0, max: 25 } } },
      })
    },

    clearFilters() {
      this.filters = { search: '', category: '', tenderStatus: '', responsibleId: '', priorityId: '', capexOnly: false }
      this.loadItems()
    },

    get subcatsForSelected() {
      const cat = this.categories.find(c => c.name === this.itemForm.category)
      return cat?.subcategories ?? []
    },

    // --- Item CRUD ---
    openNewItem() {
      this.itemForm = {
        description: '', category: '', subcategory: '', itemType: '', unit: '', quantity: 1,
        depreciationMonths: null, totalEstCost: null, additionalCostRevision: null,
        totalCostAfterRevision: null, actualPrice: null, capexNeeded: false,
        tenderStatus: '', tenderStartDate: '', tenderDeadline: '',
        orderPlaceDate: '', deliveryDate: '', approval: '',
        chosenSupplier: '', bottleneck: '', notes: '',
        responsibleId: null, priorityId: null,
      }
      this.itemModal = { open: true, id: null }
    },

    openEditItem(item) {
      this.itemForm = {
        description: item.description ?? '',
        category: item.category ?? '',
        subcategory: item.subcategory ?? '',
        itemType: item.itemType ?? '',
        unit: item.unit ?? '',
        quantity: item.quantity ?? 1,
        depreciationMonths: item.depreciationMonths ?? null,
        totalEstCost: item.totalEstCost ?? null,
        additionalCostRevision: item.additionalCostRevision ?? null,
        totalCostAfterRevision: item.totalCostAfterRevision ?? null,
        actualPrice: item.actualPrice ?? null,
        capexNeeded: item.capexNeeded ?? false,
        tenderStatus: item.tenderStatus ?? '',
        tenderStartDate: item.tenderStartDate ? item.tenderStartDate.slice(0, 10) : '',
        tenderDeadline: item.tenderDeadline ? item.tenderDeadline.slice(0, 10) : '',
        orderPlaceDate: item.orderPlaceDate ? item.orderPlaceDate.slice(0, 10) : '',
        deliveryDate: item.deliveryDate ? item.deliveryDate.slice(0, 10) : '',
        approval: item.approval ?? '',
        chosenSupplier: item.chosenSupplier ?? '',
        bottleneck: item.bottleneck ?? '',
        notes: item.notes ?? '',
        responsibleId: item.responsibleId ?? null,
        priorityId: item.priorityId ?? null,
      }
      this.itemModal = { open: true, id: item.id }
    },

    async saveItem() {
      if (!this.itemForm.description?.trim()) return alert(this.t('alertEnterItemDesc'))
      const payload = {
        ...this.itemForm,
        quantity: parseInt(this.itemForm.quantity) || 1,
        depreciationMonths: this.itemForm.depreciationMonths ? parseInt(this.itemForm.depreciationMonths) : null,
        totalEstCost: this.itemForm.totalEstCost ? parseFloat(this.itemForm.totalEstCost) : null,
        additionalCostRevision: this.itemForm.additionalCostRevision ? parseFloat(this.itemForm.additionalCostRevision) : null,
        totalCostAfterRevision: this.itemForm.totalCostAfterRevision ? parseFloat(this.itemForm.totalCostAfterRevision) : null,
        actualPrice: this.itemForm.actualPrice ? parseFloat(this.itemForm.actualPrice) : null,
        responsibleId: this.itemForm.responsibleId ? parseInt(this.itemForm.responsibleId) : null,
        priorityId: this.itemForm.priorityId ? parseInt(this.itemForm.priorityId) : null,
        tenderStartDate: this.itemForm.tenderStartDate || null,
        tenderDeadline: this.itemForm.tenderDeadline || null,
        orderPlaceDate: this.itemForm.orderPlaceDate || null,
        deliveryDate: this.itemForm.deliveryDate || null,
      }
      const path = this.itemModal.id ? `/api/items/${this.itemModal.id}` : `/api/items`
      const method = this.itemModal.id ? 'PUT' : 'POST'
      await this.apiFetch(method, path, payload)
      this.itemModal.open = false
      await this.loadItems()
      this.loadDashboard()
      // Refresh detail panel with updated item data
      if (this.detailPanel.open && this.detailPanel.item) {
        const updated = this.items.find(i => i.id === this.detailPanel.item.id)
        if (updated) {
          this.detailPanel.item = updated
        }
      }
    },

    async deleteItem(id) {
      if (!confirm(this.t('confirmDeleteItem'))) return
      await this.apiFetch('DELETE', `/api/items/${id}`)
      await this.loadItems()
      this.loadDashboard()
    },

    // --- Detail panel ---
    async openDetail(item) {
      const [freshRes, commentsRes] = await Promise.all([
        fetch(`${API}/api/items/${item.id}`),
        fetch(`${API}/api/items/${item.id}/comments`),
      ])
      this.detailPanel = { open: true, item: await freshRes.json() }
      this.comments = await commentsRes.json()
      this.commentInput = ''
    },

    closeDetail() {
      this.detailPanel = { open: false, item: null }
      this.comments = []
      this.commentInput = ''
    },

    async addComment() {
      const text = this.commentInput.trim()
      if (!text || !this.detailPanel.item) return
      const id = this.detailPanel.item.id
      await this.apiFetch('POST', `/api/items/${id}/comments`, { text })
      this.commentInput = ''
      const r = await fetch(`${API}/api/items/${id}/comments`)
      this.comments = await r.json()
      // Refresh item in list so "Posledn√≠ koment√°≈ô" column updates
      await this.loadItems()
      const updated = this.items.find(i => i.id === id)
      if (updated) this.detailPanel.item = updated
    },

    async deleteComment(commentId) {
      if (!confirm(this.t('confirmDeleteComment'))) return
      await this.apiFetch('DELETE', `/api/comments/${commentId}`)
      const id = this.detailPanel.item.id
      const r = await fetch(`${API}/api/items/${id}/comments`)
      this.comments = await r.json()
      await this.loadItems()
      const updated = this.items.find(i => i.id === id)
      if (updated) this.detailPanel.item = updated
    },

    // --- People CRUD ---
    openPersonForm(p = null) {
      this.personForm = { open: true, id: p?.id ?? null, name: p?.name ?? '', email: p?.email ?? '', department: p?.department ?? '' }
    },

    async savePerson() {
      if (!this.personForm.name.trim()) return alert(this.t('alertEnterName'))
      const path = this.personForm.id ? `/api/people/${this.personForm.id}` : `/api/people`
      const method = this.personForm.id ? 'PUT' : 'POST'
      await this.apiFetch(method, path, { name: this.personForm.name, email: this.personForm.email || null, department: this.personForm.department || null })
      this.personForm.open = false
      await this.loadPeople()
    },

    async deletePerson(id) {
      if (!confirm(this.t('confirmDeletePerson'))) return
      await this.apiFetch('DELETE', `/api/people/${id}`)
      await this.loadPeople()
    },

    // --- Categories CRUD ---
    openCategoryForm(c = null) {
      this.categoryForm = { open: true, id: c?.id ?? null, name: c?.name ?? '', subcatText: c?.subcategories?.join(', ') ?? '' }
    },

    async saveCategory() {
      if (!this.categoryForm.name.trim()) return alert(this.t('alertEnterCategoryName'))
      const subcategories = this.categoryForm.subcatText.split(',').map(s => s.trim()).filter(Boolean)
      const path = this.categoryForm.id ? `/api/categories/${this.categoryForm.id}` : `/api/categories`
      const method = this.categoryForm.id ? 'PUT' : 'POST'
      await this.apiFetch(method, path, { name: this.categoryForm.name, subcategories })
      this.categoryForm.open = false
      await this.loadCategories()
    },

    async deleteCategory(id) {
      if (!confirm(this.t('confirmDeleteCategory'))) return
      await this.apiFetch('DELETE', `/api/categories/${id}`)
      await this.loadCategories()
    },

    // --- Priorities CRUD ---
    openPriorityForm(p = null) {
      this.priorityForm = { open: true, id: p?.id ?? null, name: p?.name ?? '', color: p?.color ?? '#FFCC00', rank: p?.rank ?? 0 }
    },

    async savePriority() {
      if (!this.priorityForm.name.trim()) return alert(this.t('alertEnterPriorityName'))
      const path = this.priorityForm.id ? `/api/priorities/${this.priorityForm.id}` : `/api/priorities`
      const method = this.priorityForm.id ? 'PUT' : 'POST'
      await this.apiFetch(method, path, { name: this.priorityForm.name, color: this.priorityForm.color, rank: parseInt(this.priorityForm.rank) || 0 })
      this.priorityForm.open = false
      await this.loadPriorities()
    },

    async deletePriority(id) {
      if (!confirm(this.t('confirmDeletePriority'))) return
      await this.apiFetch('DELETE', `/api/priorities/${id}`)
      await this.loadPriorities()
    },

    // --- Labor CRUD ---
    openLaborDetail(lc) {
      this.laborDetail = { open: true, lc }
      this.laborFormEntries = lc.entries || []
      this.laborEntryForm = { month: new Date().toISOString().slice(0, 7), amount: '', note: '' }
      this.laborForm.open = false
    },

    openLaborForm(lc = null) {
      const rateInCzk = lc?.mdRate ?? ''
      const displayRate = rateInCzk !== '' && this.currency === 'EUR' && this.eurRate > 0
        ? Math.round(rateInCzk / this.eurRate * 100) / 100
        : rateInCzk
      this.laborForm = {
        open: true,
        id: lc?.id ?? null,
        role: lc?.role ?? '',
        personName: lc?.personName ?? '',
        department: lc?.department ?? '',
        costType: lc?.costType ?? 'Project',
        mdRate: displayRate,
        mdDays: lc?.mdDays ?? '',
        notes: lc?.notes ?? '',
      }
      // Naƒçti existuj√≠c√≠ z√°znamy utraceno
      this.laborFormEntries = lc?.entries ?? []
      this.laborEntryForm = { month: new Date().toISOString().slice(0, 7), amount: '', note: '' }
    },

    async saveLabor() {
      if (!this.laborForm.role.trim()) return alert(this.t('alertEnterRoleName'))
      if (!this.laborForm.mdRate || parseFloat(this.laborForm.mdRate) <= 0) return alert(this.t('alertEnterRate'))
      if (!this.laborForm.mdDays || parseFloat(this.laborForm.mdDays) <= 0) return alert(this.t('alertEnterMD'))
      const payload = {
        role: this.laborForm.role,
        personName: this.laborForm.personName || null,
        department: this.laborForm.department || null,
        costType: this.laborForm.costType,
        mdRate: this.currency === 'EUR' && this.eurRate > 0
          ? parseFloat(this.laborForm.mdRate) * this.eurRate
          : parseFloat(this.laborForm.mdRate),
        mdDays: parseFloat(this.laborForm.mdDays),
        notes: this.laborForm.notes || null,
      }
      const path = this.laborForm.id ? `/api/labor/${this.laborForm.id}` : `/api/labor`
      const method = this.laborForm.id ? 'PUT' : 'POST'
      await this.apiFetch(method, path, payload)
      this.laborForm.open = false
      await this.loadLabor()
      // Obnov√≠me laborDetail.lc pokud je otev≈ôen√Ω
      if (this.laborDetail.open) {
        const updated = this.labor.find(l => l.id === (this.laborForm.id || this.laborDetail.lc?.id))
        if (updated) { this.laborDetail.lc = updated; this.laborFormEntries = updated.entries || [] }
      }
      this.$nextTick(() => this.renderLaborChart())
      this.loadDashboard()
    },

    async deleteLabor(id) {
      if (!confirm(this.t('confirmDeleteRole'))) return
      await this.apiFetch('DELETE', `/api/labor/${id}`)
      await this.loadLabor()
      this.loadDashboard()
    },

    // Labor helpers
    laborAmount(lc) {
      return (lc.mdRate ?? 0) * (lc.mdDays ?? 0)
    },
    laborTotal() {
      return this.labor.reduce((s, lc) => s + this.laborAmount(lc), 0)
    },
    laborByType(type) {
      return this.labor.filter(lc => lc.costType === type).reduce((s, lc) => s + this.laborAmount(lc), 0)
    },

    renderLaborChart() {
      // canvas is inside x-show ‚Äî give the browser one frame to apply display
      setTimeout(() => {
        this.destroyChart('labor')
        const ctx = document.getElementById('laborChart')
        if (!ctx || !this.labor.length) return
        _charts.labor = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: this.labor.map(lc => lc.role),
          datasets: [{
            data: this.labor.map(lc => this.laborAmount(lc)),
            backgroundColor: ['#FFCC00','#D40511','#3b82f6','#22c55e','#8b5cf6','#f59e0b','#06b6d4','#ec4899','#14b8a6','#f97316'],
            borderWidth: 2,
          }],
        },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 }, boxWidth: 12 } } } },
        })
      }, 0)
    },

    // --- PDF Export ---
    exportPDF() {
      const currency = this.currency
      const eurRate = this.eurRate
      const loc = this.lang === 'en' ? 'en-GB' : 'cs-CZ'
      const fmt = (v) => {
        if (v == null || v === 0) return '‚Äî'
        if (currency === 'EUR' && eurRate > 0)
          return new Intl.NumberFormat(loc, { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v / eurRate)
        return new Intl.NumberFormat(loc, { style: 'currency', currency: 'CZK', maximumFractionDigits: 0 }).format(v)
      }
      const fmtD = (d) => d ? new Date(d).toLocaleDateString(loc, { day: '2-digit', month: '2-digit', year: 'numeric' }) : '‚Äî'
      const esc = (s) => (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      const hasFilter = this.filters.search || this.filters.category || this.filters.tenderStatus ||
        this.filters.responsibleId || this.filters.priorityId || this.filters.capexOnly

      const totalEst = this.items.reduce((s, i) => s + (i.totalEstCost ?? 0), 0)
      const totalAct = this.items.reduce((s, i) => s + (i.actualPrice ?? 0), 0)
      const diff = totalAct - totalEst

      const rows = this.items.map(item => {
        const lastC = item.comments?.[0]
        return `<tr>
          <td>${esc(item.description)}</td>
          <td>${esc(item.category)}</td>
          <td>${esc(item.itemType)}</td>
          <td class="r">${fmt(item.totalEstCost)}</td>
          <td class="r ${item.actualPrice > item.totalEstCost ? 'red' : ''}">${fmt(item.actualPrice)}</td>
          <td>${esc(item.tenderStatus)}</td>
          <td>${esc(item.priority?.name)}</td>
          <td>${esc(item.responsible?.name)}</td>
          <td class="${item.tenderDeadline && new Date(item.tenderDeadline) < new Date() && item.tenderStatus !== 'Complete' ? 'red' : ''}">${fmtD(item.tenderDeadline)}</td>
          <td>${fmtD(item.deliveryDate)}</td>
          <td>${esc(item.approval)}</td>
          <td>${esc(item.chosenSupplier)}</td>
          <td class="comment-cell">${lastC ? '<b>' + esc(lastC.author) + ':</b> ' + esc(lastC.text) : '‚Äî'}</td>
        </tr>`
      }).join('')

      const html = `<!DOCTYPE html><html><head><meta charset="utf-8">
<title>${esc(this.projectName || 'Budget Tracker')} ‚Äî Export</title>
<style>
  @page { size: A4 landscape; margin: 12mm 8mm; }
  body { font-family: Arial, Helvetica, sans-serif; font-size: 8pt; color: #1a1a1a; margin: 0; }
  .hdr { display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 7px; border-bottom: 3pt solid #FFCC00; margin-bottom: 10px; }
  .brand { font-size: 15pt; font-weight: 700; color: #D40511; line-height: 1; }
  .proj  { font-size: 10pt; font-weight: 700; margin-top: 2px; }
  .meta  { font-size: 7.5pt; color: #555; text-align: right; }
  .warn  { color: #D40511; font-weight: 700; margin-top: 2px; }
  table  { width: 100%; border-collapse: collapse; font-size: 7.5pt; }
  th { background: #FFCC00; color: #1a1a1a; padding: 4px 5px; text-align: left; font-weight: 700; white-space: nowrap; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
  td { padding: 3px 5px; border-bottom: 0.5pt solid #e8e8e8; vertical-align: top; }
  tr:nth-child(even) td { background: #fafafa; }
  tfoot td { border-top: 1.5pt solid #333; font-weight: 700; background: #f2f2f2; }
  .r { text-align: right; font-family: monospace; }
  .red { color: #D40511; }
  .comment-cell { font-size: 7pt; color: #555; max-width: 120px; }
  .comment-cell b { color: #1a1a1a; }
</style></head><body>
<div class="hdr">
  <div>
    <div class="brand">PM Tool</div>
    <div class="proj">${esc(this.projectName || 'Budget Tracker')}</div>
  </div>
  <div class="meta">
    <div>${this.t('exportDate')}: ${new Date().toLocaleDateString(this.lang === 'en' ? 'en-GB' : 'cs-CZ', { day: '2-digit', month: 'long', year: 'numeric' })}</div>
    <div>${this.t('items')}: ${this.items.length}</div>
    ${hasFilter ? '<div class="warn">‚ö† ' + this.t('exportFilterWarning') + '</div>' : ''}
  </div>
</div>
<table>
  <thead><tr>
    <th>${this.t('colDescription')}</th><th>${this.t('colCategory')}</th><th>${this.t('colType')}</th>
    <th>${this.t('colEstimate')}</th><th>${this.t('colActual')}</th>
    <th>${this.t('status')}</th><th>${this.t('colPriority')}</th><th>${this.t('colResponsible')}</th>
    <th>${this.t('colTenderDeadline')}</th><th>${this.t('colDeliveryDate')}</th>
    <th>${this.t('colApproval')}</th><th>${this.t('colSupplier')}</th><th>${this.t('lastComment')}</th>
  </tr></thead>
  <tbody>${rows}</tbody>
  <tfoot><tr>
    <td colspan="3">${this.t('total')} (${this.items.length} ${this.t('items')})</td>
    <td class="r">${fmt(totalEst)}</td>
    <td class="r ${diff > 0 ? 'red' : ''}">${fmt(totalAct)}</td>
    <td colspan="8"></td>
  </tr></tfoot>
</table>
<script>window.onload = function(){ window.print() }<\/script>
</body></html>`

      const w = window.open('', '_blank')
      w.document.write(html)
      w.document.close()
    },

    // shared helpers for PDF exports
    _pdfFmt() {
      const currency = this.currency, eurRate = this.eurRate
      const loc = this.lang === 'en' ? 'en-GB' : 'cs-CZ'
      return {
        fmt: (v) => {
          if (v == null || v === 0) return '‚Äî'
          if (currency === 'EUR' && eurRate > 0)
            return new Intl.NumberFormat(loc, { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v / eurRate)
          return new Intl.NumberFormat(loc, { style: 'currency', currency: 'CZK', maximumFractionDigits: 0 }).format(v)
        },
        fmtD: (d) => d ? new Date(d).toLocaleDateString(loc, { day: '2-digit', month: '2-digit', year: 'numeric' }) : '‚Äî',
        esc:  (s) => (s ?? '‚Äî').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'),
        currency,
      }
    },

    _pdfBaseCss() {
      return `
        @page { size: A4 landscape; margin: 12mm 8mm; }
        * { print-color-adjust: exact; -webkit-print-color-adjust: exact; box-sizing: border-box; }
        body { font-family: Arial, Helvetica, sans-serif; font-size: 8pt; color: #1a1a1a; margin: 0; }
        .hdr { display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 7px; border-bottom: 3pt solid #FFCC00; margin-bottom: 12px; }
        .brand { font-size: 14pt; font-weight: 700; color: #D40511; line-height: 1; }
        .proj  { font-size: 10pt; font-weight: 700; margin-top: 2px; }
        .meta  { font-size: 7.5pt; color: #555; text-align: right; }
        h2 { font-size: 9pt; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: #555; margin: 12px 0 5px; border-left: 3pt solid #FFCC00; padding-left: 7px; }
        table.data { width: 100%; border-collapse: collapse; font-size: 7.5pt; margin-bottom: 8px; }
        table.data th { background: #FFCC00; color: #1a1a1a; padding: 4px 5px; text-align: left; font-weight: 700; white-space: nowrap; }
        table.data td { padding: 3px 5px; border-bottom: 0.5pt solid #e8e8e8; vertical-align: top; }
        table.data tr:nth-child(even) td { background: #fafafa; }
        table.data tfoot td { border-top: 1.5pt solid #333; font-weight: 700; background: #f2f2f2; }
        .r { text-align: right; font-family: monospace; }
        .red { color: #D40511; }
        .green { color: #16a34a; }
        /* KPI row ‚Äî float-based, reliable in print */
        .kpi-grid { overflow: hidden; margin-bottom: 12px; }
        .kpi { float: left; width: 20%; padding: 7px 9px; border: 1px solid #e0e0e0; border-radius: 4px; margin-right: 0.5%; }
        .kpi:last-child { margin-right: 0; }
        .kpi-l { font-size: 6.5pt; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #777; }
        .kpi-v { font-size: 14pt; font-weight: 800; line-height: 1.2; margin: 3px 0; }
        .kpi-s { font-size: 6pt; color: #999; }
        .progress-wrap { background: #eee; border-radius: 3px; height: 8px; margin: 4px 0 2px; }
        .progress-bar  { background: #22c55e; border-radius: 3px; height: 100%; }
        .progress-bar.over { background: #D40511; }
        /* 2-col float layout ‚Äî reliable in print, no CSS grid */
        .col-wrap { overflow: hidden; margin-bottom: 10px; }
        .col-left  { float: left;  width: 58%; padding-right: 12px; }
        .col-right { float: left;  width: 42%; page-break-inside: avoid; }
        .clearfix { clear: both; }
        .page-break { page-break-before: always; }
        tr { page-break-inside: avoid; }
      `
    },

    _pdfHeader(subtitle = '') {
      const { esc } = this._pdfFmt()
      return `
        <div class="hdr">
          <div>
            <div class="brand">PM Tool</div>
            <div class="proj">${esc(this.projectName || 'Budget Tracker')}</div>
            ${subtitle ? `<div style="font-size:8pt;color:#888;margin-top:2px">${subtitle}</div>` : ''}
          </div>
          <div class="meta">
            <div>${this.t('exportDate')}: ${new Date().toLocaleDateString(this.lang === 'en' ? 'en-GB' : 'cs-CZ', { day: '2-digit', month: 'long', year: 'numeric' })}</div>
          </div>
        </div>`
    },

    _captureCharts() {
      const imgs = {}
      for (const id of ['catChart', 'statusChart', 'personChart', 'priorityChart']) {
        const c = document.getElementById(id)
        if (c && c.width > 0) { try { imgs[id] = c.toDataURL('image/png') } catch(e) {} }
      }
      return imgs
    },

    _buildDashboardSection(d, chartImgs = {}) {
      const { fmt, esc } = this._pdfFmt()
      const s = d.summary

      // 6 KPI cards matching the screen exactly
      const kpis = [
        { l: this.t('pdfAssetEstimate'), v: fmt(s.totalEstimated), sub: s.totalItems + ' ¬∑ CAPEX: ' + fmt(s.totalCapex), c: '#FFCC00' },
        { l: this.t('pdfPmPeople'),      v: fmt(s.totalLabor),     sub: (d.laborCosts?.length ?? 0) + ' ' + this.t('roles'), c: '#3b82f6' },
        { l: this.t('pdfGrandTotal'),    v: fmt(s.grandTotal),     sub: this.t('pdfAssetsPlusPeople'),                  c: '#7c3aed' },
        { l: this.t('pdfSpentAssets'),   v: fmt(s.totalActual),    sub: (s.spentPct ?? 0) + ' ' + this.t('pdfPctOfEstimate'), c: '#22c55e' },
        { l: this.t('pdfSpentPeople'),   v: (s.totalLaborSpent ?? 0) > 0 ? fmt(s.totalLaborSpent) : '‚Äî', sub: this.t('pdfActualSpent'), c: '#0ea5e9' },
        { l: this.t('pdfRemaining'),     v: fmt(s.remaining),      sub: this.t('pdfEstMinusActual'),                    c: (s.remaining ?? 0) < 0 ? '#D40511' : '#22c55e' },
      ]
      const kpiHtml = kpis.map((k, i) => `
        <div style="float:left;width:16%;margin-right:${i < 5 ? '0.4%' : '0'};padding:7px 9px;border:1pt solid #e0e0e0;border-left:3pt solid ${k.c};border-radius:4px;box-sizing:border-box">
          <div style="font-size:6pt;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;color:#777">${k.l}</div>
          <div style="font-size:12pt;font-weight:800;line-height:1.2;margin:3px 0;color:${k.c}">${k.v}</div>
          <div style="font-size:6pt;color:#999">${k.sub}</div>
        </div>`).join('')

      const spentPct = Math.min(s.spentPct ?? 0, 100)
      const progressHtml = s.totalEstimated > 0 ? `
        <div style="margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;font-size:7pt;color:#666;margin-bottom:3px">
            <span>${this.t('pdfBudgetProgress')}</span><span style="font-weight:700">${s.spentPct ?? 0}%</span>
          </div>
          <div style="background:#eee;border-radius:3px;height:8px;margin:4px 0 2px;print-color-adjust:exact;-webkit-print-color-adjust:exact">
            <div style="background:#D40511;border-radius:3px;height:100%;width:${spentPct}%;print-color-adjust:exact;-webkit-print-color-adjust:exact"></div>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:6.5pt;color:#aaa">
            <span>${this.t('pdfSpent')}: ${fmt(s.totalActual)}</span><span>${this.t('pdfRemainingToEst')}: ${fmt(s.remaining)}</span>
          </div>
        </div>` : ''

      // 4 charts ‚Äî reduced height to make room for PM section on 1 page
      const chartsHtml = `
        <div style="overflow:hidden;margin-bottom:6px">
          ${chartImgs.catChart    ? `<div style="float:left;width:63%;margin-right:1%"><img src="${chartImgs.catChart}" style="width:100%;max-height:130px;object-fit:contain;display:block"></div>` : ''}
          ${chartImgs.statusChart ? `<div style="float:left;width:36%"><img src="${chartImgs.statusChart}" style="width:100%;max-height:130px;object-fit:contain;display:block"></div>` : ''}
          <div style="clear:both"></div>
        </div>
        <div style="overflow:hidden;margin-bottom:6px">
          ${chartImgs.personChart   ? `<div style="float:left;width:49%;margin-right:2%"><img src="${chartImgs.personChart}" style="width:100%;max-height:110px;object-fit:contain;display:block"></div>` : ''}
          ${chartImgs.priorityChart ? `<div style="float:left;width:49%"><img src="${chartImgs.priorityChart}" style="width:100%;max-height:110px;object-fit:contain;display:block"></div>` : ''}
          <div style="clear:both"></div>
        </div>`

      const PC = 'print-color-adjust:exact;-webkit-print-color-adjust:exact'
      const scoreColor = sc => sc >= 15 ? '#dc2626' : sc >= 10 ? '#f97316' : sc >= 5 ? '#eab308' : '#22c55e'
      const expColor   = ex => ex >= 11 ? '#dc2626' : ex >= 7  ? '#f97316' : ex >= 4  ? '#eab308' : '#22c55e'

      // ‚îÄ‚îÄ Risks ‚Äî visual mini-cards (1 row, up to 5 risks) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const openRisks    = (this.risks||[]).filter(r => r.status==='Open'||r.status==='Monitoring')
      const topRisks     = [...openRisks].sort((a,b)=>b.score-a.score).slice(0,5)
      const totalExposure = openRisks.reduce((s,r)=>s+r.score,0)
      const riskCards = topRisks.map(r => {
        const c = scoreColor(r.score)
        return `<div style="float:left;width:${topRisks.length<=4?'24%':'19%'};margin-right:1%;border:1pt solid #e5e7eb;border-top:3pt solid ${c};border-radius:3px;padding:5px 6px;box-sizing:border-box;${PC}">
          <div style="font-size:13pt;font-weight:800;color:${c};line-height:1;${PC}">${r.score}</div>
          <div style="font-size:6pt;font-weight:700;color:#333;margin:2px 0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(r.title)}">${esc(r.title)}</div>
          <div style="font-size:5.5pt;color:#888">${esc(r.status)} ¬∑ P${r.probability}√óD${r.impact}</div>
        </div>`
      }).join('')
      const risksSectionHtml = `
        <div style="margin:7px 0 5px">
          <div style="overflow:hidden;margin-bottom:3px">
            <span style="font-size:8pt;font-weight:800;color:#1a1a1a">${this.t('pdfTopRisks')}</span>
            <span style="font-size:6pt;color:#888;margin-left:8px">${this.t('pdfOpenCount')}: <b>${openRisks.length}</b> &nbsp;¬∑&nbsp; ${this.t('pdfTotalExposure')}: <b style="color:#dc2626">${totalExposure}</b></span>
          </div>
          ${topRisks.length ? `<div style="overflow:hidden">${riskCards}<div style="clear:both"></div></div>`
            : `<div style="font-size:7pt;color:#aaa">${this.t('pdfNoOpenRisks')}</div>`}
        </div>`

      // ‚îÄ‚îÄ Upcoming deadlines ‚Äî max 3 rows ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const upcoming = (d.upcomingDeadlines || []).slice(0, 3)
      const deadlineRows = upcoming.map(i => `<tr>
        <td style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(i.description)}</td>
        <td>${esc(i.category ?? '‚Äî')}</td>
        <td style="white-space:nowrap;font-family:monospace">${i.tenderDeadline ? new Date(i.tenderDeadline).toLocaleDateString(this.lang === 'en' ? 'en-GB' : 'cs-CZ') : '‚Äî'}</td>
        <td>${esc(i.tenderStatus ?? '‚Äî')}</td>
        <td>${esc(i.responsible ?? '‚Äî')}</td>
      </tr>`).join('')
      const deadlinesHtml = upcoming.length > 0 ? `
        <h2 style="margin:5px 0 3px">${this.t('pdfUpcoming90')}</h2>
        <table class="data"><thead><tr>
          <th>${this.t('colDescription')}</th><th>${this.t('category')}</th><th>Tender deadline</th><th>Status</th><th>${this.t('pdfResponsiblePerson')}</th>
        </tr></thead><tbody>${deadlineRows}</tbody></table>` : ''

      // ‚îÄ‚îÄ Assumptions ‚Äî visual KPI cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const allA       = this.assumptions || []
      const activeA    = allA.filter(a => a.status==='Active'||a.status==='Under review')
      const validatedA = allA.filter(a => a.status==='Validated'||a.status==='Closed')
      const overdueA   = activeA.filter(a => a.validationDate && new Date(a.validationDate) < new Date())
      const expiringA  = activeA.filter(a => a.validationDate && new Date(a.validationDate) <= new Date(Date.now()+14*864e5) && new Date(a.validationDate) >= new Date())
      const validPct   = allA.length ? Math.round(validatedA.length/allA.length*100) : 0

      const aKpis = [
        { l: this.t('pdfTotalAssumptions'), v: allA.length,    sub: activeA.length + ' ' + this.t('pdfActive'),      c:'#3b82f6' },
        { l: this.t('pctValidated'),        v: validPct + '%', sub: validatedA.length + ' / ' + allA.length,          c:'#22c55e' },
        { l: this.t('pdfOverdueValidation'),v: overdueA.length, sub: this.t('pdfActiveNoValidation'),                 c: overdueA.length  > 0 ? '#dc2626' : '#22c55e' },
        { l: this.t('pdfExpires14'),        v: expiringA.length, sub: this.t('pdfDeadlineClose'),                     c: expiringA.length > 0 ? '#f97316' : '#22c55e' },
      ]
      const aKpiHtml = aKpis.map((k,i) => `
        <div style="float:left;width:24%;margin-right:${i<3?'1.3%':'0'};border:1pt solid #e5e7eb;border-left:3pt solid ${k.c};border-radius:3px;padding:5px 8px;box-sizing:border-box;${PC}">
          <div style="font-size:5.5pt;font-weight:700;text-transform:uppercase;color:#888;letter-spacing:0.3px">${k.l}</div>
          <div style="font-size:14pt;font-weight:800;color:${k.c};line-height:1.1;margin:2px 0;${PC}">${k.v}</div>
          <div style="font-size:5.5pt;color:#aaa">${k.sub}</div>
        </div>`).join('')
      const assumptionsSectionHtml = `
        <div style="margin:7px 0 0">
          <span style="font-size:8pt;font-weight:800;color:#1a1a1a">üìù Assumption Log</span>
          <div style="overflow:hidden;margin-top:4px">${aKpiHtml}<div style="clear:both"></div></div>
        </div>`

      return `
        <div style="overflow:hidden;margin-bottom:10px">${kpiHtml}<div style="clear:both"></div></div>
        ${progressHtml}
        ${chartsHtml}
        ${risksSectionHtml}
        ${deadlinesHtml}
        ${assumptionsSectionHtml}`
    },

    _buildAssetsSection(items) {
      const { fmt, fmtD, esc } = this._pdfFmt()
      const totalEst = items.reduce((s, i) => s + (i.totalEstCost ?? 0), 0)
      const totalAct = items.reduce((s, i) => s + (i.actualPrice ?? 0), 0)
      const rows = items.map(item => {
        const lastC = item.comments?.[0]
        return `<tr>
          <td>${esc(item.description)}</td><td>${esc(item.category)}</td><td>${esc(item.itemType)}</td>
          <td class="r">${fmt(item.totalEstCost)}</td>
          <td class="r ${item.actualPrice > item.totalEstCost ? 'red' : ''}">${fmt(item.actualPrice)}</td>
          <td>${esc(item.tenderStatus)}</td><td>${esc(item.priority?.name)}</td><td>${esc(item.responsible?.name)}</td>
          <td>${fmtD(item.tenderDeadline)}</td><td>${fmtD(item.deliveryDate)}</td>
          <td>${esc(item.approval)}</td><td>${esc(item.chosenSupplier)}</td>
          <td style="font-size:6.5pt;color:#555">${lastC ? '<b>' + esc(lastC.author) + ':</b> ' + esc(lastC.text) : '‚Äî'}</td>
        </tr>`
      }).join('')
      return `
        <h2 style="margin-top:0">Asset list (${items.length} ${this.t('items')})</h2>
        <table><thead><tr>
          <th>${this.t('colDescription')}</th><th>${this.t('colCategory')}</th><th>${this.t('colType')}</th>
          <th class="r">${this.t('colEstimate')}</th><th class="r">${this.t('colActual')}</th>
          <th>${this.t('status')}</th><th>${this.t('colPriority')}</th><th>${this.t('colResponsible')}</th>
          <th>Deadline</th><th>${this.t('colDeliveryDate')}</th><th>${this.t('colApproval')}</th><th>${this.t('colSupplier')}</th><th>${this.t('lastComment')}</th>
        </tr></thead>
        <tbody>${rows}</tbody>
        <tfoot><tr>
          <td colspan="3">${this.t('total')} (${items.length} ${this.t('items')})</td>
          <td class="r">${fmt(totalEst)}</td>
          <td class="r ${totalAct > totalEst ? 'red' : ''}">${fmt(totalAct)}</td>
          <td colspan="8"></td>
        </tr></tfoot></table>`
    },

    _buildGanttSection(items) {
      const { esc } = this._pdfFmt()
      const filtered = items.filter(i =>
        i.tenderStartDate || i.tenderDeadline || i.orderPlaceDate || i.deliveryDate)
      if (!filtered.length) return '<p style="color:#999;font-size:8pt">' + this.t('pdfNoGanttData') + '</p>'

      const allDates = []
      for (const i of filtered) {
        if (i.tenderStartDate) allDates.push(new Date(i.tenderStartDate))
        if (i.tenderDeadline)  allDates.push(new Date(i.tenderDeadline))
        if (i.orderPlaceDate)  allDates.push(new Date(i.orderPlaceDate))
        if (i.deliveryDate)    allDates.push(new Date(i.deliveryDate))
      }
      let minDate = new Date(Math.min(...allDates.map(d => d.getTime())))
      let maxDate = new Date(Math.max(...allDates.map(d => d.getTime())))
      minDate = new Date(minDate.getFullYear(), minDate.getMonth(), 1)
      maxDate = new Date(maxDate.getFullYear(), maxDate.getMonth() + 2, 0)
      const totalMs = maxDate - minDate

      const months = []
      let cur = new Date(minDate)
      while (cur <= maxDate) { months.push(new Date(cur)); cur = new Date(cur.getFullYear(), cur.getMonth() + 1, 1) }

      const pct  = (d) => d ? ((new Date(d) - minDate) / totalMs) * 100 : null
      const wPct = (s, e) => s && e ? Math.max(0, ((new Date(e) - new Date(s)) / totalMs) * 100) : 0
      const todayPct = Math.max(0, Math.min(100, pct(new Date()) ?? 0))

      const monthHdr = months.map(m => {
        const w = (1 / months.length) * 100
        return `<div style="flex:1;text-align:center;font-size:6pt;font-weight:700;color:#FFCC00;padding:3px;border-right:1px solid #444;min-width:0;overflow:hidden">${m.toLocaleDateString(this.lang === 'en' ? 'en-GB' : 'cs-CZ',{month:'short',year:'2-digit'})}</div>`
      }).join('')

      const ganttRows = filtered.map(item => {
        const ts = pct(item.tenderStartDate), td = pct(item.tenderDeadline)
        const op = pct(item.orderPlaceDate),  dd = pct(item.deliveryDate)
        let tBar = '', dBar = ''
        const PC = 'print-color-adjust:exact;-webkit-print-color-adjust:exact'
        if (ts !== null && td !== null)
          tBar = `<div style="position:absolute;left:${ts}%;width:${Math.max(0.5,td-ts)}%;height:10px;top:50%;transform:translateY(-50%);background:#3b82f6;opacity:0.9;border-radius:2px;${PC}" title="Tender"></div>`
        else if (td !== null)
          tBar = `<div style="position:absolute;left:${Math.max(0,td-0.5)}%;width:10px;height:10px;top:50%;transform:translateY(-50%);background:#3b82f6;border-radius:50%;${PC}" title="Deadline"></div>`
        if (op !== null && dd !== null)
          dBar = `<div style="position:absolute;left:${op}%;width:${Math.max(0.5,dd-op)}%;height:10px;top:50%;transform:translateY(-50%);background:#22c55e;opacity:0.9;border-radius:2px;${PC}" title="${this.t('pdfDelivery')}"></div>`
        else if (dd !== null)
          dBar = `<div style="position:absolute;left:${dd}%;width:10px;height:10px;top:50%;transform:translateY(-50%);background:#22c55e;border-radius:50%;${PC}" title="${this.t('pdfDeliveryPoint')}"></div>`
        return `<div style="display:flex;height:28px;border-bottom:0.5pt solid #f0f0f0;align-items:center">
          <div style="width:200px;flex-shrink:0;padding:0 8px;font-size:7pt;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-right:1px solid #e0e0e0" title="${esc(item.description)}">${esc(item.description)}</div>
          <div style="flex:1;position:relative;height:100%">
            <div style="position:absolute;left:${todayPct}%;top:0;bottom:0;width:1.5px;background:#D40511;opacity:0.6;z-index:10;print-color-adjust:exact;-webkit-print-color-adjust:exact"></div>
            ${tBar}${dBar}
          </div>
        </div>`
      }).join('')

      return `
        <h2 style="margin-top:0">Gantt / Timeline</h2>
        <div style="display:flex;flex-direction:column;border:1px solid #e0e0e0;border-radius:4px;overflow:hidden">
          <div style="display:flex;background:#1a1a1a;print-color-adjust:exact;-webkit-print-color-adjust:exact">
            <div style="width:200px;flex-shrink:0;padding:4px 8px;font-size:7pt;font-weight:700;color:#FFCC00;border-right:1px solid #444">${this.t('colDescription')}</div>
            <div style="flex:1;display:flex">${monthHdr}</div>
          </div>
          ${ganttRows}
        </div>
        <div style="font-size:6.5pt;color:#888;margin-top:5px">
          <span style="display:inline-block;width:12px;height:8px;background:#3b82f6;border-radius:2px;vertical-align:middle;print-color-adjust:exact;-webkit-print-color-adjust:exact"></span> Tender &nbsp;
          <span style="display:inline-block;width:12px;height:8px;background:#22c55e;border-radius:2px;vertical-align:middle;print-color-adjust:exact;-webkit-print-color-adjust:exact"></span> ${this.t('pdfOrder2Delivery')} &nbsp;
          <span style="display:inline-block;width:12px;height:8px;background:#D40511;border-radius:2px;vertical-align:middle;print-color-adjust:exact;-webkit-print-color-adjust:exact"></span> ${this.t('pdfToday')}
        </div>`
    },

    _openPrintWindow(body, title = '') {
      const w = window.open('', '_blank')
      w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>${title || this.projectName || 'Export'}</title>
        <style>${this._pdfBaseCss()}</style></head><body>${body}
        <script>window.onload=function(){window.print()}<\/script></body></html>`)
      w.document.close()
    },

    exportDashboardPDF() {
      if (!this.dash?.summary) return alert(this.t('alertDashboardLoading'))
      const chartImgs = this._captureCharts()
      const { esc } = this._pdfFmt()
      this._openPrintWindow(
        this._pdfHeader(this.t('pdfDashboardSubtitle')) + this._buildDashboardSection(this.dash, chartImgs),
        esc(this.projectName) + ' ‚Äî Dashboard'
      )
    },

    async exportGanttPDF() {
      const r = await fetch(`${API}/api/items`)
      const items = await r.json()
      const { esc } = this._pdfFmt()
      this._openPrintWindow(
        this._pdfHeader('Gantt / Timeline') + this._buildGanttSection(items),
        esc(this.projectName) + ' ‚Äî Gantt'
      )
    },

    async exportAllPDF() {
      if (!this.dash?.summary) await this.loadDashboard()
      const chartImgs = this._captureCharts()
      const r = await fetch(`${API}/api/items`)
      const items = await r.json()
      const { esc } = this._pdfFmt()
      const body =
        this._pdfHeader(this.t('pdfDashboardSubtitle')) +
        this._buildDashboardSection(this.dash, chartImgs) +
        `<div class="page-break"></div>` +
        this._pdfHeader('Asset list') +
        this._buildAssetsSection(items) +
        `<div class="page-break"></div>` +
        this._pdfHeader('Gantt / Timeline') +
        this._buildGanttSection(items)
      this._openPrintWindow(body, esc(this.projectName) + ' ‚Äî ' + this.t('pdfExportAll'))
    },

    exportTestingDashboardPDF() {
      if (!this.testStats) return alert(this.t('alertGoToDashboard'))
      const { esc } = this._pdfFmt()
      const s = this.testStats
      const totalCases = Object.values(s.cases).reduce((a, b) => a + b, 0)
      const donePct = totalCases ? Math.round(((s.cases.PASS ?? 0) + (s.cases['N/A'] ?? 0)) / totalCases * 100) : 0

      // Capture donut chart images
      const pieImgs = {}
      for (const ts of this.testSets) {
        const c = document.getElementById('pie-ts-' + ts.id)
        if (c && c.width > 0) { try { pieImgs[ts.id] = c.toDataURL('image/png') } catch(e) {} }
      }

      // Global KPI row
      const kpiItems = [
        { l: 'PASS',        v: s.cases.PASS ?? 0,            color: '#22c55e' },
        { l: 'DEFECT',      v: s.cases.DEFECT ?? 0,          color: '#ef4444' },
        { l: 'WIP',         v: s.cases.WIP ?? 0,             color: '#3b82f6' },
        { l: 'N/A',         v: s.cases['N/A'] ?? 0,          color: '#9ca3af' },
        { l: 'Not Started', v: s.cases['Not Started'] ?? 0,  color: '#d97706' },
        { l: this.t('pdfDone'),  v: donePct + '%',             color: '#1a1a1a' },
      ]
      const kpiHtml = kpiItems.map((k, i) =>
        `<div style="float:left;width:15.5%;${i < 5 ? 'margin-right:0.6%;' : ''}padding:7px 9px;border:1pt solid #e0e0e0;border-left:3pt solid ${k.color};border-radius:4px;box-sizing:border-box">
          <div style="font-size:6pt;font-weight:700;text-transform:uppercase;color:#777">${k.l}</div>
          <div style="font-size:13pt;font-weight:800;color:${k.color}">${k.v}</div>
        </div>`
      ).join('') + '<div style="clear:both"></div>'

      // Per-set table rows
      const setRows = this.testSets.map(ts => {
        const total = ts.testCases.length
        const pass  = ts.testCases.filter(c => c.status === 'PASS').length
        const def   = ts.testCases.filter(c => c.status === 'DEFECT').length
        const wip   = ts.testCases.filter(c => c.status === 'WIP').length
        const na    = ts.testCases.filter(c => c.status === 'N/A').length
        const ns    = ts.testCases.filter(c => c.status === 'Not Started').length
        const pct   = total ? Math.round((pass + na) / total * 100) : 0
        const status = this.testSetStatus(ts)
        const stColor = status === 'Finished' ? '#16a34a' : status === 'WIP' ? '#2563eb' : '#92400e'
        const img = pieImgs[ts.id] ? `<img src="${pieImgs[ts.id]}" style="width:48px;height:48px;vertical-align:middle">` : '‚Äî'
        return `<tr>
          <td style="font-weight:600">${esc(ts.name)}</td>
          <td style="text-align:center">${img}</td>
          <td style="color:${stColor};font-weight:700">${status}</td>
          <td style="color:#16a34a;font-weight:700;text-align:right">${pass}</td>
          <td style="color:#dc2626;font-weight:700;text-align:right">${def}</td>
          <td style="color:#2563eb;font-weight:700;text-align:right">${wip}</td>
          <td style="text-align:right">${na}</td>
          <td style="text-align:right">${ns}</td>
          <td style="text-align:right;font-weight:800">${total ? pct + '%' : '‚Äî'}</td>
        </tr>`
      }).join('')

      // Defects table
      const sevColor = { Critical: '#dc2626', High: '#c2410c', Medium: '#d97706', Low: '#6b7280' }
      const defectRows = (s.defectsList ?? []).map(d =>
        `<tr>
          <td style="color:${sevColor[d.severity] ?? '#666'};font-weight:700">${esc(d.severity)}</td>
          <td style="font-weight:600">${esc(d.title)}</td>
          <td>${esc(d.testCase)}</td>
          <td>${esc(d.testSet)}</td>
          <td>${esc(d.status)}</td>
          <td style="color:#888">${esc(d.reportedBy) || '‚Äî'}</td>
        </tr>`
      ).join('')

      const body = this._pdfHeader('Test Management ‚Äî Dashboard') + `
        <h2>${this.t('pdfOverallProgress')}</h2>
        <div style="margin-bottom:12px">${kpiHtml}</div>
        <h2>${this.t('pdfProgressBySet')}</h2>
        <table class="data">
          <thead><tr>
            <th>Test Set</th><th style="text-align:center">Graf</th><th>Status</th>
            <th style="text-align:right;color:#16a34a">PASS</th>
            <th style="text-align:right;color:#dc2626">DEFECT</th>
            <th style="text-align:right;color:#2563eb">WIP</th>
            <th style="text-align:right">N/A</th>
            <th style="text-align:right">Not Started</th>
            <th style="text-align:right">% ${this.t('pdfDone')}</th>
          </tr></thead>
          <tbody>${setRows}</tbody>
        </table>
        ${defectRows ? `
        <h2>${this.t('pdfDefectsTop15')}</h2>
        <table class="data">
          <thead><tr>
            <th>${this.t('pdfSeverity')}</th><th>${this.t('pdfDefectName')}</th><th>Test Case</th><th>Test Set</th><th>Status</th><th>${this.t('pdfReportedBy')}</th>
          </tr></thead>
          <tbody>${defectRows}</tbody>
        </table>` : ''}
      `
      this._openPrintWindow(body, esc(this.projectName) + ' ‚Äî Test Dashboard')
    },

    // --- Risk / Issue / Change PDF exports ---
    exportRisksPDF() {
      const { fmt, fmtD, esc } = this._pdfFmt()
      const scoreStyle = (s) => s >= 15 ? 'background:#fee2e2;color:#991b1b' : s >= 10 ? 'background:#ffedd5;color:#9a3412' : s >= 5 ? 'background:#fef9c3;color:#854d0e' : 'background:#d1fae5;color:#065f46'
      const rows = this.risks.map(r => `<tr>
        <td style="font-size:7pt;color:#888">R-${String(r.id).padStart(3,'0')}</td>
        <td><b>${esc(r.title)}</b>${r.description ? '<br><span style="color:#888;font-size:7pt">' + esc(r.description.slice(0,80)) + '</span>' : ''}</td>
        <td>${esc(r.category)}</td>
        <td class="r">${r.probability}</td><td class="r">${r.impact}</td>
        <td class="r"><span style="padding:2px 6px;border-radius:3px;font-weight:700;${scoreStyle(r.score)}">${r.score}</span></td>
        <td>${esc(r.owner?.name)}</td>
        <td>${esc(r.status)}</td>
        <td>${fmtD(r.reviewDate)}</td>
        <td>${fmtD(r.materializationDate)}</td>
        <td style="font-size:7pt">${esc(r.mitigationPlan?.slice(0,60))}</td>
      </tr>`).join('')
      const openRisks = this.risks.filter(r => r.status === 'Open' || r.status === 'Monitoring')
      const exposure  = openRisks.reduce((s, r) => s + r.score, 0)
      const body = this._pdfHeader(this.t('pdfRiskRegister')) + `
        <div class="kpi-grid" style="overflow:hidden;margin-bottom:12px">
          <div class="kpi" style="float:left;width:18%;padding:7px 9px;border:1px solid #e0e0e0;border-radius:4px;margin-right:1%">
            <div class="kpi-l" style="font-size:6.5pt;font-weight:700;text-transform:uppercase;color:#777">${this.t('pdfTotalRisks')}</div>
            <div class="kpi-v" style="font-size:14pt;font-weight:800">${this.risks.length}</div>
          </div>
          <div class="kpi" style="float:left;width:18%;padding:7px 9px;border:1px solid #e0e0e0;border-radius:4px;margin-right:1%">
            <div class="kpi-l" style="font-size:6.5pt;font-weight:700;text-transform:uppercase;color:#777">${this.t('pdfOpenRisks')}</div>
            <div class="kpi-v" style="font-size:14pt;font-weight:800">${openRisks.length}</div>
          </div>
          <div class="kpi" style="float:left;width:18%;padding:7px 9px;border:1px solid #fee2e2;border-radius:4px;margin-right:1%">
            <div class="kpi-l" style="font-size:6.5pt;font-weight:700;text-transform:uppercase;color:#991b1b" x-text="t('riskExposure')"></div>
            <div class="kpi-v" style="font-size:14pt;font-weight:800;color:#D40511">${exposure}</div>
          </div>
          <div style="clear:both"></div>
        </div>
        <table class="data">
          <thead><tr>
            <th style="width:40px">ID</th><th>${this.t('pdfNameDesc')}</th><th style="width:80px">${this.t('category')}</th>
            <th style="width:30px">P</th><th style="width:30px">I</th><th style="width:55px">Score</th>
            <th style="width:90px">Owner</th><th style="width:80px">Status</th>
            <th style="width:80px">Review</th><th style="width:90px">${this.t('materializationDate')}</th>
            <th>${this.t('pdfMitigation')}</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>`
      this._openPrintWindow(body, esc(this.projectName) + ' ‚Äî Risk Management')
    },

    exportIssuesPDF() {
      const { fmtD, esc } = this._pdfFmt()
      const sevStyle = (s) => s === 'Critical' ? 'background:#fee2e2;color:#991b1b' : s === 'High' ? 'background:#ffedd5;color:#9a3412' : s === 'Medium' ? 'background:#fff3cd;color:#856404' : 'background:#f3f4f6;color:#4b5563'
      const stStyle  = (s) => s === 'Open' ? 'background:#fee2e2;color:#991b1b' : s === 'In progress' ? 'background:#dbeafe;color:#1e40af' : s === 'Escalated' ? 'background:#ede9fe;color:#5b21b6' : s === 'Resolved' ? 'background:#fff3cd;color:#856404' : 'background:#d1fae5;color:#065f46'
      const rows = this.issues.map(i => `<tr>
        <td style="font-size:7pt;color:#888">I-${String(i.id).padStart(3,'0')}</td>
        <td><b>${esc(i.title)}</b>${i.rootCause ? '<br><span style="color:#888;font-size:7pt">' + this.t('pdfRootCauseLabel') + ': ' + esc(i.rootCause.slice(0,60)) + '</span>' : ''}</td>
        <td>${esc(i.type)}</td>
        <td><span style="padding:2px 5px;border-radius:3px;font-weight:700;font-size:7pt;${sevStyle(i.severity)}">${esc(i.severity)}</span></td>
        <td><span style="padding:2px 5px;border-radius:3px;font-weight:700;font-size:7pt;${sevStyle(i.priority)}">${esc(i.priority)}</span></td>
        <td><span style="padding:2px 5px;border-radius:3px;font-weight:700;font-size:7pt;${stStyle(i.status)}">${esc(i.status)}</span></td>
        <td>${esc(i.owner?.name)}</td>
        <td class="${i.dueDate && new Date(i.dueDate) < new Date() ? 'red' : ''}">${fmtD(i.dueDate)}</td>
        <td style="font-size:7pt">${i.linkedRisk ? 'R-' + String(i.linkedRisk.id).padStart(3,'0') + ' ' + esc(i.linkedRisk.title.slice(0,25)) : '‚Äî'}</td>
      </tr>`).join('')
      const critical = this.issues.filter(i => i.severity === 'Critical' || i.severity === 'High').length
      const open     = this.issues.filter(i => i.status === 'Open' || i.status === 'In progress').length
      const body = this._pdfHeader('Issue Tracker') + `
        <div style="overflow:hidden;margin-bottom:12px">
          <div style="float:left;width:18%;padding:7px 9px;border:1px solid #e0e0e0;border-radius:4px;margin-right:1%">
            <div style="font-size:6.5pt;font-weight:700;text-transform:uppercase;color:#777">${this.t('pdfTotalIssues')}</div>
            <div style="font-size:14pt;font-weight:800">${this.issues.length}</div>
          </div>
          <div style="float:left;width:18%;padding:7px 9px;border:1px solid #fee2e2;border-radius:4px;margin-right:1%">
            <div style="font-size:6.5pt;font-weight:700;text-transform:uppercase;color:#991b1b">Critical / High</div>
            <div style="font-size:14pt;font-weight:800;color:#D40511">${critical}</div>
          </div>
          <div style="float:left;width:18%;padding:7px 9px;border:1px solid #dbeafe;border-radius:4px;margin-right:1%">
            <div style="font-size:6.5pt;font-weight:700;text-transform:uppercase;color:#1e40af">${this.t('pdfOpen')}</div>
            <div style="font-size:14pt;font-weight:800;color:#1e40af">${open}</div>
          </div>
          <div style="clear:both"></div>
        </div>
        <table class="data">
          <thead><tr>
            <th style="width:40px">ID</th><th>${this.t('pdfNameRootCause')}</th><th style="width:80px">${this.t('issueType')}</th>
            <th style="width:70px">${this.t('pdfSeverity')}</th><th style="width:70px">${this.t('colPriority')}</th>
            <th style="width:80px">Status</th><th style="width:90px">Owner</th>
            <th style="width:80px">Due date</th><th>Linked Risk</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>`
      this._openPrintWindow(body, esc(this.projectName) + ' ‚Äî Issue Tracker')
    },

    exportChangesPDF() {
      const { fmt, fmtD, esc } = this._pdfFmt()
      const stStyle = (s) => s === 'Draft' ? 'background:#f3f4f6;color:#4b5563' : s === 'Submitted' ? 'background:#dbeafe;color:#1e40af' : s === 'Approved' ? 'background:#d1fae5;color:#065f46' : s === 'Rejected' ? 'background:#fee2e2;color:#991b1b' : 'background:#ede9fe;color:#5b21b6'
      const rows = this.changes.map(cr => `<tr>
        <td style="font-size:7pt;color:#888">CR-${String(cr.id).padStart(3,'0')}</td>
        <td><b>${esc(cr.title)}</b>${cr.description ? '<br><span style="color:#888;font-size:7pt">' + esc(cr.description.slice(0,70)) + '</span>' : ''}</td>
        <td>${esc(cr.changeType)}</td>
        <td><span style="padding:2px 5px;border-radius:3px;font-weight:700;font-size:7pt;${stStyle(cr.approvalStatus)}">${esc(cr.approvalStatus)}</span></td>
        <td class="r ${(cr.budgetImpact ?? 0) > 0 ? 'red' : ''}">${cr.budgetImpact ? fmt(cr.budgetImpact) : '‚Äî'}</td>
        <td>${esc(cr.timelineImpact)}</td>
        <td>${esc(cr.requestedBy?.name)}</td>
        <td>${esc(cr.approvedBy?.name)}</td>
        <td style="font-size:7pt">${esc(cr.businessJustification?.slice(0,60))}</td>
      </tr>`).join('')
      const pending  = this.changes.filter(c => c.approvalStatus === 'Draft' || c.approvalStatus === 'Submitted').length
      const approved = this.changes.filter(c => c.approvalStatus === 'Approved' || c.approvalStatus === 'Implemented').length
      const totalImpact = this.changes.filter(c => c.approvalStatus === 'Approved' || c.approvalStatus === 'Implemented').reduce((s,c) => s + (c.budgetImpact ?? 0), 0)
      const body = this._pdfHeader('Change Management') + `
        <div style="overflow:hidden;margin-bottom:12px">
          <div style="float:left;width:18%;padding:7px 9px;border:1px solid #e0e0e0;border-radius:4px;margin-right:1%">
            <div style="font-size:6.5pt;font-weight:700;text-transform:uppercase;color:#777">${this.t('pdfTotalCR')}</div>
            <div style="font-size:14pt;font-weight:800">${this.changes.length}</div>
          </div>
          <div style="float:left;width:18%;padding:7px 9px;border:1px solid #dbeafe;border-radius:4px;margin-right:1%">
            <div style="font-size:6.5pt;font-weight:700;text-transform:uppercase;color:#1e40af">${this.t('pdfPending')}</div>
            <div style="font-size:14pt;font-weight:800;color:#1e40af">${pending}</div>
          </div>
          <div style="float:left;width:18%;padding:7px 9px;border:1px solid #d1fae5;border-radius:4px;margin-right:1%">
            <div style="font-size:6.5pt;font-weight:700;text-transform:uppercase;color:#065f46">${this.t('pdfApproved')}</div>
            <div style="font-size:14pt;font-weight:800;color:#065f46">${approved}</div>
          </div>
          ${totalImpact ? `<div style="float:left;width:22%;padding:7px 9px;border:1px solid #fee2e2;border-radius:4px;margin-right:1%">
            <div style="font-size:6.5pt;font-weight:700;text-transform:uppercase;color:#991b1b">${this.t('pdfBudgetImpactApproved')}</div>
            <div style="font-size:14pt;font-weight:800;color:#D40511">${fmt(totalImpact)}</div>
          </div>` : ''}
          <div style="clear:both"></div>
        </div>
        <table class="data">
          <thead><tr>
            <th style="width:40px">ID</th><th>${this.t('pdfNameDesc')}</th><th style="width:80px">${this.t('changeType')}</th>
            <th style="width:90px">Status</th><th style="width:90px">${this.t('budgetImpact')}</th>
            <th style="width:80px">Timeline</th>
            <th style="width:90px">${this.t('requestedBy')}</th><th style="width:90px">${this.t('approvedBy')}</th>
            <th>${this.t('pdfJustification')}</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>`
      this._openPrintWindow(body, esc(this.projectName) + ' ‚Äî Change Management')
    },

    // --- Helpers ---
    fmtMoney(v) {
      if (v == null || v === 0) return '‚Äî'
      const loc = this.lang === 'en' ? 'en-GB' : 'cs-CZ'
      if (this.currency === 'EUR' && this.eurRate > 0) {
        return new Intl.NumberFormat(loc, { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v / this.eurRate)
      }
      return new Intl.NumberFormat(loc, { style: 'currency', currency: 'CZK', maximumFractionDigits: 0 }).format(v)
    },

    fmtDate(d) {
      if (!d) return '‚Äî'
      const loc = this.lang === 'en' ? 'en-GB' : 'cs-CZ'
      return new Date(d).toLocaleDateString(loc, { day: '2-digit', month: '2-digit', year: 'numeric' })
    },

    fmtDateTime(d) {
      if (!d) return '‚Äî'
      const loc = this.lang === 'en' ? 'en-GB' : 'cs-CZ'
      return new Date(d).toLocaleString(loc, { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
    },

    isoDate(d) {
      if (!d) return ''
      return new Date(d).toISOString().slice(0, 10)
    },

    deadlineClass(d) {
      if (!d) return ''
      const diff = (new Date(d) - new Date()) / (1000 * 60 * 60 * 24)
      if (diff < 14) return 'deadline-urgent'
      if (diff < 30) return 'deadline-soon'
      return ''
    },

    statusBadge(s) {
      const map = {
        'Not Tender Needed': 'badge-grey',
        'Tender Planned': 'badge-blue',
        'Tender Closed': 'badge-purple',
        'Implementation': 'badge-yellow',
        'Approved': 'badge-green',
        'Complete': 'badge-green',
      }
      return map[s] ?? 'badge-grey'
    },

    approvalBadge(a) {
      return { 'Approved': 'badge-green', 'Pending': 'badge-yellow', 'Rejected': 'badge-red', 'Not Required': 'badge-grey' }[a] ?? 'badge-grey'
    },

    statusStyle(s) {
      const m = {
        'Not Tender Needed': 'background:#f3f4f6;color:#4b5563',
        'Tender Planned':    'background:#dbeafe;color:#1e40af',
        'Tender Closed':     'background:#ede9fe;color:#5b21b6',
        'Implementation':    'background:#fff3cd;color:#856404',
        'Approved':          'background:#d1fae5;color:#065f46',
        'Complete':          'background:#d1fae5;color:#065f46',
      }
      return m[s] ?? 'background:#f3f4f6;color:#9ca3af'
    },

    approvalStyle(a) {
      const m = {
        'Approved':     'background:#d1fae5;color:#065f46',
        'Pending':      'background:#fff3cd;color:#856404',
        'Rejected':     'background:#fee2e2;color:#991b1b',
        'Not Required': 'background:#f3f4f6;color:#4b5563',
      }
      return m[a] ?? 'background:#f3f4f6;color:#9ca3af'
    },

    gotoAssets(filterKey, filterValue) {
      this.filters = { search: '', category: '', tenderStatus: '', responsibleId: '', priorityId: '', capexOnly: false }
      this.filters[filterKey] = filterValue
      this.view = 'assets'
      this.loadItems()
    },

    async quickPatch(id, field, value) {
      await this.apiFetch('PUT', `/api/items/${id}`, { [field]: value })
      await this.loadItems()
      this.loadDashboard()
      if (this.detailPanel.open && this.detailPanel.item?.id === id) {
        const updated = this.items.find(i => i.id === id)
        if (updated) this.detailPanel.item = updated
      }
    },

    // --- Charts ---
    destroyChart(key) {
      if (_charts[key]) { _charts[key].destroy(); delete _charts[key] }
    },

    renderCharts() {
      const d = this.dash
      if (!d.summary) return

      const hoverCursor = (evt, els) => { evt.native.target.style.cursor = els.length ? 'pointer' : 'default' }

      // Category chart
      this.destroyChart('cat')
      const catCtx = document.getElementById('catChart')
      if (catCtx && d.byCategory?.length) {
        const labels = d.byCategory.slice(0, 8).map(c => c.category)
        _charts.cat = new Chart(catCtx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label: this.t('chartEstimated'), data: d.byCategory.slice(0, 8).map(c => c.estimated), backgroundColor: '#FFCC00cc' },
              { label: this.t('chartActual'), data: d.byCategory.slice(0, 8).map(c => c.actual),
                backgroundColor: d.byCategory.slice(0, 8).map(c => c.actual > c.estimated ? '#D40511cc' : '#22c55ecc') },
            ],
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  afterBody: (items) => {
                    const idx = items[0]?.dataIndex
                    if (idx == null) return ''
                    const cat = d.byCategory[idx]
                    const diff = (cat.actual ?? 0) - (cat.estimated ?? 0)
                    if (!diff) return ''
                    const sign = diff > 0 ? this.t('chartOverspent') : this.t('chartSavings')
                    return sign + ': ' + this.fmtMoney(Math.abs(diff))
                  }
                }
              }
            },
            scales: { y: { ticks: { callback: v => this.fmtMoney(v) } } },
            onHover: hoverCursor,
            onClick: (evt, els) => {
              if (!els.length) return
              this.gotoAssets('category', labels[els[0].index])
            },
          },
        })
      }

      // Status chart
      this.destroyChart('status')
      const statusCtx = document.getElementById('statusChart')
      if (statusCtx && d.summary.byStatus) {
        const statusColors = { 'Not Tender Needed': '#9ca3af', 'Tender Planned': '#3b82f6', 'Tender Closed': '#8b5cf6', 'Implementation': '#FFCC00', 'Approved': '#22c55e', 'Complete': '#16a34a', 'Unset': '#e5e7eb' }
        const labels = Object.keys(d.summary.byStatus)
        _charts.status = new Chart(statusCtx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{ data: labels.map(l => d.summary.byStatus[l]), backgroundColor: labels.map(l => statusColors[l] ?? '#ccc'), borderWidth: 2 }],
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { font: { size: 10 }, boxWidth: 12 } } },
            onHover: hoverCursor,
            onClick: (evt, els) => {
              if (!els.length) return
              this.gotoAssets('tenderStatus', labels[els[0].index])
            },
          },
        })
      }

      // Person chart
      this.destroyChart('person')
      const personCtx = document.getElementById('personChart')
      if (personCtx && d.byPerson?.length) {
        const data = d.byPerson.slice(0, 8)
        const totalItems = data.reduce((s, p) => s + p.count, 0)
        const avg = totalItems / data.length
        const overloadThreshold = Math.max(avg * 1.5, avg + 2)
        const labels = data.map(p => p.count >= overloadThreshold ? '‚ö† ' + p.name : p.name)
        const colors = data.map(p => p.count >= overloadThreshold ? '#D40511cc' : '#1A1A1Acc')
        _charts.person = new Chart(personCtx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{ label: 'Poƒçet polo≈æek', data: data.map(p => p.count), backgroundColor: colors }],
          },
          options: {
            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  afterLabel: (item) => data[item.dataIndex].count >= overloadThreshold ? '‚ö† Mo≈æn√© p≈ôet√≠≈æen√≠!' : ''
                }
              }
            },
            scales: { x: { ticks: { stepSize: 1 } } },
            onHover: hoverCursor,
            onClick: (evt, els) => {
              if (!els.length) return
              const name = data[els[0].index].name
              const person = this.people.find(p => p.name === name)
              if (person) this.gotoAssets('responsibleId', String(person.id))
            },
          },
        })
      }

      // Priority chart
      this.destroyChart('priority')
      const prioCtx = document.getElementById('priorityChart')
      if (prioCtx && d.byPriority?.length) {
        const prioData = d.byPriority
        _charts.priority = new Chart(prioCtx, {
          type: 'pie',
          data: {
            labels: prioData.map(p => p.name),
            datasets: [{ data: prioData.map(p => p.count), backgroundColor: prioData.map(p => p.color), borderWidth: 2 }],
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { font: { size: 10 }, boxWidth: 12 } } },
            onHover: hoverCursor,
            onClick: (evt, els) => {
              if (!els.length) return
              const name = prioData[els[0].index].name
              const prio = this.priorities.find(p => p.name === name)
              if (prio) this.gotoAssets('priorityId', String(prio.id))
            },
          },
        })
      }
    },

    // ‚îÄ‚îÄ Testing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async loadTestSets() {
      try {
        const r = await fetch(`${API}/api/testsets`)
        const data = await r.json()
        this.testSets = Array.isArray(data) ? data : []
        this.$nextTick(() => {
          for (const ts of this.testSets) {
            if (ts.dateMin && ts.dateMax) this.renderWaterfall(ts)
          }
        })
      } catch (e) {
        console.error('loadTestSets error:', e)
        this.testSets = []
      }
    },

    async loadTestStats() {
      const [statsRes, defectsRes] = await Promise.all([
        fetch(`${API}/api/testing/stats`),
        fetch(`${API}/api/testing/defects`),
      ])
      const stats = await statsRes.json()
      stats.defectsList = await defectsRes.json()
      this.testStats = stats
    },

    openStepEdit(step) {
      this.stepEditForm = {
        open: true,
        id: step.id,
        description: step.description ?? '',
        notes: step.notes ?? '',
        status: step.status ?? 'Not Started',
        testedBy: step.testedBy ?? '',
        testedAt: step.testedAt ? step.testedAt.slice(0, 10) : '',
      }
    },

    async saveStepEdit() {
      if (!this.stepEditForm.description.trim()) return alert(this.t('alertEnterStepDesc'))
      const body = {
        description: this.stepEditForm.description,
        notes: this.stepEditForm.notes || null,
        status: this.stepEditForm.status,
        testedBy: this.stepEditForm.testedBy || null,
        testedAt: this.stepEditForm.testedAt || null,
      }
      const r = await fetch(`${API}/api/teststeps/${this.stepEditForm.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      })
      if (!r.ok) return alert('Chyba p≈ôi ukl√°d√°n√≠ kroku')
      this.stepEditForm.open = false
      await this.loadTestSets()
    },

    getStepForm(caseId) {
      if (!this.stepForms[caseId]) this.stepForms[caseId] = { description: '', notes: '', testedBy: '', testedAt: '', adding: false }
      return this.stepForms[caseId]
    },

    statusBadgeClass(status) {
      const map = { 'PASS': 'status-PASS', 'DEFECT': 'status-DEFECT', 'WIP': 'status-WIP', 'N/A': 'status-NA', 'Not Started': 'status-NOT-STARTED' }
      return map[status] ?? 'badge-grey'
    },

    testSetStatus(ts) {
      if (!ts.testCases.length) return 'Not Started'
      const finished = ['PASS', 'N/A']
      if (ts.testCases.every(c => c.status === 'Not Started')) return 'Not Started'
      if (ts.testCases.every(c => finished.includes(c.status))) return 'Finished'
      return 'WIP'
    },

    testSetStatusClass(ts) {
      const s = this.testSetStatus(ts)
      if (s === 'Finished') return 'status-PASS'
      if (s === 'WIP') return 'status-WIP'
      return 'status-NOT-STARTED'
    },

    defectSeverityClass(sev) {
      const map = { 'Critical': 'severity-Critical', 'High': 'severity-High', 'Medium': 'severity-Medium', 'Low': 'severity-Low' }
      return map[sev] ?? 'badge-grey'
    },

    // TestSet CRUD
    openTsForm(ts = null) {
      if (ts) {
        this.tsForm = { open: true, id: ts.id, name: ts.name, dateMin: ts.dateMin?.slice(0,10) ?? '', dateMax: ts.dateMax?.slice(0,10) ?? '', notes: ts.notes ?? '' }
      } else {
        this.tsForm = { open: true, id: null, name: '', dateMin: '', dateMax: '', notes: '' }
      }
    },

    async saveTestSet() {
      if (!this.tsForm.name.trim()) return alert(this.t('alertEnterTestSetName'))
      const body = { name: this.tsForm.name, dateMin: this.tsForm.dateMin || null, dateMax: this.tsForm.dateMax || null, notes: this.tsForm.notes || null }
      const url = this.tsForm.id ? `${API}/api/testsets/${this.tsForm.id}` : `${API}/api/testsets`
      const method = this.tsForm.id ? 'PUT' : 'POST'
      try {
        const r = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
        console.log('[saveTestSet] HTTP status:', r.status)
        if (!r.ok) {
          const errText = await r.text().catch(() => '?')
          alert('Chyba p≈ôi ulo≈æen√≠ (HTTP ' + r.status + '):\n' + errText)
          return
        }
        this.tsForm.open = false
        await this.loadTestSets()
      } catch (e) {
        alert('S√≠≈•ov√° chyba: ' + e.message)
      }
    },

    async deleteTestSet(id) {
      if (!confirm(this.t('confirmDeleteTestSet'))) return
      await fetch(`${API}/api/testsets/${id}`, { method: 'DELETE' })
      await this.loadTestSets()
    },

    // TestCase CRUD
    openTcForm(setId, tc = null) {
      if (tc) {
        this.tcForm = { open: true, id: tc.id, setId, name: tc.name, status: tc.status, notes: tc.notes ?? '', testedBy: tc.testedBy ?? '', dataUsed: tc.dataUsed ?? '' }
      } else {
        this.tcForm = { open: true, id: null, setId, name: '', status: 'Not Started', notes: '', testedBy: '', dataUsed: '' }
      }
    },

    async saveTestCase() {
      if (!this.tcForm.name.trim()) return alert(this.t('alertEnterTestCaseName'))
      const body = { name: this.tcForm.name, status: this.tcForm.status, notes: this.tcForm.notes || null, testedBy: this.tcForm.testedBy || null, dataUsed: this.tcForm.dataUsed || null }
      if (this.tcForm.id) {
        await fetch(`${API}/api/testcases/${this.tcForm.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
      } else {
        await fetch(`${API}/api/testsets/${this.tcForm.setId}/testcases`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
      }
      this.tcForm.open = false
      await this.loadTestSets()
    },

    async deleteTestCase(id, setId) {
      if (!confirm(this.t('confirmDeleteTestCase'))) return
      await fetch(`${API}/api/testcases/${id}`, { method: 'DELETE' })
      await this.loadTestSets()
    },

    async updateTestCaseStatus(tc, newStatus) {
      const calls = [
        fetch(`${API}/api/testcases/${tc.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) }),
        ...tc.steps.map(step => fetch(`${API}/api/teststeps/${step.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) })),
      ]
      await Promise.all(calls)
      await this.loadTestSets()
    },

    // TestStep CRUD
    async addTestStep(tc) {
      const sf = this.getStepForm(tc.id)
      if (!sf.description.trim()) return
      const nextOrder = tc.steps.length
      await fetch(`${API}/api/testcases/${tc.id}/steps`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          description: sf.description,
          order: nextOrder,
          notes: sf.notes || null,
          testedBy: sf.testedBy || null,
          testedAt: sf.testedAt || null,
        }),
      })
      sf.description = ''
      sf.notes = ''
      sf.testedBy = ''
      sf.testedAt = ''
      sf.adding = false
      await this.loadTestSets()
    },

    async updateStepStatus(step, tc, newStatus) {
      await fetch(`${API}/api/teststeps/${step.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) })
      await this.loadTestSets()
    },

    async deleteTestStep(id, tc) {
      await fetch(`${API}/api/teststeps/${id}`, { method: 'DELETE' })
      await this.loadTestSets()
    },

    // Defect CRUD
    openDefectForm(caseId, def = null) {
      if (def) {
        this.defectForm = { open: true, id: def.id, caseId, title: def.title, description: def.description ?? '', severity: def.severity, status: def.status, reportedBy: def.reportedBy ?? '' }
      } else {
        this.defectForm = { open: true, id: null, caseId, title: '', description: '', severity: 'Medium', status: 'Open', reportedBy: '' }
      }
    },

    async saveDefect() {
      if (!this.defectForm.title.trim()) return alert(this.t('alertEnterDefectName'))
      const body = { title: this.defectForm.title, description: this.defectForm.description || null, severity: this.defectForm.severity, status: this.defectForm.status, reportedBy: this.defectForm.reportedBy || null }
      if (this.defectForm.id) {
        await fetch(`${API}/api/defects/${this.defectForm.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
      } else {
        await fetch(`${API}/api/testcases/${this.defectForm.caseId}/defects`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
      }
      this.defectForm.open = false
      await this.loadTestSets()
    },

    async updateDefectStatus(def, newStatus) {
      await fetch(`${API}/api/defects/${def.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) })
      def.status = newStatus
    },

    async deleteDefect(id, tc) {
      if (!confirm(this.t('confirmDeleteDefect'))) return
      await fetch(`${API}/api/defects/${id}`, { method: 'DELETE' })
      await this.loadTestSets()
    },

    // CSV Import
    downloadCsvTemplate() {
      const content = [
        '# REQUIRED: test_set, test_case | OPTIONAL: vse ostatni',
        'test_set,test_set_date_min,test_set_date_max,test_set_notes,test_case,test_case_notes,test_case_data_used,step_order,step_description,step_notes',
        'Inbound,2025-01-10,2025-01-20,Testovani prijmu zasilek,Happy Flow,,TC001,1,Prijem zasilky na rampe,Zasilka je prijata bez poskozeni',
        'Inbound,2025-01-10,2025-01-20,Testovani prijmu zasilek,Happy Flow,,TC001,2,Overeni stitku a obsahu,Stitek odpovida obsahu',
        'Inbound,2025-01-10,2025-01-20,Testovani prijmu zasilek,Happy Flow,,TC001,3,Ulozeni na sklad,Zasilka ulozena na spravne misto',
        'Inbound,2025-01-10,2025-01-20,Testovani prijmu zasilek,Error Flow,,,1,Prijem poskozene zasilky,Zasilka je oznacena jako poskozena',
        'Inbound,2025-01-10,2025-01-20,Testovani prijmu zasilek,Error Flow,,,2,Vytvoreni reklamace,Reklamace je vytvorena v systemu',
        'Outbound,,,,Pick & Pack,,,1,Vyber ze skladu,Spravna zasilka je vybrana',
        'Outbound,,,,Pick & Pack,,,2,Baleni zasilky,Zasilka je spravne zabalena',
      ].join('\n')
      const blob = new Blob(['\uFEFF' + content], { type: 'text/csv;charset=utf-8;' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url; a.download = 'import-template.csv'; a.click()
      URL.revokeObjectURL(url)
    },

    handleCsvFile(event) {
      const file = event.target.files[0]
      if (!file) return
      this.csvImport.fileName = file.name
      this.csvImport.error = ''
      const reader = new FileReader()
      reader.onload = (e) => { this.csvImport.raw = e.target.result }
      reader.readAsText(file, 'UTF-8')
    },

    handleCsvDrop(event) {
      const file = event.dataTransfer.files[0]
      if (!file) return
      if (!file.name.match(/\.(csv|txt)$/i)) { this.csvImport.error = this.t('alertCsvOnly'); return }
      this.csvImport.fileName = file.name
      this.csvImport.error = ''
      const reader = new FileReader()
      reader.onload = (e) => { this.csvImport.raw = e.target.result }
      reader.readAsText(file, 'UTF-8')
    },

    async importCSV() {
      if (!this.csvImport.raw.trim()) { this.csvImport.error = this.t('alertUploadCsv'); return }
      this.csvImport.loading = true
      this.csvImport.error = ''
      try {
        const body = { csv: this.csvImport.raw }
        if (this.csvImport.setId) body.testSetId = this.csvImport.setId
        else if (this.csvImport.setName) body.testSetName = this.csvImport.setName
        const r = await fetch(`${API}/api/testsets/import`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
        const data = await r.json()
        if (!r.ok) { this.csvImport.error = data.error || 'Chyba p≈ôi importu'; return }
        this.csvImport.open = false
        await this.loadTestSets()
      } catch (e) {
        this.csvImport.error = String(e)
      } finally {
        this.csvImport.loading = false
      }
    },

    // Waterfall chart ‚Äî planned target (Total/Available days) + actual closed by testedAt
    renderWaterfall(ts) {
      const canvasId = 'waterfall-' + ts.id
      const canvas = document.getElementById(canvasId)
      if (!canvas) return

      const total = ts.testCases.length
      if (total === 0) return

      const min = new Date(ts.dateMin); min.setHours(0,0,0,0)
      const max = new Date(ts.dateMax); max.setHours(0,0,0,0)

      // Count available days in range
      let availDays = 0
      const tmp = new Date(min)
      while (tmp <= max) { availDays++; tmp.setDate(tmp.getDate() + 1) }

      // Build day-by-day arrays
      const labels = []
      const planned = []   // cumulative linear target
      const actualClosed = []  // cumulative tests closed by testedAt

      const d = new Date(min)
      let dayIndex = 0
      while (d <= max) {
        labels.push(d.toLocaleDateString(this.lang === 'en' ? 'en-GB' : 'cs-CZ', { day: '2-digit', month: '2-digit' }))

        // Planned: linear cumulative
        planned.push(Math.round(total * (dayIndex + 1) / availDays))

        // Actual: count cases closed (PASS/N/A) with testedAt <= end of this day
        const dayEnd = new Date(d); dayEnd.setHours(23,59,59,999)
        const closed = ts.testCases.filter(c => {
          if (!['PASS', 'N/A'].includes(c.status)) return false
          if (!c.testedAt) return false
          return new Date(c.testedAt) <= dayEnd
        }).length
        actualClosed.push(closed)

        dayIndex++
        d.setDate(d.getDate() + 1)
        if (labels.length > 90) break
      }

      const existing = Chart.getChart(canvas)
      if (existing) existing.destroy()

      new Chart(canvas, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Pl√°novan√Ω target',
              data: planned,
              borderColor: '#94a3b8',
              borderDash: [6, 4],
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              tension: 0,
            },
            {
              label: 'Re√°lnƒõ uzav≈ôeno',
              data: actualClosed,
              borderColor: '#22c55e',
              backgroundColor: 'rgba(34,197,94,0.08)',
              borderWidth: 2,
              pointRadius: 2,
              fill: true,
              tension: 0.2,
            },
          ],
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top', labels: { font: { size: 10 }, boxWidth: 12, padding: 8 } },
            tooltip: { mode: 'index', intersect: false },
          },
          scales: {
            x: { ticks: { font: { size: 9 }, maxRotation: 45, maxTicksLimit: 20 } },
            y: { min: 0, max: total, ticks: { font: { size: 9 }, stepSize: Math.max(1, Math.ceil(total/5)) } },
          },
        },
      })
    },

    renderSetPieCharts() {
      for (const ts of this.testSets) {
        const canvas = document.getElementById('pie-ts-' + ts.id)
        if (!canvas) continue
        const c = { PASS: 0, DEFECT: 0, WIP: 0, 'N/A': 0, 'Not Started': 0 }
        for (const tc of ts.testCases) c[tc.status] = (c[tc.status] ?? 0) + 1
        const total = ts.testCases.length
        const existing = Chart.getChart(canvas)
        if (existing) existing.destroy()
        if (total === 0) {
          // Draw empty ring
          new Chart(canvas, {
            type: 'doughnut',
            data: { labels: ['Pr√°zdn√Ω'], datasets: [{ data: [1], backgroundColor: ['#e5e7eb'], borderWidth: 0 }] },
            options: { responsive: false, cutout: '65%', plugins: { legend: { display: false }, tooltip: { enabled: false } } },
          })
          continue
        }
        new Chart(canvas, {
          type: 'doughnut',
          data: {
            labels: ['PASS', 'DEFECT', 'WIP', 'N/A', 'Not Started'],
            datasets: [{
              data: [c.PASS, c.DEFECT, c.WIP, c['N/A'], c['Not Started']],
              backgroundColor: ['#22c55e', '#ef4444', '#3b82f6', '#9ca3af', '#fde68a'],
              borderWidth: 2,
              borderColor: '#fff',
              hoverOffset: 4,
            }],
          },
          options: {
            responsive: false,
            cutout: '65%',
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => ` ${ctx.label}: ${ctx.parsed} (${Math.round(ctx.parsed / total * 100)}%)`,
                },
              },
            },
          },
        })
      }
    },

    // --- Gantt ---
    async renderGantt() {
      const r = await fetch(`${API}/api/items`)
      const all = await r.json()

      // Filter items with at least one date
      const filtered = all.filter(i => {
        if (this.ganttFilter === 'tender') return i.tenderStartDate || i.tenderDeadline
        if (this.ganttFilter === 'delivery') return i.orderPlaceDate || i.deliveryDate
        return i.tenderStartDate || i.tenderDeadline || i.orderPlaceDate || i.deliveryDate
      })

      const area = document.getElementById('ganttArea')
      if (!filtered.length) {
        area.innerHTML = '<div class="text-center text-gray-400 py-12 text-sm">≈Ω√°dn√© polo≈æky s daty pro Gantt zobrazen√≠.<br>P≈ôidejte datum tenderu nebo dod√°n√≠ u polo≈æek.</div>'
        return
      }

      // Determine date range
      const allDates = []
      for (const i of filtered) {
        if (i.tenderStartDate) allDates.push(new Date(i.tenderStartDate))
        if (i.tenderDeadline) allDates.push(new Date(i.tenderDeadline))
        if (i.orderPlaceDate) allDates.push(new Date(i.orderPlaceDate))
        if (i.deliveryDate) allDates.push(new Date(i.deliveryDate))
      }

      let minDate = new Date(Math.min(...allDates.map(d => d.getTime())))
      let maxDate = new Date(Math.max(...allDates.map(d => d.getTime())))
      // Extend by a bit
      minDate = new Date(minDate.getFullYear(), minDate.getMonth(), 1)
      maxDate = new Date(maxDate.getFullYear(), maxDate.getMonth() + 2, 0)

      const totalMs = maxDate - minDate

      // Build month headers
      const months = []
      let cur = new Date(minDate)
      while (cur <= maxDate) {
        months.push(new Date(cur))
        cur = new Date(cur.getFullYear(), cur.getMonth() + 1, 1)
      }

      const pct = (d) => {
        if (!d) return null
        return ((new Date(d) - minDate) / totalMs) * 100
      }
      const width = (s, e) => {
        if (!s || !e) return 0
        return Math.max(0, ((new Date(e) - new Date(s)) / totalMs) * 100)
      }

      // Today line
      const todayPct = pct(new Date())

      let html = `
        <div class="gantt-header-row">
          <div class="gantt-header-label">${this.t('ppGanttHeaderLabel')}</div>
          <div style="flex:1;display:flex;position:relative">
            ${months.map(m => {
              const msPct = ((m - minDate) / totalMs) * 100
              const label = m.toLocaleDateString(this.lang === 'en' ? 'en-GB' : 'cs-CZ', { month: 'short', year: '2-digit' })
              const mWidth = (1 / months.length) * 100
              return `<div class="gantt-month" style="width:${mWidth}%">${label}</div>`
            }).join('')}
          </div>
        </div>
        <div style="position:relative">
      `

      // Today marker overlay
      html += `<div style="position:absolute;left:calc(220px + ${Math.max(0, Math.min(100, todayPct ?? 0))}%);top:0;bottom:0;width:2px;background:#D40511;z-index:20;opacity:0.7" title="${this.t('ppGanttToday')}">
        <div style="background:#D40511;color:white;font-size:9px;padding:1px 3px;white-space:nowrap;position:absolute;top:0;transform:translateX(-50%)">${this.t('ppGanttToday')}</div>
      </div>`

      for (const item of filtered) {
        const ts = pct(item.tenderStartDate)
        const td = pct(item.tenderDeadline)
        const op = pct(item.orderPlaceDate)
        const dd = pct(item.deliveryDate)

        // Tender bar: from tenderStartDate to tenderDeadline
        let tenderBar = ''
        if (ts !== null && td !== null) {
          tenderBar = `<div class="gantt-bar gantt-bar-tender" style="left:${ts}%;width:${td - ts}%" title="Tender: ${item.tenderStartDate?.slice(0,10)} ‚Üí ${item.tenderDeadline?.slice(0,10)}"></div>`
        } else if (td !== null) {
          tenderBar = `<div class="gantt-bar gantt-bar-tender" style="left:${Math.max(0, td - 1)}%;width:1%;border-radius:50%;width:14px;height:14px" title="Deadline: ${item.tenderDeadline?.slice(0,10)}"></div>`
        }

        // Delivery bar: orderPlace to deliveryDate
        let deliveryBar = ''
        if (op !== null && dd !== null) {
          deliveryBar = `<div class="gantt-bar gantt-bar-delivery" style="left:${op}%;width:${dd - op}%" title="Objedn√°vka‚ÜíDod√°n√≠: ${item.orderPlaceDate?.slice(0,10)} ‚Üí ${item.deliveryDate?.slice(0,10)}"></div>`
        } else if (dd !== null) {
          deliveryBar = `<div class="gantt-bar gantt-bar-delivery" style="left:${dd}%;width:14px;height:14px;border-radius:50%" title="Dod√°n√≠: ${item.deliveryDate?.slice(0,10)}"></div>`
        }

        html += `
          <div class="gantt-row" style="position:relative">
            <div class="gantt-label" title="${item.description}">${item.description}</div>
            <div class="gantt-timeline" style="position:relative;flex:1">
              ${this.ganttFilter !== 'delivery' ? tenderBar : ''}
              ${this.ganttFilter !== 'tender' ? deliveryBar : ''}
            </div>
          </div>
        `
      }

      html += '</div>'
      area.innerHTML = html
    },
  }
}
</script>
</body>
</html>
